

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.beam_stats &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.beam_stats</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.beam_stats</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Beam statistics methods</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="k">import</span> <span class="n">Tracer</span>

<span class="n">meta_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;EGU&#39;</span><span class="p">,</span> <span class="s1">&#39;PREC&#39;</span><span class="p">:</span> <span class="s1">&#39;PREC&#39;</span><span class="p">,</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">}</span>
<span class="n">_transmission_pvs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;FEE&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;fee_trans&#39;</span><span class="p">:</span>     <span class="s1">&#39;SATT:FEE1:320:RACT&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;feegas_trans&#39;</span><span class="p">:</span>     <span class="s1">&#39;GATT:FEE1:310:R_ACT&#39;</span><span class="p">,</span> 
                        <span class="c1">#&#39;fee_trans_set&#39;: &#39;SATT:FEE1:320:RDES&#39;, </span>
                        <span class="c1">#&#39;feegas_trans_set&#39;: &#39;GATT:FEE1:310:R_DES&#39;, </span>
                        <span class="p">},</span>
                <span class="s1">&#39;XPP&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;xpp_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XPP:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;xpp_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XPP:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;xpp_trans_set&#39;:    &#39;XPP:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;xpp_trans3_set&#39;:    &#39;XPP:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;XCS&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;xcs_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XCS:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;xcs_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XCS:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;xcs_trans_set&#39;:    &#39;XCS:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;xcs_trans3_set&#39;:    &#39;XCS:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;MFX&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;mfx_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;MFX:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;mfx_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;MFX:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;mfx_trans_set&#39;:    &#39;MFX:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;mfx_trans3_set&#39;:    &#39;MFX:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;CXI&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;cxi_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;CXI:DSB:ATT:COM:R_CUR&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;dsb_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XRT:DIA:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cxi_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;CXI:DSB:ATT:COM:R3_CUR&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;dsb_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XRT:DIA:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;cxi_trans_set&#39;:    &#39;CXI:DSB:ATT:COM:R_DES&#39;, </span>
                        <span class="c1">#&#39;dsb_trans_set&#39;:    &#39;XRT:DIA:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;cxi_trans3_set&#39;:    &#39;CXI:DSB:ATT:COM:R3_DES&#39;, </span>
                        <span class="c1">#&#39;dsb_trans3_set&#39;:    &#39;XRT:DIA:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="p">}</span>

<span class="k">def</span> <span class="nf">load_exp_sum</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nctype</span><span class="o">=</span><span class="s1">&#39;drop_sum&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load drop stats summary for all runs</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    exp : str</span>
<span class="sd">        experiment name</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instrument : str</span>
<span class="sd">        instrument name.  default = exp[:3] </span>
<span class="sd">    </span>
<span class="sd">    path : str</span>
<span class="sd">        path of run summary files</span>

<span class="sd">    save : bool</span>
<span class="sd">        Save drop_summary file </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray_utils</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run*_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">nctype</span><span class="p">)))</span>

    <span class="n">axstats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dvars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>                                      
        <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">axstats</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">dvars</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading Run </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping Run </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot do &#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">dvars</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dvars</span><span class="p">)))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aattrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dvars</span><span class="p">:</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axstats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aattrs</span><span class="p">:</span>
                    <span class="n">aattrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">adf</span><span class="p">[</span><span class="n">run</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                        <span class="n">aattrs</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> 

        <span class="n">ax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">adf</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">attr</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">del</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">resort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">})</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axstats</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span>
    <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;dvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dvars</span>
    <span class="n">dattrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_detected&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">axstats</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;detected&#39;</span><span class="p">)}</span>
    <span class="n">advar</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dattrs</span><span class="p">:</span>
        <span class="n">advar</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dvar</span> <span class="ow">in</span> <span class="n">dvars</span><span class="p">:</span>
            <span class="n">advar</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">dvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
    
    <span class="n">rinds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">xo</span> <span class="ow">in</span> <span class="n">axstats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">irun</span> <span class="o">=</span> <span class="n">rinds</span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dattrs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dvar</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_detected&#39;</span><span class="p">,[]):</span>
                <span class="n">advar</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">dvar</span><span class="p">][</span><span class="n">irun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">aattrs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">]:</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">aattrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot add attrs for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dattrs</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">advar</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dvars</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;dvar&#39;</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">sum_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/drop_summary.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving drop_summary file: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sum_file</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">clean_dataset</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">clean_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">To_netcdf</span><span class="p">(</span><span class="n">sum_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="c1">#x.To_netcdf(sum_file, engine=&#39;h5netcdf&#39;, invalid_netcdf=True)</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">build_drop_stats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">min_detected</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  
        <span class="n">alert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">html_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">report_name</span><span class="o">=</span><span class="s1">&#39;drop_summary&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">requests</span> <span class="k">import</span> <span class="n">post</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">environ</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BATCH_UPDATE_URL&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">load_exp_sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   
    <span class="n">exp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">)</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">)</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
    <span class="n">expNum</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expNum&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_name</span><span class="p">)</span>
    <span class="n">h5file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">report_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">PyDataSource</span> <span class="k">import</span> <span class="n">DataSource</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">show_codes</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>
        <span class="n">ievt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="c1"># make sure in all detectors have been seen to get full det config</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
            <span class="k">while</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span> <span class="ow">and</span> <span class="n">ievt</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">nevents</span><span class="p">]):</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">:</span>
                    <span class="n">ievt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot get data source information for </span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>

    <span class="n">report_notes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Report includes:&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">build_html</span> <span class="k">import</span> <span class="n">Build_html</span>
        <span class="kn">from</span> <span class="nn">h5write</span> <span class="k">import</span> <span class="n">runlist_to_str</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h5file</span><span class="o">=</span><span class="n">h5file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">report_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">html_path</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">exp</span><span class="o">+</span><span class="s1">&#39; Drop Summary&#39;</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;Drop Summary&#39;</span><span class="p">)</span>
        <span class="n">dattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;dvar&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">webattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">expNum</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">report_name</span><span class="p">,</span> <span class="s1">&#39;report.html&#39;</span><span class="p">]</span> 
        <span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://pswww.slac.stanford.edu/experiment_results/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">webattrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dattrs</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_detected</span><span class="p">)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">inds</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">gattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">dattr</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dattr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gattrs</span><span class="p">:</span>
                    <span class="n">gattrs</span><span class="p">[</span><span class="n">dattr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gattrs</span><span class="p">[</span><span class="n">dattr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;timing_error&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - ALERT:  off-by-one timing errors detected </span><span class="se">\n</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)]))</span>
                    <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">#</span><span class="si">{:}</span><span class="s1">_data&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> \
                                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)])</span>
                    <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span><span class="s1">&#39;Off-by-one detected&#39;</span><span class="p">)</span>
                    <span class="c1">#batch_attr = &#39;Off-by-one detected&#39;</span>
                    <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
                <span class="c1">#    for a in attrs:</span>
                <span class="c1">#        report_notes.append(&#39;      {:}&#39;.format(a))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - No off-by-one timing errors detected&#39;</span><span class="p">)</span>
                    <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;Off-by-one&#39;</span>
                    <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None Detected&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - </span><span class="si">{:}</span><span class="s1"> detected </span><span class="se">\n</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gattrs</span><span class="p">)]))</span>
                <span class="c1">#    for a in attrs:</span>
                <span class="c1">#        report_notes.append(&#39;      {:}&#39;.format(a))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - No </span><span class="si">{:}</span><span class="s1"> detected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">gattrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;timing_error&#39;</span><span class="p">:</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="s1">&#39;Alert Off-by-one Error&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">attr</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="n">alias</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Runs with </span><span class="si">{:}</span><span class="s1"> for </span><span class="si">{:}</span><span class="s1"> attributes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">alias</span><span class="p">)]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                        <span class="n">da</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">aattrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                        <span class="n">runstr</span> <span class="o">=</span> <span class="n">runlist_to_str</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
                        <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - </span><span class="si">{:}</span><span class="s1"> runs with </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">] </span><span class="se">\n</span><span class="s1">       [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> 
                                    <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">runstr</span><span class="p">))</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x[&quot;</span><span class="si">{:}</span><span class="s1">&quot;].to_pandas()[</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">a</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">})</span><span class="o">.</span><span class="n">T</span>
                <span class="n">b</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">attr_cat</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config_info</span><span class="p">:</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No config info&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot add config information&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>

        <span class="n">b</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">h5file</span><span class="o">=</span><span class="n">h5file</span><span class="p">,</span> <span class="n">report_notes</span><span class="o">=</span><span class="n">report_notes</span><span class="p">,</span> <span class="n">show_event_access</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting batch job counter output: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_counters</span><span class="p">))</span>
                <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot update batch submission json counter info to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update_url</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">to_name</span> <span class="o">=</span> <span class="n">alert</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_name</span> <span class="o">=</span> <span class="n">from_name</span>
            
        <span class="k">if</span> <span class="n">alert</span> <span class="ow">and</span> <span class="n">to_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alert_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;Alert&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span> <span class="n">item</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Alert&#39;</span><span class="p">)}</span>
                <span class="k">if</span> <span class="n">alert_items</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">psmessage</span> <span class="k">import</span> <span class="n">Message</span>

                    <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s1">&#39;Alert </span><span class="si">{:}</span><span class="s1"> Off-by-one Errors&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">alert_type</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">alert_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">message</span><span class="p">(</span><span class="n">alert_type</span><span class="p">)</span>
                        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">_message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">)</span>
                            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;* &#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                                <span class="n">da</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;  -</span><span class="si">{:}</span><span class="s1"> -- </span><span class="si">{:}</span><span class="s1"> Errors:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">da</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
                                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;       [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runlist_to_str</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">])))</span>
                    
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;See report:&#39;</span><span class="p">)</span>
                    <span class="n">message</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">weblink</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending message to </span><span class="si">{:}</span><span class="s1"> from </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_name</span><span class="p">,</span> <span class="n">from_name</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    
                    <span class="k">if</span> <span class="n">to_name</span><span class="p">:</span>
                        <span class="n">message</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="n">to_name</span><span class="o">=</span><span class="n">to_name</span><span class="p">,</span> <span class="n">from_name</span><span class="o">=</span><span class="n">from_name</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">message</span>
            
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot send alerts: </span><span class="se">\n</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">b</span>
    
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot build beam drop stats&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="get_beam_stats"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.get_beam_stats.html#PyDataSource.beam_stats.get_beam_stats">[docs]</a><span class="k">def</span> <span class="nf">get_beam_stats</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">default_modules</span><span class="o">=</span><span class="p">{},</span> 
        <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">drop_code</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">drop_attr</span><span class="o">=</span><span class="s1">&#39;delta_drop&#39;</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_min</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  
        <span class="n">pulse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gasdetcut_mJ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">report_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> 
        <span class="n">wait</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">add_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pvdict</span><span class="o">=</span><span class="p">{},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get drop shot statistics to detected dropped shots and beam correlated detectors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    drop_code : str</span>
<span class="sd">        Event code that indicates a dropped shot with no X-rays</span>
<span class="sd">    </span>
<span class="sd">    drop_attr: str</span>
<span class="sd">        Name for number of shots off from dropped shot.</span>
<span class="sd">    </span>
<span class="sd">    nearest : int</span>
<span class="sd">        Number of nearest events to dropped shot to analayze </span>
<span class="sd">        [default=5 unless rate=10 Hz, then nearest=10]</span>

<span class="sd">    drop_min : int</span>
<span class="sd">        Minumum number of dropped shots to perform analysis</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">set_delta_beam</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">clean_dataset</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">merge_fill</span>
    <span class="kn">import</span> <span class="nn">PyDataSource</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">requests</span> <span class="k">import</span> <span class="n">post</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">environ</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BATCH_UPDATE_URL&#39;</span><span class="p">)</span>
    
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">default_modules</span><span class="o">=</span><span class="n">default_modules</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
<span class="c1">#    if update_url:</span>
<span class="c1">#        batch_counters = {&#39;Status&#39;: [&#39;Loading small data...&#39;,&#39;yellow&#39;]}</span>
<span class="c1">#        post(update_url, json={&#39;counters&#39; : batch_counters})</span>
    
    <span class="n">xsmd</span> <span class="o">=</span> <span class="n">load_small_xarray</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
  
    <span class="k">try</span><span class="p">:</span>

        <span class="n">configData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_tstart</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_tend</span>
        <span class="n">fields</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>            <span class="p">(</span><span class="s1">&#39;DESC&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">),</span> 
                <span class="s1">&#39;slew_speed&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;VELO&#39;</span><span class="p">,</span> <span class="s1">&#39;Velocity (EGU/s) &#39;</span><span class="p">),</span>
                <span class="s1">&#39;acceleration&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ACCL&#39;</span><span class="p">,</span> <span class="s1">&#39;acceleration time&#39;</span><span class="p">),</span>
                <span class="s1">&#39;step_size&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span>  <span class="s1">&#39;Step Size (EGU)&#39;</span><span class="p">),</span>
                <span class="s1">&#39;encoder_step&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ERES&#39;</span><span class="p">,</span> <span class="s1">&#39;Encoder Step Size &#39;</span><span class="p">),</span>
                <span class="s1">&#39;resolution&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;MRES&#39;</span><span class="p">,</span> <span class="s1">&#39;Motor Step Size (EGU)&#39;</span><span class="p">),</span>
                <span class="s1">&#39;high_limit&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;HLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User High Limit&#39;</span><span class="p">),</span>
                <span class="s1">&#39;low_limit&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;LLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User Low Limit&#39;</span><span class="p">),</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="s1">&#39;EGU&#39;</span><span class="p">,</span>  <span class="s1">&#39;Units&#39;</span><span class="p">),</span>
    <span class="c1">#            &#39;device_type&#39;:            (&#39;DTYP&#39;, &#39;Device type&#39;), </span>
    <span class="c1">#            &#39;record_type&#39;:            (&#39;RTYP&#39;, &#39;Record Type&#39;), </span>
                <span class="p">}</span>

        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">trans_pvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans&#39;</span><span class="p">)]</span>
        <span class="n">trans_pvs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans&#39;</span><span class="p">)]</span>
        <span class="n">trans3_pvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans3&#39;</span><span class="p">)]</span>
        <span class="n">trans3_pvs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans3&#39;</span><span class="p">)]</span>
        <span class="n">pvdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,{}))</span>
        <span class="n">pvdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,{}))</span>
        
        <span class="n">pvs</span> <span class="o">=</span> <span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="n">pv</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">configData</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv</span><span class="p">)}</span> 
        
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">data_fields</span> <span class="o">=</span> <span class="p">{}</span>
 
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:  </span><span class="si">{:}</span><span class="s1"> - </span><span class="si">{:}</span><span class="s1"> not archived&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                <span class="k">continue</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">meta_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">pv_desc</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">field</span>
                        <span class="k">if</span> <span class="n">configData</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">):</span>
                            <span class="n">desc</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                                <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">fattrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="n">fattrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
                                <span class="n">fattrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="c1"># remove redundant data</span>
                                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                                    <span class="n">newval</span> <span class="o">=</span>  <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                                        <span class="n">val</span> <span class="o">=</span> <span class="n">newval</span>
                                        <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
                                        <span class="n">vals</span><span class="p">[</span><span class="n">vt</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                               
                                <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> 
                                                                <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> 
                                                                <span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">fattrs</span><span class="p">)</span> 
                                <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
         
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot get meta for&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">pass</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data in archive for  </span><span class="si">{:}</span><span class="s1"> - </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">doc</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
              
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="n">dfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span> 
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">alias</span>
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
                
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loadinig&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:10.3f}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                    <span class="n">gias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                    <span class="n">alias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
            
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loading&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_arrays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">trans_pvs</span><span class="p">:</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">trans_pvs</span><span class="p">]</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span> 
            <span class="n">xdata</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">da</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">))</span>
            <span class="n">xdata</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Total transmission: &#39;</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trans_pvs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">xsmd</span><span class="p">)</span>

        <span class="n">xdata</span> <span class="o">=</span> <span class="n">merge_fill</span><span class="p">(</span><span class="n">xsmd</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not load transmission pvs&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#Save sources, eventCodes and ScanData xarray datasets</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">save_configData</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing Scan Data&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot write scan information for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>

    <span class="n">nevents</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nevents</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_seq_evtCodes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">167</span><span class="p">,</span><span class="mi">199</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="mi">217</span><span class="p">)</span>
        <span class="n">code_stats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">))</span> <span class="ow">in</span> <span class="n">_seq_evtCodes</span> \
                <span class="ow">and</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="n">nevents</span><span class="p">]</span>
        <span class="n">code_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">162</span><span class="p">)</span>
        <span class="n">code_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">162</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">code_stats</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">drop_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xsmd</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping beam stats analysis for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  -- No </span><span class="si">{:}</span><span class="s1"> present in data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_code</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Warning&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;No dropped shots present in </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nevents</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">]}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting batch job counter output: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_counters</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
                <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot update batch submission json counter info to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update_url</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">xsmd</span>

    <span class="n">set_delta_beam</span><span class="p">(</span><span class="n">xsmd</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">drop_code</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">drop_attr</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nearest</span><span class="p">:</span>
        <span class="c1"># auto set number of nearest shots to include at least two on</span>
        <span class="c1"># each side for up to 60 Hz data rates.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_drop</span> <span class="o">=</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">drop_mode</span> <span class="o">=</span> <span class="n">df_drop</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">drop_mode</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">drop_mode</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
                <span class="n">nearest</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">drop_mode</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span><span class="mi">12</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nearest</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nearest</span><span class="o">=</span><span class="mi">5</span>
        
        <span class="n">xdrop</span> <span class="o">=</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">nearest</span><span class="o">=</span><span class="mi">12</span>
            <span class="n">xdrop</span> <span class="o">=</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ntimes</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">ndrop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">drop_code</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot select dropped events&#39;</span><span class="p">)</span>
                    <span class="n">ndrop</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping beam stats analysis for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  -- only </span><span class="si">{:}</span><span class="s1"> events with </span><span class="si">{:}</span><span class="s1"> in </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndrop</span><span class="p">,</span> <span class="n">drop_code</span><span class="p">,</span> <span class="n">nevents</span><span class="p">))</span>
                <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Warning&#39;</span><span class="p">:</span> 
                        <span class="p">[</span><span class="s1">&#39;Low event rate: </span><span class="si">{:}</span><span class="s1"> dropped shots present in </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndrop</span><span class="p">,</span> <span class="n">nevents</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">]}</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting batch job counter output: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_counters</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
                    <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">xdrop</span> 
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pulse</span><span class="p">:</span>
        <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span>
        <span class="k">if</span> <span class="n">pulse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">or</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>
        <span class="k">if</span> <span class="n">pulse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">or</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="n">gasdetcut_mJ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">gas_attr</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># determine gasdet cut from dropped shots</span>
            <span class="n">gasdet_stats</span> <span class="o">=</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">gas_attr</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.95</span><span class="p">])</span>
            <span class="n">gasdetcut_mJ</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">gasdet_stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span><span class="n">gasdet_stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">gasdet_stats</span><span class="p">[</span><span class="s1">&#39;95%&#39;</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">gasdetcut_mJ</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot auto set gasdetcut_mJ - default = </span><span class="si">{:}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">))</span>
       
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;gasdetcut_mJ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gasdetcut_mJ</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;gasdet_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas_attr</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">gas_attr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gasdetcut_mJ</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Gas detector cut.  Gasdet_pre_atten &gt; </span><span class="si">{:}</span><span class="s2"> mJ&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nlowshots</span> <span class="o">=</span> <span class="p">((</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">nshots</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">xsmd</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lowbeam_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlowshots</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nshots</span><span class="p">)</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot calculate lowbeam_fraction for threshold gasdetcut_mJ </span><span class="si">{:}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot make Gasdet_cut with threshold gasdetcut_mJ </span><span class="si">{:}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray Off for events with </span><span class="si">{:}</span><span class="s1"> or lowbeam&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_code</span><span class="p">)</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray On for events without </span><span class="si">{:}</span><span class="s1"> and no lowbeam&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_code</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot set XrayOn/XrayOff with threshold gasdetcut_mJ </span><span class="si">{:}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">))</span>
   
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Gasdet_cut&#39;</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">drop_select</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="n">xsmd</span><span class="p">[</span><span class="n">drop_code</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_select</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">drop_select</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot select smd using threshold gasdetcut_mJ </span><span class="si">{:}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">))</span>
            
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xdrop</span> <span class="o">=</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">drop_select</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntimes</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ndrop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">drop_code</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot select dropped events&#39;</span><span class="p">)</span>
        <span class="n">ndrop</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">ndrop</span> <span class="o">&lt;</span> <span class="n">drop_min</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping beam stats analysis for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  -- only </span><span class="si">{:}</span><span class="s1"> events with </span><span class="si">{:}</span><span class="s1"> in </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndrop</span><span class="p">,</span> <span class="n">drop_code</span><span class="p">,</span> <span class="n">nevents</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Warning&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Only </span><span class="si">{:}</span><span class="s1"> dropped shots present in </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndrop</span><span class="p">,</span> <span class="n">nevents</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">]}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting batch job counter output: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_counters</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
                <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot update batch submission json counter info to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update_url</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">xsmd</span>

    <span class="n">dets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">flatten_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flatten_channels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">area_dets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wf_dets</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">det_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,{})</span>
            <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="s1">&#39;pydet not implemented&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.AreaDetector&#39;</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_srcstr</span> 
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># for not just use rawsum for &#39;Epix10ka&#39; and  &#39;Jungfrau&#39; until full</span>
                <span class="c1"># development of gain switching in Detector module</span>
                <span class="k">if</span> <span class="n">devName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Opal&#39;</span><span class="p">):</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;rawsum&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                    <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">]))</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum of raw data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">area_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">add_stats</span><span class="p">:</span>
                        <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">ok_stats</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="n">eventCodes</span><span class="o">=</span><span class="n">code_stats</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding stats for&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ok_stats</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">devName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Epix10ka&#39;</span><span class="p">]:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;rawsum&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                    <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">]))</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum of raw data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">area_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">add_stats</span><span class="p">:</span>
                        <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">ok_stats</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;calib&#39;</span><span class="p">,</span> <span class="n">eventCodes</span><span class="o">=</span><span class="n">code_stats</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding stats for&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ok_stats</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">devName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Jungfrau&#39;</span><span class="p">]:</span>
                    <span class="n">nch</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">numberOfModules</span>
                    <span class="k">if</span> <span class="n">nch</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;sectors&#39;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="s1">&#39;rawsum&#39;</span><span class="p">])</span>
                        <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_ch&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">,</span> <span class="n">nch</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">ich</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nch</span><span class="p">):</span>
                            <span class="n">area_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_ch</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">ich</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;sector&#39;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="s1">&#39;rawsum&#39;</span><span class="p">])</span>
                        <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">]))</span>
                        <span class="n">area_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum of raw data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="k">if</span> <span class="n">add_stats</span><span class="p">:</span>
                        <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">ok_stats</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;calib&#39;</span><span class="p">,</span> <span class="n">eventCodes</span><span class="o">=</span><span class="n">code_stats</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding stats for&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ok_stats</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                    <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">]))</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum of pedestal corrected data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">area_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">add_stats</span><span class="p">:</span>
                        <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">ok_stats</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="n">eventCodes</span><span class="o">=</span><span class="n">code_stats</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding stats for&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ok_stats</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.GenericWFDetector&#39;</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_srcstr</span> 
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">devName</span> <span class="o">==</span> <span class="s1">&#39;Wave8&#39;</span><span class="p">:</span>
                    <span class="c1">#nch = detector.configData.NChannels </span>
                    <span class="n">nch</span> <span class="o">=</span> <span class="mi">8</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;wave8_height&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_ch&#39;</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">,</span> <span class="n">nch</span><span class="p">]))</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BeamMonitor </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">wf_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.WFDetector&#39;</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_srcstr</span> 
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">devName</span> <span class="o">==</span> <span class="s1">&#39;Acqiris&#39;</span><span class="p">:</span>
                    <span class="n">nch</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">nbrChannels</span> 
                    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;peak_height&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_time&#39;</span><span class="p">]:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                        <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_ch&#39;</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">,</span> <span class="n">nch</span><span class="p">]))</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Acqiris </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                        <span class="n">wf_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">devName</span> <span class="o">==</span> <span class="s1">&#39;Imp&#39;</span><span class="p">:</span>
                    <span class="n">nch</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;amplitudes&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                    <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_ch&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ntimes</span><span class="p">,</span> <span class="n">nch</span><span class="p">]))</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;waveform&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;IMP filtered amplitudes&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                    <span class="n">wf_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
 
            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.UsdUsbDetector&#39;</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_srcstr</span> 
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">devName</span> <span class="o">==</span> <span class="s1">&#39;USDUSB&#39;</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;encoder_values&#39;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                    <span class="n">flatten_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.DdlDetector&#39;</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_srcstr</span> 
                <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcstr</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;BldInfo&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">srcname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;BMMON&#39;</span><span class="p">):</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;channelValue&#39;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                        <span class="n">flatten_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Flatten </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                        <span class="c1">#flatten_channels[name] = range(8,16)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">devName</span> <span class="o">==</span> <span class="s1">&#39;Gsc16ai&#39;</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;channelValue&#39;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">method</span><span class="p">])</span>
                        <span class="n">flatten_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Flatten </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;Detector.IpimbDetector&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Not implemented&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
        
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Error with config of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error with config of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">methods</span><span class="p">:</span>
            <span class="n">dets</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">methods</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;waveform_detectors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wf_dets</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;area_detectors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area_dets</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xdrop</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="n">times</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">sec</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">xdrop</span><span class="o">.</span><span class="n">nsec</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">xdrop</span><span class="o">.</span><span class="n">fiducials</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">nupdate</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">time_last</span> <span class="o">=</span> <span class="n">time0</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dets</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">itime</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">itime</span> <span class="o">%</span> <span class="n">nupdate</span> <span class="o">==</span> <span class="n">nupdate</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dtime</span> <span class="o">=</span> <span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span>
            <span class="n">evt_info</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:8}</span><span class="s1"> of </span><span class="si">{:8}</span><span class="s1"> -- </span><span class="si">{:8.3f}</span><span class="s1"> sec, </span><span class="si">{:8.3f}</span><span class="s1"> events/sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itime</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
                    <span class="n">ntimes</span><span class="p">,</span> <span class="n">time_next</span><span class="o">-</span><span class="n">time0</span><span class="p">,</span> <span class="n">nupdate</span><span class="o">/</span><span class="n">dtime</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">evt_info</span><span class="p">)</span>
            <span class="n">time_last</span> <span class="o">=</span> <span class="n">time_next</span> 
<span class="c1">#            if update_url:</span>
<span class="c1">#                batch_counters = {&#39;Status&#39;: [evt_info,&#39;yellow&#39;]}</span>
<span class="c1">#                post(update_url, json={&#39;counters&#39; : batch_counters})</span>

        <span class="n">evt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">methods</span> <span class="ow">in</span> <span class="n">dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">detector</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">_dets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">detector</span> <span class="ow">and</span> <span class="n">detector</span><span class="o">.</span><span class="n">sourceData</span><span class="o">.</span><span class="n">eventCode</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes_strict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">itime</span><span class="p">]</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">method</span><span class="p">](</span><span class="n">detector</span><span class="p">)</span> 
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">itime</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot calculate </span><span class="si">{:}</span><span class="s1"> for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Error with </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">itime</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 

    <span class="c1"># Flatten waveform data with channels</span>
    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="c1">#for name in xdrop.data_vars:</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">methods</span> <span class="ow">in</span> <span class="n">dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">flatten_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">flatten_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">nch</span> <span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fchans</span> <span class="o">=</span> <span class="n">flatten_channels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nch</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">nch</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">flatten_channels</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ich</span> <span class="ow">in</span> <span class="n">fchans</span><span class="p">:</span>
                        <span class="n">chname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_ch</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">ich</span><span class="p">)</span>
                        <span class="n">xdrop</span><span class="p">[</span><span class="n">chname</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span><span class="n">ich</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr&#39;</span><span class="p">):</span>
                                <span class="n">alias</span> <span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="n">attr</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                                <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span> 
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">del</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">add_stats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot save stats for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">report_name</span><span class="p">:</span>
        <span class="n">report_name</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_drop_stats&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

    <span class="n">h5file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">report_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
   
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Build </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">,</span> <span class="n">xdrop</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">build_beam_stats</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">xdrop</span><span class="o">=</span><span class="n">xdrop</span><span class="p">,</span> <span class="n">xsmd</span><span class="o">=</span><span class="n">xsmd</span><span class="p">,</span> 
            <span class="n">nearest</span><span class="o">=</span><span class="n">nearest</span><span class="p">,</span>
            <span class="n">report_name</span><span class="o">=</span><span class="n">report_name</span><span class="p">,</span> <span class="n">h5file</span><span class="o">=</span><span class="n">h5file</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xdrop</span> <span class="o">=</span> <span class="n">clean_dataset</span><span class="p">(</span><span class="n">xdrop</span><span class="p">)</span>
        <span class="c1">#xdrop.to_netcdf(h5file, engine=engine, invalid_netcdf=True)</span>
        <span class="n">xdrop</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">h5file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving file to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5file</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving file to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5file</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot save to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5file</span><span class="p">))</span>
   
    <span class="k">return</span> <span class="n">xdrop</span></div>

<div class="viewcode-block" id="build_beam_stats"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.build_beam_stats.html#PyDataSource.beam_stats.build_beam_stats">[docs]</a><span class="k">def</span> <span class="nf">build_beam_stats</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">xdrop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">report_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h5file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">alert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">html_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">make_scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cut_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nearest</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">pulse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">from</span> <span class="nn">requests</span> <span class="k">import</span> <span class="n">post</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">environ</span>
    <span class="n">update_url</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BATCH_UPDATE_URL&#39;</span><span class="p">)</span>
    <span class="n">_seq_evtCodes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">167</span><span class="p">,</span><span class="mi">199</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="mi">217</span><span class="p">)</span>
    <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xdrop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">])</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xdrop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error:  Need to specify exp and run or alternatively xdrop DataSet&#39;</span><span class="p">)</span> 
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">report_name</span><span class="p">:</span>
        <span class="n">report_name</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_drop_stats&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h5file</span><span class="p">:</span>
        <span class="n">h5file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">report_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="n">xdrop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="n">xdrop</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">h5file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">))</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">))</span>
    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">))</span>
    <span class="n">expNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expNum&#39;</span><span class="p">))</span>
    <span class="n">webattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">expNum</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">report_name</span><span class="p">,</span> <span class="s1">&#39;report.html&#39;</span><span class="p">]</span> 
    <span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://pswww.slac.stanford.edu/experiment_results/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">webattrs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">PyDataSource</span> <span class="k">import</span> <span class="n">DataSource</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
        <span class="n">configData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">show_codes</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">configData</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot get data source information for </span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">build_html</span> <span class="k">import</span> <span class="n">Build_html</span>
   
        <span class="n">b</span> <span class="o">=</span> <span class="n">Build_html</span><span class="p">(</span><span class="n">xdrop</span><span class="p">,</span> <span class="n">h5file</span><span class="o">=</span><span class="n">h5file</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">report_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">html_path</span><span class="p">)</span>
        <span class="n">drop_attr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_attr&#39;</span><span class="p">,</span> <span class="s1">&#39;ec162&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;XrayOff&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">and</span> <span class="n">drop_attr</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="p">:</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray Off for events with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;XrayOn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">and</span> <span class="n">drop_attr</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="p">:</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray On for events without </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_attr</span><span class="p">)</span>

        <span class="n">report_notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># X-ray Energy and Charge information</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">energy_mean</span><span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">EBeam_ebeamPhotonEnergy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">energy_std</span><span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">EBeam_ebeamPhotonEnergy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Energy = </span><span class="si">{:6.1f}</span><span class="s1">+=</span><span class="si">{:5.1f}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">energy_mean</span><span class="p">,</span> <span class="n">energy_std</span><span class="p">))</span>
            <span class="n">charge_mean</span><span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">EBeam_ebeamCharge</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">charge_std</span><span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">EBeam_ebeamCharge</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Charge = </span><span class="si">{:6.3f}</span><span class="s1">+=</span><span class="si">{:5.3f}</span><span class="s1"> mA&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">charge_mean</span><span class="p">,</span> <span class="n">charge_std</span><span class="p">))</span>
            <span class="n">gas_attr</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gasdet_attr&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gas_attr</span> <span class="ow">and</span> <span class="n">gas_attr</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="p">:</span> 
                <span class="n">pulseE_mean</span><span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">gas_attr</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">pulseE_std</span><span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">gas_attr</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">XrayOn</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PulseE = </span><span class="si">{:6.3f}</span><span class="s1">+=</span><span class="si">{:5.3f}</span><span class="s1"> mJ&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pulseE_mean</span><span class="p">,</span> <span class="n">pulseE_std</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xsmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nsmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsmd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> 
                    <span class="n">nec_smd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;ec162&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">ecfrac_smd</span> <span class="o">=</span> <span class="n">nec_smd</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsmd</span><span class="p">)</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Dropped = 1/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">ecfrac_smd</span><span class="p">)))</span>
                    <span class="c1"># Check for A-line Kicker rate</span>
                    <span class="k">if</span> <span class="s1">&#39;ec163&#39;</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                        <span class="n">nec_smd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="s1">&#39;ec163&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">nec_smd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ecfrac_smd</span> <span class="o">=</span> <span class="n">nec_smd</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsmd</span><span class="p">)</span>
                            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ESA Kick = 1/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">ecfrac_smd</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot report drop fraction&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot report drop fraction&#39;</span><span class="p">)</span>

            <span class="n">lowbeam_frac</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lowbeam_fraction&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">gasdetcut_mJ</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gasdetcut_mJ&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lowbeam_frac</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gasdetcut_mJ</span><span class="p">:</span> 
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LowBeam = </span><span class="si">{:4.1f}</span><span class="s1"> % (&lt;</span><span class="si">{:6.2}</span><span class="s1"> mJ)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowbeam_frac</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="n">gasdetcut_mJ</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;LowBeam = </span><span class="si">{:4.1f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowbeam_frac</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="n">step_attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">configData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scanData</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span>
                <span class="n">nsteps</span> <span class="o">=</span> <span class="n">scanData</span><span class="o">.</span><span class="n">nsteps</span>
                <span class="n">df_steps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scanData</span><span class="o">.</span><span class="n">control_values</span><span class="p">)</span>
                <span class="n">scan_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_steps</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">df_steps</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scan Steps = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsteps</span><span class="p">))</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scan Variables = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan_attrs</span><span class="p">))</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot get scan information for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>

        <span class="c1"># Event code flags</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code_kicker</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ec162&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ec163&#39;</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">code_kicker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ec163&#39;</span><span class="p">)</span>
            <span class="n">nevents</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> 
            <span class="n">code_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">))</span> <span class="ow">in</span> <span class="n">_seq_evtCodes</span> \
                    <span class="ow">and</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="n">nevents</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xsmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nsmd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsmd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">count</span><span class="p">())</span> 
                <span class="n">report_str</span> <span class="o">=</span> <span class="s1">&#39;Event Types in All Run Events: </span><span class="si">{:}</span><span class="s1"> Total&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsmd</span><span class="p">)</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_str</span><span class="p">)</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_flags</span><span class="o">+</span><span class="n">code_kicker</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;event code for &#39;</span><span class="p">)</span>
                        <span class="n">nec_smd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsmd</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">nec_smd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ecfrac_smd</span> <span class="o">=</span> <span class="n">nec_smd</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsmd</span><span class="p">)</span>
                            <span class="n">report_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:7}</span><span class="s1"> </span><span class="si">{:6}</span><span class="s1"> - </span><span class="si">{:5.1f}</span><span class="s1">%  </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nec_smd</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ecfrac_smd</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_str</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in report of </span><span class="si">{:}</span><span class="s1"> rate&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">report_str</span> <span class="o">=</span> <span class="s1">&#39;Event Types in Dropped Shot Analysis: </span><span class="si">{:}</span><span class="s1"> of </span><span class="si">{:}</span><span class="s1"> (</span><span class="si">{:5.1f}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> 
                            <span class="n">nsmd</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsmd</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_str</span><span class="p">)</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_flags</span><span class="o">+</span><span class="n">code_kicker</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;event code for &#39;</span><span class="p">)</span>
                    <span class="n">nec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">nec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ecfrac</span> <span class="o">=</span> <span class="n">nec</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span>
                        <span class="n">report_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:7}</span><span class="s1"> </span><span class="si">{:6}</span><span class="s1"> - </span><span class="si">{:5.1f}</span><span class="s1">%  </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nec</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ecfrac</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                        <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_str</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in report of </span><span class="si">{:}</span><span class="s1"> rate&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">code_flags</span><span class="p">:</span>
                    <span class="n">flag_names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_flags</span><span class="p">:</span>
                        <span class="n">flag_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;event code for &#39;</span><span class="p">)</span>
                        <span class="n">flag_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">flag_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">flag_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                        <span class="n">flag_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code_flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">df_codes</span> <span class="o">=</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">flag_names</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">df_codes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">nevents</span><span class="p">:</span>
                            <span class="n">cut_flag</span> <span class="o">=</span> <span class="n">df_codes</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                            <span class="n">flag_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag_names</span><span class="p">))</span>
                            <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
                            <span class="c1">#xdrop.coords[&#39;tag_name&#39;] = ((&#39;tag&#39;), flag_names)</span>
                            <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tag_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag_names</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flag_inds</span><span class="p">:</span>
                                <span class="n">xdrop</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">][</span><span class="n">xdrop</span><span class="p">[</span><span class="n">flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot process code_flags </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_flags</span><span class="p">))</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot process code_flags </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_flags</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot detect code_flags&#39;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot detect code_flags&#39;</span><span class="p">)</span>

        <span class="c1"># Timing and config alerts</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">configCheck</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">configCheck</span>
            <span class="n">report_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">det_errors</span> <span class="o">=</span> <span class="p">[]</span> 
            <span class="k">if</span> <span class="n">configCheck</span><span class="o">.</span><span class="n">alerts</span><span class="p">:</span>
                <span class="n">det_errors</span> <span class="o">+=</span> <span class="n">configCheck</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="c1">#                report_config = True</span>
<span class="c1">#                batch_attr = &#39;&lt;a href={:}#{:}&gt;{:}&lt;/a&gt;&#39;.format(weblink, &#39;Report_Notes&#39;, &#39;Timing Config Alerts&#39;)</span>
<span class="c1">#                batch_str = &#39;,&#39;.join(set(configCheck.alerts.keys()))</span>
<span class="c1">#                batch_counters[batch_attr] = [batch_str, &#39;red&#39;]</span>
            <span class="k">if</span> <span class="n">configCheck</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                <span class="n">det_errors</span> <span class="o">+=</span> <span class="n">configCheck</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="c1">#                report_config = True</span>
<span class="c1">#                batch_str = &#39;,&#39;.join(set(configCheck.warnings.keys()))</span>
<span class="c1">#                batch_attr = &#39;&lt;a href={:}#{:}&gt;{:}&lt;/a&gt;&#39;.format(weblink, &#39;Report_Notes&#39;, &#39;Timing Config Warnings&#39;)</span>
<span class="c1">#                batch_counters[batch_attr] = [batch_str, &#39;red&#39;]</span>
            <span class="c1">#if report_config:</span>
            <span class="k">if</span> <span class="n">det_errors</span><span class="p">:</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">det_errors</span><span class="p">))</span>
                <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">#</span><span class="si">{:}</span><span class="s1">&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span> <span class="s1">&#39;Report_Notes&#39;</span><span class="p">,</span> <span class="s1">&#39;Timing Config Errors&#39;</span><span class="p">)</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Detector Timing and Config Errors:&#39;</span><span class="p">)</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;----------------------------------&#39;</span><span class="p">)</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">configCheck</span><span class="o">.</span><span class="n">show_info</span><span class="p">()))</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">report_str</span><span class="o">=</span><span class="s1">&#39;Link to Confluence Detector timing settings:&#39;</span>
                <span class="n">report_link</span><span class="o">=</span><span class="s1">&#39;https://confluence.slac.stanford.edu/display/PCDS/Detector+timing+settings&#39;</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report_link</span><span class="p">,</span> <span class="n">report_str</span><span class="p">))</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot check timing and config alerts&#39;</span><span class="p">)</span>

        <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Report includes:&#39;</span><span class="p">)</span>
      
       
        <span class="n">b</span><span class="o">.</span><span class="n">_xstats</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">add_delta_beam</span><span class="p">(</span><span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut_flag</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="n">nearest</span><span class="p">)</span>
        <span class="n">corr_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Beam Correlations Detected </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr_attrs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">corr_attrs</span><span class="p">:</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_corr_attr&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pulse</span><span class="p">:</span>
                <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span>
                <span class="k">if</span> <span class="n">pulse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">or</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>
                <span class="k">if</span> <span class="n">pulse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdrop</span> <span class="ow">or</span> <span class="n">xdrop</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pulse</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="n">pulse</span><span class="p">:</span>
                <span class="n">corr_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">corr_attrs</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">pulse</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">)]</span>
                <span class="n">corr_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pulse</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;PhaseCavity_charge1&#39;</span> <span class="ow">in</span> <span class="n">corr_attrs</span> <span class="ow">and</span> <span class="s1">&#39;PhaseCavity_charge2&#39;</span> <span class="ow">in</span> <span class="n">corr_attrs</span><span class="p">:</span>
                    <span class="n">corr_attrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;PhaseCavity_charge2&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding Detector Beam Correlations </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr_attrs</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">corr_attrs</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39; Beam Correlations&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">,</span>
                        <span class="n">make_timeplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_histplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">make_scatter</span><span class="o">=</span><span class="n">make_scatter</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot make beam correlations </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">corr_attrs</span><span class="p">))</span>

        <span class="c1">#batch_counters[&#39;report&#39;] = [&#39;See &lt;a href={:}&gt;Run{:04} Report&lt;/a&gt;&#39;.format(weblink,run),&#39;blue&#39;]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_config_srcs</span><span class="p">:</span>
                <span class="n">config_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                <span class="n">b</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config_data</span><span class="o">.</span><span class="n">show_info</span><span class="p">()),</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_config&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add detector configurations&#39;</span><span class="p">)</span>
 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">offbyone_detectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">timing_error_detected</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">offbyone_detectors</span><span class="p">:</span>
                <span class="c1">#batch_str = &#39;, &#39;.join([&#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, attr,attr) \</span>
                <span class="c1">#                        for attr in offbyone_detectors])</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">offbyone_detectors</span><span class="p">])</span>
                <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">#</span><span class="si">{:}</span><span class="s1">_data&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span> <span class="s2">&quot;%20Alert%20Timing</span><span class="si">%20E</span><span class="s2">rror&quot;</span><span class="p">,</span> <span class="s1">&#39;Off-by-one detected&#39;</span><span class="p">)</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - Off-by-one detected: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">offbyone_detectors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">timing_error_detected</span><span class="p">):</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    + &#39;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">offbyone_detectors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">drop_detectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">drop_shot_detected</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">drop_detectors</span><span class="p">:</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">drop_detectors</span><span class="p">])</span>
                <span class="c1">#batch_str = &#39;, &#39;.join([&#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, attr,attr) \</span>
                <span class="c1">#                        for attr in drop_detectors])</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="s1">&#39;Dropped shot detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - Dropped shot detected: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">drop_detectors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">drop_shot_detected</span><span class="p">):</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    + &#39;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">drop_detectors</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">beam_detectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">beam_corr_detected</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">beam_detectors</span><span class="p">:</span>
                <span class="c1">#beam_detectors = [&#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, a, a) for a in beam_detectors]</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">beam_detectors</span><span class="p">])</span>
                <span class="c1">#batch_str = &#39;, &#39;.join([&#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, attr,attr) \</span>
                <span class="c1">#                        for attr in beam_detectors])</span>
                <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">#</span><span class="si">{:}</span><span class="s1">_data&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span> <span class="s2">&quot;%20Beam%20Correlations&quot;</span><span class="p">,</span> <span class="s1">&#39;Beam Correlated detected&#39;</span><span class="p">)</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - Beam correlated detected: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">beam_detectors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">beam_corr_detected</span><span class="p">):</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    + &#39;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">beam_detectors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">warning_detectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">xdrop</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xdrop</span><span class="o">.</span><span class="n">beam_warning_detected</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">warning_detectors</span><span class="p">:</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">warning_detectors</span><span class="p">])</span>
                <span class="c1">#batch_str = &#39;, &#39;.join([&#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, attr,attr) \</span>
                <span class="c1">#                        for attr in warning_detectors])</span>
                <span class="c1">#batch_attr = &#39;&lt;a href={:}#{:}_data&gt;{:}&lt;/a&gt;&#39;.format(weblink, &quot;%20Beam%20Warnings&quot;, &#39;Beam Warnings detected&#39;)</span>
                <span class="c1">#batch_counters[batch_attr] = [batch_str, &#39;green&#39;]</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="s1">&#39;Beam warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
                <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; - Beam Warnings: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">warning_detectors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xdrop</span><span class="o">.</span><span class="n">beam_warning_detected</span><span class="p">):</span>
                    <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;    + &#39;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warning_detectors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">batch_attr</span> <span class="o">=</span> <span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">#</span><span class="si">{:}</span><span class="s1">_data&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span> <span class="s2">&quot;%20Scan&quot;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Scan Steps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsteps</span><span class="p">))</span>
                <span class="n">batch_str</span> <span class="o">=</span> <span class="s1">&#39;Scan Variables = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan_attrs</span><span class="p">)</span>
                <span class="n">batch_counters</span><span class="p">[</span><span class="n">batch_attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_str</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">show_info</span><span class="p">()),</span> <span class="s1">&#39; Scan&#39;</span><span class="p">,</span> <span class="s1">&#39;Step Info&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot add Scan Data&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">config_info</span><span class="p">:</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">report_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config_info</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No config info&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="c1"># only make reports if not empty</span>
            <span class="n">b</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">h5file</span><span class="o">=</span><span class="n">h5file</span><span class="p">,</span> <span class="n">report_notes</span><span class="o">=</span><span class="n">report_notes</span><span class="p">,</span> <span class="n">show_event_access</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting batch job counter output: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_counters</span><span class="p">))</span>
                <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot update batch submission json counter info to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update_url</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">to_name</span> <span class="o">=</span> <span class="n">alert</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_name</span> <span class="o">=</span> <span class="n">from_name</span>
            
        <span class="n">alert_items</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;Alert&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span> <span class="n">item</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Alert&#39;</span><span class="p">)}</span>
       
        <span class="k">if</span> <span class="n">alert_items</span> <span class="ow">and</span> <span class="n">offbyone_detectors</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;EBeam&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">alert</span> <span class="ow">and</span> <span class="n">to_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">psmessage</span> <span class="k">import</span> <span class="n">Message</span>
                    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s1">&#39;Alert </span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alert_items</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                    <span class="n">event_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">begin_time</span> <span class="o">=</span> <span class="n">event_times</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">event_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">run_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
                    <span class="n">minutes</span><span class="p">,</span><span class="n">fracseconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">run_time</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>

                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;- Run Start:  </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">begin_time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;- Run End:    </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;- Duration:   </span><span class="si">{:}</span><span class="s1"> seconds (</span><span class="si">{:02.0f}</span><span class="s1">:</span><span class="si">{:02.0f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_time</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">fracseconds</span><span class="p">))</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;- Total events: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
 
                    <span class="k">for</span> <span class="n">alert_type</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">alert_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">message</span><span class="p">(</span><span class="n">alert_type</span><span class="p">)</span>
                        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">_message</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">doc</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;* &#39;</span><span class="o">+</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;   - &#39;</span><span class="o">+</span><span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">message</span><span class="p">(</span><span class="s1">&#39;See report:&#39;</span><span class="p">)</span>
                    <span class="n">message</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">weblink</span><span class="p">)</span>
                    
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending message to </span><span class="si">{:}</span><span class="s1"> from </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_name</span><span class="p">,</span> <span class="n">from_name</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="n">message</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="n">to_name</span><span class="o">=</span><span class="n">to_name</span><span class="p">,</span> <span class="n">from_name</span><span class="o">=</span><span class="n">from_name</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;ERROR Sending message to </span><span class="si">{:}</span><span class="s1"> from </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_name</span><span class="p">,</span> <span class="n">from_name</span><span class="p">))</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot send alerts: </span><span class="se">\n</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)))</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot build drop report&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">b</span></div>


<div class="viewcode-block" id="load_small_xarray"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.load_small_xarray.html#PyDataSource.beam_stats.load_small_xarray">[docs]</a><span class="k">def</span> <span class="nf">load_small_xarray</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load small xarray Dataset with PyDataSource.DataSource. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    refresh : bool</span>
<span class="sd">        True = reload</span>
<span class="sd">        False = load from file, return None if file does not exist</span>
<span class="sd">        None = load from file or make new if file does not exist [default] </span>
<span class="sd">         </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_smd.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

    <span class="n">smd_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">file_available</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">smd_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file_available</span><span class="p">:</span> 
        <span class="n">refresh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_small_xarray</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_available</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="make_small_xarray"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.make_small_xarray.html#PyDataSource.beam_stats.make_small_xarray">[docs]</a><span class="k">def</span> <span class="nf">make_small_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_dets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_1d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_unused_codes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span><span class="s1">&#39;numChannels&#39;</span><span class="p">,</span><span class="s1">&#39;digital_in&#39;</span><span class="p">],</span>
        <span class="n">drop_code</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">drop_attr</span><span class="o">=</span><span class="s1">&#39;delta_drop&#39;</span><span class="p">,</span> 
        <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> 
        <span class="n">make_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nevents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make Small xarray Dataset.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ignore_unused_codes : bool</span>
<span class="sd">        If true drop unused eventCodes except drop_code [default=True]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">set_delta_beam</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">clean_dataset</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">to_summary</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nevents</span><span class="p">:</span>
        <span class="n">nevents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span>
    
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">cnames</span> <span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="p">:</span> <span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span>  <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">drop_code</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">:</span>
            <span class="n">cnames</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> 
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot add drop_code = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">cnames</span><span class="p">[</span><span class="n">code</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">}</span>
    <span class="c1">#data = {cnames[code]: np.zeros(nevents, dtype=bool) for code in self.configData._eventcodes}</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data1d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dets1d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">]</span>
    <span class="n">dets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EventId&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">}}}</span>
    <span class="n">coords</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)})</span>
    
    <span class="n">ievt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">add_dets</span><span class="p">:</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">detector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
            <span class="c1">#srcstr = detector._srcstr </span>
            <span class="c1">#srcname = srcstr.split(&#39;(&#39;)[1].split(&#39;)&#39;)[0]</span>
            <span class="c1">#devName = srcname.split(&#39;:&#39;)[1].split(&#39;.&#39;)[0]</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_present&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)})</span>
            
            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;EBeam&#39;</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ebeamCharge&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamDumpCharge&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamEnergyBC1&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamEnergyBC2&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;ebeamL3Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamLTU250&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamLTU450&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamLTUAngX&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamLTUAngY&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;ebeamLTUPosX&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamLTUPosY&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamPhotonEnergy&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;ebeamPkCurrBC1&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamPkCurrBC2&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamUndAngX&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamUndAngY&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;ebeamUndPosX&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamUndPosY&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamXTCAVAmpl&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamXTCAVPhase&#39;</span><span class="p">]</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
                <span class="c1">#attrs = {&#39;EBeam_&#39;+attr.lstrip(&#39;ebeam&#39;): attr for attr in attrs}</span>
                <span class="n">dets</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;EBeam&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}})</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">)})</span>
            <span class="k">elif</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_11_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;f_12_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;f_21_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;f_22_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;f_63_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;f_64_ENRC&#39;</span><span class="p">]</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
                <span class="c1">#attrs = {&#39;GasDet_&#39;+&#39;&#39;.join(attr.split(&#39;_&#39;)[0:2]): attr for attr in attrs}</span>
                <span class="n">dets</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}})</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">)})</span>
            <span class="k">elif</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;PhaseCavity&#39;</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;charge1&#39;</span><span class="p">,</span> <span class="s1">&#39;charge2&#39;</span><span class="p">,</span> <span class="s1">&#39;fitTime1&#39;</span><span class="p">,</span> <span class="s1">&#39;fitTime2&#39;</span><span class="p">]</span>
                <span class="c1">#attrs = {&#39;PhaseCavity_&#39;+attr: attr for attr in attrs}</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
                <span class="n">dets</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;PhaseCavity&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}})</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#detector = self._detectors.get(det)</span>
                    <span class="k">while</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span> <span class="ow">and</span> <span class="n">ievt</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span><span class="n">nevents</span><span class="p">]):</span>
                        <span class="n">evt</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ievt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">auto_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="s1">&#39;_update_xarray_info&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">detector</span><span class="o">.</span><span class="n">_update_xarray_info</span><span class="p">()</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="n">info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span>
                    <span class="n">attr_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,{})</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">attrs1d</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ignore_attrs</span><span class="p">:</span>
                            <span class="c1">#ignore some attrs, e.g., timestamp</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                                <span class="n">attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">add_1d</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
                                <span class="n">nch</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                                <span class="n">attrs1d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                                <span class="n">data1d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nevents</span><span class="p">,</span> <span class="n">nch</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cannot add </span><span class="si">{:}</span><span class="s1">, </span><span class="si">{:}</span><span class="s1"> -- </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">add_counts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;corr&#39;</span> <span class="ow">in</span> <span class="n">detector</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                        <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                                <span class="n">attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">dets</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">attrs1d</span><span class="p">:</span>
                        <span class="n">dets1d</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">attrs1d</span><span class="p">}</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cannot add </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
    
    <span class="n">nupdate</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">time_last</span> <span class="o">=</span> <span class="n">time0</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading Scalar: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dets</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">add_1d</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading 1D: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dets1d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>       
        <span class="c1"># Skip events without event code with are only controls cameras </span>
        <span class="c1"># nevents in ds does not include controls cameras</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># break at nevents </span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nevents</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Breaking event loop at event </span><span class="si">{:}</span><span class="s1"> with more events available in DataSource&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nupdate</span> <span class="o">==</span> <span class="n">nupdate</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dtime</span> <span class="o">=</span> <span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8}</span><span class="s1"> of </span><span class="si">{:8}</span><span class="s1"> -- </span><span class="si">{:8.3f}</span><span class="s1"> sec, </span><span class="si">{:8.3f}</span><span class="s1"> events/sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
                    <span class="n">nevents</span><span class="p">,</span> <span class="n">time_next</span><span class="o">-</span><span class="n">time0</span><span class="p">,</span> <span class="n">nupdate</span><span class="o">/</span><span class="n">dtime</span><span class="p">))</span>
            <span class="n">time_last</span> <span class="o">=</span> <span class="n">time_next</span> 

        <span class="c1"># add step</span>
        <span class="n">istep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istep</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">istep</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nupdate</span> <span class="o">==</span> <span class="n">nupdate</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">istep</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

        <span class="c1"># add eventCodes</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes_strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">cnames</span><span class="p">[</span><span class="n">code</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>

        <span class="c1"># add detectors present</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">:</span> 
            <span class="n">data</span><span class="p">[</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_present&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">add_dets</span><span class="p">:</span>
            <span class="c1"># Add detector attribute scalar data</span>
            <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;EventId&#39;</span> <span class="ow">or</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                    <span class="n">detector</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="k">if</span> <span class="n">add_1d</span><span class="p">:</span>
                <span class="c1"># optionally add detector scalar data</span>
                <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">dets1d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                        <span class="n">detector</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">data1d</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                                
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">})</span>
    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">nsec</span><span class="p">)]</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expNum</span>
    <span class="c1"># add attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">detector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
        <span class="c1"># get next event with detector in event</span>
        <span class="c1"># needed when controls cameras and/or groups present</span>
        <span class="k">if</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EventId&#39;</span><span class="p">,</span> <span class="s1">&#39;Evr&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">detector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot load attributes for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_source_info</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">source_info</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_present&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source_info</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="s1">&#39;EventId&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">detector</span><span class="o">.</span><span class="n">_update_xarray_info</span><span class="p">()</span>
            <span class="n">det_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source_info</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">det_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">([],(),{},))</span>
                <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Error updating scalar data for </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
    <span class="c1"># add 1d</span>
    <span class="k">if</span> <span class="n">add_1d</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dets1d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">detector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">_update_xarray_info</span><span class="p">()</span>
                <span class="n">det_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">det_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">([],(),{},))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">data1d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">attrs</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">det</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Error updating 1D data for </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">cnames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ec_doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ec_doc</span><span class="p">:</span>
                <span class="n">ec_doc</span> <span class="o">=</span> <span class="s1">&#39;event code for &#39;</span><span class="o">+</span><span class="n">ec_doc</span>
            <span class="n">x</span><span class="p">[</span><span class="n">ec</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ec_doc</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add doc for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ignore_unused_codes</span><span class="p">:</span>
        <span class="n">drop_codes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">cnames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="n">drop_code</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="n">ec</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">drop_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_codes</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropping unused eventCodes: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop_codes</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;ec162&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">set_delta_beam</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">drop_code</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">drop_attr</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ec162</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray Off for events with ec162&#39;</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ec162</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Xray On for events without ec162&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_smd.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">clean_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="c1">#self.x.to_netcdf(os.path.join(path,filename), engine=&#39;h5netcdf&#39;, invalid_netcdf=True)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot save to </span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">xsum</span> <span class="o">=</span> <span class="n">to_summary</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">fsumname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;_sum.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">xsum</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">fsumname</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot make smd sum file&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span></div>

<div class="viewcode-block" id="rawsum"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.rawsum.html#PyDataSource.beam_stats.rawsum">[docs]</a><span class="k">def</span> <span class="nf">rawsum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return raw sum of AreaDetector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span></div>

<div class="viewcode-block" id="count"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.count.html#PyDataSource.beam_stats.count">[docs]</a><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pedestal corrected count of AreaDetector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span></div>

<div class="viewcode-block" id="sector"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.sector.html#PyDataSource.beam_stats.sector">[docs]</a><span class="k">def</span> <span class="nf">sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return calib mean of each AreaDetector sector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="sectors"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.sectors.html#PyDataSource.beam_stats.sectors">[docs]</a><span class="k">def</span> <span class="nf">sectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return calib mean of each AreaDetector sector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">isector</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">isector</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span></div>

<div class="viewcode-block" id="wave8_height"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.wave8_height.html#PyDataSource.beam_stats.wave8_height">[docs]</a><span class="k">def</span> <span class="nf">wave8_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkrange</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span><span class="mi">600</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Peaks of 8 waveforms with background subtration from mean within bkrange.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">wfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">data_u32</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">data_u16</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">wf</span><span class="p">[</span><span class="n">bkrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bkrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">wf</span><span class="o">+</span><span class="n">back</span>
        <span class="n">wfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">wf</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span></div>

<div class="viewcode-block" id="peak_height"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.peak_height.html#PyDataSource.beam_stats.peak_height">[docs]</a><span class="k">def</span> <span class="nf">peak_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Max value of each waveform for WFDetector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;waveform&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveform</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">waveform</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="peak_time"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.peak_time.html#PyDataSource.beam_stats.peak_time">[docs]</a><span class="k">def</span> <span class="nf">peak_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Time of max of each waveform for WFDetector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wftime</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">ch</span><span class="p">,</span><span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveform</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))])</span></div>

<div class="viewcode-block" id="amplitudes"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.amplitudes.html#PyDataSource.beam_stats.amplitudes">[docs]</a><span class="k">def</span> <span class="nf">amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an array of max values of a set of waveforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">filtered</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="filtered"><a class="viewcode-back" href="../../generated/PyDataSource.beam_stats.filtered.html#PyDataSource.beam_stats.filtered">[docs]</a><span class="k">def</span> <span class="nf">filtered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_width</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns filtered waveform for WFDetector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">waveform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waveform</span>
    <span class="n">af</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hw</span> <span class="o">=</span> <span class="n">signal_width</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">afilter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">hw</span><span class="p">)])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">hw</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">nch</span> <span class="o">=</span> <span class="n">waveform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ich</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nch</span><span class="p">):</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">waveform</span><span class="p">[</span><span class="n">ich</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">afilter</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">afilter</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">afilter</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">af</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">hw</span><span class="p">:</span><span class="n">wf</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">hw</span><span class="p">])</span>
    
    <span class="k">return</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">af</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">save_exp_stats</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">find_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save drop stats summaries for all runs </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">find_beam_correlations</span>
    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">clean_dataset</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run*_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;drop_stats&#39;</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>                                      
        <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">run</span>
            <span class="n">save_file</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="s1">&#39;drop_sum&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">save_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">find_corr</span> <span class="ow">and</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">save_file</span><span class="p">):</span>
                <span class="n">xstats</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
                <span class="n">xout</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="n">xstats</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">xstats</span>
                <span class="k">for</span> <span class="n">avar</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">avar</span> <span class="ow">in</span> <span class="n">xout</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">]:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">avar</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                <span class="n">xout</span><span class="p">[</span><span class="n">avar</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> 
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add attrs for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avar</span><span class="p">))</span>
                
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unicode</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">xout</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add attrs for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

                
                <span class="n">xout</span> <span class="o">=</span> <span class="n">clean_dataset</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                <span class="c1">#xout.to_netcdf(save_file, engine=&#39;h5netcdf&#39;, invalid_netcdf=True)</span>
                <span class="n">xout</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">xout</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="n">x</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">x</span>
                <span class="n">xstats</span> <span class="o">=</span> <span class="n">find_beam_correlations</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="n">save_file</span><span class="p">)</span>
                <span class="c1">#xout.to_netcdf(f, engine=&#39;h5netcdf&#39;, invalid_netcdf=True)</span>
                <span class="n">xout</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
           
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot do </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">load_exp_sum</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>