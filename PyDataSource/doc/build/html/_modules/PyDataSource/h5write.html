

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.h5write &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.h5write</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.h5write</h1><div class="highlight"><pre>
<span></span><span class="c1"># standard python modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="o">*</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DEVELOPMENT MODULE:  Direct write to_hdf5 to be xarray compatible without using xarray.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#from pylab import *</span>

<span class="k">def</span> <span class="nf">runlist_to_str</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="n">portable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert list of runs to string representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">portable</span><span class="p">:</span>
        <span class="n">strmulti</span><span class="o">=</span><span class="s1">&#39;-&#39;</span>
        <span class="n">strsingle</span><span class="o">=</span><span class="s1">&#39;_&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strmulti</span><span class="o">=</span><span class="s1">&#39;:&#39;</span>
        <span class="n">strsingle</span><span class="o">=</span><span class="s1">&#39;,&#39;</span>

    <span class="n">runs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">runs</span><span class="p">)))</span>
    <span class="n">runsteps</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">runs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">runstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">runsteps</span><span class="p">)):</span>    
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">runsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">grouped_runs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grouped_runs</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">runsteps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strsingle</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">runsteps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grouped_runs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">runsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strmulti</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strmulti</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">strsingle</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">:</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strsingle</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">runsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped_runs</span><span class="p">:</span>
                    <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strsingle</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="n">grouped_runs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">grouped_runs</span><span class="p">:</span>
                    <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strmulti</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">runstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strsingle</span><span class="p">,</span><span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="n">grouped_runs</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">runstr</span>

<span class="k">def</span> <span class="nf">runstr_to_array</span><span class="p">(</span><span class="n">runstr</span><span class="p">,</span> <span class="n">portable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert run string to list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">portable</span><span class="p">:</span>
        <span class="n">strmulti</span><span class="o">=</span><span class="s1">&#39;-&#39;</span>
        <span class="n">strsingle</span><span class="o">=</span><span class="s1">&#39;_&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strmulti</span><span class="o">=</span><span class="s1">&#39;:&#39;</span>
        <span class="n">strsingle</span><span class="o">=</span><span class="s1">&#39;,&#39;</span>
    
    <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">runstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">strsingle</span><span class="p">):</span>
        <span class="n">runrange</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">strmulti</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">runrange</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">runrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">runrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">runrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">runs</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">read_netcdfs</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> 
        <span class="n">make_cuts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">transform_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read netcdf files and return concatenated xarray Dataset object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : str or list</span>
<span class="sd">        File name(s) which may have &#39;*&#39; and &#39;?&#39; to be used for matching</span>
<span class="sd">    dim : str</span>
<span class="sd">        Diminsion along which to concatenate Dataset objects</span>
<span class="sd">        Default = &#39;time&#39;</span>
<span class="sd">    transform_func : object</span>
<span class="sd">        Method to transform each Dataset before concatenating</span>
<span class="sd">    engine : str</span>
<span class="sd">        Engine for loading files.  default = &#39;h5netcdf&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="k">def</span> <span class="nf">process_one_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># use a context manager, to ensure the file gets closed after use</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;nevents&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nevents</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="nb">print</span> <span class="s1">&#39;cannot select&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nevents</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sec</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">nsec</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
            <span class="c1"># transform_func should do some sort of selection or</span>
            <span class="c1"># aggregation</span>
            <span class="k">if</span> <span class="n">transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">transform_func</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="c1"># load all data from the transformed dataset, to ensure we can</span>
            <span class="c1"># use it after closing each original file</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ds</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xattrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xo</span> <span class="o">=</span> <span class="n">process_one_path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">):</span>
                <span class="n">xattrs</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot open </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
   
    <span class="c1">#try:</span>
    <span class="c1">#    x = resort(xr.concat(datasets, dim))</span>
    <span class="c1">#except:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xattrs</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">xattrs</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;present&#39;</span><span class="p">)])</span> 
    
    <span class="k">if</span> <span class="s1">&#39;ichunk&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ichunk&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span>

    <span class="k">if</span> <span class="n">make_cuts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">make_default_cuts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot make default cuts&#39;</span>

    <span class="k">return</span> <span class="n">x</span> 

<span class="c1">#ds = PyDataSource.DataSource(&#39;exp=cxij4915:run=49:smd&#39;)</span>
<div class="viewcode-block" id="open_h5netcdf"><a class="viewcode-back" href="../../generated/PyDataSource.open_h5netcdf.html#PyDataSource.open_h5netcdf">[docs]</a><span class="k">def</span> <span class="nf">open_h5netcdf</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open hdf5 file with netcdf4 convention using builtin xarray engine h5netcdf.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">h5folder</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>
  
    <span class="k">if</span> <span class="n">exp</span> <span class="ow">and</span> <span class="n">run</span> <span class="ow">and</span> <span class="n">run</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">psutils</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">psutils</span><span class="o">.</span><span class="n">get_run_from_id</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">combine</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">chunk</span> <span class="ow">and</span> <span class="n">run</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_base</span><span class="p">:</span>
                <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                    <span class="n">file_base</span> <span class="o">+=</span> <span class="s1">&#39;_sum&#39;</span>

            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">file_base</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">combine</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_base</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">file_base</span><span class="o">+</span><span class="s1">&#39;_*.nc&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">read_netcdfs</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">make_cuts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
 
    <span class="k">elif</span> <span class="n">chunk</span> <span class="ow">and</span> <span class="n">run</span><span class="p">:</span>
        <span class="n">file_names</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_c*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">read_netcdfs</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">make_cuts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">glob</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
            <span class="n">xo</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">))</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ichunk&#39;</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="to_h5netcdf"><a class="viewcode-back" href="../../generated/PyDataSource.to_h5netcdf.html#PyDataSource.to_h5netcdf">[docs]</a><span class="k">def</span> <span class="nf">to_h5netcdf</span><span class="p">(</span><span class="n">xdat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write hdf5 file with netcdf4 convention using builtin xarray engine h5netcdf.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xdat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xdat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;DataSource&#39;</span><span class="p">:</span>
            <span class="c1"># 1st arg is actually PyDataSource.DataSource</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xdat</span>
            <span class="n">xdat</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">xdat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">PyDataSource</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">xdat</span> <span class="o">=</span> <span class="n">to_xarray</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="n">xdat</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ichunk&#39;</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_c</span><span class="si">{:03}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">run</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">xdat</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ichunk&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add in sets for mulit run</span>
            <span class="n">file_base</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_base&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_base</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">run</span>
                    <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_sum&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
                
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">file_base</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span><span class="p">)</span>
    
    <span class="n">xdat</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xdat</span></div>

<span class="k">def</span> <span class="nf">process_one_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">transform_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load one file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="c1"># use a context manager, to ensure the file gets closed after use</span>
    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;nevents&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nevents</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;cannot select&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nevents</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sec</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">ds</span><span class="o">.</span><span class="n">nsec</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
        
        <span class="c1"># transform_func should do some sort of selection or</span>
        <span class="c1"># aggregation</span>
        <span class="k">if</span> <span class="n">transform_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">transform_func</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="c1"># load all data from the transformed dataset, to ensure we can</span>
        <span class="c1"># use it after closing each original file</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ds</span>

<span class="k">def</span> <span class="nf">merge_datasets</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> 
            <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
        <span class="c1">#det = file_name.split(&#39;/run&#39;)[1].split(&#39;_&#39;)[2].split(&#39;.&#39;)[0]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="n">file_name</span>
            <span class="n">xo</span> <span class="o">=</span> <span class="n">process_one_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
            <span class="c1">#skip files with no data</span>
            <span class="k">if</span> <span class="n">xo</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">det</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">det</span><span class="p">:</span>
                    <span class="n">det</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xattrs</span><span class="p">:</span>
                    <span class="n">xattrs</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span>

                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
                <span class="c1">#if file_name == min(paths, key=len):</span>
                <span class="c1">#    xattrs = xo.attrs</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot open </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="c1">#return xo, xattrs </span>
    
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Error merging... try omitting stats&#39;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">xo</span> <span class="k">for</span> <span class="n">xo</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;base&#39;</span> <span class="ow">in</span> <span class="n">xattrs</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">xattrs</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">save_file</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Saving&#39;</span><span class="p">,</span> <span class="n">save_file</span>
        <span class="n">x</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">xattrs</span>

<span class="k">def</span> <span class="nf">merge_stats</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span>
        <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read netcdf chunked stats </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dim : str</span>
<span class="sd">        Diminsion along which to merge stats files</span>
<span class="sd">        Default = &#39;steps&#39;</span>
<span class="sd">    engine : str</span>
<span class="sd">        Engine for loading files.  default = &#39;h5netcdf&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;run must be provided&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;exp must be provided&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/Run</span><span class="si">{:04}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> 
                <span class="n">exp</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_*stats.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">xdata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Loading stats </span><span class="si">{:}</span><span class="s1"> of </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">xdat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
       
        <span class="n">steps</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
                <span class="n">dattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">dim</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">()]</span>
                <span class="k">if</span> <span class="n">dattrs</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dattrs</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">:</span>
                    <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># make sure each has the same event codes</span>
                    <span class="k">if</span> <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                        <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">])</span>

                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">values</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">istats</span> <span class="o">=</span> <span class="p">{</span><span class="n">stat</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">stats</span><span class="p">))}</span>
                        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
                        <span class="k">if</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">istats</span><span class="p">[</span><span class="n">stat</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                                            <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
                        <span class="k">if</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">istats</span><span class="p">[</span><span class="n">stat</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                                            <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;var&#39;</span>
                        <span class="k">if</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                            <span class="n">xvar</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">svar</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">istats</span><span class="p">[</span><span class="n">stat</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">xvar</span><span class="o">+</span><span class="mf">1.</span><span class="o">/</span><span class="n">svar</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">in</span> <span class="n">stats</span> <span class="ow">and</span> <span class="s1">&#39;std&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                            <span class="n">svar</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span>
                            <span class="n">xvar</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span>
                            <span class="n">smean</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">xmean</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">sxvar</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">xvar</span><span class="o">+</span><span class="mf">1.</span><span class="o">/</span><span class="n">svar</span><span class="p">)</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">istats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmean</span><span class="o">/</span><span class="n">xvar</span><span class="o">+</span><span class="n">smean</span><span class="o">/</span><span class="n">svar</span><span class="p">)</span><span class="o">*</span><span class="n">sxvar</span>
                            <span class="n">item</span><span class="p">[</span><span class="n">istats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sxvar</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">xdata</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">dim</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">read_chunked</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span>
        <span class="n">omit_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ichunk&#39;</span><span class="p">,</span> <span class="s1">&#39;nevents&#39;</span><span class="p">],</span> 
        <span class="n">make_cuts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">transform_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read netcdf files and return concatenated xarray Dataset object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : str or list</span>
<span class="sd">        File name(s) which may have &#39;*&#39; and &#39;?&#39; to be used for matching</span>
<span class="sd">    dim : str</span>
<span class="sd">        Diminsion along which to concatenate Dataset objects</span>
<span class="sd">        Default = &#39;time&#39;</span>
<span class="sd">    transform_func : object</span>
<span class="sd">        Method to transform each Dataset before concatenating</span>
<span class="sd">    engine : str</span>
<span class="sd">        Engine for loading files.  default = &#39;h5netcdf&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#exp=&#39;cxilr6716&#39;;run=121;dim=&#39;time&#39;;h5folder=&#39;scratch&#39;;subfolder=&#39;nc&#39;;omit_attrs=[&#39;ichunk&#39;, &#39;nevents&#39;];make_cuts=True;merge=False;quiet=False;save=False;save_path=None;cleanup=False;transform_func=None</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;run must be provided&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;exp must be provided&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/Run</span><span class="si">{:04}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> 
                <span class="n">exp</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="s1">&#39;File does not exist: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;stats.nc&#39;</span><span class="p">)]</span>
    <span class="c1">#dets = set([a.lstrip(&#39;{:}/run{:04}_&#39;.format(path,run)).split(&#39;_&#39;)[1].split(&#39;.&#39;)[0] for a in files])</span>
    <span class="n">datachunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">run</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
    <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">axattrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">merge_chunk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">//run</span><span class="si">{:04}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">run</span><span class="p">,</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">merge</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;Loading chunk&#39;</span><span class="p">,</span> <span class="n">chunk</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">process_one_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">merge_chunk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merge_chunk</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">merge</span> <span class="ow">or</span> <span class="n">merge_chunk</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Merging chunk&#39;</span><span class="p">,</span> <span class="n">chunk</span>
            <span class="n">file_names</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">//run</span><span class="si">{:04}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">_*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">run</span><span class="p">,</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;stats.nc&#39;</span><span class="p">)]</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">//run</span><span class="si">{:04}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">run</span><span class="p">,</span><span class="n">chunk</span><span class="p">)</span>
            <span class="c1">#x = merge_datasets(file_names, save_file=save_file, quiet=quiet)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">cxattrs</span> <span class="o">=</span> <span class="n">merge_datasets</span><span class="p">(</span><span class="n">file_names</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
            <span class="n">axattrs</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">cxattrs</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">datachunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xattrs</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">xchunk</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Concat all chunks&#39;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">datachunks</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Concat Failed&#39;</span>
            <span class="k">return</span> <span class="n">datachunks</span>

        <span class="k">if</span> <span class="n">xattrs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">xattrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;Cannot add run attrs&#39;</span>
                <span class="nb">print</span> <span class="n">xattrs</span>

    <span class="k">try</span><span class="p">:</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;present&#39;</span><span class="p">)])</span> 
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">nsteps</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nsteps&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#    steps = set([x.step.values])</span>
<span class="c1">#    if &#39;steps&#39; not in x:</span>
<span class="c1">#        x.coords[&#39;steps&#39;] = steps</span>

<span class="c1">#    if nsteps &gt; 1:</span>
<span class="c1">#        uniq_attrs = {}</span>
<span class="c1">#        for det, a in xattrs.items():</span>
<span class="c1">#            for attr, item in a.items():</span>
<span class="c1">#                try:</span>
<span class="c1">#                    vals = set(item.values())</span>
<span class="c1">#                    if len(vals) &gt; 1 and attr not in omit_attrs:</span>
<span class="c1">#                        if det not in uniq_attrs:</span>
<span class="c1">#                            uniq_attrs[det] = {}</span>
<span class="c1">#                        uniq_attrs[det][attr] = item.values()</span>
<span class="c1">#                except:</span>
<span class="c1">#                    pass</span>
        
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">omit_attrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">make_cuts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">make_default_cuts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot make default cuts&#39;</span>

    <span class="nb">print</span> <span class="s1">&#39;... merge stats chunks&#39;</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">path</span>
    <span class="n">xstats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xstats</span> <span class="o">=</span> <span class="n">merge_stats</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot merge stats chunks&#39;</span>
        <span class="n">cleanup</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">xstats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;... merge stats with event data&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xstats</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot merge stats into overall run Dataset&#39;</span>
            <span class="n">cleanup</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Saving data&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="n">save</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">save_path</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">//run</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Saving Run </span><span class="si">{:}</span><span class="s1"> to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span> 
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_*.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">))</span> 
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>          
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;Cleanup failed:  Could not delete files </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Write Failed to </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">to_hdf5_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="s1">&#39;basic&#39;</span><span class="p">,</span> 
            <span class="n">default_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MPI wrapper for write_hdf5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">h5netcdf</span>
        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;xarray package not available. Use for example conda environment with &quot;source conda_setup&quot;&#39;</span><span class="p">)</span>

    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span>  <span class="c1"># The process ID (integer 0-3 for 4-process run)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

    <span class="n">path</span><span class="p">,</span> <span class="n">file_base</span> <span class="o">=</span> <span class="n">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Free up memory for mpi DataSource objects after writing stats to h5 at end of write_hdf5</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reset_stats ...&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s1">&#39;, mpi time&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">file_base</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
        <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">read_chunked</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Could not read files&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_base</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">build_html</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">PyDataSource</span> <span class="k">import</span> <span class="n">Build_html</span>    
                <span class="k">if</span> <span class="n">build_html</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;Could not build html run summary for&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="n">MPI</span><span class="o">.</span><span class="n">Finalize</span><span class="p">()</span>
    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span>
    <span class="n">nevents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;*** Total time </span><span class="si">{:8.1f}</span><span class="s1"> sec for </span><span class="si">{:}</span><span class="s1"> events -- </span><span class="si">{:8.1f}</span><span class="s1"> events/sec using </span><span class="si">{:}</span><span class="s1"> cores ***&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_time</span><span class="p">,</span> <span class="n">nevents</span><span class="p">,</span> <span class="n">nevents</span><span class="o">/</span><span class="n">total_time</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> 

<div class="viewcode-block" id="to_hdf5"><a class="viewcode-back" href="../../generated/PyDataSource.to_hdf5.html#PyDataSource.to_hdf5">[docs]</a><span class="k">def</span> <span class="nf">to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write PyDataSource.DataSource to hdf5 file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">file_base</span> <span class="o">=</span> <span class="n">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
<span class="c1">#    x = open_h5netcdf(path=path, file_base=file_base, combine=True) </span>
<span class="c1">#    file_name = os.path.join(path,file_base+&#39;_*.nc&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">read_chunked</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Could not read files&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_base</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">x</span></div>

<span class="k">def</span> <span class="nf">get_config_xarray</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">no_create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get xarray run config.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="k">if</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span> 
    
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">exp_dir</span> <span class="o">=</span> <span class="s2">&quot;/reg/d/psdm/</span><span class="si">{:}</span><span class="s2">/</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h5folder</span> <span class="ow">is</span> <span class="s1">&#39;results&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">h5folder</span><span class="p">)):</span> 
                <span class="n">h5folder0</span> <span class="o">=</span> <span class="n">h5folder</span>
                <span class="n">h5folder</span> <span class="o">=</span> <span class="s1">&#39;res&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">h5folder</span><span class="p">)):</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expdir</span><span class="p">,</span> <span class="n">h5folder0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; does not exist!&#39;</span><span class="p">)</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="n">subfolder</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
        <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">))</span>

    <span class="nb">print</span> <span class="n">file_name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">no_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reload</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">reload</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">PyDataSource</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
        <span class="n">write_hdf5</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">file_base</span><span class="o">=</span><span class="n">file_base</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">no_events</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39;Need to create&#39;</span>
    
    <span class="n">x</span><span class="o">=</span> <span class="n">process_one_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">to_summary</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>

<span class="c1"># Need to add in &#39;chunking based on steps&#39;</span>
<span class="k">def</span> <span class="nf">write_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nevents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">10001</span><span class="p">,</span> 
        <span class="n">aliases</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span>
        <span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">store_data</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">chunk_steps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ichunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nchunks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1">#code_flags={&#39;XrayOff&#39;: [162], &#39;XrayOn&#39;: [-162], &#39;LaserOn&#39;: [183, -162], &#39;LaserOff&#39;: [184, -162]},</span>
        <span class="n">code_flags</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">162</span><span class="p">],</span> <span class="s1">&#39;XrayOn&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">162</span><span class="p">]},</span>
        <span class="n">drop_unused_codes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pvs</span><span class="o">=</span><span class="p">[],</span> <span class="n">epics_attrs</span><span class="o">=</span><span class="p">[],</span> 
        <span class="n">eventCodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  
        <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">mpi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mpio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">no_events</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">min_all_save</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">auto_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">auto_pvs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write directly to hdf5 with h5netcdf package.  </span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    max_size : uint</span>
<span class="sd">        Maximum array size of data objects to build into xarray.</span>
<span class="sd">    ichunk: int</span>
<span class="sd">        chunk index (skip ahead nevents*ichunk)</span>
<span class="sd">    pvs: list</span>
<span class="sd">        List of pvs to be loaded vs time</span>
<span class="sd">    epics_attrs: list</span>
<span class="sd">        List of epics pvs to be saved as run attributes based on inital value </span>
<span class="sd">        of first event.</span>
<span class="sd">    code_flags : dict</span>
<span class="sd">        Dictionary of event code flags. </span>
<span class="sd">        Default = {&#39;XrayOff&#39;: [162], &#39;XrayOn&#39;: [-162]}</span>
<span class="sd">    eventCodes : list</span>
<span class="sd">        List of event codes </span>
<span class="sd">        Default is all event codes in DataSource</span>
<span class="sd">    drop_unused_codes : bool</span>
<span class="sd">        If true drop unused eventCodes [default=True]</span>
<span class="sd">    min_all_save : int</span>
<span class="sd">        Min number of events where all &#39;calib&#39; data saved.  Sets max_size = 1e10</span>
<span class="sd">    default_stats : bool</span>
<span class="sd">        If true automatically add default stats for all waveforms and area detector calib </span>
<span class="sd">        image data that do not already have stats added</span>
<span class="sd">    auto_update : bool</span>
<span class="sd">        If true automatically update xarray info for all detectors</span>
<span class="sd">    auto_pvs : bool</span>
<span class="sd">        If true automatically add pvs that were moved during run.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    import PyDataSource</span>
<span class="sd">    ds = PyDataSource.DataSource(exp=&#39;xpptut15&#39;,run=200)</span>
<span class="sd">    evt = ds.events.next()</span>
<span class="sd">    evt.opal_1.add.projection(&#39;raw&#39;, axis=&#39;x&#39;, roi=((0,300),(400,1024)))</span>
<span class="sd">    evt.cs140_rob.add.roi(&#39;calib&#39;,sensor=1,roi=((104,184),(255,335)))</span>
<span class="sd">    evt.cs140_rob.add.count(&#39;roi&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">h5netcdf</span>
        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;xarray package not available. Use for example conda environment with &quot;source conda_setup&quot;&#39;</span><span class="p">)</span>

    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span>  <span class="c1"># The process ID (integer 0-3 for 4-process run)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span> <span class="ow">and</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ichunk</span><span class="o">=</span><span class="n">rank</span>
   
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="n">size</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">publish</span><span class="p">)</span>
    <span class="n">dtime</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">EventId</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">eventCodes</span><span class="p">:</span>
        <span class="n">eventCodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="s1">&#39;ScanData&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="p">:</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">nsteps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">ievent0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nevents</span><span class="p">:</span>
        <span class="n">nevents_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span>
        <span class="k">if</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># steps and chunks start with 0</span>
            <span class="k">if</span> <span class="n">chunk_steps</span> <span class="ow">and</span> <span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">istep</span> <span class="o">=</span> <span class="n">ichunk</span>
                <span class="n">ievent_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_start&#39;</span><span class="p">][</span><span class="n">istep</span><span class="p">]</span>
                <span class="n">ievent_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_end&#39;</span><span class="p">][</span><span class="n">istep</span><span class="p">]</span>
                <span class="n">nevents</span> <span class="o">=</span> <span class="n">ievent_end</span><span class="o">-</span><span class="n">ievent_start</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">ievent0</span> <span class="o">=</span> <span class="n">ievent_start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nevents</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nchunks</span><span class="p">)))</span>
                <span class="n">ievent0</span> <span class="o">=</span> <span class="n">ichunk</span><span class="o">*</span><span class="n">nevents</span>
            
            <span class="nb">print</span> <span class="s1">&#39;Do </span><span class="si">{:}</span><span class="s1"> of </span><span class="si">{:}</span><span class="s1"> events startine with </span><span class="si">{:}</span><span class="s1"> for chunk </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nevents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">,</span> <span class="n">ievent0</span><span class="p">,</span> <span class="n">ichunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nevents</span> <span class="o">=</span> <span class="n">nevents_total</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nevents_total</span> <span class="o">=</span> <span class="n">nevents</span>
        <span class="k">if</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nevents</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nevents_total</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nchunks</span><span class="p">)))</span>
            <span class="n">ievent0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ichunk</span><span class="p">)</span><span class="o">*</span><span class="n">nevents</span>

    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">no_events</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/Run</span><span class="si">{:04}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s1">&#39;INFO: directory was already created by another thread </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span> <span class="s1">&#39;ERROR making </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_base</span><span class="p">:</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_c</span><span class="si">{:03}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">ichunk</span><span class="p">)</span>

    <span class="n">adat</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">axdat</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">axfuncs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">atimes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#btimes = []</span>
    <span class="n">xcoords</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">axcoords</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">no_events</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">))</span>
        <span class="n">xbase</span> <span class="o">=</span> <span class="n">h5netcdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">invalid_netcdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="n">nevents_total</span>
    <span class="k">elif</span> <span class="n">mpio</span><span class="p">:</span> 
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">))</span>
        <span class="n">xbase</span> <span class="o">=</span> <span class="n">h5netcdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">invalid_netcdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="n">nevents_total</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="n">ichunk</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">))</span>
        <span class="n">xbase</span> <span class="o">=</span> <span class="n">h5netcdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">invalid_netcdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="n">nevents</span>

    <span class="n">xbase</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntime</span>
    <span class="c1">#xbase = h5netcdf.File(file_name, &#39;w&#39;, invalid_netcdf=True)</span>

    <span class="n">neventCodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventCodes</span><span class="p">)</span>


    <span class="c1"># Experiment Attributes</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;expNum&#39;</span><span class="p">,</span> <span class="s1">&#39;calibDir&#39;</span><span class="p">]:</span>
        <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    
    <span class="n">ttypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sec&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;nsec&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;fiducials&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;int32&#39;</span><span class="p">}</span>
    
    <span class="c1"># explicitly order EventId coords in desired order </span>
    <span class="k">if</span> <span class="n">ichunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Begin processing </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nevents</span><span class="p">)</span>
 
    <span class="n">cattrs</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cattrs</span><span class="p">:</span>
        <span class="n">xcoords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">int</span><span class="p">)</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cattrs</span><span class="p">)</span>

    <span class="c1"># Event Codes -- earlier bool was not supported but now is. </span>
    <span class="c1">#if not no_events:</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Event Code present for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">code_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Event code flag: True if all positive and no negative &quot;codes&quot; are in eventCodes&#39;</span>
        <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ec</span>
        <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;event_flags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_flags</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
   
    <span class="c1"># eventCode Timestamp information</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventCodes</span><span class="p">)</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">,),</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">eventCodes</span>
    <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Event Codes&#39;</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;timestampHigh&#39;</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">,),</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Timestamp High Value for eventCodes&#39;</span>
    <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;timestampLow&#39;</span>
    <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">,),</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Timestamp Low Value for eventCodes&#39;</span>
    <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
   
    <span class="c1"># add epics pvs expected to change during run</span>
   
    <span class="c1">#xbase.create_variable(&#39;steps&#39;, (&#39;isteps&#39;), data=range(nsteps))</span>
    <span class="c1">#xbase.create_variable(&#39;codes&#39;, (&#39;icodes&#39;), data=eventCodes)</span>
 
    <span class="c1"># Scan Attributes -- cxbase.create_variable(&#39;codes&#39;, data=eventCodes)annot put None or dicts as attrs in netcdf4</span>
    <span class="c1"># e.g., pvAliases is a dict</span>

    <span class="c1"># build epics_pvs from input list of aliases and from exp_summary epicsArchive scan detection </span>
    <span class="n">epics_pvs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scan_variables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attr_lookup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">auto_pvs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">exp_summary</span>
            <span class="n">pv_attrs</span> <span class="o">=</span> <span class="n">exp_summary</span><span class="o">.</span><span class="n">get_pv_attrs</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="n">pv_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">):</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pv_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">aliases</span><span class="p">():</span>
                    <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">pvName</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">epics_pvs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="n">pv_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">{})}</span>

            <span class="n">scan_pvs</span> <span class="o">=</span> <span class="n">exp_summary</span><span class="o">.</span><span class="n">get_scan_pvs</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s1">&#39;scan_pvs&#39;</span><span class="p">,</span> <span class="n">scan_pvs</span>
            <span class="k">if</span> <span class="n">scan_pvs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">scan_pvs</span><span class="p">:</span>
                    <span class="n">pvattrs</span> <span class="o">=</span> <span class="n">pv_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">pvbase</span> <span class="o">=</span> <span class="n">pvattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pvbase</span><span class="p">:</span>
                        <span class="n">scan_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                        <span class="n">pvdict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">pv</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="n">pvattrs</span><span class="p">}</span> \
                                    <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">pvNames</span><span class="p">()</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pvbase</span><span class="p">)}</span>
                        <span class="n">epics_pvs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">pvdict</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Could not auto load epics pvs moved during run&#39;</span> 
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
     
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="s1">&#39;ScanData&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="p">:</span>
        <span class="n">pvMonitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">pvMonitors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pvMonitors</span><span class="p">:</span>
            <span class="n">pvMonitors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.RBV&#39;</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">pvControls</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvMonitors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">pvAliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                    <span class="n">epics_pvs</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="n">attr_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="p">{})}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Could not add pvMonitor&#39;</span><span class="p">,</span> <span class="n">pv</span>

    <span class="n">apvControls</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="s1">&#39;ScanData&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">apvControls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">control_values</span>
            <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">control_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">pvAliases</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span>
                <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">_control&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="n">scan_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_control&#39;</span><span class="p">)</span>
                <span class="n">apvControls</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_control&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span> 
                <span class="n">apvControls</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">,</span> 
                                                 <span class="s1">&#39;step_values&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="p">,</span> 
                                                 <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;daq pvControls values for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pv</span><span class="p">)})</span>

    <span class="n">axpvs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">epics_pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">)</span>
            <span class="n">axpvs</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">axpvs</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,{}))</span>
            <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Failed to add epics PV&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span> <span class="n">attr</span>

    <span class="n">base_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>
    <span class="n">scan_variables</span> <span class="o">=</span> <span class="n">epics_pvs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
    <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_variables</span>
  
    <span class="k">for</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">src_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">det0</span> <span class="o">=</span> <span class="n">src_info</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>
            <span class="n">det</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det0</span><span class="p">,</span> <span class="n">det0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ichunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;configuring&#39;</span><span class="p">,</span> <span class="n">det</span>
            <span class="n">nmaxevents</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">ievt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span> <span class="ow">and</span> <span class="n">ievt</span> <span class="o">&lt;</span> <span class="n">nmaxevents</span><span class="p">:</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">publish</span><span class="p">)</span>
                <span class="n">ievt</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="n">detector</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span><span class="n">det0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">auto_update</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="s1">&#39;_update_xarray_info&#39;</span><span class="p">):</span>
                    <span class="n">detector</span><span class="o">.</span><span class="n">_update_xarray_info</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;Error updating xarray info for &#39;</span><span class="p">,</span> <span class="n">det0</span>
                <span class="k">continue</span>

            <span class="n">config_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># make sure not objects -- should be moved into PyDataSoruce</span>
            <span class="k">for</span> <span class="n">config_attr</span><span class="p">,</span> <span class="n">config_item</span> <span class="ow">in</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config_item</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
                    <span class="n">config_info</span><span class="p">[</span><span class="n">config_attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">config_info</span><span class="p">[</span><span class="n">config_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_item</span>

<span class="c1">#            if attrs:</span>
<span class="c1">#                axdat[det].coords[det+&#39;_config&#39;] = ([det+&#39;_steps&#39;], range(nsteps))</span>
<span class="c1">#                axdat[det].coords[det+&#39;_config&#39;].attrs.update(attrs)</span>

            <span class="n">adat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">axcoords</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1">#det_funcs[det] = {}</span>
            <span class="n">xarray_dims</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">)</span>
            <span class="n">axfuncs</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
            <span class="c1"># Add default attr information.</span>
            <span class="n">src_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">detector</span><span class="o">.</span><span class="n">_source_info</span><span class="p">)</span>
            <span class="c1">#if &#39;src&#39; in src_info:</span>
            <span class="c1">#    src_info[&#39;src&#39;] = str(src_info[&#39;src&#39;])</span>
 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mpio</span><span class="p">:</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="n">det</span><span class="p">))</span>
                        <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5netcdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">invalid_netcdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="n">ichunk</span><span class="p">,</span><span class="n">det</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting </span><span class="si">{:}</span><span class="s1"> file_name = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
                        <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5netcdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">invalid_netcdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error setting file for&#39;</span><span class="p">,</span><span class="n">det</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            
            <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntime</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
<span class="c1">#                axdat[det].attrs.update(**config_info)</span>
                <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">src_info</span><span class="p">)</span>
<span class="c1">#                axdat[det].attrs[&#39;funcs&#39;] = funcs</span>
            
            <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;present&#39;</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
            <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">xbase</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">config_info</span><span class="p">)</span>
            <span class="n">xbase</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">src_info</span><span class="p">)</span>
<span class="c1">#            xbase[alias].attrs[&#39;funcs&#39;] = funcs</span>

<span class="c1">#            if not no_events:</span>
<span class="c1">#                axdat[det].create_variable(alias, (&#39;time&#39;,), bool)</span>
<span class="c1">#                axdat[det][alias].attrs.update(**config_info)</span>
<span class="c1">#                axdat[det][alias].attrs.update(**src_info)</span>
<span class="c1">#                axdat[det][alias].attrs[&#39;funcs&#39;] = funcs</span>
            
            <span class="k">if</span> <span class="n">xarray_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xarray_dims</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="c1"># Only save data with less than max_size total elements</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                    <span class="n">attr_info</span> <span class="o">=</span> <span class="n">src_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

                    <span class="n">attr_info</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                    <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">_tabclass</span> <span class="o">==</span> <span class="s1">&#39;evtData&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">evtData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">infos</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">infos</span><span class="p">:</span>
                                <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">:</span> <span class="n">infos</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">]})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s1">&#39;No data for </span><span class="si">{:}</span><span class="s1"> in </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">detector</span><span class="p">),</span> <span class="n">attr</span><span class="p">)</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">_calib_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">infos</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">infos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
                        
                        <span class="k">elif</span> <span class="n">detector</span><span class="o">.</span><span class="n">detector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">infos</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">infos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span>
                    
                    <span class="c1"># Make sure no None attrs</span>
                    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">aitm</span> <span class="ow">in</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">aitm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">attr_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">aitm</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">aitm</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">):</span>
                                <span class="n">attr_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="nb">print</span> <span class="s1">&#39;Error fixing up attr_info&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">aitm</span>
                            <span class="nb">print</span> <span class="s1">&#39;Setting to empty&#39;</span>
                            <span class="n">attr_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

                    <span class="c1">#det_funcs[det][attr] = {&#39;alias&#39;: alias, &#39;det&#39;: det, &#39;attr&#39;: attr, &#39;attr_info&#39;: attr_info}</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">max_size</span> <span class="ow">or</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">store_data</span> <span class="ow">or</span> <span class="n">min_all_save</span> <span class="o">&gt;=</span> <span class="n">nevents</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="c1">#maxsize = list(item[1])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="c1">#maxsize = [item[1]]</span>
                        <span class="c1">#maxsize.insert(0, None) </span>
                        <span class="n">b</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntime</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">xname</span><span class="p">,</span> <span class="n">xshape</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">xname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                                    <span class="nb">print</span> <span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">xshape</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">a</span>
                                    <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">xname</span><span class="p">]</span> <span class="o">=</span> <span class="n">xshape</span>

                            <span class="n">adat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                            <span class="n">axfuncs</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attr_info</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="nb">print</span> <span class="s1">&#39;Cannot add attrs&#39;</span><span class="p">,</span> <span class="n">attr_info</span>
                            <span class="c1">#det_funcs[det][attr][&#39;event&#39;] = {&#39;dims&#39;: a, &#39;shape&#39;: b}</span>
            
            <span class="n">coordinates</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">]:</span>
                    <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="nb">int</span><span class="p">)</span>
        
            <span class="n">coords</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">_xarray_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">coord</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">attr_info</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                            <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">dim</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="nb">print</span> <span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                                <span class="n">axcoords</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>
                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                                <span class="n">axcoords</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="p">(</span><span class="n">alias</span><span class="p">,),</span> <span class="n">data</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">xbase</span><span class="o">.</span><span class="n">create_variable</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="p">(</span><span class="n">alias</span><span class="p">,),</span> <span class="n">data</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">attr_info</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                                <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attr_info</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">xbase</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attr_info</span><span class="p">)</span>
                        
                        <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">alias</span>
                    
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ichunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span> <span class="s1">&#39;Missing coord&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">item</span>
            
            <span class="c1">#base_coordinates += coordinates</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;ERROR loading&#39;</span><span class="p">,</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">det</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;detector objects: &#39;</span><span class="p">,</span> <span class="n">axdat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
<span class="c1"># Need to fix handling of detector image axis</span>

    <span class="c1">#return xbase, axcoords, axfuncs, axdat, adat</span>

    <span class="k">if</span> <span class="n">default_stats</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Add default stats&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_default_stats</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">ichunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Dataset configured&#39;</span>
    <span class="c1">#return xbase, axdat </span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;funcs&#39;</span>
        <span class="nb">print</span> <span class="n">axfuncs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
    <span class="k">if</span> <span class="kc">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">igood</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">aievt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">aievents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">asteps</span> <span class="o">=</span> <span class="p">[]</span> 

        <span class="c1"># keep track of events for each det</span>
        <span class="k">for</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">srcitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">det0</span> <span class="o">=</span> <span class="n">srcitem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span>
            <span class="n">det</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det0</span><span class="p">,</span> <span class="n">det0</span><span class="p">)</span>
            <span class="n">aievt</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">aievents</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      
        <span class="k">if</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#print &#39;Making chunk {:}&#39;.format(ichunk)</span>
            <span class="c1">#print &#39;Starting with event {:} of {:}&#39;.format(ievent0,self.nevents)</span>
            <span class="c1">#print &#39;Analyzing {:} events&#39;.format(nevents)</span>
            <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ichunk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ichunk</span>
            <span class="c1"># Need to update to jump to event.</span>
            <span class="k">if</span> <span class="n">ichunk</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">chunk_steps</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s1">&#39;skipping ahead to event </span><span class="si">{:}</span><span class="s1"> for chunk </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ievent0</span><span class="p">,</span><span class="n">ichunk</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ievent0</span><span class="p">):</span>
                    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reset_stats ...&#39;</span><span class="p">,</span> <span class="n">ichunk</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>
                
            
                <span class="c1">#print &#39;Previous event before current chunk:&#39;, evt</span>

        <span class="k">if</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evtformat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:10.1f}</span><span class="s1"> sec, Event </span><span class="si">{:}</span><span class="s1"> of </span><span class="si">{:}</span><span class="s1"> in chunk </span><span class="si">{:}</span><span class="s1"> with </span><span class="si">{:}</span><span class="s1"> accepted&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evtformat</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:10.1f}</span><span class="s1"> sec, Event </span><span class="si">{:}</span><span class="s1"> of </span><span class="si">{:}</span><span class="s1"> with </span><span class="si">{:}</span><span class="s1"> accepted&#39;</span>
        
        <span class="c1">#for ievent in range(ds.nevents+1):</span>
        <span class="k">for</span> <span class="n">ievt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nevents</span><span class="p">):</span>
            <span class="n">ievent</span> <span class="o">=</span> <span class="n">ievent0</span><span class="o">+</span><span class="n">ievt</span>
            <span class="k">if</span> <span class="n">ievt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ievt</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ichunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">evtformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">,</span> <span class="n">ievt</span><span class="p">,</span> <span class="n">nevents</span><span class="p">,</span> <span class="n">ichunk</span><span class="p">,</span> <span class="n">igood</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">evtformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">,</span> <span class="n">ievt</span><span class="p">,</span> <span class="n">nevents</span><span class="p">,</span> <span class="n">igood</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ichunk</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">chunk_steps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ievt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># on first event skip to the desired step</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ichunk</span><span class="p">):</span>
                        <span class="n">step_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reset_stats ...&#39;</span><span class="p">,</span> <span class="n">ichunk</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">evt</span> <span class="o">=</span> <span class="n">step_events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">ievent</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#evt = self.events.next(publish=publish, init=publish)</span>
                    <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Note that old data does not have configData eventCodes</span>
            <span class="k">if</span> <span class="n">eventCodes</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eventCodes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
           
            <span class="n">dtime</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">EventId</span>
            <span class="k">if</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">igood</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nevents</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">igood</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">iwrite</span> <span class="o">=</span> <span class="n">igood</span>
            <span class="k">if</span> <span class="n">mpio</span><span class="p">:</span>
                <span class="n">iwrite</span> <span class="o">+=</span> <span class="n">ievent0</span>

            <span class="n">istep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istep</span>
            <span class="n">asteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
            <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">istep</span>
            <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span>
            <span class="c1">#btimes.append(dtime)</span>
            
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">]:</span>
                <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            
            <span class="c1">#for ec in evt.Evr.eventCodes:</span>
            <span class="c1">#for iec, ec in enumerate(evt.Evr.fifoEvents.eventCode):</span>
            <span class="k">for</span> <span class="n">iec</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes_strict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">:</span>
                    <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ec</span><span class="p">)][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> 

            <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;timestampLow&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">timestampLow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">]</span>
            <span class="n">xbase</span><span class="p">[</span><span class="s1">&#39;timestampHigh&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">timestampHigh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">]</span>
<span class="c1">#            fevr = evt.Evr.fifoEvents</span>
<span class="c1">#            thigh = dict(zip(fevr.eventCode, fevr.timestampHigh))</span>
<span class="c1">#            tshigh = [thigh.get(ec,0) for ec in eventCodes]</span>
<span class="c1">#            tlow = dict(zip(fevr.eventCode, fevr.timestampLow))</span>
<span class="c1">#            tslow = [tlow.get(ec,0) for ec in eventCodes]</span>
<span class="c1">#            xbase[&#39;timestampLow&#39;][iwrite] = tslow</span>
<span class="c1">#            xbase[&#39;timestampHigh&#39;][iwrite] = tshigh</span>
            
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">codes</span> <span class="ow">in</span> <span class="n">code_flags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">present</span><span class="p">(</span><span class="n">codes</span><span class="p">):</span>
                    <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># put pvControls step value for each event </span>
            <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">xpv</span> <span class="ow">in</span> <span class="n">apvControls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xpv</span><span class="p">[</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpv</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;step_values&#39;</span><span class="p">][</span><span class="n">istep</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;Cannot write pvControl&#39;</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">iwrite</span><span class="p">,</span> <span class="n">istep</span>

            <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">xpv</span> <span class="ow">in</span> <span class="n">axpvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xpv</span><span class="p">[</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">getPV</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">())</span> 
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#print &#39;cannot update pv&#39;, pv, iwrite</span>
                    <span class="k">pass</span>

            <span class="k">for</span> <span class="n">det0</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                <span class="n">det</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det0</span><span class="p">,</span> <span class="n">det0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_present&#39;</span> <span class="ow">in</span> <span class="n">xbase</span><span class="p">:</span>
                    <span class="n">xbase</span><span class="p">[</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39;_present&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_events</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">det0</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                    <span class="n">det</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det0</span><span class="p">,</span> <span class="n">det0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">det</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axdat</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">detector</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">_dets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det0</span><span class="p">)</span>
                    <span class="n">aievt</span><span class="p">[</span><span class="n">det</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> 
                    <span class="n">iwrite</span> <span class="o">=</span> <span class="n">aievt</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">mpio</span><span class="p">:</span>
                        <span class="n">iwrite</span> <span class="o">+=</span> <span class="n">ievent0</span>
                    <span class="n">aievents</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ievent</span><span class="p">)</span>
                    <span class="c1">#axdat[det][det+&#39;_present&#39;][iwrite] = True</span>
                    <span class="k">if</span> <span class="s1">&#39;sec&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]:</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;********&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">]:</span>
                            <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">attr</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span> <span class="s1">&#39;Bad time&#39;</span>
                        <span class="nb">print</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">iwrite</span>
                        <span class="nb">print</span> <span class="s1">&#39;axdat keys:&#39;</span><span class="p">,</span> <span class="n">axdat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="nb">print</span> <span class="s1">&#39;axdat[det] keys:&#39;</span><span class="p">,</span> <span class="n">axdat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">det</span><span class="p">,{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="nb">print</span> <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
                        <span class="k">continue</span>

                    <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">istep</span>
                    <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="s1">&#39;run&#39;</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span>  <span class="n">axfuncs</span><span class="p">[</span><span class="n">det</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                            <span class="n">alias</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span>
                            <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                        <span class="nb">print</span> <span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span>
                                    <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">alias</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                                        <span class="nb">print</span> <span class="s1">&#39;Event Error&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ievent</span><span class="p">,</span> <span class="n">vals</span>
                                    <span class="n">vals</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                                <span class="nb">print</span> <span class="s1">&#39;Event Error&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ievent</span>

        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nevents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">igood</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">axdat</span><span class="p">:</span>
            <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nevents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aievt</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">axdat</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">elif</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iwrite</span><span class="p">,</span> <span class="n">atup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iattr</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">]):</span>
                    <span class="n">xbase</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">iwrite</span><span class="p">]</span> <span class="o">=</span> <span class="n">atup</span><span class="p">[</span><span class="n">iattr</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">xbase</span> 
        
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ievent</span><span class="p">,</span> <span class="n">evt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ievent</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">ievent</span><span class="p">,</span> <span class="n">evt</span>

            <span class="nb">print</span> <span class="s1">&#39;total time&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="s1">&#39;ScanData&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nsteps&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nsteps&#39;</span><span class="p">,</span> <span class="s1">&#39;pvControls&#39;</span><span class="p">,</span> <span class="s1">&#39;pvMonitors&#39;</span><span class="p">,</span> <span class="s1">&#39;pvLabels&#39;</span><span class="p">]</span>
<span class="c1">#            for pv, vals in self.configData.ScanData.control_values.items():</span>
<span class="c1">#                alias = self.configData.ScanData.pvAliases[pv]</span>
<span class="c1">#                xbase.create_variable(alias+&#39;_steps&#39;, (&#39;steps&#39;,), data=vals) </span>
<span class="c1">#                base_coordinates += &#39; &#39;+alias+&#39;+steps&#39;</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> 
 
    <span class="n">xbase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_coordinates</span>
 
    <span class="n">det</span> <span class="o">=</span> <span class="s1">&#39;stats&#39;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_C</span><span class="si">{:02}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="n">ichunk</span><span class="p">,</span><span class="n">det</span><span class="p">))</span>
    <span class="n">data_sets</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">(</span><span class="n">aliases</span><span class="o">=</span><span class="n">aliases</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_sets</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">aliases</span><span class="p">)</span>

    <span class="n">xbase</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#    for alias in self._device_sets</span>

    <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_base</span>

<span class="c1">#        xbase = xbase.isel(time=range(len(btimes)))</span>
<span class="c1">#        xbase[&#39;time&#39;] =  [e.datetime64 for e in btimes]</span>
<span class="c1">#        for attr, dtyp in ttypes.items():</span>
<span class="c1">#            xbase.coords[attr] = ([&#39;time&#39;], np.array([getattr(e, attr) for e in btimes],dtype=dtyp))</span>
<span class="c1">#            </span>
<span class="c1">#        # fill each control PV with current step value</span>
<span class="c1">#        scan_variables = []</span>
<span class="c1">#        if self.configData.ScanData and self.configData.ScanData.nsteps &gt; 1:</span>
<span class="c1">#            for attr, vals in self.configData.ScanData.control_values.items():</span>
<span class="c1">#                alias = self.configData.ScanData.pvAliases[attr]</span>
<span class="c1">#                scan_variables.append(alias)</span>
<span class="c1">#                xbase.coords[alias] = ([&#39;time&#39;], xbase.coords[alias+&#39;_steps&#39;][xbase.step]) </span>
<span class="c1">#</span>
<span class="c1">#        xbase.attrs[&#39;scan_variables&#39;] = scan_variables</span>
<span class="c1">#        xbase.attrs[&#39;correlation_variables&#39;] = []</span>
<span class="c1">#       </span>
<span class="c1">#        # add in epics_attrs (assumed fixed over run)</span>
<span class="c1">#        for pv in epics_attrs:</span>
<span class="c1">#            try:</span>
<span class="c1">#                xbase.attrs.update({pv: self.epicsData.getPV(pv).data()[0]})</span>
<span class="c1">#            except:</span>
<span class="c1">#                print &#39;cannot att epics_attr&#39;, pv</span>
<span class="c1">#                traceback.print_exc()</span>

<span class="c1">#        if drop_unused_codes:</span>
<span class="c1">#            for ec in eventCodes:</span>
<span class="c1">#                print &#39;Dropping unused eventCode&#39;, ec</span>
<span class="c1">#                if not xbase[&#39;ec{:}&#39;.format(ec)].any():</span>
<span class="c1">#                    xbase = xbase.drop(&#39;ec{:}&#39;.format(ec))</span>
<span class="c1">#</span>
<span class="c1">#        # cut down size of xdat</span>
<span class="c1">#        det_list = [det for det in axdat]</span>
<span class="c1">#        for det in np.sort(det_list):</span>
<span class="c1">#            nevents = len(atimes[det])</span>
<span class="c1">#            if nevents &gt; 0 and det in axdat:</span>
<span class="c1">#                try:</span>
<span class="c1">#                    print &#39;merging&#39;, det, nevents</span>
<span class="c1">#                    xdat = axdat.pop(det)</span>
<span class="c1">#                    if &#39;time&#39; in xdat.dims:</span>
<span class="c1">#                        xdat = xdat.isel(time=range(nevents))</span>
<span class="c1">#                        xdat[&#39;time&#39;] = [e.datetime64 for e in atimes[det]]</span>
<span class="c1">#                        xdat = xdat.reindex_like(xbase)</span>
<span class="c1">#            </span>
<span class="c1">#                    xbase = xbase.merge(xdat)</span>
<span class="c1">#                </span>
<span class="c1">#                except:</span>
<span class="c1">#                    print &#39;Could not merge&#39;, det</span>
<span class="c1">#                    return xbase, xdat, axdat, atimes, btimes</span>
<span class="c1">#</span>
<span class="c1">#        attrs = [attr for attr,item in xbase.data_vars.items()] </span>
<span class="c1">#        for attr in attrs:</span>
<span class="c1">#            for a in [&#39;unit&#39;, &#39;doc&#39;]:</span>
<span class="c1">#                if a in xbase[attr].attrs and xbase[attr].attrs[a] is None:</span>
<span class="c1">#                    xbase[attr].attrs[a] = &#39;&#39;</span>
<span class="c1">#        </span>
<span class="c1">#        for pv, pvdata in epics_pvs.items():</span>
<span class="c1">#            xdat = xr.Dataset({pv: ([&#39;time&#39;], np.array(pvdata.values()).squeeze())}, </span>
<span class="c1">#                                  coords={&#39;time&#39;: [e.datetime64 for e in pvdata.keys()]} )</span>
<span class="c1">#            xbase = xbase.merge(xdat)</span>
<span class="c1">#</span>
<span class="c1">#        xbase = resort(xbase)</span>
<span class="c1">#</span>
<span class="c1">#        if save:</span>
<span class="c1">#            try:</span>
<span class="c1">#                to_h5netcdf(xbase)</span>
<span class="c1">#            except:</span>
<span class="c1">#                print &#39;Could not save to_h5netcdf&#39;</span>
<span class="c1">#</span>
<span class="c1">#        return xbase</span>



<span class="c1">#def normalize_data(x, variables=[], norm_attr=&#39;PulseEnergy&#39;, name=&#39;norm&#39;, quiet=True):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Normalize a list of variables with norm_attr [default = &#39;PulseEnergy&#39;]</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    if not variables:</span>
<span class="c1">#        variables = [a for a in get_correlations(x) if not a.endswith(&#39;_&#39;+name)]    </span>
<span class="c1">#</span>
<span class="c1">#    for attr in variables:</span>
<span class="c1">#        aname = attr+&#39;_&#39;+name</span>
<span class="c1">#        try:</span>
<span class="c1">#            x[aname] = x[attr]/x[norm_attr]</span>
<span class="c1">#            x[aname].attrs = x[attr].attrs</span>
<span class="c1">#            try:</span>
<span class="c1">#                x[aname].attrs[&#39;doc&#39;] = x[aname].attrs.get(&#39;doc&#39;,&#39;&#39;)+&#39; -- normalized to &#39;+norm_attr</span>
<span class="c1">#                units = x[attr].attrs.get(&#39;unit&#39;)</span>
<span class="c1">#                norm_units = x[norm_attr].attrs.get(&#39;unit&#39;)</span>
<span class="c1">#                if units and norm_units:</span>
<span class="c1">#                    x[aname].attrs[&#39;unit&#39;] = &#39;/&#39;.join([units, norm_units])</span>
<span class="c1">#            except:</span>
<span class="c1">#                if not quiet:</span>
<span class="c1">#                    print &#39;cannot add attrs for&#39;, aname</span>
<span class="c1">#        except:</span>
<span class="c1">#            print &#39;Cannot normalize {:} with {:}&#39;.format(attr, norm_attr)</span>
<span class="c1">#</span>
<span class="c1">#    return  resort(x)</span>

<span class="k">def</span> <span class="nf">map_indexes</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">ww</span><span class="p">):</span>                                                                      
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified map method from PSCalib.GeometryAccess.img_from_pixel_arrays</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xx : array-like</span>
<span class="sd">        Array of x coordinates</span>
<span class="sd">    yy : array-like</span>
<span class="sd">        Array of y coordinates</span>
<span class="sd">    ww : array-like</span>
<span class="sd">        Array of weights</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    2D image array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span> <span class="o">=</span> <span class="n">ww</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="c1">#def xy_ploterr(a, attr=None, xaxis=None, title=&#39;&#39;, desc=None, fmt=&#39;o&#39;, **kwargs):</span>
<span class="c1">#    &quot;&quot;&quot;Plot summary data with error bars, e.g.,</span>
<span class="c1">#        xy_ploterr(x, &#39;MnScatter&#39;,&#39;Sample_z&#39;,logy=True)</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    import numpy as np</span>
<span class="c1">#    import matplotlib.pyplot as plt</span>
<span class="c1">#    if not attr:</span>
<span class="c1">#        print &#39;Must supply plot attribute&#39;</span>
<span class="c1">#        return</span>
<span class="c1">#</span>
<span class="c1">#    if &#39;groupby&#39; in kwargs:</span>
<span class="c1">#        groupby=kwargs[&#39;groupby&#39;]</span>
<span class="c1">#    elif &#39;step&#39; in a.dims:</span>
<span class="c1">#        groupby=&#39;step&#39;</span>
<span class="c1">#    else:</span>
<span class="c1">#        groupby=&#39;run&#39;</span>
<span class="c1">#</span>
<span class="c1">#    run = a.attrs.get(&#39;run&#39;)</span>
<span class="c1">#    experiment = a.attrs.get(&#39;experiment&#39;, &#39;&#39;)</span>
<span class="c1">#    runstr = &#39;{:} Run {:}&#39;.format(experiment, run)</span>
<span class="c1">#    name = a.attrs.get(&#39;name&#39;, runstr)</span>
<span class="c1">#    if not title:</span>
<span class="c1">#        title = &#39;{:}: {:}&#39;.format(name, attr)</span>
<span class="c1">#</span>
<span class="c1">#    if not xaxis:</span>
<span class="c1">#        xaxis = a.attrs.get(&#39;scan_variables&#39;)</span>
<span class="c1">#        if xaxis:</span>
<span class="c1">#            xaxis = xaxis[0]</span>
<span class="c1">#</span>
<span class="c1">#    ylabel = kwargs.get(&#39;ylabel&#39;, &#39;&#39;)</span>
<span class="c1">#    if not ylabel:</span>
<span class="c1">#        ylabel = a[attr].name</span>
<span class="c1">#        unit = a[attr].attrs.get(&#39;unit&#39;)</span>
<span class="c1">#        if unit:</span>
<span class="c1">#            ylabel = &#39;{:} [{:}]&#39;.format(ylabel, unit)</span>
<span class="c1">#</span>
<span class="c1">#    xlabel = kwargs.get(&#39;xlabel&#39;, &#39;&#39;)</span>
<span class="c1">#    if not xlabel:</span>
<span class="c1">#        xlabel = a[xaxis].name</span>
<span class="c1">#        unit = a[xaxis].attrs.get(&#39;unit&#39;)</span>
<span class="c1">#        if unit:</span>
<span class="c1">#            xlabel = &#39;{:} [{:}]&#39;.format(xlabel, unit)</span>
<span class="c1">#    </span>
<span class="c1">#    if xaxis:</span>
<span class="c1">#        if &#39;stat&#39; in a[xaxis].dims:</span>
<span class="c1">#            xerr = a[xaxis].sel(stat=&#39;std&#39;).values</span>
<span class="c1">#            a[xaxis+&#39;_axis&#39;] = ([groupby], a[xaxis].sel(stat=&#39;mean&#39;).values)</span>
<span class="c1">#            xaxis = xaxis+&#39;_axis&#39;</span>
<span class="c1">#        else:</span>
<span class="c1">#            xerr = None</span>
<span class="c1">#</span>
<span class="c1">#        a = a.swap_dims({groupby:xaxis})</span>
<span class="c1">#    </span>
<span class="c1">#    else:</span>
<span class="c1">#        xerr = None</span>
<span class="c1">#</span>
<span class="c1">#    if desc is None:</span>
<span class="c1">#        desc = a[attr].attrs.get(&#39;doc&#39;, &#39;&#39;)</span>
<span class="c1">#</span>
<span class="c1">#    ndims = len(a[attr].dims)</span>
<span class="c1">#    if ndims == 2:</span>
<span class="c1">#        c = a[attr].to_pandas().T</span>
<span class="c1">#        if xerr is not None:</span>
<span class="c1">#            c[&#39;xerr&#39;] = xerr</span>
<span class="c1">#        c = c.sort_index()</span>
<span class="c1">#        </span>
<span class="c1">#        plt.figure()</span>
<span class="c1">#        plt.gca().set_position((.1,.2,.8,.7))</span>
<span class="c1">#        p = c[&#39;mean&#39;].plot(yerr=c[&#39;std&#39;],xerr=c.get(&#39;xerr&#39;), title=title, fmt=fmt, **kwargs)</span>
<span class="c1">#        plt.xlabel(xlabel)</span>
<span class="c1">#        plt.ylabel(ylabel)</span>
<span class="c1">#        if desc:</span>
<span class="c1">#            plt.text(-.1,-.2, desc, transform=p.transAxes, wrap=True)   </span>
<span class="c1"># </span>
<span class="c1">#        return p </span>
<span class="c1">#    elif ndims == 3:</span>
<span class="c1">#        plt.figure()</span>
<span class="c1">#        plt.gca().set_position((.1,.2,.8,.7))</span>
<span class="c1">#        pdim = [d for d in a[attr].dims if d not in [&#39;stat&#39;, groupby, xaxis]][0]</span>
<span class="c1">#        for i in range(len(a[attr].coords[pdim])):</span>
<span class="c1">#            c = a[attr].sel(**{pdim:i}).drop(pdim).to_pandas().T.sort_index()</span>
<span class="c1">#            p = c[&#39;mean&#39;].plot(yerr=c[&#39;std&#39;], fmt=fmt, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#        plt.xlabel(xlabel)</span>
<span class="c1">#        plt.ylabel(ylabel)</span>
<span class="c1">#        p.set_title(title)</span>
<span class="c1">#        if desc:</span>
<span class="c1">#            plt.text(-.1,-.2, desc, transform=p.transAxes, wrap=True)   </span>

<span class="c1">#        return p </span>
<span class="c1">#    else:</span>
<span class="c1">#        print &#39;Too many dims to plot&#39;</span>

<span class="k">def</span> <span class="nf">make_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel</span><span class="o">=.</span><span class="mi">11</span><span class="p">,</span> <span class="n">ix0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iy0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">indexes_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indexes_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ximage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yimage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image from 3-dim detector DataArray.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indexes_x</span><span class="p">:</span>
            <span class="n">indexes_x</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">index_base</span><span class="o">+</span><span class="s1">&#39;_x&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indexes_y</span><span class="p">:</span>
            <span class="n">indexes_y</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">index_base</span><span class="o">+</span><span class="s1">&#39;_y&#39;</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">indexes_x</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">indexes_y</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ximage</span><span class="p">:</span>
            <span class="n">ximage</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_ximage&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yimage</span><span class="p">:</span>
            <span class="n">yimage</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_yimage&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ximage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ix0</span><span class="p">:</span>
                <span class="n">ix0</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">ix0</span><span class="p">)</span><span class="o">*</span><span class="n">pixel</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">yimage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iy0</span><span class="p">:</span>
                <span class="n">iy0</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">iy0</span><span class="p">)</span><span class="o">*</span><span class="n">pixel</span>
        <span class="n">a</span><span class="p">[</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="n">base</span><span class="o">+</span><span class="s1">&#39;_yimage&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="s1">&#39;_ximage&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)],</span>
                                       <span class="n">attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        
    <span class="k">except</span><span class="p">:</span>
        <span class="n">newdim</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="o">**</span><span class="n">newdim</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">newdim</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1">#return xr.DataArray(a, coords=[(base+&#39;_yimage&#39;, y.mean(axis=1)), (base+&#39;_ximage&#39;, x.mean(axis=0))])</span>

<span class="k">def</span> <span class="nf">make_default_cuts</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gasdetcut_mJ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make default cuts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># FEEGasDetEnergy_f_12_ENRC is duplicate measurement -- can average if desired </span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_pre_atten&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_pre_atten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Energy measurement before attenuation (</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">]:</span> 
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_pre_atten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># FEEGasDetEnergy_f_22_ENRC is duplicate measurement -- can average if desired </span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Energy measurement afeter attenuation (</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">]:</span> 
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;FEEGasDetEnergy_f_12_ENRC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;FEEGasDetEnergy_f_22_ENRC&#39;</span><span class="p">])</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1">#      Need to add in experiment specific PulseEnergy with attenuation</span>
<span class="c1">#        try:</span>
<span class="c1">#            x[&#39;PulseEnergy&#39;] = ([&#39;time&#39;], x[&#39;Gasdet_post_atten&#39;].values*x[&#39;dia_trans1&#39;].values)</span>
<span class="c1">#        except:</span>
<span class="c1">#            x[&#39;PulseEnergy&#39;] = ([&#39;time&#39;], x[&#39;Gasdet_post_atten&#39;].values*x.attrs[&#39;dia_trans1&#39;])</span>
<span class="c1">#        </span>
<span class="c1">#        x[&#39;PulseEnergy&#39;].attrs = x[&#39;Gasdet_pre_atten&#39;].attrs</span>
<span class="c1">#        x[&#39;PulseEnergy&#39;].attrs[&#39;doc&#39;] = &quot;Energy measurement normalized by attenuators&quot;</span>
<span class="c1">#</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#gasdetcut =  np.array(x.Gasdet_pre_atten.values &gt; gasdetcut_mJ, dtype=np.byte)</span>
        <span class="c1">#x.coords[&#39;Gasdet_cut&#39;] = ([&#39;time&#39;], gasdetcut)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Gasdet_pre_atten</span> <span class="o">&gt;</span> <span class="n">gasdetcut_mJ</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;Gas detector cut.  Gasdet_pre_atten &gt; </span><span class="si">{:}</span><span class="s2"> mJ&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gasdetcut_mJ</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span> 
    <span class="k">except</span><span class="p">:</span>
        <span class="n">gasdetcut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">#    damagecut = np.array(phasecut &amp; gasdetcut &amp; (x.EBeam_damageMask.values == 0), dtype=np.byte)</span>
    <span class="c1">#damagecut = np.array(gasdetcut, dtype=np.byte)</span>
    <span class="c1">#x.coords[&#39;Damage_cut&#39;] = ([&#39;time&#39;], damagecut)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Damage_cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Gasdet_cut&#39;</span><span class="p">]</span>
    <span class="c1">#doc = &quot;Combined Gas detector, Phase cavity and EBeam damage cut&quot;</span>
    <span class="c1">#x.coords[&#39;Damage_cut&#39;].attrs[&#39;doc&#39;] = doc </span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;EBeam_ebeamPhotonEnergy&#39;</span><span class="p">:</span> <span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">}</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_variables&#39;</span><span class="p">):</span>
        <span class="n">cvars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cvar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cvar</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">cvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cvar</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;correlation_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvars</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sattrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">,[])))</span>
        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_steps&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_steps&#39;</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">pv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">x</span><span class="p">[</span><span class="n">pv</span><span class="o">+</span><span class="s1">&#39;_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))])</span>
                <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">pv</span><span class="o">+</span><span class="s1">&#39;_steps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                <span class="n">sattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot add _steps as events&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pvControls&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">pv</span><span class="o">+</span><span class="s1">&#39;_control&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">sattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="o">+</span><span class="s1">&#39;_control&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">sattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
        <span class="n">sattrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">sattrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">]))</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sattrs</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot add pvControls to scan_variables&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;XrayOff&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">XrayOff</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cuts&#39;</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cuts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">,</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">]</span>
            <span class="nb">print</span> <span class="s1">&#39;Setting cuts&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cuts&#39;</span><span class="p">]</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Cannot make default cuts&#39;</span>


    <span class="k">return</span> <span class="n">x</span>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>