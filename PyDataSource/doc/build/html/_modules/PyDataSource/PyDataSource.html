

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.PyDataSource &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.PyDataSource</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.PyDataSource</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># File and Version Information:</span>
<span class="c1">#  $HeaderURL$</span>
<span class="c1">#  $Id$</span>
<span class="c1">#  $LastChangedDate$</span>
<span class="c1">#</span>
<span class="c1"># Description:</span>
<span class="c1">#  module PyDataSource</span>
<span class="c1">#--------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Python implementation of psana DataSource object.</span>

<span class="sd">Example</span>
<span class="sd">-------</span>

<span class="sd">    # Import the PyDataSource module</span>
<span class="sd">    In [1]: import PyDataSource</span>

<span class="sd">    # Load example run</span>
<span class="sd">    In [2]: ds = PyDataSource.DataSource(&#39;exp=xpptut15:run=54&#39;)</span>

<span class="sd">    # Access the first event</span>
<span class="sd">    In [3]: evt = ds.events.next()</span>

<span class="sd">    # Tab to see Data objects in current event</span>
<span class="sd">    In [4]: evt.</span>
<span class="sd">    evt.EBeam            evt.FEEGasDetEnergy  evt.XppEnds_Ipm0     evt.cspad            evt.next</span>
<span class="sd">    evt.EventId          evt.L3T              evt.XppSb2_Ipm       evt.get              evt.yag2</span>
<span class="sd">    evt.Evr              evt.PhaseCavity      evt.XppSb3_Ipm       evt.keys             evt.yag_lom</span>

<span class="sd">    # Tab to see EBeam attributes</span>
<span class="sd">    In [4]: evt.EBeam.</span>
<span class="sd">    evt.EBeam.EventId            evt.EBeam.ebeamEnergyBC1     evt.EBeam.ebeamPhotonEnergy  evt.EBeam.epicsData</span>
<span class="sd">    ...</span>
<span class="sd">    evt.EBeam.ebeamDumpCharge    evt.EBeam.ebeamLTUPosY       evt.EBeam.ebeamXTCAVPhase    </span>

<span class="sd">    # Print a table of the EBeam data for the current event</span>
<span class="sd">    In [4]: evt.EBeam.show_info()</span>
<span class="sd">    --------------------------------------------------------------------------------</span>
<span class="sd">    EBeam xpptut15, Run 54, Step -1, Event 0, 11:37:12.4517, [140, 141, 41, 40]</span>
<span class="sd">    --------------------------------------------------------------------------------</span>
<span class="sd">    damageMask                 1.0486e+06         Damage mask.</span>
<span class="sd">    ebeamCharge                0.00080421 nC      Beam charge in nC.</span>
<span class="sd">    ...</span>
<span class="sd">    ebeamPhotonEnergy                   0 eV      computed photon energy, in eV</span>
<span class="sd">    ...</span>

<span class="sd">    # Print summary of the cspad detector (uses PyDetector methods for creatining calib and image data)</span>
<span class="sd">    In [5]: evt.cspad.show_info()</span>
<span class="sd">    --------------------------------------------------------------------------------</span>
<span class="sd">    cspad xpptut15, Run 54, Step -1, Event 0, 11:37:12.4517, [140, 141, 41, 40]</span>
<span class="sd">    --------------------------------------------------------------------------------</span>
<span class="sd">    calib                &lt;0.010653&gt; ADU     Calibrated data</span>
<span class="sd">    image               &lt;0.0081394&gt; ADU     Reconstruced 2D image from calibStore geometry</span>
<span class="sd">    raw                    &lt;1570.2&gt; ADU     Raw data</span>
<span class="sd">    shape              (32, 185, 388)         Shape of raw data array</span>
<span class="sd">    size                  2.297e+06         Total size of raw data</span>

<span class="sd">    # Print summary of cspad detector calibration data (using PyDetector access methods) </span>
<span class="sd">    In [6]: evt.cspad.calibData.show_info()</span>
<span class="sd">    areas                  &lt;1.0077&gt;         Pixel area correction factor</span>
<span class="sd">    bkgd                      &lt;0.0&gt;         </span>
<span class="sd">    ...</span>
<span class="sd">    shape              (32, 185, 388)         Shape of raw data array</span>
<span class="sd">    size                  2.297e+06         Total size of raw data</span>
<span class="sd">    status             &lt;0.00069396&gt;         </span>

<span class="sd">    # Print summary of cspad detector calibration data (using PyDetector access methods) </span>
<span class="sd">    In [7]: evt.cspad.configData.show_info()</span>
<span class="sd">    activeRunMode                       3         </span>
<span class="sd">    asicMask                           15         </span>
<span class="sd">    ...</span>
<span class="sd">    roiMasks                   0xffffffff         </span>
<span class="sd">    runDelay                        58100         </span>
<span class="sd">    tdi                                 4         </span>

<span class="sd">This software was developed for the LCLS project.</span>
<span class="sd">If you use all or part of it, please give an appropriate acknowledgment.</span>

<span class="sd">@version $Id$</span>

<span class="sd">@author Koglin, Jason</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#------------------------------</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision$&quot;</span>
<span class="c1">##-----------------------------</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1">#from pylab import *</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># psana modules</span>
<span class="kn">import</span> <span class="nn">psana</span>

<span class="kn">from</span> <span class="nn">psmon</span> <span class="k">import</span> <span class="n">publish</span>
<span class="n">publish</span><span class="o">.</span><span class="n">client_opts</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
<span class="kn">from</span> <span class="nn">psmon.plots</span> <span class="k">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">XYPlot</span><span class="p">,</span> <span class="n">MultiPlot</span>

<span class="c1"># PyDataSource modules</span>
<span class="kn">from</span> <span class="nn">DataSourceInfo</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">psana_doc_info</span> <span class="k">import</span> <span class="o">*</span> 
<span class="kn">from</span> <span class="nn">psmessage</span> <span class="k">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">build_html</span> <span class="k">import</span> <span class="n">Build_html</span>
<span class="kn">from</span> <span class="nn">exp_summary</span> <span class="k">import</span> <span class="n">ExperimentSummary</span>
<span class="kn">from</span> <span class="nn">exp_summary</span> <span class="k">import</span> <span class="n">get_exp_summary</span> 
<span class="kn">from</span> <span class="nn">arp_tools</span> <span class="k">import</span> <span class="n">post_report</span>
<span class="kn">from</span> <span class="nn">h5write</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">_eventCodes_rate</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">40</span><span class="p">:</span> <span class="s1">&#39;120 Hz&#39;</span><span class="p">,</span>
        <span class="mi">41</span><span class="p">:</span> <span class="s1">&#39;60 Hz&#39;</span><span class="p">,</span>
        <span class="mi">42</span><span class="p">:</span> <span class="s1">&#39;30 Hz&#39;</span><span class="p">,</span>
        <span class="mi">43</span><span class="p">:</span> <span class="s1">&#39;10 Hz&#39;</span><span class="p">,</span>
        <span class="mi">44</span><span class="p">:</span> <span class="s1">&#39;5 Hz&#39;</span><span class="p">,</span>
        <span class="mi">45</span><span class="p">:</span> <span class="s1">&#39;1 Hz&#39;</span><span class="p">,</span>
        <span class="mi">46</span><span class="p">:</span> <span class="s1">&#39;0.5 Hz&#39;</span><span class="p">,</span>
        <span class="mi">140</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 120 Hz&#39;</span><span class="p">,</span>
        <span class="mi">141</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 60 Hz&#39;</span><span class="p">,</span>
        <span class="mi">142</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 30 Hz&#39;</span><span class="p">,</span>
        <span class="mi">143</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 10 Hz&#39;</span><span class="p">,</span>
        <span class="mi">144</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 5 Hz&#39;</span><span class="p">,</span>
        <span class="mi">145</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 1 Hz&#39;</span><span class="p">,</span>
        <span class="mi">146</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 0.5 Hz&#39;</span><span class="p">,</span>
        <span class="mi">150</span><span class="p">:</span> <span class="s1">&#39;Burst&#39;</span><span class="p">,</span>
        <span class="mi">162</span><span class="p">:</span> <span class="s1">&#39;BYKIK&#39;</span><span class="p">,</span>
        <span class="mi">163</span><span class="p">:</span> <span class="s1">&#39;BAKIK&#39;</span><span class="p">,</span>
        <span class="p">}</span>

<span class="n">_transmission_pvs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;FEE&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;fee_trans&#39;</span><span class="p">:</span>     <span class="s1">&#39;SATT:FEE1:320:RACT&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;feegas_trans&#39;</span><span class="p">:</span>     <span class="s1">&#39;GATT:FEE1:310:R_ACT&#39;</span><span class="p">,</span> 
                        <span class="c1">#&#39;fee_trans_set&#39;: &#39;SATT:FEE1:320:RDES&#39;, </span>
                        <span class="c1">#&#39;feegas_trans_set&#39;: &#39;GATT:FEE1:310:R_DES&#39;, </span>
                        <span class="p">},</span>
                <span class="s1">&#39;XPP&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;xpp_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XPP:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;xpp_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XPP:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;xpp_trans_set&#39;:    &#39;XPP:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;xpp_trans3_set&#39;:    &#39;XPP:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;XCS&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;xcs_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XCS:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;xcs_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XCS:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;xcs_trans_set&#39;:    &#39;XCS:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;xcs_trans3_set&#39;:    &#39;XCS:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;MFX&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;mfx_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;MFX:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;mfx_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;MFX:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;mfx_trans_set&#39;:    &#39;MFX:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;mfx_trans3_set&#39;:    &#39;MFX:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="s1">&#39;CXI&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;cxi_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;CXI:DSB:ATT:COM:R_CUR&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;dsb_trans&#39;</span><span class="p">:</span>        <span class="s1">&#39;XRT:DIA:ATT:COM:R_CUR&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cxi_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;CXI:DSB:ATT:COM:R3_CUR&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;dsb_trans3&#39;</span><span class="p">:</span>        <span class="s1">&#39;XRT:DIA:ATT:COM:R3_CUR&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;cxi_trans_set&#39;:    &#39;CXI:DSB:ATT:COM:R_DES&#39;, </span>
                        <span class="c1">#&#39;dsb_trans_set&#39;:    &#39;XRT:DIA:ATT:COM:R_DES&#39;,</span>
                        <span class="c1">#&#39;cxi_trans3_set&#39;:    &#39;CXI:DSB:ATT:COM:R3_DES&#39;, </span>
                        <span class="c1">#&#39;dsb_trans3_set&#39;:    &#39;XRT:DIA:ATT:COM:R3_DES&#39;,</span>
                        <span class="p">},</span>
                <span class="p">}</span>

<span class="k">def</span> <span class="nf">getattr_complete</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursive getattr</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base : object</span>
<span class="sd">        Object</span>

<span class="sd">    args : str</span>
<span class="sd">        Argument to get from object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">base</span>

<span class="k">def</span> <span class="nf">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import a module from a given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name : str</span>
<span class="sd">        Name of module</span>
<span class="sd">    module_path : str</span>
<span class="sd">        Path of module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">module_path</span><span class="p">]</span>
        <span class="n">file</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">desc</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">)</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;import_module error&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR loading </span><span class="si">{:}</span><span class="s1"> from </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">))</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get module from path</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name : str</span>
<span class="sd">        Name of module</span>
<span class="sd">    module_path : str</span>
<span class="sd">        Path of module</span>
<span class="sd">    reload : bool</span>
<span class="sd">        Reload module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reload</span> <span class="ow">or</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_class</span> <span class="o">=</span>  <span class="nb">getattr</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">module_name</span><span class="p">],</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">new_class</span> <span class="o">=</span>  <span class="nb">getattr</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">module_name</span><span class="p">],</span><span class="n">module_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">new_class</span>

<span class="k">def</span> <span class="nf">get_key_info</span><span class="p">(</span><span class="n">psana_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a dictionary of the (type, src, key) for the data types of each src.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psana_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">src</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">:</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_info</span><span class="p">:</span>
                <span class="n">key_info</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
            <span class="n">key_info</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">key</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">key_info</span>

<span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="n">psana_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a dictionary of the (type, src, key) for the data types of each src.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_modules</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psana_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">src</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">:</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_info</span><span class="p">:</span>
                <span class="n">key_info</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
            
            <span class="n">key_info</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">key</span><span class="p">()))</span>
            
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;psana.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_modules</span><span class="p">:</span>
                    <span class="n">_modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="k">if</span> <span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_modules</span><span class="p">[</span><span class="n">module</span><span class="p">]:</span>
                    <span class="n">_modules</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">_modules</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">key</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">key_info</span><span class="p">,</span> <span class="n">_modules</span>


<span class="k">def</span> <span class="nf">_repr_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a value for use in show_info method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;list&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1">#return str(value)</span>
        
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{:.4}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1">#return &#39;{:10.5g}&#39;.format(value)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_is_psana_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;True if the input is a psana data type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;psana&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="_get_typ_func_attr"><a class="viewcode-back" href="../../generated/PyDataSource.PyDataSource._get_typ_func_attr.html#PyDataSource._get_typ_func_attr">[docs]</a><span class="k">def</span> <span class="nf">_get_typ_func_attr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return psana functions as properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;psana.&#39;</span><span class="p">)</span>
    <span class="n">type_name</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">info</span> <span class="o">=</span> <span class="n">psana_doc_info</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>

    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;typ_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">typ_func</span>
    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>

    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_shape&#39;</span><span class="p">):</span>
        <span class="n">nvals</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nvals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">nvals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">nvals</span><span class="p">)()[</span><span class="mi">0</span><span class="p">]</span>
       
        <span class="n">i0</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func0&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">i0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_len_hex&#39;</span><span class="p">):</span>
        <span class="n">nvals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_len_hex&#39;</span><span class="p">))()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_len&#39;</span><span class="p">):</span>
        <span class="n">nvals</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_len&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nvals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">nvals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">nvals</span><span class="p">)()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_index&#39;</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_index&#39;</span><span class="p">))()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">elif</span> <span class="s1">&#39;func_method&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;func_method&#39;</span><span class="p">)(</span><span class="n">value</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">info</span>


    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;_typ_func&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_typ_func</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
        <span class="c1"># evaluate as name to avoid recursive psana functions </span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">_attrs</span> <span class="ow">and</span> <span class="s1">&#39;conjugate&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>   
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span>
  
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span>
            <span class="k">return</span> <span class="n">info</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_type_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">nvals</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;list_len&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nvals</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">nvals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">nvals</span><span class="p">)()</span>
       
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_is_psana_type</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PsanaTypeData</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="n">is_type_list</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_type_list</span><span class="p">:</span> <span class="c1"># and not nolist:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">PsanaTypeList</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">if</span> <span class="n">_is_psana_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PsanaTypeData</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">info</span></div>

<span class="k">def</span> <span class="nf">psmon_publish</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Publish psmon plots for an event</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">psmon</span> <span class="k">import</span> <span class="n">publish</span>
    <span class="kn">from</span> <span class="nn">psmon.plots</span> <span class="k">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">XYPlot</span><span class="p">,</span> <span class="n">MultiPlot</span>
    <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">eventCodes</span>
    <span class="n">event_info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
        <span class="n">psplots</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psplot&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psplots</span><span class="p">:</span>
            <span class="n">detector</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">_dets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">psmon_args</span> <span class="ow">in</span> <span class="n">psplots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">eventCode</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eventCode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">nskip</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nskip&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">reshape</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reshape&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">transpose</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transpose&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">fliplr</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fliplr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">flipud</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flipud&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">flipud</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flipud&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">rot90</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;pubargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rot90&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nskip</span> <span class="ow">and</span> <span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">%</span> <span class="n">nskip</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">eventCode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">psmon_args</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">eventCode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">eventCode</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">:</span>
                    <span class="n">psplot_func</span> <span class="o">=</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;plot_function&#39;</span><span class="p">]</span>
                    <span class="n">psmon_fnc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">psplot_func</span> <span class="ow">is</span> <span class="s1">&#39;Image&#39;</span><span class="p">:</span>
                        <span class="n">image</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">reshape</span><span class="p">:</span>
                            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
                            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;transpose&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span> 
                            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flipud&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fliplr</span><span class="p">:</span> 
                            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fliplr&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">rot90</span><span class="p">:</span> 
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rot90</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="n">krot</span> <span class="o">=</span> <span class="n">rot90</span>
                            <span class="k">else</span><span class="p">:</span> <span class="n">krot</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">krot</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rot90&#39;</span><span class="p">,</span> <span class="n">krot</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">psmon_args</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">psmon_fnc</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span>
                                        <span class="n">event_info</span><span class="p">,</span>
                                        <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">),</span> 
                                        <span class="c1">#np.array(image, dtype=&#39;f&#39;).transpose(), </span>
                                        <span class="o">**</span><span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
                    
                    <span class="k">elif</span> <span class="n">psplot_func</span> <span class="ow">is</span> <span class="s1">&#39;XYPlot&#39;</span><span class="p">:</span>
                        <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">getattr_complete</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> \
                                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">event_info</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;xdata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">))</span>
                            
                            <span class="n">psmon_fnc</span> <span class="o">=</span> <span class="n">XYPlot</span><span class="p">(</span>
                                        <span class="n">event_info</span><span class="p">,</span>
                                        <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                                        <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;xdata&#39;</span><span class="p">],</span>
                                        <span class="n">ydata</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">psmon_fnc</span><span class="p">:</span>
                        <span class="c1">#print &#39;publish&#39;, name, event_info, psmon_args</span>
                        <span class="c1">#print psmon_fnc</span>
                        <span class="n">pub_info</span> <span class="o">=</span> <span class="n">publish</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">psmon_fnc</span><span class="p">)</span>
                        <span class="n">psmon_args</span><span class="p">[</span><span class="s1">&#39;psmon_fnc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psmon_fnc</span>


<div class="viewcode-block" id="ScanData"><a class="viewcode-back" href="../../generated/PyDataSource.ScanData.html#PyDataSource.ScanData">[docs]</a><span class="k">class</span> <span class="nc">ScanData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan configuration for Run</span>
<span class="sd">    </span>
<span class="sd">    Information from daq-scan, where things like motor positions are changed during a run </span>
<span class="sd">    in &quot;steps&quot; or &quot;calibcycles&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : object</span>
<span class="sd">        PyDataSource.DataSource object</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    nevents : list</span>
<span class="sd">        Number of events for each step</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_array_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pvControls_value&#39;</span><span class="p">,</span> <span class="s1">&#39;pvMonitors_loValue&#39;</span><span class="p">,</span> <span class="s1">&#39;pvMonitors_hiValue&#39;</span><span class="p">]</span>
    <span class="n">_uses_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uses_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;uses_events&#39;</span><span class="p">,</span> <span class="s1">&#39;uses_l3t_events&#39;</span><span class="p">]</span>
    <span class="n">_npv_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;npvControls&#39;</span><span class="p">,</span> <span class="s1">&#39;npvMonitors&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="ScanData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.ScanData.html#PyDataSource.ScanData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ControlData</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">}</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_idx_nsteps</span>
        <span class="n">ievent_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_datetimes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ievent_end</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_datetimes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_istep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">istep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...Building ScanData configuration...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="n">okevt</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">okevt</span><span class="p">:</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="n">ttup</span> <span class="o">=</span> <span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span> <span class="n">evt</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">nsec</span><span class="p">,</span> <span class="n">evt</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">fiducials</span><span class="p">)</span>
                <span class="n">okevt</span> <span class="o">=</span> <span class="n">ttup</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">_idx_times_tuple</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step:&#39;</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>

            <span class="n">ievent</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ttup</span><span class="p">)</span>
            <span class="n">ievent_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ievent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ievent_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ievent</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">timef64</span><span class="p">)</span> 
            <span class="n">start_datetimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">datetime64</span><span class="p">)</span> 
 
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ControlData</span><span class="o">.</span><span class="n">_all_values</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
       
            <span class="n">istep</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">ievent_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>       
        <span class="k">for</span> <span class="n">istep</span><span class="p">,</span> <span class="n">ievent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ievent_end</span><span class="p">):</span>
            <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">ievent</span><span class="p">)</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">timef64</span><span class="p">)</span>
            <span class="n">end_datetimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">ievent</span><span class="p">)</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">datetime64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ievent_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ievent_end</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ievent_end</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ievent_start</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_datetimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_datetimes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_datetimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end_datetimes</span><span class="p">)</span>
        
        <span class="c1"># Save lookup of step</span>
        <span class="k">for</span> <span class="n">istep</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_istep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
 
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uses_attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_duration</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_l3t_events</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;npvControls&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;npvMonitors&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_simple</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_npv_attrs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> 

            <span class="k">if</span> <span class="s1">&#39;pvControls_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvControls_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="s1">&#39;pvMonitors_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvMonitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvMonitors_name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvMonitors</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pvLabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvLabels&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvLabels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvLabels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="p">:</span>
                        <span class="n">alias</span> <span class="o">=</span> <span class="n">pv</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">pvLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> 
            
            <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span> <span class="o">=</span> <span class="p">{}</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_hivalues</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_lovalues</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvControls_value&#39;</span><span class="p">]])</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvMonitors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvMonitors</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">monitor_hivalues</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvMonitors_hiValue&#39;</span><span class="p">]])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">monitor_lovalues</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;pvMonitors_loValue&#39;</span><span class="p">]])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pvAliases</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pvControls</span><span class="p">):</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvLabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pvAliases</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span> 
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="p">[</span><span class="n">pv</span><span class="p">])</span>

        <span class="n">ds</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray Dataset of ScanData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_times</span><span class="p">)</span>
        <span class="n">xscan</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">)})</span>
        <span class="n">xscan</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_datetimes</span><span class="p">)</span> 
        <span class="n">xscan</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="n">xscan</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">xscan</span><span class="p">[</span><span class="s1">&#39;step_tstart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_datetimes</span><span class="p">)</span> 
        <span class="n">xscan</span><span class="p">[</span><span class="s1">&#39;step_tend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_datetimes</span><span class="p">)</span> 
        <span class="n">xscan</span><span class="p">[</span><span class="s1">&#39;step_istart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_start&#39;</span><span class="p">])</span> 
        <span class="n">xscan</span><span class="p">[</span><span class="s1">&#39;step_iend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span><span class="p">[</span><span class="s1">&#39;ievent_end&#39;</span><span class="p">])</span> 
        <span class="n">xscan</span><span class="p">[</span><span class="s1">&#39;step_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvAliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>  <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="n">xscan</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;step&#39;</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add </span><span class="si">{:}</span><span class="s1"> values to ScanData.dataset&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">xscan</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show scan information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span> 
            <span class="s1">&#39;nsteps&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>     <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of steps&#39;</span><span class="p">},</span> 
            <span class="s1">&#39;npvControls&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>     <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of control PVs&#39;</span><span class="p">},</span>
            <span class="s1">&#39;npvMonitors&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>     <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of monitor PVs&#39;</span><span class="p">},</span>
            <span class="p">}</span>

        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:10}</span><span class="s1">: Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1"> </span><span class="si">{:16}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">attr</span><span class="p">))</span>
       
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24}</span><span class="s1"> </span><span class="si">{:40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Alias&#39;</span><span class="p">,</span> <span class="s1">&#39;PV&#39;</span><span class="p">))</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvAliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24}</span><span class="s1"> </span><span class="si">{:40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_control_format</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name_len</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">header1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:6}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="s1">&#39;Events&#39;</span><span class="p">,</span> <span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="p">):</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvAliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">name_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name_len</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_len</span> 
            <span class="n">name_format</span> <span class="o">=</span> <span class="s1">&#39; {:&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>
            <span class="n">header1</span> <span class="o">+=</span> <span class="n">name_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">meanvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">vals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">meanvals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sigdigit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">meanvals</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sigdigit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sigdigit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">))))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sigdigit</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">sigdigit</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">sigdigit</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_control_format</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; {:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.3e}&#39;</span>
            <span class="k">elif</span> <span class="n">sigdigit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_control_format</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; {:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">sigdigit</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_control_format</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; {:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name_len</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>

        <span class="n">message</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">21</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name_len</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nevents</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:6}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nevents</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">a</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_format</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="n">message</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s1">&#39;ScanData: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span></div>


<div class="viewcode-block" id="DataSource"><a class="viewcode-back" href="../../generated/PyDataSource.DataSource.html#PyDataSource.DataSource">[docs]</a><span class="k">class</span> <span class="nc">DataSource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python version of psana.DataSource with support for event and config</span>
<span class="sd">    data as well as PyDetector functions to access calibrated data.</span>

<span class="sd">    data_source string is build by DataSourceInfo object if not passed </span>
<span class="sd">    directly as data_source string.</span>
<span class="sd">    </span>
<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>
<span class="sd">    data_source : str</span>
<span class="sd">        name of data source using psana convention (e.g., &#39;exp=xpptut15:run=54:smd&#39;)</span>

<span class="sd">    exp : str</span>
<span class="sd">        experiment name (e.g., exp=&#39;xpptut15&#39;)</span>

<span class="sd">    run : int</span>
<span class="sd">        run number (e.g., run=54)</span>

<span class="sd">    smd : bool , optional</span>
<span class="sd">        small data support -- default for experiments after Oct 2015 when this feature became standard </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data_source :  object</span>
<span class="sd">        DataSourceInfo object</span>

<span class="sd">    steps : object</span>
<span class="sd">        Steps object</span>

<span class="sd">    epicsData : object</span>

<span class="sd">    configData : object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_ds_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">]</span>
    <span class="n">_ds_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">]</span>
    <span class="n">_env_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calibDir&#39;</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span>
<span class="c1">#    _plugins = {}</span>
<span class="c1">#    _default_plugins = [&#39;psplot.Psplot&#39;]</span>
    <span class="n">_default_modules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;devName&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Imp&#39;</span><span class="p">:</span> <span class="s1">&#39;impbox&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Acqiris&#39;</span><span class="p">:</span> <span class="s1">&#39;acqiris&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Tm6740&#39;</span><span class="p">:</span> <span class="s1">&#39;yag&#39;</span><span class="p">,</span>
<span class="c1">#                &#39;Cspad&#39;: &#39;cspad&#39;,</span>
<span class="c1">#                &#39;Opal1000&#39;: &#39;camera&#39;,</span>
<span class="c1">#                &#39;Opal2000&#39;: &#39;camera&#39;,</span>
<span class="c1">#                &#39;Opal4000&#39;: &#39;camera&#39;,</span>
<span class="c1">#                &#39;Opal8000&#39;: &#39;camera&#39;,</span>
<span class="c1">##                &#39;Epix&#39;: &#39;epix100&#39;,</span>
<span class="c1">##                &#39;Cspad2x2&#39;: &#39;cspad2x2&#39;,</span>
                <span class="p">},</span>
             <span class="s1">&#39;srcname&#39;</span><span class="p">:</span> <span class="p">{</span>
<span class="c1">#                &#39;XrayTransportDiagnostic.0:Opal1000.0&#39;: &#39;xtcav_det&#39;,</span>
<span class="c1">#                &#39;CxiDsu.0:Opal1000.0&#39;: &#39;timetool&#39;,     </span>
                <span class="p">},</span>
            <span class="p">}</span>


<div class="viewcode-block" id="DataSource.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.DataSource.html#PyDataSource.DataSource.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_modules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#self._device_sets = {&#39;DataSource&#39;: {}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>

        <span class="k">if</span> <span class="n">default_modules</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span> <span class="o">=</span> <span class="n">default_modules</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
        <span class="c1">#self._default_modules.update({&#39;path&#39;: os.path.join(path,&#39;detectors&#39;)})</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_run</span><span class="p">(</span><span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">smd</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_smd_config</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_load_smd_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load configData of first calib cycle by going to first step.</span>
<span class="sd">           Reload so that steps can be used as an iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">smd</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not load first step in smd data.&#39;</span> <span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load experiment summary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reload</span> <span class="ow">and</span> <span class="n">build_html</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">build_html</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_summary</span> <span class="o">=</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="n">reload</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="n">build_html</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_summary</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Experiment summary.  Reload if not up to date with current data_source run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_summary</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_summary</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_summary</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">es</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dict of pv alias and number of times set during run.</span>
<span class="sd">        For more detailed information on scan see for example xarray Dataset retruned from:</span>
<span class="sd">            xpvscan = ds.exp_summary.get_scan_data(run_number)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_summary</span><span class="o">.</span><span class="n">dfscan</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">moved_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dict of pv alias and values that were set prior to run..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_summary</span><span class="o">.</span><span class="n">dfset</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray Dataset of small data from beam_stats analysis,</span>
<span class="sd">        standard epics info for &#39;FEE&#39; and instrument from _transmission_pvs,</span>
<span class="sd">        scan data automatically determined from exp_summary and </span>
<span class="sd">        scan data from daq config of calib cycles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">meta_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;EGU&#39;</span><span class="p">,</span> <span class="s1">&#39;PREC&#39;</span><span class="p">:</span> <span class="s1">&#39;PREC&#39;</span><span class="p">,</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">},</span>
            <span class="n">load_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_scan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_smd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_psocake</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">tstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get dataset from epics PVs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        load_default : bool</span>
<span class="sd">            Load default PVs including transmission</span>
<span class="sd">        load_scan : bool</span>
<span class="sd">            Load PVs that are scanned -- uses exp_summary</span>
<span class="sd">        load_smd : bool</span>
<span class="sd">            Load beam_stats small data file used in off-by-one analysis</span>
<span class="sd">        load_psocake : bool</span>
<span class="sd">            Load psocake peak index </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">xarray_utils</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
        <span class="n">run</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
        <span class="n">configData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span>
        <span class="n">xsmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">load_smd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">beam_stats</span>
                <span class="n">xsmd</span> <span class="o">=</span> <span class="n">beam_stats</span><span class="o">.</span><span class="n">load_small_xarray</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> 
                <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">xsmd</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">xsmd</span><span class="o">.</span><span class="n">nsec</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add smd data&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tstart</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_tstart</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tend</span><span class="p">:</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_tend</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span>            <span class="p">(</span><span class="s1">&#39;DESC&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">),</span> 
                    <span class="s1">&#39;slew_speed&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;VELO&#39;</span><span class="p">,</span> <span class="s1">&#39;Velocity (EGU/s) &#39;</span><span class="p">),</span>
                    <span class="s1">&#39;acceleration&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ACCL&#39;</span><span class="p">,</span> <span class="s1">&#39;acceleration time&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;step_size&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span>  <span class="s1">&#39;Step Size (EGU)&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;encoder_step&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ERES&#39;</span><span class="p">,</span> <span class="s1">&#39;Encoder Step Size &#39;</span><span class="p">),</span>
                    <span class="s1">&#39;resolution&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;MRES&#39;</span><span class="p">,</span> <span class="s1">&#39;Motor Step Size (EGU)&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;high_limit&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;HLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User High Limit&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;low_limit&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;LLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User Low Limit&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="s1">&#39;EGU&#39;</span><span class="p">,</span>  <span class="s1">&#39;Units&#39;</span><span class="p">),</span>
        <span class="c1">#            &#39;device_type&#39;:            (&#39;DTYP&#39;, &#39;Device type&#39;), </span>
        <span class="c1">#            &#39;record_type&#39;:            (&#39;RTYP&#39;, &#39;Record Type&#39;), </span>
                    <span class="p">}</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time0</span>
       
        <span class="k">if</span> <span class="n">load_default</span><span class="p">:</span>
            <span class="n">trans_pvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans&#39;</span><span class="p">)]</span>
            <span class="n">trans_pvs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans&#39;</span><span class="p">)]</span>
            <span class="n">trans3_pvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans3&#39;</span><span class="p">)]</span>
            <span class="n">trans3_pvs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_trans3&#39;</span><span class="p">)]</span>
            <span class="n">pvdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FEE&#39;</span><span class="p">,{}))</span>
            <span class="n">pvdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">_transmission_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">instrument</span><span class="p">,{}))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trans_pvs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">trans3_pvs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pvs</span> <span class="o">=</span> <span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="n">pv</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">configData</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv</span><span class="p">)}</span> 
        
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">data_fields</span> <span class="o">=</span> <span class="p">{}</span>
 
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:  </span><span class="si">{:}</span><span class="s1"> - </span><span class="si">{:}</span><span class="s1"> not archived&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                <span class="k">continue</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">meta_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">pv_desc</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">field</span>
                        <span class="k">if</span> <span class="n">configData</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">):</span>
                            <span class="n">desc</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                                <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">fattrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="n">fattrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
                                <span class="n">fattrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="c1"># remove redundant data</span>
                                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                                    <span class="n">newval</span> <span class="o">=</span>  <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                                        <span class="n">val</span> <span class="o">=</span> <span class="n">newval</span>
                                        <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
                                        <span class="n">vals</span><span class="p">[</span><span class="n">vt</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                               
                                <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> 
                                                                <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> 
                                                                <span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">fattrs</span><span class="p">)</span> 
                                <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
         
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot get meta for&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                        <span class="k">pass</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data in archive for  </span><span class="si">{:}</span><span class="s1"> - </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="n">doc</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
              
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="n">dfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span> 
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">alias</span>
                        <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
                
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loadinig&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:10.3f}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                        <span class="n">gias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                        <span class="n">alias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
            
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loading&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_arrays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">trans_pvs</span><span class="p">:</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">trans_pvs</span><span class="p">]</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span> 
            <span class="n">xdata</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">da</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">))</span>
            <span class="n">xdata</span><span class="p">[</span><span class="s1">&#39;trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Total transmission: &#39;</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trans_pvs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load_psocake</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">xarray_utils</span>
            <span class="n">xpsocake</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">open_cxi_psocake</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> 
                    <span class="n">load_smd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_moved_pvs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xpsocake</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xpsocake</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">xpsocake</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">xsmd</span> <span class="o">=</span> <span class="n">xpsocake</span>
        
        <span class="k">if</span> <span class="n">xsmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">merge_fill</span><span class="p">(</span><span class="n">xsmd</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span>
        
        <span class="n">xtimes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">_idx_datetime64</span><span class="p">})</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">merge_fill</span><span class="p">(</span><span class="n">xtimes</span><span class="p">,</span> <span class="n">xdata</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">load_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xscan</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">exp_summary</span><span class="o">.</span><span class="n">get_scan_data</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
                <span class="n">xdata</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">merge_fill</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xscan</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add exp_summary scan data&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xscan</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">dataset</span>
                <span class="k">if</span> <span class="n">load_scan</span> <span class="ow">or</span> <span class="n">xscan</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">merge_fill</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xscan</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add exp_summary scan data&#39;</span><span class="p">)</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">resort</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">pdict</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">pdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">PvData</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">()):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">(),</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">())</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EpicsData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">load_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">try_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> 
            <span class="n">update_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a run with psana.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wait : bool</span>
<span class="sd">            Wait until files are available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evtData</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_evt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_dets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSourceInfo</span><span class="p">(</span><span class="n">data_source</span><span class="o">=</span><span class="n">data_source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># do not reload shared memory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">):</span>
            <span class="c1"># do not wait for monshmserver</span>
            <span class="k">if</span> <span class="n">wait</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">time</span>
                <span class="kn">import</span> <span class="nn">psutils</span>
                <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">psutils</span><span class="o">.</span><span class="n">run_available</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;tut&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">:</span> 
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for </span><span class="si">{:}</span><span class="s1"> to become available...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">update_url</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">requests</span> <span class="k">import</span> <span class="n">post</span>
                        <span class="n">batch_counters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Waiting </span><span class="si">{:}</span><span class="s1"> sec for data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">),</span><span class="s1">&#39;yellow&#39;</span><span class="p">]</span>
                        <span class="n">post</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;counters&#39;</span> <span class="p">:</span> <span class="n">batch_counters</span><span class="p">})</span>

                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timeout loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wait</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span><span class="p">:</span>
                    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Try Loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...Waiting for </span><span class="si">{:}</span><span class="s1"> to become available...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...Timeout loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                                <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                
                <span class="n">_key_info</span><span class="p">,</span> <span class="n">_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">configStore</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;Partition&#39;</span> <span class="ow">in</span> <span class="n">_modules</span><span class="p">:</span>
                    <span class="n">try_idx</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#if not self.data_source.smd:</span>
                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exp </span><span class="si">{:}</span><span class="s1">, run </span><span class="si">{:}</span><span class="s1"> is has no Partition data.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PyDataSource requires Partition data.&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returning psana.DataSource(</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span>
                    <span class="k">elif</span> <span class="n">try_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">try_idx</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exp </span><span class="si">{:}</span><span class="s1">, run </span><span class="si">{:}</span><span class="s1"> smd data has no Partition data -- loading idx data instead.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">try_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">try_idx</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exp </span><span class="si">{:}</span><span class="s1">, run </span><span class="si">{:}</span><span class="s1"> smd data file not available -- loading idx data instead.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">try_idx</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">smd</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use smldata executable to convert idx data to smd data.&#39;</span><span class="p">)</span>
                    <span class="n">data_source_smd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span>
                    <span class="n">data_source_idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_source_smd</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;smd&#39;</span><span class="p">,</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">DataSourceInfo</span><span class="p">(</span><span class="n">data_source</span><span class="o">=</span><span class="n">data_source_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading idx </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to load either smd or idx data for exp </span><span class="si">{:}</span><span class="s1">, run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data can be restored from experiment data portal:  https://pswww.slac.stanford.edu&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span> <span class="o">=</span> <span class="n">EpicsData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">_evt_time_last</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_istep</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_irun</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jump_last</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">events</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idx_nsteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">nsteps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">times</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times_tuple</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">seconds</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">nanoseconds</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">fiducial</span><span class="p">())</span> \
                                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idx_datetime64</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> \
                                        <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span><span class="p">,</span><span class="n">fid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;BldInfo(EBeam)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="s1">&#39;BldInfo(EBeam)&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;EBeam&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s1">&#39;BldInfo(FEEGasDetEnergy)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="s1">&#39;BldInfo(FEEGasDetEnergy)&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">smd</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">Steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># SmdEvents automatically goes to next step if no events in current step.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">SmdEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">time</span>
                    <span class="kn">import</span> <span class="nn">psutils</span>
                    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">psutils</span><span class="o">.</span><span class="n">run_available</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;tut&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for </span><span class="si">{:}</span><span class="s1"> run</span><span class="si">{:}</span><span class="s1"> idx to become available...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timeout loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                            <span class="k">return</span> <span class="kc">None</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_scanData</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s1">&#39;live&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_source_idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;smd&#39;</span><span class="p">,</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
                        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Additional wait loading idx </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_idx_ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">data_source_idx</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for </span><span class="si">{:}</span><span class="s1"> to become available...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_source_idx</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timeout loading </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                                <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Additional loading idx </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_idx_ds</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">data_source_idx</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_ds</span><span class="o">.</span><span class="n">runs</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx_nsteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_run</span><span class="o">.</span><span class="n">nsteps</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_run</span><span class="o">.</span><span class="n">times</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times_tuple</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">seconds</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">nanoseconds</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">fiducial</span><span class="p">())</span> \
                                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_idx_datetime64</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> \
                                            <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span><span class="p">,</span><span class="n">fid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For live data or data_source without idx or smd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">Events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_evr</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reload the current run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_run</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset_stats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_stats</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset Welford stats objects.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs:  Optional list of stats objects to reset (e.g., [CsPad.calib_stats])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">alias</span><span class="p">,</span><span class="n">attr</span><span class="p">])</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">_add_default_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add default statistics for each Image and Waveform Detectors</span>
<span class="sd">        if not stats already created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">det</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">det</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">WaveformData</span><span class="p">:</span>
                        <span class="n">OKadd</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;waveform&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">det</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">ImageData</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">OKadd</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">OKadd</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">OKadd</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">OKadd</span><span class="p">:</span>
                            <span class="n">det</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
                            <span class="n">OKadd</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">OKadd</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1">#elif &#39;data&#39; in det._attrs:</span>
                    <span class="c1">#    # currently just zyla</span>
                    <span class="c1">#    det.add.stats(&#39;data&#39;, **kwargs)</span>
                    <span class="k">if</span> <span class="n">OKadd</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added default stats for &#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">])</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add stats for&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray Dataset of all Welford stats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray Dataset of Welford stats.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs:  Optional list of stats objects to save (e.g., [CsPad.calib_stats])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">alias</span><span class="p">,</span><span class="n">attr</span><span class="p">])</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">)))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add stats for&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datasets</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;merge failed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">datasets</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xsteps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xsteps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">control_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">pvAliases</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_steps&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">((</span><span class="s1">&#39;steps&#39;</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">xsteps</span><span class="p">])</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not add steps&#39;</span><span class="p">)</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data_source</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
            <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expNum</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not add attrs to stats Dataset&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">h5folder</span><span class="o">=</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="n">subfolder</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span>
            <span class="n">aliases</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save Welford stats as xarray compatible hdf5 files (using h5netcdf engine).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs:  Optional list of stats objects to save (e.g., [CsPad.calib_stats])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">data_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">aliases</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No stats to save&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_sets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save stats&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/Run</span><span class="si">{:04}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> 
                        <span class="n">exp</span><span class="p">,</span><span class="n">h5folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
            <span class="n">file_base</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">,</span><span class="s1">&#39;stats&#39;</span><span class="p">))</span>
   
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_ConfigData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ConfigData</span> <span class="o">=</span> <span class="n">ConfigData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xarray_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of keywords passed to to_xarray.  </span>
<span class="sd">        This information is saved/loaded with save_config/load_config methods.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_size : uint</span>
<span class="sd">            Maximum array size of data objects to build into xarray.</span>
<span class="sd">        pvs: list</span>
<span class="sd">            List of pvs to be loaded vs time</span>
<span class="sd">        epics_attrs: list</span>
<span class="sd">            List of epics pvs to be saved as run attributes based on inital value </span>
<span class="sd">            of first event.</span>
<span class="sd">        code_flags : dict</span>
<span class="sd">            Dictionary of event code flags. </span>
<span class="sd">            Default = {&#39;XrayOff&#39;: [162], &#39;XrayOn&#39;: [-162]}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;DataSource&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;DataSource&#39;</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataSource&#39;</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">submit_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Batch submission of run summary with auto report.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xarray_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">submit_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;../../bin/submit_summary&#39;</span><span class="p">)</span>
        <span class="n">bsubproc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bsubproc</span><span class="p">))</span>
            <span class="n">subproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">bsubproc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submit from ipython not yet available&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setup conda environment the same was as for ipython then:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; kinit&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">fomrat</span><span class="p">(</span><span class="n">bsubproc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build xarray object from PyDataSource.DataSource object.</span>
<span class="sd">        Same as to_hdf5 -- backwards compatability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">h5write</span>
        <span class="n">xarray_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xarray_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xarray_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">h5write</span><span class="o">.</span><span class="n">to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">xarray_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">build_html</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">build_html</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">build_html</span><span class="o">.</span><span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not build html run summary for&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="DataSource.to_hdf5"><a class="viewcode-back" href="../../generated/PyDataSource.DataSource.to_hdf5.html#PyDataSource.DataSource.to_hdf5">[docs]</a>    <span class="k">def</span> <span class="nf">to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write directly to hdf5 in xarray comatable netcdf4 format.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        build_html : bool</span>
<span class="sd">            Build run summary if True</span>
<span class="sd">        max_size : uint</span>
<span class="sd">            Maximum array size of data objects to build into xarray.</span>
<span class="sd">        nchunks: int</span>
<span class="sd">            number of chunks when using mpi</span>
<span class="sd">        pvs: list</span>
<span class="sd">            List of pvs to be loaded vs time</span>
<span class="sd">        epics_attrs: list</span>
<span class="sd">            List of epics pvs to be saved as run attributes based on inital value </span>
<span class="sd">            of first event.</span>
<span class="sd">        code_flags : dict</span>
<span class="sd">            Dictionary of event code flags. </span>
<span class="sd">            Default = {&#39;XrayOff&#39;: [162], &#39;XrayOn&#39;: [-162]}</span>
<span class="sd">        eventCodes : list</span>
<span class="sd">            List of event codes </span>
<span class="sd">            Default is all event codes in DataSource</span>
<span class="sd">        drop_unused_codes : bool</span>
<span class="sd">            If true drop unused eventCodes [default=True]</span>
<span class="sd">        default_stats : bool</span>
<span class="sd">            If true include stats for waveforms and calib image data.</span>
<span class="sd">        min_all_save : int</span>
<span class="sd">            Min number of events where all &#39;calib&#39; data saved.  Sets max_size = 1e10</span>
<span class="sd">        default_stats : bool</span>
<span class="sd">            If true automatically add default stats for all detectors that do not already</span>
<span class="sd">            have stats added</span>
<span class="sd">        auto_update : bool</span>
<span class="sd">            If true automatically update xarray info for all detectors</span>
<span class="sd">        auto_pvs : bool</span>
<span class="sd">            If true automatically add pvs that were moved during run.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span>  <span class="c1"># The process ID (integer 0-3 for 4-process run)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
        
        <span class="n">xarray_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xarray_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xarray_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">h5write</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">h5write</span><span class="o">.</span><span class="n">to_hdf5_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_html</span><span class="o">=</span><span class="n">build_html</span><span class="p">,</span> <span class="o">**</span><span class="n">xarray_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">h5write</span><span class="o">.</span><span class="n">to_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">xarray_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">build_html</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">build_html</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">build_html</span><span class="o">.</span><span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not build html run summary for&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">x</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configuration Data from ds.env().configStore().</span>
<span class="sd">        For effieciency only loaded at beginning of run or step unless</span>
<span class="sd">        working with shared memory.</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        ConfigData : class</span>
<span class="sd">            Configuation Data Access  </span>
<span class="sd">        </span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_ConfigData</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConfigData</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scanData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ScanData</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        ScanData : class</span>
<span class="sd">            Scan Data Access  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">ScanData</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detector sources</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Sources : class</span>
<span class="sd">            Event data sources</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">Sources</span>

    <span class="k">def</span> <span class="nf">_make_smd_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute script to make small data file for old files.        </span>
<span class="sd"> </span>
<span class="sd">            Usage:  ./smldata  [-f &lt;xtc filename&gt;] [-i &lt;input index&gt;] [-o &lt;index filename&gt;] [-s &lt;size threshold&gt;] [-h]</span>
<span class="sd">              Options:</span>
<span class="sd">                -h                     Show usage.</span>
<span class="sd">                -f &lt;xtc filename&gt;      Set input xtc filename</span>
<span class="sd">                -i &lt;index filename&gt;    Set input index filename</span>
<span class="sd">                   Note 1: -i option is used for testing. The program will parse</span>
<span class="sd">                     the index file to see if it is valid, and output to another</span>
<span class="sd">                     index file if -o option is specified</span>
<span class="sd">                   Note 2: -i will overwrite -f option</span>
<span class="sd">                -o &lt;index filename&gt;    Set output index filename</span>
<span class="sd">                -s &lt;size threshold&gt;    Set L1Accept xtc size threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
        <span class="n">xtc_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;xtc&#39;</span><span class="p">)</span>
        <span class="n">smd_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xtc_dir</span><span class="p">,</span><span class="s1">&#39;smalldata&#39;</span><span class="p">)</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="s1">&#39;/reg/common/package/pdsdata/8.7.3/x86_64-rhel7-opt/bin/&#39;</span>
        <span class="n">xtc_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">xtc_dir</span><span class="o">+</span><span class="s1">&#39;/*-r</span><span class="si">{:04}</span><span class="s1">-s*.xtc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">smd_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">smd_dir</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:  Need to have priviledge to do this...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ask for help from CDS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Execute the following commands from psana:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_in</span> <span class="ow">in</span> <span class="n">xtc_files</span><span class="p">:</span>
            <span class="n">file_out</span> <span class="o">=</span> <span class="n">file_in</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/xtc/&#39;</span><span class="p">,</span><span class="s1">&#39;/xtc/smalldata/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;xtc&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;smd.xtc&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_out</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">smldata -f </span><span class="si">{:}</span><span class="s1"> -o </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">file_in</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="c1">#subproc = subprocess.Popen(cmd, stdout=subprocess.PIPE, shell=True)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# Small data file already exists: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_out</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_init_detectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize psana.Detector classes based on psana env information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ConfigData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_aliases</span>

        <span class="k">for</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_dets</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="n">srcstr</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_init_evr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize evr. </span>
<span class="sd">        Requires first event to know which evr when more than one present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="s1">&#39;EvrData&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No EvrData in first </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ievent</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s1">&#39;EvrData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">:</span>
            <span class="n">evr_typ</span><span class="p">,</span> <span class="n">evr_src</span><span class="p">,</span> <span class="n">evr_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">evr_src</span><span class="p">)</span> 
            <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ievr</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evr</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="n">srcstr</span><span class="p">)</span>
            <span class="c1">#self._evr = psana.Detector(&#39;evr{:}&#39;.format(ievr))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evr_alias</span> <span class="o">=</span> <span class="s1">&#39;evr</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ievr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if no EvrData in event then try using first Evr</span>
            <span class="n">ievr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">ievr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evr</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="s1">&#39;evr</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ievr</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evr_alias</span> <span class="o">=</span> <span class="s1">&#39;evr</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ievr</span><span class="p">)</span>
                    <span class="n">ievr</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ievr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">ievr</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Erro. -- no evr present&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                     <span class="c1">#pvs=None, desc=None, parameters={}, </span>
                     <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a detector </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        srcstr : str</span>
<span class="sd">            Source string name or alias of detector</span>

<span class="sd">        alias : str</span>
<span class="sd">            Detector alias -- default uses srcstr</span>

<span class="sd">        module : str</span>
<span class="sd">            Name of python module that contains a user defined PyDataSource.Detector class</span>
<span class="sd">            with the same name as the module.  e.g., &#39;acqiris&#39; loads &#39;acqiris.py&#39; file </span>
<span class="sd">            which must have class Acqiris(PyDatasource.Detector)</span>

<span class="sd">        path : str</span>
<span class="sd">            Name of path for python module (default is the path of PyDataSource)</span>

<span class="sd">        desc : str</span>
<span class="sd">            Description </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">srcstr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source string name or alias must be supplied&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">srcstr</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">srcstr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">srcstr</span><span class="p">:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">srcstr</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> not a valid Detector&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># update aliases with srcstr -- required for old data</span>
                <span class="c1"># but could overwrite aliases for new data</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcstr</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">psana_src</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">srcstr</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">psana_src</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span>
                                                        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">psana_src</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">srcstr</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> alias already taken&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>

        <span class="n">det</span> <span class="o">=</span> <span class="n">alias</span>
        
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span> 
                    <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;opts&#39;</span><span class="p">:</span> <span class="p">{},</span> 
                    <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="p">{},</span> 
                    <span class="s1">&#39;property&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;psplot&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;xarray&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">alias</span>
        
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">srcname</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="n">srcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">devName</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">det_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="n">det_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span> <span class="s1">&#39;srcname&#39;</span><span class="p">:</span> <span class="n">srcname</span><span class="p">,</span> <span class="s1">&#39;srcstr&#39;</span><span class="p">:</span> <span class="n">srcstr</span><span class="p">,</span> <span class="s1">&#39;devName&#39;</span><span class="p">:</span> <span class="n">devName</span><span class="p">})</span>
            
            <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># First check for device configuration</span>
            
            <span class="k">if</span> <span class="n">det_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">):</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">module_path</span> <span class="o">=</span> <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="c1">#                module_name = det_dict[&#39;module&#39;].get(&#39;name&#39;,None)</span>
<span class="c1">#                if &#39;path&#39; in det_dict[&#39;module&#39;]:</span>
<span class="c1">#                    module_path = det_dict[&#39;module&#39;].get(&#39;path&#39;,&#39;&#39;)</span>
<span class="c1">#                else:</span>
<span class="c1">#                    module_path = &#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="n">module_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># Then use module and path keywords if applicable</span>
            <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">module_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Changing </span><span class="si">{alias}</span><span class="s1"> detector module from </span><span class="si">{module_name}</span><span class="s1"> to </span><span class="si">{module}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                               <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span><span class="n">module_name</span><span class="o">=</span><span class="n">module_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">module</span>
                <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

            <span class="c1"># Use defaults if not set by keyword or in device config</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module_name</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">srcname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;srcname&#39;</span><span class="p">,</span> <span class="p">{}):</span>
                    <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="p">[</span><span class="s1">&#39;srcname&#39;</span><span class="p">][</span><span class="n">srcname</span><span class="p">]</span>
                    <span class="n">module_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">devName</span> <span class="ow">and</span> <span class="n">devName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;devName&#39;</span><span class="p">,</span> <span class="p">{}):</span>
                    <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="p">[</span><span class="s1">&#39;devName&#39;</span><span class="p">][</span><span class="n">devName</span><span class="p">]</span>
                    <span class="n">module_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">module_name</span><span class="p">:</span>
                <span class="n">is_default_class</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_default_class</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_default_class</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">module_path</span> <span class="o">=</span> <span class="n">path</span>
        
                <span class="k">if</span> <span class="n">module_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using the path </span><span class="si">{module_path}</span><span class="s1"> for </span><span class="si">{module_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                               <span class="n">module_path</span><span class="o">=</span><span class="n">module_path</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="n">module_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">module_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_modules</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
                    
                <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_path</span>
                <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>

                <span class="n">new_class</span> <span class="o">=</span> <span class="n">get_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#                import_module(module_name, module_path)</span>
<span class="c1">#                try:</span>
<span class="c1">#                    new_class =  getattr(globals()[module_name],module_name)</span>
<span class="c1">#                except:</span>
<span class="c1">#                    new_class =  getattr(globals()[module_name],module_name.capitalize())</span>
                
                <span class="n">det_dict</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">new_class</span><span class="o">.</span><span class="vm">__dict__</span> \
                                              <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{alias}</span><span class="s1"> as </span><span class="si">{new_class}</span><span class="s1"> from </span><span class="si">{module_path}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                           <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span><span class="n">new_class</span><span class="o">=</span><span class="n">new_class</span><span class="p">,</span><span class="n">module_path</span><span class="o">=</span><span class="n">module_path</span><span class="p">))</span>
                
                <span class="n">nomodule</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">is_default_class</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{alias}</span><span class="s1"> as standard Detector class&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">))</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">Detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                <span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_dets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

<span class="c1">#    def add_plugin(self, cls, **kwargs):</span>
<span class="c1">#        self._plugins.update({cls.__name__: cls})</span>

    <span class="k">def</span> <span class="nf">_add_dets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">srcstr</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add </span><span class="si">{:}</span><span class="s1">:  </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">srcstr</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the full config file name.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">user_dir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">_get_user_dir</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/results&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="n">base_path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/res&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/summary_config&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">.config&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">file_name</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">.config&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">file_name</span>
            
        <span class="n">err_message</span> <span class="o">=</span> <span class="s1">&#39;No valid config file found for </span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
            

<div class="viewcode-block" id="DataSource.save_config"><a class="viewcode-back" href="../../generated/PyDataSource.DataSource.save_config.html#PyDataSource.DataSource.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save DataSource configuration.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name : str</span>
<span class="sd">            Name of file</span>
<span class="sd">        path : str</span>
<span class="sd">            Path of file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="c1">#file_name = self._get_config_file(run=self.data_source.run, path=path)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
                <span class="n">base_path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/results&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                    <span class="n">base_path</span> <span class="o">=</span> <span class="s1">&#39;/reg/d/psdm/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/res&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/summary_config&#39;</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">.config&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid file_name to save config&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataSource.load_config"><a class="viewcode-back" href="../../generated/PyDataSource.DataSource.load_config.html#PyDataSource.DataSource.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load DataSource configuration.  Overwrites any existing config and reloads DataSource.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run : int, optional</span>
<span class="sd">            Run number </span>
<span class="sd">        exp : str, optional</span>
<span class="sd">            Experiment name</span>
<span class="sd">        file_name : str, optional</span>
<span class="sd">            Name of file</span>
<span class="sd">        path : str, optional</span>
<span class="sd">            Path of file</span>
<span class="sd">        user : str, optional</span>
<span class="sd">            Name of user to load config file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_file</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

<span class="c1">#        attrs = [&#39;parameter&#39;, &#39;property&#39;, &#39;psplot&#39;, &#39;peak&#39;, </span>
<span class="c1">#                 &#39;roi&#39;, &#39;projection&#39;, &#39;xarray&#39;]</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No config file to load&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Config file not present: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Config file not present: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;module&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">module_dict</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">module_dict</span><span class="p">:</span>
                            <span class="c1"># Make sure start with event when loading</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_evt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">{:}</span><span class="s1"> detector object in data stream.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>

                            <span class="c1">#print alias, module_dict</span>
                            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span> 
                                           <span class="s1">&#39;srcstr&#39;</span><span class="p">:</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;srcstr&#39;</span><span class="p">),</span>
                                           <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                                           <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
                                           <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">module_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">)})</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add_detector&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not add detector module.&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="n">det_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_sets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">config_dict</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="c1"># Does not work yet to only try updating </span>
                            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                                        <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">bval</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">bval</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                                        <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;No overwrite&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">attr</span> <span class="o">!=</span> <span class="s1">&#39;stats&#39;</span><span class="p">:</span>
                            <span class="n">det_config</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span>

                    <span class="c1"># Need to be careful with stats objects to make sure added with dims correctly</span>
                    <span class="n">stats_config</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stats_config</span><span class="p">:</span>
                        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span>
                        <span class="k">while</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                            <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">detector</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stat_item</span> <span class="ow">in</span> <span class="n">stats_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">attr</span> <span class="o">=</span> <span class="n">stat_item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding stats for&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">)</span>
                            <span class="n">detector</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_load_small_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load small xarray Dataset. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">beam_stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">beam_stats</span><span class="o">.</span><span class="n">load_small_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show DataSource information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">:</span>
            <span class="n">repr_str</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nevents</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_funcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">(),</span> <span class="n">attr</span><span class="p">)()</span>
        
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds_attrs</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_ds_funcs</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_env_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">DataSource</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="Runs"><a class="viewcode-back" href="../../generated/PyDataSource.Runs.html#PyDataSource.Runs">[docs]</a><span class="k">class</span> <span class="nc">Runs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    psana DataSource Run iterator from ds.runs().</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Runs.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.Runs.html#PyDataSource.Runs.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_runs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_run</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        iterator</span>
<span class="sd">            Run iterator</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Run : class</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">runs</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_irun</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_init_detectors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_run</span> <span class="o">=</span> <span class="n">Run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_run</span></div>


<div class="viewcode-block" id="Run"><a class="viewcode-back" href="../../generated/PyDataSource.Run.html#PyDataSource.Run">[docs]</a><span class="k">class</span> <span class="nc">Run</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python psana.Run class from psana.DataSource.runs().next().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_run_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nsteps&#39;</span><span class="p">,</span> <span class="s1">&#39;times&#39;</span><span class="p">]</span>
    <span class="n">_run_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Run.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.Run.html#PyDataSource.Run.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;RunEvents Iterator.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        iterator</span>
<span class="sd">            Events in current run of DataSource.</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        RunEvents : class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RunEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>

<span class="c1">#    @property</span>
<span class="c1">#    def steps(self):</span>
<span class="c1">#        return RunSteps(self._ds)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_run</span><span class="p">,</span> <span class="n">attr</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_funcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_run</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_run_funcs</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Run</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<span class="c1">#class RunSteps(object):</span>
<span class="c1">#    &quot;&quot;&quot;Step iterator from psana.DataSource.runs().steps().</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    def __init__(self, ds, **kwargs):</span>
<span class="c1">#        self._ds = ds</span>
<span class="c1">#        self._kwargs = kwargs</span>
<span class="c1">#        self._ds_steps = []</span>
<span class="c1">#        self._configSteps = []</span>
<span class="c1">#</span>
<span class="c1">#    def __iter__(self):</span>
<span class="c1">#        return self</span>
<span class="c1">#</span>
<span class="c1">#    def next(self):</span>
<span class="c1">#        try:</span>
<span class="c1">#            self._ds._ievent = -1</span>
<span class="c1">#            self._ds._istep +=1</span>
<span class="c1">#            self._ds._ds_step = self._ds._current_run.steps().next()</span>
<span class="c1">#            self._ds_steps.append(self._ds._ds_step)</span>
<span class="c1">#            self._ds._init_detectors()</span>
<span class="c1">#            return StepEvents(self._ds)</span>
<span class="c1">#        </span>
<span class="c1">#        except: </span>
<span class="c1">#            raise StopIteration()</span>


<div class="viewcode-block" id="RunEvents"><a class="viewcode-back" href="../../generated/PyDataSource.RunEvents.html#PyDataSource.RunEvents">[docs]</a><span class="k">class</span> <span class="nc">RunEvents</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event iterator from ds.runs() for indexed idx data </span>

<span class="sd">    No support yet for multiple runs in a data_source</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RunEvents.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.RunEvents.html#PyDataSource.RunEvents.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">runs</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">times</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current event.</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        EvtDetectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optionally pass either an integer for the event number in the data_source</span>
<span class="sd">           or a psana.EventTime time stamp to jump to an event.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evt_time : object or int</span>
<span class="sd">            psana.EventTime time stamp to jump to specific event,</span>
<span class="sd">            if int is supplied goto event number in DataSource (may not be exactly</span>
<span class="sd">            same event depending on how the data_source string is corresponding</span>
<span class="sd">            keywords to define the data_source is defined and also may differ</span>
<span class="sd">            for fast feedback and offline analysis environments.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventDetectors : object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">evt_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evt_time</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="n">evt_time</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">evt_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_run</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span><span class="p">])</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span> <span class="o">=</span> <span class="n">evt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1">#if hasattr(self._ds, &#39;_idx_istep&#39;):</span>
            <span class="c1">#if self._ds._idx_istep:</span>
            <span class="c1">#    self._ds._istep = self._ds._idx_istep[self._ds._ievent]</span>

            <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span></div>


<div class="viewcode-block" id="SmdEvents"><a class="viewcode-back" href="../../generated/PyDataSource.SmdEvents.html#PyDataSource.SmdEvents">[docs]</a><span class="k">class</span> <span class="nc">SmdEvents</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event iterator for smd xtc data that iterates first over steps and then</span>
<span class="sd">    events in steps (to make sure configData is updated for each step since</span>
<span class="sd">    it is possible that it changes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SmdEvents.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.SmdEvents.html#PyDataSource.SmdEvents.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evt_time : object or int</span>
<span class="sd">            psana.EventTime time stamp (second, nanosecond, fiducial) to jump to </span>
<span class="sd">            specific event,</span>
<span class="sd">            If int is supplied goto event number in DataSource (may not be exactly</span>
<span class="sd">            same event depending on how the data_source string is corresponding</span>
<span class="sd">            keywords to define the data_source is defined and also may differ</span>
<span class="sd">            for fast feedback and offline analysis environments.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventDetectors object</span>
<span class="sd">            Returns next event in current step.  </span>
<span class="sd">            If at end of step goes to next step and returns first event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_step</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">evt_time</span><span class="o">=</span><span class="n">evt_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_step</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span></div>


<div class="viewcode-block" id="Steps"><a class="viewcode-back" href="../../generated/PyDataSource.Steps.html#PyDataSource.Steps">[docs]</a><span class="k">class</span> <span class="nc">Steps</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Step iterator from ds.steps().</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Steps.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.Steps.html#PyDataSource.Steps.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_steps</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_step</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Step iteration method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        StepEvents object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_run</span><span class="o">.</span><span class="n">nsteps</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">steps</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_step</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_init_detectors</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_step</span> <span class="o">=</span> <span class="n">StepEvents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_step</span>

        <span class="k">except</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span></div>


<div class="viewcode-block" id="StepEvents"><a class="viewcode-back" href="../../generated/PyDataSource.StepEvents.html#PyDataSource.StepEvents">[docs]</a><span class="k">class</span> <span class="nc">StepEvents</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event iterator from ds.steps().events() </span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="StepEvents.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.StepEvents.html#PyDataSource.StepEvents.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Next event in step.  If no evt_time provided, the event loop will</span>
<span class="sd">        procede from the last event in the step regardless of which event </span>
<span class="sd">        was previously jumped to.</span>

<span class="sd">        Optional Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evt_time : object or int</span>
<span class="sd">            psana.EventTime time stamp (second, nanosecond, fiducial) to jump to </span>
<span class="sd">            specific event,</span>
<span class="sd">            If int is supplied goto event number in DataSource (may not be exactly</span>
<span class="sd">            same event depending on how the data_source string is corresponding</span>
<span class="sd">            keywords to define the data_source is defined and also may differ</span>
<span class="sd">            for fast feedback and offline analysis environments.</span>
<span class="sd">        recover : bool</span>
<span class="sd">            recover the last step before a jump</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventDetectors object</span>
<span class="sd">            Returns next event in current step.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">evt_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Jump to the specified event</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># keep trak of event index to go back to step event loop</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_jump_last</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">evt_time</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;EventTime&#39;</span><span class="p">:</span>
                    <span class="c1"># lookup event index from time tuple</span>
                    <span class="n">ttup</span> <span class="o">=</span> <span class="p">(</span><span class="n">evt_time</span><span class="o">.</span><span class="n">seconds</span><span class="p">(),</span> <span class="n">evt_time</span><span class="o">.</span><span class="n">nanoseconds</span><span class="p">(),</span> <span class="n">evt_time</span><span class="o">.</span><span class="n">fiducial</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ttup</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evt_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="c1"># optionally accept a time tuple (seconds, nanoseconds, fiducial)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_times_tuple</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">evt_time</span><span class="p">)</span>
                    <span class="n">evt_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if an integer was passed jump to the appropriate time from </span>
                    <span class="c1"># the list of run times -- i.e., psana.DataSource.runs().next().times()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="n">evt_time</span>
                    <span class="n">evt_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_times</span><span class="p">[</span><span class="n">evt_time</span><span class="p">]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_scanData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_istep</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#print(&#39;Warning -- must load configData.ScanData before steps can be updated when jumping to events&#39;)</span>
                        <span class="k">pass</span>
                
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting istep&#39;</span><span class="p">)</span>

                <span class="c1">#print self._ds._ievent, evt_time.seconds(), evt_time.nanoseconds()</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_run</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">evt_time</span><span class="p">)</span> 
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span> <span class="o">=</span> <span class="n">evt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">evt_time</span><span class="p">,</span> <span class="s1">&#39;is not a valid event time&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_jump_last</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">recover</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># recover event and step index after previoiusly jumping to an event </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent_last</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep_last</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds_step</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span> <span class="o">=</span> <span class="n">evt</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_jump_last</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Events"><a class="viewcode-back" href="../../generated/PyDataSource.Events.html#PyDataSource.Events">[docs]</a><span class="k">class</span> <span class="nc">Events</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event iterator</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Events.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.Events.html#PyDataSource.Events.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_init_detectors</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EventDetectors : object</span>
<span class="sd">            Returns next event in DataSource.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span> <span class="o">=</span> <span class="n">evt</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">EvtDetectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PsanaTypeList"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaTypeList.html#PyDataSource.PsanaTypeList">[docs]</a><span class="k">class</span> <span class="nc">PsanaTypeList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python representation for lists of psana data objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PsanaTypeList.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaTypeList.html#PyDataSource.PsanaTypeList.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_list</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_list</span> <span class="o">=</span> <span class="n">type_list</span>
        <span class="n">typ_func</span> <span class="o">=</span> <span class="n">type_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_typ_func</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;psana.&#39;</span><span class="p">)</span>
        <span class="n">type_name</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">psana_doc_info</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span> <span class="o">=</span> <span class="n">typ_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_list</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
<span class="c1">#                print module, type_name, info</span>
<span class="c1">#                print values</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_typ_func&#39;</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">PsanaTypeList</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_all_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All values in a flattened dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">avalues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;_all_values&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">avalues</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avalues</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">avalues</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a table of the attribute, value, unit and doc information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr&#39;</span><span class="p">)</span>
                <span class="n">str_repr</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">alias</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24s}</span><span class="s1"> </span><span class="si">{:&gt;12}</span><span class="s1"> </span><span class="si">{:7}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">str_repr</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">PsanaTypeList</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="PsanaTypeData"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaTypeData.html#PyDataSource.PsanaTypeData">[docs]</a><span class="k">class</span> <span class="nc">PsanaTypeData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python representation of a psana data object (event or configStore data).</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PsanaTypeData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaTypeData.html#PyDataSource.PsanaTypeData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ_func</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ_func</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span> <span class="o">=</span> <span class="n">typ_func</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;psana.&#39;</span><span class="p">)</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nolist</span> <span class="o">=</span> <span class="n">nolist</span>

        <span class="k">if</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="n">psana_doc_info</span><span class="p">[</span><span class="n">module</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">psana_doc_info</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">psana_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">type_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psana_attrs</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">type_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>
            
            <span class="c1">#print module,        </span>
 
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">typ_func</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_typ_func_attr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="n">nolist</span><span class="p">)</span></div>
        
<span class="c1">#        self._attr_info_new = {}</span>
<span class="c1">#        for attr in self._attrs_new:</span>
<span class="c1">#            self._attr_info_new[attr] = _get_typ_func_attr(typ_func, attr, nolist=nolist)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of attributes: values. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_all_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All values in a flattened dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">avalues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;_all_values&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">avalues</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avalues</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">avalues</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show a table of the attribute, value, unit and doc information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">alias</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;show_info&#39;</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str_repr</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24s}</span><span class="s1"> </span><span class="si">{:&gt;12}</span><span class="s1"> </span><span class="si">{:7}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">str_repr</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">.</span><span class="si">{:}</span><span class="s1">.</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> 
                                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">PsanaTypeData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="PsanaSrcData"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaSrcData.html#PyDataSource.PsanaSrcData">[docs]</a><span class="k">class</span> <span class="nc">PsanaSrcData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python represenation of psana data for a given detector source.</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key_info : get_key_info(objclass) </span>
<span class="sd">        for faster evt data access.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PsanaSrcData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.PsanaSrcData.html#PyDataSource.PsanaSrcData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objclass</span><span class="p">,</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">key_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_srcstr</span> <span class="o">=</span> <span class="n">srcstr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_info</span><span class="p">:</span>
            <span class="n">key_info</span> <span class="o">=</span> <span class="n">get_key_info</span><span class="p">(</span><span class="n">objclass</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">srcstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">typ_func</span> <span class="o">=</span> <span class="n">objclass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">typ_func</span> <span class="o">=</span> <span class="n">objclass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">):</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;psana.&#39;</span><span class="p">)</span>
                    <span class="n">type_name</span> <span class="o">=</span> <span class="n">typ_func</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="n">type_alias</span> <span class="o">=</span> <span class="n">module</span><span class="o">+</span><span class="n">type_name</span><span class="o">+</span><span class="n">key</span> 
                    <span class="n">type_data</span> <span class="o">=</span> <span class="n">PsanaTypeData</span><span class="p">(</span><span class="n">typ_func</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="n">nolist</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">[</span><span class="n">type_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_data</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_type_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="n">type_alias</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">type_data</span><span class="o">.</span><span class="n">_attrs</span><span class="p">})</span>
                    <span class="c1">#self._types[(typ,key)] = type_data </span>
                    <span class="c1">#self._type_attrs.update({attr: (typ,key) for attr in type_data._attrs})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span></div>
                    <span class="c1"># psana.EventId is in configStore keys after ana-1.3.10</span>
                    <span class="c1"># Not necessary so do nothing for now but avoid error here</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">type_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">type_data</span><span class="o">.</span><span class="n">_attrs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">attrs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_attr_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attribute information including the unit and doc information </span>
<span class="sd">           and a str representation of the value for all data types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">type_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">attr_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">type_data</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">attr_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of attributes: values for all data types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">type_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">type_data</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_all_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All values in a flattened dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">type_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">type_data</span><span class="o">.</span><span class="n">_all_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a table of the attribute, value, unit and doc information</span>
<span class="sd">           for all data types of the given source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">type_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">type_data</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">_get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_srcstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">attr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                   <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">PsanaSrcData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ConfigData"><a class="viewcode-back" href="../../generated/PyDataSource.ConfigData.html#PyDataSource.ConfigData">[docs]</a><span class="k">class</span> <span class="nc">ConfigData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration Data representation of configStore within psana.DataSource.env object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : DataSource object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_configStore_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span><span class="s1">&#39;put&#39;</span><span class="p">,</span><span class="s1">&#39;keys&#39;</span><span class="p">]</span>
    <span class="c1"># Alias default provides way to keep aliases consistent for controls devices like the FEE_Spec</span>
    <span class="n">_alias_defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BldInfo(FEE-SPEC0)&#39;</span><span class="p">:</span>       <span class="s1">&#39;FEE_Spec0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BldInfo(NH2-SB1-IPM-01)&#39;</span><span class="p">:</span>  <span class="s1">&#39;Nh2Sb1_Ipm1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BldInfo(NH2-SB1-IPM-02)&#39;</span><span class="p">:</span>  <span class="s1">&#39;Nh2Sb1_Ipm2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BldInfo(MFX-BEAMMON-01)&#39;</span><span class="p">:</span>  <span class="s1">&#39;MfxBeammon&#39;</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="n">_seq_evtCodes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">167</span><span class="p">,</span><span class="mi">199</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="mi">217</span><span class="p">)</span>
    <span class="n">_lcls_evtCodes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">140</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 120Hz&#39;</span><span class="p">,</span>
            <span class="mi">141</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 60Hz&#39;</span><span class="p">,</span>
            <span class="mi">142</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 30Hz&#39;</span><span class="p">,</span>
            <span class="mi">143</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 10Hz&#39;</span><span class="p">,</span>
            <span class="mi">144</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 5Hz&#39;</span><span class="p">,</span>
            <span class="mi">145</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 1Hz&#39;</span><span class="p">,</span>
            <span class="mi">146</span><span class="p">:</span> <span class="s1">&#39;Beam &amp; 0.5Hz&#39;</span><span class="p">,</span>
            <span class="mi">147</span><span class="p">:</span> <span class="s1">&#39;Full N-1&#39;</span><span class="p">,</span>
            <span class="mi">148</span><span class="p">:</span> <span class="s1">&#39;Full N-2&#39;</span><span class="p">,</span>
            <span class="mi">149</span><span class="p">:</span> <span class="s1">&#39;TCAV0&#39;</span><span class="p">,</span>
            <span class="mi">150</span><span class="p">:</span> <span class="s1">&#39;Burst&#39;</span><span class="p">,</span>
            <span class="mi">151</span><span class="p">:</span> <span class="s1">&#39;Klys Accel&#39;</span><span class="p">,</span>
            <span class="mi">152</span><span class="p">:</span> <span class="s1">&#39;Klys Standby&#39;</span><span class="p">,</span>
            <span class="mi">153</span><span class="p">:</span> <span class="s1">&#39;Klys Standby no TCAV0&#39;</span><span class="p">,</span>
            <span class="mi">154</span><span class="p">:</span> <span class="s1">&#39;Klys Accel at 10 Hz&#39;</span><span class="p">,</span>
            <span class="mi">155</span><span class="p">:</span> <span class="s1">&#39;Straight Ahead&#39;</span><span class="p">,</span>
            <span class="mi">156</span><span class="p">:</span> <span class="s1">&#39;TCAV3&#39;</span><span class="p">,</span>
            <span class="mi">157</span><span class="p">:</span> <span class="s1">&#39;Klys StdBy No TCAV3&#39;</span><span class="p">,</span>
            <span class="mi">158</span><span class="p">:</span> <span class="s1">&#39;Pockets Cell&#39;</span><span class="p">,</span>
            <span class="mi">159</span><span class="p">:</span> <span class="s1">&#39;Profile Monitors&#39;</span><span class="p">,</span>
            <span class="mi">160</span><span class="p">:</span> <span class="s1">&#39;TCAV3 OTR&#39;</span><span class="p">,</span>
            <span class="mi">161</span><span class="p">:</span> <span class="s1">&#39;BXKIK&#39;</span><span class="p">,</span>
            <span class="mi">162</span><span class="p">:</span> <span class="s1">&#39;BYKIK&#39;</span><span class="p">,</span>
            <span class="mi">163</span><span class="p">:</span> <span class="s1">&#39;A-line Kicker&#39;</span><span class="p">,</span>
            <span class="mi">164</span><span class="p">:</span> <span class="s1">&#39;Test Burst&#39;</span><span class="p">,</span>
            <span class="mi">165</span><span class="p">:</span> <span class="s1">&#39;Spare&#39;</span><span class="p">,</span>
            <span class="mi">40</span><span class="p">:</span> <span class="s1">&#39;120 Hz&#39;</span><span class="p">,</span>
            <span class="mi">41</span><span class="p">:</span> <span class="s1">&#39;60 Hz&#39;</span><span class="p">,</span>
            <span class="mi">42</span><span class="p">:</span> <span class="s1">&#39;30 Hz&#39;</span><span class="p">,</span>
            <span class="mi">43</span><span class="p">:</span> <span class="s1">&#39;10 Hz&#39;</span><span class="p">,</span>
            <span class="mi">44</span><span class="p">:</span> <span class="s1">&#39;5 Hz&#39;</span><span class="p">,</span>
            <span class="mi">45</span><span class="p">:</span> <span class="s1">&#39;1 Hz&#39;</span><span class="p">,</span>
            <span class="mi">46</span><span class="p">:</span> <span class="s1">&#39;0.5 Hz&#39;</span><span class="p">,</span>
            <span class="p">}</span>

<div class="viewcode-block" id="ConfigData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.ConfigData.html#PyDataSource.ConfigData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="n">configStore</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">configStore</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;data_source&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">monshmserver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span> <span class="o">=</span> <span class="kc">None</span> 
       
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configStore</span> <span class="o">=</span> <span class="n">configStore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">get_keys</span><span class="p">(</span><span class="n">configStore</span><span class="p">)</span>

        <span class="c1"># Build _config dictionary for each source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">PsanaSrcData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_configStore</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> 
                                      <span class="n">key_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_info</span><span class="p">,</span> <span class="n">nolist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:  Cannot load PsanaSrcData config for &#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#Setup Partition</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Partition&#39;</span><span class="p">):</span>
            <span class="c1">#print &#39;ERROR:  No Partition module in configStore data.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_srcAlias</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">srcstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BldInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;DetInfo&#39;</span><span class="p">]:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">srcstr</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                               <span class="c1">#&#39;alias&#39;: alias, </span>
                                               <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                                               <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">}</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_srcAlias</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_bldMask</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ipAddrpartition</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">[]}}</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;Partition&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR:  More than one Partition config type in configStore data.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Build _partition _srcAlias _readoutGroup dictionaries based on Partition configStore data. </span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Partition&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;Partition&#39;</span><span class="p">][</span><span class="n">type_name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;Partition&#39;</span><span class="p">][</span><span class="n">type_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Partition</span> <span class="o">=</span> <span class="n">config</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR:  More that one Partition module in configStore data.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;Partition&#39;</span><span class="p">][</span><span class="n">type_name</span><span class="p">])</span>
                <span class="k">return</span>

    <span class="c1"># to convert ipAddr int to address </span>
    <span class="c1"># import socket, struct</span>
    <span class="c1"># s = key.src()</span>
    <span class="c1"># socket.inet_ntoa(struct.pack(&#39;!L&#39;,s.ipAddr()))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ipAddrPartition</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">ipAddr</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bldMask</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">bldMask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;eventCodes&#39;</span><span class="p">:</span> <span class="p">[]}</span> \
                                  <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">group</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">}</span> \
                               <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">src</span><span class="p">)}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_srcAlias</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Alias&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;Alias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                        <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span>
                        <span class="n">ipAddr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">ipAddr</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">srcAlias</span><span class="o">.</span><span class="n">src</span><span class="p">):</span>
                            <span class="n">alias</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">srcAlias</span><span class="o">.</span><span class="n">aliasName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_srcAlias</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ipAddr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srcAlias</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ipAddr</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="p">[</span><span class="n">srcstr</span><span class="p">][</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>
                <span class="k">if</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;NoDetector&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcstr</span>
                
                <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">ipAddr</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipAddrPartition</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span><span class="p">:</span>
                    <span class="c1"># add data sources not in partition for live data</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># add data sources not in partition that come from recording nodes</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcstr</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;eventCodes&#39;</span><span class="p">:</span> <span class="p">[]}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">}</span>
            
            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;srcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srcstr</span><span class="p">)</span>
            <span class="c1">#else:</span>
            <span class="c1">#    print &#39;No group for&#39;, srcstr</span>

        <span class="c1"># Determine data sources and update aliases</span>
        <span class="k">for</span> <span class="n">srcstr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Evr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">srcstr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_defaults</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">srcstr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">alias</span> <span class="o">=</span> <span class="n">srcstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Info(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">alias</span> <span class="o">=</span> <span class="n">srcstr</span>
                
                <span class="n">alias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">alias</span><span class="p">)</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcstr</span>

            <span class="k">if</span> <span class="s1">&#39;NoDetector&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">srcstr</span> <span class="ow">and</span> <span class="s1">&#39;NoDevice&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">srcstr</span><span class="p">:</span>
                <span class="c1"># sources not recorded have group None</span>
                <span class="c1"># only include these devices for shared memory</span>
                <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Make dictionary of src: alias for sources with config objects </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_srcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config_srcs</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attr</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_maps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evr_pulses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">IOCconfig_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">config_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">type_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;IOConfig&#39;</span><span class="p">):</span>
                <span class="n">IOCconfig_type</span> <span class="o">=</span> <span class="n">type_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_IOCconfig_type</span> <span class="o">=</span> <span class="n">type_name</span>
            <span class="k">elif</span> <span class="n">type_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Config&#39;</span><span class="p">):</span>
                <span class="n">config_type</span> <span class="o">=</span> <span class="n">type_name</span>

        <span class="k">if</span> <span class="n">IOCconfig_type</span><span class="p">:</span>
            <span class="c1"># get eventcodes and combine output_map info from all EvrData config keys</span>
            <span class="n">map_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;conn_id&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;source_id&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">][</span><span class="n">config_type</span><span class="p">]:</span>
                <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">eventcode</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">eventcodes</span><span class="o">.</span><span class="n">_type_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># No archive on shared memory currently</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_init_arch</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot initialize archive&#39;</span><span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">eventcode</span><span class="o">.</span><span class="n">code</span><span class="p">:</span> <span class="n">eventcode</span><span class="o">.</span><span class="n">_values</span><span class="p">})</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">code_num</span> <span class="o">=</span> <span class="n">eventcode</span><span class="o">.</span><span class="n">code</span>
                        <span class="k">if</span> <span class="n">code_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_evtCodes</span><span class="p">:</span> 
                            <span class="n">owner_pv</span> <span class="o">=</span> <span class="s1">&#39;ECS:SYS0:0:EC_</span><span class="si">{:}</span><span class="s1">_OWNER_ID&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_num</span><span class="p">)</span>
                            <span class="n">desc_pv</span>  <span class="o">=</span> <span class="s1">&#39;EVNT:SYS0:1:NAME</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code_num</span><span class="p">)</span>
                            <span class="n">owner_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">owner_pv</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
                            <span class="n">desc_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">desc_pv</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">[</span><span class="n">code_num</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc_val</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">[</span><span class="n">code_num</span><span class="p">][</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">owner_val</span>
                        <span class="k">elif</span> <span class="n">code_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lcls_evtCodes</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">[</span><span class="n">code_num</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lcls_evtCodes</span><span class="p">[</span><span class="n">code_num</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">eventcode</span><span class="o">.</span><span class="n">isReadout</span><span class="p">:</span>
                        <span class="n">group</span> <span class="o">=</span> <span class="n">eventcode</span><span class="o">.</span><span class="n">readoutGroup</span>
                        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;eventCodes&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eventcode</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">output_map</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">output_maps</span><span class="o">.</span><span class="n">_type_list</span><span class="p">:</span>
                    <span class="n">map_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_map</span><span class="o">.</span><span class="n">module</span><span class="p">,</span><span class="n">output_map</span><span class="o">.</span><span class="n">conn_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">output_map</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;Pulse&#39;</span><span class="p">:</span>
                        <span class="n">pulse_id</span> <span class="o">=</span> <span class="n">output_map</span><span class="o">.</span><span class="n">source_id</span>
                        <span class="n">pulse</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pulses</span><span class="o">.</span><span class="n">_type_list</span><span class="p">[</span><span class="n">pulse_id</span><span class="p">]</span>
                        <span class="n">evr_info</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;evr_width&#39;</span><span class="p">:</span> <span class="n">pulse</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="n">pulse</span><span class="o">.</span><span class="n">prescale</span><span class="o">/</span><span class="mf">119.e6</span><span class="p">,</span> 
                                     <span class="s1">&#39;evr_delay&#39;</span><span class="p">:</span> <span class="n">pulse</span><span class="o">.</span><span class="n">delay</span><span class="o">*</span><span class="n">pulse</span><span class="o">.</span><span class="n">prescale</span><span class="o">/</span><span class="mf">119.e6</span><span class="p">,</span> 
                                     <span class="s1">&#39;evr_polarity&#39;</span><span class="p">:</span> <span class="n">pulse</span><span class="o">.</span><span class="n">polarity</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pulse_id</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">pulse</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">evr_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;evr_width&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;evr_delay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;evr_polarity&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_output_maps</span><span class="p">[</span><span class="n">map_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">output_map</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">map_attrs</span><span class="p">}</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_output_maps</span><span class="p">[</span><span class="n">map_key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">evr_info</span><span class="p">)</span> 

            <span class="c1"># Assign evr info to the appropriate sources</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">][</span><span class="n">IOCconfig_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: More than one EvrData.</span><span class="si">{:}</span><span class="s1"> objects&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">IOCconfig_type</span><span class="p">))</span>

            <span class="n">IOCconfig_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IOCconfig_type</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">][</span><span class="n">IOCconfig_type</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">srcstr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_type_list</span><span class="p">:</span>
                    <span class="n">map_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">conn_id</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">ninfo</span><span class="p">):</span>
                        <span class="n">src</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">infos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">][</span><span class="s1">&#39;map_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_key</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;evr_width&#39;</span><span class="p">,</span> <span class="s1">&#39;evr_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;evr_polarity&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_maps</span><span class="p">[</span><span class="n">map_key</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readoutGroup</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;srcs&#39;</span><span class="p">]:</span> 
                        <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">][</span><span class="s1">&#39;eventCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get control data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ControlData&#39;</span><span class="p">):</span>
            <span class="n">type_name</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;ControlData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_controlData</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ControlData</span> <span class="o">=</span> <span class="n">config</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SmlData&#39;</span><span class="p">):</span>
            <span class="n">type_name</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">[</span><span class="s1">&#39;SmlData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">typ</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smlData</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_values</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">config_check</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configCheck</span> <span class="o">=</span> <span class="n">config_check</span><span class="o">.</span><span class="n">ConfigCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_init_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Epics Archive access</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">epicsarchive</span> <span class="k">import</span> <span class="n">EpicsArchive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span> <span class="o">=</span> <span class="n">EpicsArchive</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_datetime64</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tstart</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_idx_datetime64</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tend</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_pv_from_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tstart</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tstart</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tend</span><span class="p">:</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tend</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="o">.</span><span class="n">_get_json</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_in_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if pv is in archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="o">.</span><span class="n">search_pvs</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">save_configData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save sources, eventCodes and ScanData xarray datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">scan_file</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="s1">&#39;scan&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">scan_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save scan config for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eventCode_file</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="s1">&#39;eventCodes&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">eventCodes</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">eventCode_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save eventCode config for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">))</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eventCode_file</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="s1">&#39;eventCodes&#39;</span><span class="p">)</span>
            <span class="n">sources_file</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/run</span><span class="si">{:04}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="s1">&#39;sources&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">sources_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save source config for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Source information including evr config.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ConfigSources object</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConfigSources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ScanData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan configuration from steps ControlData.  </span>
<span class="sd">        May take several seconds to load the first time.</span>
<span class="sd">        Only relevant for smd data.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ScanData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if self._ds.data_source.monshmserver is not None:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">smd</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_scanData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_scanData</span> <span class="o">=</span> <span class="n">ScanData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_scanData</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_scanData</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_codes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show Detector Source information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Source Information:&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_codes</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Event Code Information:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">show_eventCodes</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Detector Source Information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">show_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show Detector Source and ScanData information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Source Information:&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Scan Data:&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ScanData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s1">&#39;ConfigData: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sources</span><span class="o">.</span><span class="n">show_info</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_srcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_srcs</span><span class="p">[</span><span class="n">attr</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configStore_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_configStore</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_configStore_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_config_srcs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">ConfigData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EvtDetectors"><a class="viewcode-back" href="../../generated/PyDataSource.EvtDetectors.html#PyDataSource.EvtDetectors">[docs]</a><span class="k">class</span> <span class="nc">EvtDetectors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Psana tab accessible event detectors.</span>
<span class="sd">    All detectors in Partition or defined in any configStore Alias object </span>
<span class="sd">    (i.e., recording nodes as well as daq) return the relevant attributes of </span>
<span class="sd">    a PyDetector object for that src, but only the sources in the evt.keys()</span>
<span class="sd">    show up in the ipython tab accessible dir.</span>
<span class="sd">    </span>
<span class="sd">    Preserves get, keys and run method of items in psana events iterators.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : DataSource object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_init_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">]</span> <span class="c1">#  &#39;run&#39; depreciated</span>
    <span class="n">_event_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EventId&#39;</span><span class="p">,</span> <span class="s1">&#39;Evr&#39;</span><span class="p">,</span> <span class="s1">&#39;L3T&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EvtDetectors.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EvtDetectors.html#PyDataSource.EvtDetectors.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">,</span> <span class="n">update_stats</span><span class="o">=</span><span class="n">update_stats</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_stats</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">publish</span><span class="p">:</span>
            <span class="n">psmon_publish</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_stats</span><span class="p">:</span>
            <span class="n">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
 
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EventId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EventId object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EventId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of detector names in current evt data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">alias</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_aliases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                                        <span class="k">if</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_dets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of detectors.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataSource._detectors dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_detectors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Evr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Master evr from psana evt data.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EvrData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;EvrData&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EvrData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EvrNullData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">L3T</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        L3T Level 3 trigger.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        L3Tdata object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;L3T&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">L3Tdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">L3Ttrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run number.  For shared memory when not recording will be a large int</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<div class="viewcode-block" id="EvtDetectors.next"><a class="viewcode-back" href="../../generated/PyDataSource.EvtDetectors.next.html#PyDataSource.EvtDetectors.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EvtDetectors : object</span>
<span class="sd">            Next event in DataSource (behavior depends on if smd, idx options used in data_source)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">evt</span></div>

    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nevents</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor events continuously.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">ievent</span> <span class="o">=</span> <span class="n">nevents</span>
        <span class="k">while</span> <span class="n">ievent</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="k">if</span> <span class="n">ievent</span> <span class="o">&lt;</span> <span class="n">nevents</span> <span class="ow">and</span> <span class="n">sleep</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">)</span>

                <span class="n">ievent</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">ievent</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">, Run </span><span class="si">{:}</span><span class="s1">, Step </span><span class="si">{:}</span><span class="s1">, Event </span><span class="si">{:}</span><span class="s1">, </span><span class="si">{:}</span><span class="s1">, </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span><span class="p">,</span> 
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EventId</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Evr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_detectors</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_detectors</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_init_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EvtDetectors</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="L3Ttrue"><a class="viewcode-back" href="../../generated/PyDataSource.L3Ttrue.html#PyDataSource.L3Ttrue">[docs]</a><span class="k">class</span> <span class="nc">L3Ttrue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    L3 Trigger default if no L3 Trigger data is in DataSource.</span>
<span class="sd">    Typically only used for older data where no L3 Trigger data was generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="L3Ttrue.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.L3Ttrue.html#PyDataSource.L3Ttrue.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;doc&#39;</span><span class="p">:</span>  <span class="s1">&#39;No L3T set&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of attributes: values. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show a table of the attribute, value, unit and doc information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;show_info&#39;</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:24s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">L3Ttrue</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="L3Tdata"><a class="viewcode-back" href="../../generated/PyDataSource.L3Tdata.html#PyDataSource.L3Tdata">[docs]</a><span class="k">class</span> <span class="nc">L3Tdata</span><span class="p">(</span><span class="n">PsanaTypeData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    L3 Trigger data</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="L3Tdata.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.L3Tdata.html#PyDataSource.L3Tdata.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_typ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">[</span><span class="s1">&#39;L3T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">typ_func</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typ</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_src</span><span class="p">)</span>
        <span class="n">PsanaTypeData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ_func</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<div class="viewcode-block" id="ConfigSources"><a class="viewcode-back" href="../../generated/PyDataSource.ConfigSources.html#PyDataSource.ConfigSources">[docs]</a><span class="k">class</span> <span class="nc">ConfigSources</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration Sources</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    configData : ConfigData object</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConfigSources.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.ConfigSources.html#PyDataSource.ConfigSources.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configData</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]:</span> <span class="n">src</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg_srcs</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_config_srcs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">configData</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span> <span class="o">=</span> <span class="n">configData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span> <span class="o">=</span> <span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray of sources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">xsources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;alias&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;src&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;map_key&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xsources</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">xsources</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SourceData</span><span class="o">.</span><span class="n">_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">xsources</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SourceData</span><span class="o">.</span><span class="n">_units</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">xsources</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
            <span class="n">xsources</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
            <span class="n">xsources</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span>
            <span class="n">xsources</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data_source</span>
            <span class="n">xsources</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">expNum</span>

        <span class="k">return</span> <span class="n">xsources</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eventCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xarray of event codes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">xcodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;desc_shape&#39;</span><span class="p">)</span> 
        <span class="n">xcodes</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">exp</span>
        <span class="n">xcodes</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">run</span>
        <span class="n">xcodes</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">xcodes</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">data_source</span>
        <span class="n">xcodes</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;expNum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configData</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">expNum</span>
        <span class="k">return</span> <span class="n">xcodes</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;*Detectors in group 0 are &quot;BLD&quot; data recorded at 120 Hz on event code 40&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monshmserver</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;*Detectors listed as Monitored are not being recorded (group -2).&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;*Detectors listed as Controls are controls devices with unknown event code (but likely 40).&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span>  <span class="s1">&#39;</span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:&gt;3}</span><span class="s1"> </span><span class="si">{:&gt;13}</span><span class="s1"> </span><span class="si">{:&gt;4}</span><span class="s1"> </span><span class="si">{:&gt;3}</span><span class="s1"> </span><span class="si">{:&gt;11}</span><span class="s1"> </span><span class="si">{:&gt;11}</span><span class="s1"> </span><span class="si">{:30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Alias&#39;</span><span class="p">,</span> <span class="s1">&#39;Grp&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="s1">&#39;Code&#39;</span><span class="p">,</span> <span class="s1">&#39;Pol&#39;</span><span class="p">,</span> <span class="s1">&#39;Delay [s]&#39;</span><span class="p">,</span> <span class="s1">&#39;Width [s]&#39;</span><span class="p">,</span> <span class="s1">&#39;Source&#39;</span><span class="p">)</span> 
        <span class="n">message</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
        <span class="n">data_srcs</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                       <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg_srcs</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bld&#39;</span><span class="p">)}</span>
        
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">srcstr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_srcs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">srcstr</span><span class="p">,{})</span>

            <span class="n">polarity</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evr_polarity&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Epics convention used -- has it always been this?</span>
            <span class="c1"># I was previously using the opposite convetion here</span>
            <span class="k">if</span> <span class="n">polarity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">polarity</span> <span class="o">=</span> <span class="s1">&#39;Pos&#39;</span>
            <span class="k">elif</span> <span class="n">polarity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">polarity</span> <span class="o">=</span> <span class="s1">&#39;Neg&#39;</span>

            <span class="n">delay</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evr_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">delay</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:11.9f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

            <span class="n">width</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evr_width&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">width</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:11.9f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

            <span class="n">group</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;Controls&#39;</span>
            <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;Monitor&#39;</span>

            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">eventCode</span> <span class="o">=</span> <span class="mi">40</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eventCode</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eventCode&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">rate</span> <span class="o">=</span> <span class="n">_eventCodes_rate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eventCode</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eventCode</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">rate</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">rate</span>

            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:&gt;3}</span><span class="s1"> </span><span class="si">{:&gt;13}</span><span class="s1"> </span><span class="si">{:&gt;4}</span><span class="s1"> </span><span class="si">{:&gt;3}</span><span class="s1"> </span><span class="si">{:&gt;11}</span><span class="s1"> </span><span class="si">{:&gt;11}</span><span class="s1"> </span><span class="si">{:30}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> 
                   <span class="n">group</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">polarity</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">srcstr</span><span class="p">))</span>
                   <span class="c1">#group, rate, eventCode, polarity, delay, width, srcstr))</span>
       
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">show_eventCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show event code information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:12}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span>  <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">)</span> 
        <span class="n">message</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isReadout&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">codetype</span> <span class="o">=</span> <span class="s1">&#39;Readout&#39;</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isCommand&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">codetype</span> <span class="o">=</span> <span class="s1">&#39;Command&#39;</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isLatch&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">codetype</span> <span class="o">=</span> <span class="s1">&#39;Latch&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">codetype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:12}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readoutGroup&#39;</span><span class="p">),</span> <span class="n">codetype</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_repr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>
 
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">:</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">SourceData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">srcstr</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">ConfigSources</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="SourceData"><a class="viewcode-back" href="../../generated/PyDataSource.SourceData.html#PyDataSource.SourceData">[docs]</a><span class="k">class</span> <span class="nc">SourceData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Source information for a daq device.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : str</span>
<span class="sd">        Source name</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    evr_width : float</span>
<span class="sd">        Detector evr trigger width [&#39;s&#39;]</span>
<span class="sd">    evr_delay : float</span>
<span class="sd">        Detector evr trigger delay [&#39;s&#39;]</span>
<span class="sd">    evr_polarity : bool</span>
<span class="sd">        Detector evr trigger polarity</span>
<span class="sd">    group: int</span>
<span class="sd">        Daq evr group</span>
<span class="sd">    map_key: int tuple</span>
<span class="sd">        Evr configuation map key (card,channel)</span>
<span class="sd">    eventCode: int</span>
<span class="sd">        Evr event code</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;evr_width&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
              <span class="s1">&#39;evr_delay&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">}</span>

    <span class="n">_doc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;evr_width&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr trigger width&#39;</span><span class="p">,</span>
            <span class="s1">&#39;evr_delay&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr trigger delay&#39;</span><span class="p">,</span>
            <span class="s1">&#39;evr_polarity&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr trigger polarity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr group&#39;</span><span class="p">,</span>
            <span class="s1">&#39;map_key&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr configuation map key (card,channel)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;eventCode&#39;</span><span class="p">:</span> <span class="s1">&#39;Evr event code&#39;</span><span class="p">,</span>
            <span class="p">}</span>

<div class="viewcode-block" id="SourceData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.SourceData.html#PyDataSource.SourceData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span></div>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="c1">#        for attr in self._source:</span>
<span class="c1">#            val = self._source[attr]</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:10.9f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:22}</span><span class="s1"> </span><span class="si">{:&gt;12}</span><span class="s1"> </span><span class="si">{:3}</span><span class="s1"> </span><span class="si">{:40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">SourceData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>

<div class="viewcode-block" id="EvrData"><a class="viewcode-back" href="../../generated/PyDataSource.EvrData.html#PyDataSource.EvrData">[docs]</a><span class="k">class</span> <span class="nc">EvrData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evr eventCode information for current event in DataSource </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : DataSource object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_detail_attrs</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">,</span> <span class="s1">&#39;timestampHigh&#39;</span><span class="p">,</span> <span class="s1">&#39;timestampLow&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;_attr_info&#39;</span><span class="p">,</span> <span class="s1">&#39;_src&#39;</span><span class="p">,</span> <span class="s1">&#39;_typ&#39;</span><span class="p">,</span> <span class="s1">&#39;_info&#39;</span><span class="p">,</span> <span class="s1">&#39;_typ_func&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;show_info&#39;</span><span class="p">,</span> <span class="s1">&#39;show_table&#39;</span><span class="p">,</span> <span class="s1">&#39;_present&#39;</span><span class="p">,</span> <span class="s1">&#39;_values&#39;</span><span class="p">,</span> <span class="s1">&#39;_all_values&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EvrData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EvrData.html#PyDataSource.EvrData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evr</span> <span class="o">=</span> <span class="kc">None</span></div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eventCodes_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        eventcodes that were sent on precisely the fiducial corresponding to the evt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;eventCodes&#39;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">,</span> <span class="n">this_fiducial_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eventCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All event codes in current event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;eventCodes&#39;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ddls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;_fetch_ddls&#39;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;_find_types&#39;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>

    <span class="o">@</span> <span class="nb">property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evr name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="o">.</span><span class="n">name</span>

    <span class="o">@</span> <span class="nb">property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evr source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evr</span><span class="o">.</span><span class="n">source</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EventId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EventId object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EventId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eventCodeStr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">eventCodeStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">return</span> <span class="n">eventCodeStr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detail_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_evr</span> <span class="o">=</span> <span class="n">EvrDataDetails</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detail_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EvrData</span><span class="p">)</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EvrDataDetails</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EvrDataDetails"><a class="viewcode-back" href="../../generated/PyDataSource.EvrDataDetails.html#PyDataSource.EvrDataDetails">[docs]</a><span class="k">class</span> <span class="nc">EvrDataDetails</span><span class="p">(</span><span class="n">PsanaTypeData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evr eventCode information for current event in DataSource </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : DataSource object</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EvrDataDetails.__init__"><a class="viewcode-back" href="../../generated/generated/PyDataSource.EvrDataDetails.__init__.html#PyDataSource.EvrDataDetails.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_typ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_evt_modules</span><span class="p">[</span><span class="s1">&#39;EvrData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">typ_func</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typ</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_src</span><span class="p">)</span>
        <span class="n">PsanaTypeData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span><span class="o">.</span><span class="n">eventCode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_strict_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Event codes strictly defined for the readout event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fiducials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">fiducials</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">tsh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestampHigh</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">tsh</span> <span class="o">==</span> <span class="n">fiducials</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if the eventCode is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestampHigh</span><span class="p">[</span><span class="n">eventCode</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">fiducials</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">eventCode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span><span class="p">,</span> <span class="s1">&#39;present&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_typ_func</span><span class="o">.</span><span class="n">present</span><span class="p">(</span><span class="n">eventCode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pres</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">strict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestampHigh</span><span class="p">[</span><span class="n">eventCode</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EventId</span><span class="o">.</span><span class="n">fiducials</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">: error checking for eventCode </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EventId</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">eventCode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="EvrDataDetails.present"><a class="viewcode-back" href="../../generated/generated/PyDataSource.EvrDataDetails.present.html#PyDataSource.EvrDataDetails.present">[docs]</a>    <span class="k">def</span> <span class="nf">present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the event has specified event code.</span>
<span class="sd">        Multiple event codes can be tested.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strict: bool (default=True)</span>
<span class="sd">            check if code has same timestamp as EventId</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        </span>
<span class="sd">        Assume: </span>
<span class="sd">            self.eventCodes = [41, 140]</span>
<span class="sd">        Then:</span>
<span class="sd">            self.present(41, 140) = True</span>
<span class="sd">            self.present(42, 140) = Flase</span>
<span class="sd">            </span>
<span class="sd">        To check if an event code is not present use a negative number:</span>
<span class="sd">            self.present(-41) = False</span>
<span class="sd">            self.present(-41, 140) = False</span>
<span class="sd">            self.present(-42) = True</span>
<span class="sd">            self.present(-42, 140) = True</span>
<span class="sd">            self.present(-42, 41, 140) = True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">eventCodes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">args</span>

        <span class="k">for</span> <span class="n">eventCode</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eventCode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present</span><span class="p">(</span><span class="n">eventCode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">eventCode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eventCode</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestampHigh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        timstampHigh dict from fifoEvents data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span><span class="o">.</span><span class="n">eventCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span><span class="o">.</span><span class="n">timestampHigh</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestampLow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        timstampLow dict from fifoEvents data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span><span class="o">.</span><span class="n">eventCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span><span class="o">.</span><span class="n">timestampLow</span><span class="p">))</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EventId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EventId object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">EventId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>


<div class="viewcode-block" id="EvrDataDetails.show_table"><a class="viewcode-back" href="../../generated/generated/PyDataSource.EvrDataDetails.show_table.html#PyDataSource.EvrDataDetails.show_table">[docs]</a>    <span class="k">def</span> <span class="nf">show_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show table of event codes present&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fifoEvents</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;6}</span><span class="s1"> </span><span class="si">{:&gt;8}</span><span class="s1"> </span><span class="si">{:&gt;8}</span><span class="s1"> </span><span class="si">{:&gt;9}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;TS_high&#39;</span><span class="p">,</span> <span class="s1">&#39;TS_low&#39;</span><span class="p">,</span> <span class="s1">&#39;Present&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numFifoEvents</span><span class="p">):</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:6}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1">   </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ecs</span><span class="o">.</span><span class="n">eventCode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                            <span class="n">ecs</span><span class="o">.</span><span class="n">timestampHigh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ecs</span><span class="o">.</span><span class="n">timestampLow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">present</span><span class="p">(</span><span class="n">ecs</span><span class="o">.</span><span class="n">eventCode</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">message</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eventCodeStr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">eventCodeStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="k">return</span> <span class="n">eventCodeStr</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EvrDataDetails</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EvrNullData"><a class="viewcode-back" href="../../generated/PyDataSource.EvrNullData.html#PyDataSource.EvrNullData">[docs]</a><span class="k">class</span> <span class="nc">EvrNullData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evr data class when no EvrData type is in event keys.</span>
<span class="sd">    Occurs for controls cameras with no other daq data present.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EvrNullData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EvrNullData.html#PyDataSource.EvrNullData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventCodes_strict</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="EventId"><a class="viewcode-back" href="../../generated/PyDataSource.EventId.html#PyDataSource.EventId">[docs]</a><span class="k">class</span> <span class="nc">EventId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time stamp information from psana EventId. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;idxtime&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">]</span>
    <span class="n">_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime64&#39;</span><span class="p">,</span> <span class="s1">&#39;EventTime&#39;</span><span class="p">,</span> <span class="s1">&#39;timef64&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EventId.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EventId.html#PyDataSource.EventId.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_EventId</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">psana</span><span class="o">.</span><span class="n">EventId</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NumPy datetime64 representation of EventTime.</span>
<span class="sd">        </span>
<span class="sd">        References </span>
<span class="sd">        ----------</span>

<span class="sd">        http://docs.scipy.org/doc/numpy/reference/arrays.datetime.html</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">EventTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        psana.EventTime for use in indexed idx xtc files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">psana</span><span class="o">.</span><span class="n">EventTime</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span><span class="o">|</span><span class="bp">self</span><span class="o">.</span><span class="n">nsec</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducials</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timef64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Event time represented as float64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsec</span><span class="p">)</span><span class="o">/</span><span class="mf">1.e9</span> 

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nsec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nanosecond part of event time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Second part of event time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Message object</span>
<span class="sd">            Time stamp information for event </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">!=</span> <span class="s1">&#39;idxtime&#39;</span><span class="p">:</span> 
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:18s}</span><span class="s1"> </span><span class="si">{:&gt;12}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">EventTimeStr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">EventTimeStr</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1e5</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">EventTimeStr</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">EventTimeStr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_EventId</span><span class="p">,</span> <span class="n">attr</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EventId</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="Detector"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.html#PyDataSource.Detector">[docs]</a><span class="k">class</span> <span class="nc">Detector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Includes epicsData, configData, evrConfig info </span>
<span class="sd">    Uses full ds in order to be able to access epicsData info on</span>
<span class="sd">    an event basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#import Detector as psanaDetector</span>
    <span class="c1"># dict of detectors in psana.DetectorTypes.detectors</span>
   
    <span class="n">_tabclass</span> <span class="o">=</span> <span class="s1">&#39;evtData&#39;</span>
    <span class="n">_calib_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_det_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_alias</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">_pydet</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_pydet_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_init</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_xarray_init</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Detector.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.html#PyDataSource.Detector.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a psana Detector class for a given detector alias.</span>
<span class="sd">        Provides the attributes of the PyDetector functions for the current </span>
<span class="sd">        event if applicable.  Otherwise provides the attributes from the</span>
<span class="sd">        raw data in the psana event keys for the given detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="p">{}})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding Detector: </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:40}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">psana</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR No Detector with alias </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_srcstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="c1">#self._srcname = self._srcstr.split(&#39;(&#39;)[1].split(&#39;)&#39;)[0]</span>
        <span class="n">srcname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;srcname&#39;</span><span class="p">]</span>
        <span class="c1">#self._srcname = str(self.srcname)</span>
        <span class="c1">#self._devName = self._det_config[&#39;devName&#39;]</span>
 
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span> <span class="o">=</span> <span class="n">psana</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pydet_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">_pydet_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;AreaDetector&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;det_class&#39;</span><span class="p">:</span> <span class="n">ImageData</span><span class="p">,</span>
                                      <span class="s1">&#39;calib_class&#39;</span><span class="p">:</span> <span class="n">ImageCalibData</span><span class="p">},</span>
                <span class="s1">&#39;GenericWFDetector&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;det_class&#39;</span><span class="p">:</span> <span class="n">GenericWaveformData</span><span class="p">,</span>
                                     <span class="s1">&#39;calib_class&#39;</span><span class="p">:</span> <span class="n">GenericWaveformCalibData</span><span class="p">},</span>
                <span class="s1">&#39;WFDetector&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;det_class&#39;</span><span class="p">:</span> <span class="n">WaveformData</span><span class="p">,</span>
                                      <span class="s1">&#39;calib_class&#39;</span><span class="p">:</span> <span class="n">WaveformCalibData</span><span class="p">},</span>
                <span class="s1">&#39;IpimbDetector&#39;</span><span class="p">:</span>     <span class="p">{</span><span class="s1">&#39;det_class&#39;</span><span class="p">:</span> <span class="n">IpimbData</span><span class="p">,</span>
                                      <span class="s1">&#39;calib_class&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="p">}</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">_pydet_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pydet_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det_class&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calib_class</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;calib_class&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span> <span class="o">=</span> <span class="s1">&#39;detector&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Epix10ka calib class not yet implmented</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;devName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Epix10ka&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calib_class</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;calib&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">352</span><span class="p">,</span><span class="mi">384</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">135168</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>


<span class="c1">#    # Does not quite work.  Need to invesigate how to rename robustly</span>
<span class="c1">#    def rename(self, alias):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Rename detector.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        self._ds.rename(**{self._alias: alias})</span>

    <span class="k">def</span> <span class="nf">_on_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for Detector instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_source_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sourceData information.  Objects converted to str.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceData</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;src&#39;</span> <span class="ow">in</span> <span class="n">src_info</span><span class="p">:</span>
            <span class="n">src_info</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_info</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">src_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add data processing methods.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        AddOn : class</span>
<span class="sd">            Methods to add parameters, properties, and reduction/proccesing of data </span>
<span class="sd">            with roi, projection, histogram methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AddOn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>
   
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_det_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detector configuration</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        _device_sets : dict</span>
<span class="sd">            Dictionary of detector devices in DataSource object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_xarray_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of information to build xarray data summaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Detector._update_xarray_info"><a class="viewcode-back" href="../../generated/PyDataSource.Detector._update_xarray_info.html#PyDataSource.Detector._update_xarray_info">[docs]</a>    <span class="k">def</span> <span class="nf">_update_xarray_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update default xarray information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="c1"># attrs -- not valid yet for bld but should fix this to avoid try/except here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">17</span><span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># xarray dims</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;BldInfo(FEE-SPEC0)&#39;</span><span class="p">:</span>
            <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="p">([],</span> <span class="p">())</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;integral&#39;</span><span class="p">]}</span>
            <span class="n">dims_dict</span><span class="p">[</span><span class="s1">&#39;hproj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hproj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">GenericWaveformData</span><span class="p">:</span>
            <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;waveform&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4096</span><span class="p">))}</span> 

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">WaveformData</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
                <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;waveform&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">numberOfSamples</span><span class="p">))}</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>  <span class="p">([</span><span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">],</span> 
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">nbrChannels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">horiz</span><span class="o">.</span><span class="n">nbrSamples</span><span class="p">)),</span>
                        <span class="p">}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">IpimbData</span><span class="p">:</span>
            <span class="n">attr_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">_attr_info</span>
            <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;sum&#39;</span><span class="p">:</span>      <span class="p">([],</span> <span class="p">(),</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,{})),</span>
                    <span class="s1">&#39;xpos&#39;</span><span class="p">:</span>     <span class="p">([],</span> <span class="p">(),</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xpos&#39;</span><span class="p">,{})),</span>
                    <span class="s1">&#39;ypos&#39;</span><span class="p">:</span>     <span class="p">([],</span> <span class="p">(),</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ypos&#39;</span><span class="p">,{})),</span>
                    <span class="s1">&#39;channel&#39;</span><span class="p">:</span>  <span class="p">([</span><span class="s1">&#39;ch&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span>
                    <span class="p">}</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">ImageData</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;sensor&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;calib&#39;</span><span class="p">:</span>     <span class="n">raw_dims</span><span class="p">,</span>
                    <span class="s1">&#39;raw&#39;</span><span class="p">:</span>       <span class="n">raw_dims</span><span class="p">,</span>
                    <span class="s1">&#39;corr&#39;</span><span class="p">:</span>      <span class="n">raw_dims</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_yaxis</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">image_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">image_shape</span><span class="p">)</span> 
                    <span class="n">dims_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;image&#39;</span><span class="p">:</span>     <span class="n">image_dims</span><span class="p">})</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;yaxis&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_yaxis</span><span class="p">))</span>
                    <span class="n">image_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">image_shape</span><span class="p">)</span>
                    <span class="c1">#dims_dict = {&#39;calib&#39;:     image_dims}</span>
                    <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;image&#39;</span><span class="p">:</span>     <span class="n">image_dims</span><span class="p">,</span>
                        <span class="s1">&#39;raw&#39;</span><span class="p">:</span>       <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;corr&#39;</span><span class="p">:</span>      <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;calib&#39;</span><span class="p">:</span>     <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;photons&#39;</span><span class="p">:</span>   <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="p">}</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;yaxis&#39;</span><span class="p">],</span> <span class="n">dshape</span><span class="p">)</span>
                    <span class="n">image_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">dshape</span><span class="p">)</span>
                    <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;image&#39;</span><span class="p">:</span>     <span class="n">image_dims</span><span class="p">,</span>
                        <span class="s1">&#39;raw&#39;</span><span class="p">:</span>       <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;corr&#39;</span><span class="p">:</span>      <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;calib&#39;</span><span class="p">:</span>     <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;photons&#39;</span><span class="p">:</span>   <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="p">}</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Shape is not alwasy correct as of ana-1.3.4 for roi, e.g., Timetool</span>
                    <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;yaxis&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">image_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;image&#39;</span><span class="p">:</span>     <span class="n">image_dims</span><span class="p">,</span>
                        <span class="s1">&#39;raw&#39;</span><span class="p">:</span>       <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;corr&#39;</span><span class="p">:</span>      <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;calib&#39;</span><span class="p">:</span>     <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="s1">&#39;photons&#39;</span><span class="p">:</span>   <span class="n">raw_dims</span><span class="p">,</span>
                        <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">data16</span><span class="o">.</span><span class="n">shape</span><span class="p">)}</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="p">,</span> <span class="s1">&#39;data8&#39;</span><span class="p">):</span>
                            <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">data8</span><span class="o">.</span><span class="n">shape</span><span class="p">)}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                                <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span><span class="p">)}</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error adding dims for &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># temporary fix for Quartz camera not in PyDetector class</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="p">,</span> <span class="s1">&#39;dettype&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">18</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data8&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data8</span><span class="o">.</span><span class="n">shape</span><span class="p">)}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;Not valid data8&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">npval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">npval</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dims_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;d</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">npval</span><span class="o">.</span><span class="n">shape</span><span class="p">)],</span> <span class="n">npval</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">xattrs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dims_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">(),</span> <span class="n">xattrs</span><span class="p">)</span>

<span class="c1">#            dims_dict = {attr: ([], ()) for attr in self.evtData._all_values}</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dims_dict</span><span class="p">)</span>

        <span class="c1"># coords</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">WaveformData</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">numberOfSamples</span><span class="p">)</span> 
                        <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">horiz</span><span class="o">.</span><span class="n">nbrSamples</span><span class="p">)</span> \
                                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">horiz</span><span class="o">.</span><span class="n">sampInterval</span> \
                                <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">horiz</span><span class="o">.</span><span class="n">delayTime</span>
                        <span class="p">}</span>

        <span class="c1"># temporary fix for Opal2000, Opal4000 and Opa8000</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span> <span class="o">==</span> <span class="n">ImageData</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;sensor&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;areas&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_x&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_y&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_z&#39;</span><span class="p">,</span> 
                        <span class="c1"># &#39;image_xaxis&#39;, &#39;image_yaxis&#39;,</span>
                         <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_y&#39;</span><span class="p">,</span> <span class="s1">&#39;pedestals&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">]</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span><span class="p">,</span>
                        <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_yaxis</span>
                        <span class="p">}</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">coords_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coords_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                               <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coords_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>  <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">raw_dims</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;xaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;yaxis&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;areas&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_x&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_y&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_z&#39;</span><span class="p">,</span> 
                        <span class="c1"># &#39;image_xaxis&#39;, &#39;image_yaxis&#39;,</span>
                         <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_y&#39;</span><span class="p">,</span> <span class="s1">&#39;pedestals&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">]</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_xaxis</span><span class="p">,</span>
                        <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">image_yaxis</span>
                        <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coords_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">coords_dict</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_xarray_evtData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add evtData xarray information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">dims_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_all_values</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_all_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">npval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npval</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dims_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;d</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">npval</span><span class="o">.</span><span class="n">shape</span><span class="p">)],</span> <span class="n">npval</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                        <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;unit&#39;</span><span class="p">]}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">dims_dict</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">(),</span> <span class="n">xattrs</span><span class="p">)</span>
               
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;evtData&#39;</span><span class="p">,</span><span class="n">attr</span><span class="p">]),</span> <span class="n">attr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dims_dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes of psana.Detector functions if relevant, and otherwise</span>
<span class="sd">        attributes of raw psana event keys for the given detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span><span class="p">:</span>
            <span class="n">tabclass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tabclass</span><span class="p">,</span> <span class="s1">&#39;_attrs&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tabclass</span><span class="o">.</span><span class="n">_attrs</span>

        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="Detector.next"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.next.html#PyDataSource.Detector.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return next event that contains the Detector in the event data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_keys</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">in_keys</span><span class="p">:</span>
            <span class="n">evt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
            <span class="n">in_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_attrs</span>

        <span class="n">evt</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span></div>
 
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Detector.monitor"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.monitor.html#PyDataSource.Detector.monitor">[docs]</a>    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span><span class="s1">&#39;calib&#39;</span><span class="p">],</span> <span class="n">nevents</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor detector attributes continuously with show_info function.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">ievent</span> <span class="o">=</span> <span class="n">nevents</span>
        <span class="k">while</span> <span class="n">ievent</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="k">if</span> <span class="n">ievent</span> <span class="o">&lt;</span> <span class="n">nevents</span> <span class="ow">and</span> <span class="n">sleep</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">)</span>

                <span class="n">ievent</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">ievent</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">_show_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show user defined information from AddOn methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1">#        if self._det_config.get(&#39;module&#39;) and self._det_config[&#39;module&#39;].get(&#39;dict&#39;):</span>
<span class="c1">#            message(&#39;-&#39;*80)</span>
<span class="c1">#            message(&#39;Class Properties:&#39;)</span>
<span class="c1">#            message(&#39;-&#39;*18)</span>
<span class="c1">#            for attr in self._det_config[&#39;module&#39;].get(&#39;dict&#39;, []):</span>
<span class="c1">#                val = getattr(self, attr)</span>
<span class="c1">#                try:</span>
<span class="c1">#                    val = val()</span>
<span class="c1">#                except:</span>
<span class="c1">#                    pass</span>
<span class="c1">#                </span>
<span class="c1">#                strval = _repr_value(val)</span>
<span class="c1">#                fdict = {&#39;attr&#39;: attr, &#39;str&#39;: strval, &#39;unit&#39;: &#39;&#39;, &#39;doc&#39;: &#39;&#39;}</span>
<span class="c1">#                message(&#39;{attr:18s} {str:&gt;12} {unit:7} {doc:}&#39;.format(**fdict))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Projections:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
 
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">})</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Histograms:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
 
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">})</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Region of Interests (roi):&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">})</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Detector Counts:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">})</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;User Defined Parameters:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Peak Result:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">strval</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">strval</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:10.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">strval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="n">doc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;User Defined Properties:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_property</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">adims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xarray_info</span><span class="p">[</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">adims</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">adims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">adims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">adims</span><span class="p">)</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;detector&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">info</span>

        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;histogram&#39;</span><span class="p">,</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span><span class="s1">&#39;peak&#39;</span><span class="p">,</span><span class="s1">&#39;projection&#39;</span><span class="p">,</span><span class="s1">&#39;property&#39;</span><span class="p">,</span><span class="s1">&#39;stats&#39;</span><span class="p">]:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">typ</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">info</span>

        <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="Detector.show_all"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.show_all.html#PyDataSource.Detector.show_all">[docs]</a>    <span class="k">def</span> <span class="nf">show_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show detailed detector information for current event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Event Data:&#39;</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_user_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span> <span class="o">==</span> <span class="s1">&#39;detector&#39;</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Processed Data:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calib_class</span><span class="p">:</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Calibration Data:&#39;</span><span class="p">)</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calibData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Configuration Data:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;Epics Data:&#39;</span><span class="p">)</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
               
        <span class="k">return</span> <span class="n">message</span></div>

<div class="viewcode-block" id="Detector.show_info"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.show_info.html#PyDataSource.Detector.show_info">[docs]</a>    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show basic detector information, including from user defined AddOn methods, </span>
<span class="sd">        for current event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">message</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span><span class="p">)</span><span class="o">.</span><span class="n">show_info</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_user_info</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sourceData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Source information for detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">Sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configuration data for detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">configData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evtData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tab accessible raw data from psana event keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span> 
                <span class="n">PsanaSrcData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_srcstr</span><span class="p">,</span> <span class="n">key_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_evt_keys</span><span class="p">)})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evtData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epicsData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Epics information for current detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">epicsData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">detector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raw, calib and image data using psana.Detector class.</span>
<span class="sd">        Improved speed with data cashing when accessing the same object multiple times for</span>
<span class="sd">        the same event (e.g., multiple roi or other access for same data).</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        ImageData object</span>
<span class="sd">        ImageCalibData object</span>
<span class="sd">        WaveformData object</span>
<span class="sd">        WaveformCalibData object</span>
<span class="sd">        IpimbData object</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span><span class="p">:</span>
                <span class="c1">#opts = self._det_config.get(&#39;opts&#39;, {})</span>
                <span class="c1">#self._ds._current_data.update({self._alias: self._det_class(self._pydet, self._ds._current_evt, opts=opts)})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)})</span>
             
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calibData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calibration data using psana.Detector class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calib_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Detector.set_cmpars"><a class="viewcode-back" href="../../generated/PyDataSource.Detector.set_cmpars.html#PyDataSource.Detector.set_cmpars">[docs]</a>    <span class="k">def</span> <span class="nf">set_cmpars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmpars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set common mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;calib&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;opts&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;opts&#39;</span><span class="p">][</span><span class="s1">&#39;calib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># reset current data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># save opts for calib object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;opts&#39;</span><span class="p">][</span><span class="s1">&#39;calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cmpars&#39;</span><span class="p">:</span> <span class="n">cmpars</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="n">calib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_current_evt</span><span class="p">,</span> <span class="n">cmpars</span><span class="o">=</span><span class="n">cmpars</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get roi from roi_name as defined by AddOn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
            <span class="c1">#img = getattr(self, item[&#39;attr&#39;])</span>
            <span class="c1">#img = self._getattr(item[&#39;attr&#39;])</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">roi</span><span class="p">:</span>
                    <span class="n">sensor</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sensor&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">img</span>
                <span class="k">elif</span> <span class="n">roi</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">img</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">img</span>
                
                <span class="n">sensor</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sensor&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">img</span>

                <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">psplots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To kill a plot that has been created with self.add.psplot, del self.psplots[name]</span>
<span class="sd">        and close the plot window.  </span>
<span class="sd">           </span>
<span class="sd">        If you only close the plot window it will automatically reopen on the next event.</span>
<span class="sd">        If the plot is not updating as expected, simply close the window and it will refresh</span>
<span class="sd">        on the next event.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        evt.DscCsPad.add.projection(&#39;calib&#39;,&#39;r&#39;,publish=True)</span>
<span class="sd">        del evt.DscCsPad.psplots[&#39;DscCsPad_calib_r&#39;]</span>
<span class="sd">        </span>
<span class="sd">        evt.DscCsPad.add.psplot(&#39;image&#39;)                </span>
<span class="sd">        del evt.DscCsPad.psplots[&#39;DscCsPad_image&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;psplot&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get counts from count_name as defined by AddOn.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
            <span class="c1">#img = getattr(self, item[&#39;attr&#39;])</span>
            <span class="c1">#img = self._getattr(item[&#39;attr&#39;])</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">])</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limits&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">limits</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">img</span><span class="p">[(</span><span class="n">img</span> <span class="o">&gt;=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">gain</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="n">gain</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns histogram as defined by AddOn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">])</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
            <span class="n">hst</span><span class="p">,</span> <span class="n">hbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">img</span><span class="o">*</span><span class="n">gain</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">),</span> 
                    <span class="n">weights</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">hst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns peak information as defined in AddOn class.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">])</span>
            <span class="n">ichannel</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ichannel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ichannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wf</span> <span class="o">=</span> <span class="n">wf</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]</span>

            <span class="n">background</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
                <span class="n">wf</span> <span class="o">-=</span> <span class="n">background</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
                <span class="n">wf</span> <span class="o">*=</span> <span class="n">scale</span>

            <span class="n">method</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">wf</span>
            
            <span class="n">roi</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roi&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
                <span class="n">wf</span> <span class="o">=</span> <span class="n">wf</span><span class="p">[</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">wf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">maxval</span>
            
            <span class="k">if</span> <span class="nb">max</span> <span class="o">&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">maxval</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>        
    
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idx</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xaxis&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">xaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">xaxis</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get xarray.DataArray of Welford stats as defined by stats AddOn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stat_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        
        <span class="c1"># Need to fix handling of coords to be robust</span>
        <span class="c1">#coords = stat_info.get(&#39;coords&#39;).copy()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">stat_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">)</span>
        <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">stat_info</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">stat_info</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ec</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">stat_info</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">fec</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="n">neventCodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventCodes</span><span class="p">)</span>
        <span class="n">nstats</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="n">aevents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nsteps</span><span class="p">,</span><span class="n">neventCodes</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>
        
        <span class="n">dim_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">alias</span><span class="p">,</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">dim_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dim_names</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span>
        <span class="n">dim_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">neventCodes</span><span class="p">)</span>
        <span class="n">dim_names</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span>
        <span class="n">dim_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nsteps</span><span class="p">)</span>
        <span class="n">dim_names</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;stat&#39;</span><span class="p">)</span>
        <span class="n">dim_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nstats</span><span class="p">)</span>

        <span class="n">ddims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_names</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dim_shape</span><span class="p">))</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;codes&#39;</span><span class="p">:</span> <span class="n">eventCodes</span><span class="p">,</span> <span class="s1">&#39;stat&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="n">steps</span><span class="p">})</span>
        <span class="n">asums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">dim_shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ec</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">stat_info</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">fec</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">istep</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="n">iec</span> <span class="o">=</span> <span class="n">eventCodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
                <span class="n">aevents</span><span class="p">[</span><span class="n">istep</span><span class="p">,</span> <span class="n">iec</span><span class="p">]</span> <span class="o">=</span> <span class="n">fec</span><span class="o">.</span><span class="n">n</span>
                <span class="k">for</span> <span class="n">istat</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats</span><span class="p">):</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fec</span><span class="p">,</span> <span class="n">stat</span><span class="p">)()</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                        <span class="n">asums</span><span class="p">[</span><span class="n">istat</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">iec</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>         

        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">asums</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ddims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> 
                <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">]))</span>
        <span class="n">da</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;events&#39;</span><span class="p">])]</span><span class="o">=</span> <span class="p">([</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="s1">&#39;codes&#39;</span><span class="p">],</span> <span class="n">aevents</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">da</span>

    <span class="k">def</span> <span class="nf">_get_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get projection as defined by AddOn.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#img = getattr(self, item[&#39;attr&#39;])</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">])</span>
        <span class="c1">#img = self._getattr(item[&#39;attr&#39;])</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">axis</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">]:</span>
            <span class="c1"># make a radial histogram</span>
            <span class="n">coord_compressed</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;coord_compressed&#39;</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
            <span class="c1"># make masked image with mask compressed</span>
            <span class="n">img_compressed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
            <span class="n">hst</span><span class="p">,</span> <span class="n">hbins</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">coord_compressed</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">img_compressed</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hst</span><span class="o">/</span><span class="n">norm</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># perform method on oposite axis where psana convention is images have coordinates (x, y)</span>
            <span class="n">iaxis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get property as defined by AddOn.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">six</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span><span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>  <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
   
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabclass</span><span class="p">),</span> <span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_property</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_count</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_histogram</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_roi</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_peak</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_projection</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stats</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">_event_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">_event_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Detector</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="AddOn"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.html#PyDataSource.AddOn">[docs]</a><span class="k">class</span> <span class="nc">AddOn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collection of methods to add parameters, properties, and reduction/proccesing of data </span>
<span class="sd">    with roi, projection, histogram methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_plugins</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_init_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ds&#39;</span><span class="p">,</span> <span class="s1">&#39;_alias&#39;</span><span class="p">]</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="s1">&#39;peak&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;histogram&#39;</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;projection&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AddOn.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.html#PyDataSource.AddOn.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span> <span class="o">=</span> <span class="n">alias</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_det_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_device_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_evt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_det</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">)</span>

<div class="viewcode-block" id="AddOn.module"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.module.html#PyDataSource.AddOn.module">[docs]</a>    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add detector module</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        module : str</span>
<span class="sd">            Name of python module that contains a user defined PyDataSource.Detector class</span>
<span class="sd">            with the same name as the module.  e.g., &#39;acqiris&#39; loads &#39;acqiris.py&#39; file </span>
<span class="sd">            which must have class Acqiris(PyDatasource.Detector)</span>
<span class="sd">        path : str</span>
<span class="sd">            Name of path for python module (default is the path of PyDataSource)</span>
<span class="sd">        desc : str</span>
<span class="sd">            Description </span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; evt.acqiris.add.module(&#39;acqiris&#39;)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        DataSource.add_detector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddOn.parameter"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.parameter.html#PyDataSource.AddOn.parameter">[docs]</a>    <span class="k">def</span> <span class="nf">parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add parameters as keword arguments.  </span>
<span class="sd">        Will be perserved if module is added or DataSource is reloaded</span>
<span class="sd">        and is saved along with other AddOn information with save_config.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; evt.acqiris.add.parameter(foo=&#39;bar&#39;, backlevel=1.)</span>
<span class="sd">        </span>
<span class="sd">        or alternatively</span>

<span class="sd">        &gt;&gt;&gt; params = {foo=&#39;bar&#39;, backlevel=1.}</span>
<span class="sd">        &gt;&gt;&gt; evt.acqiris.add.parameter(**params)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;parameter&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> </div>

    <span class="c1">#def property(self, func_name, *args, **kwargs):</span>
<div class="viewcode-block" id="AddOn.property"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.property.html#PyDataSource.AddOn.property">[docs]</a>    <span class="k">def</span> <span class="nf">property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a property that operates on this detector object.</span>
<span class="sd">        </span>
<span class="sd">        The result will be added as an attribute to the detecor with the</span>
<span class="sd">        name of the function unless attr is provided.</span>
<span class="sd">       </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Import or create a method acting on self as the Detector object and add it as a property</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; def myfunc(self):       </span>
<span class="sd">                return self.ebeamL3Energy</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; evt.EBeam.add.property(myfunc, &#39;energy&#39;)</span>

<span class="sd">        Or alternatively using lambda:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; evt.EBeam.add.property(lambda self: self.ebeamL3Energy, &#39;energy&#39;)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">func_name</span><span class="o">.</span><span class="n">func_name</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_name</span> 
        
        <span class="n">doc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">unit</span><span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="p">([],</span> <span class="p">(),</span> <span class="n">xattrs</span><span class="p">)})</span></div>

<div class="viewcode-block" id="AddOn.projection"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.projection.html#PyDataSource.AddOn.projection">[docs]</a>    <span class="k">def</span> <span class="nf">projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> 
            <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">axis_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  
            <span class="n">coords_x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coords_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ADU&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a projection along an axis.</span>
<span class="sd">        </span>
<span class="sd">        Options implemented for x/y projections (i.e., axis=&#39;x&#39; or axis=&#39;y&#39;)</span>
<span class="sd">        But radial (axis=&#39;r&#39;) and azimuth (axis=&#39;az&#39;) projections are valid </span>
<span class="sd">        in limited circumstances.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object on which to make projection</span>
<span class="sd">        axis : str</span>
<span class="sd">            Projection axis</span>
<span class="sd">                &#39;x&#39;: x-axis </span>
<span class="sd">                &#39;y&#39;: y-axis</span>
<span class="sd">                &#39;r&#39;: radial</span>
<span class="sd">                &#39;az&#39;: azimuth</span>
<span class="sd">                True: both &#39;x&#39; and &#39;y&#39; projections</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of projection object [Default is to append &#39;_&#39;+axis and sequential number</span>
<span class="sd">            to input attr name.</span>
<span class="sd">        axis_name : str</span>
<span class="sd">            name of axis [default = axis+name]</span>
<span class="sd">        coords_x : array</span>
<span class="sd">            Array of X coordinates for input data object defined by attr</span>
<span class="sd">        coords_y : array</span>
<span class="sd">            Array of X coordinates for input data object defined by attr</span>
<span class="sd">        method : str</span>
<span class="sd">            by default the method is &#39;sum&#39; but other numpy methods are</span>
<span class="sd">            also possible (e.g., &#39;mean&#39;, &#39;std&#39;, &#39;min&#39;, &#39;max&#39;, &#39;var&#39;).</span>
<span class="sd">        sensor : int, optional</span>
<span class="sd">            First array element for 3 dim objects</span>
<span class="sd">            If no roi given, then roi created for entire sensor</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest (roi) parameters passed to roi method.</span>
<span class="sd">            roi method then acts on this reduced data</span>
<span class="sd">        mask : str, optional</span>
<span class="sd">            Name of mask to apply before making projection.</span>
<span class="sd">        bins : int or sequence of scalars, optional</span>
<span class="sd">            If `bins` is an int, it defines the number of equal-width</span>
<span class="sd">            bins in the given range (10, by default). If `bins` is a sequence,</span>
<span class="sd">            it defines the bin edges, including the rightmost edge, allowing</span>
<span class="sd">            for non-uniform bin widths. (used with np.histogram)</span>
<span class="sd">        bin_size : float, optional</span>
<span class="sd">            Size of bins for polar coordinate projections.</span>
<span class="sd">            Default = pixelsize</span>
<span class="sd">        rmin : float, optional</span>
<span class="sd">            Minimum radius for az projection only </span>
<span class="sd">            in units of calibData coords (e.g., calibData.coords_x, typically um)</span>
<span class="sd">        rmax : float, optional</span>
<span class="sd">            Maximum radius for az projection only</span>
<span class="sd">            in units of calibData coords (e.g., calibData.coords_x, typically um)</span>
<span class="sd">        doc : str, optional</span>
<span class="sd">            Doc string for resulting projection data</span>
<span class="sd">        unit : str, optional</span>
<span class="sd">            Units of roi data [Default assumes same as attr data]</span>
<span class="sd">        publish : bool, optional</span>
<span class="sd">            Make psplot of roi data</span>
<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">]</span>
        <span class="n">_cartesian_axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">_polar_axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">]</span>

        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">xunit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">_polar_axes</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;calib&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;image&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">calib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;calib&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;raw&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">evtData</span><span class="o">.</span><span class="n">data16</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;evtData.data16&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;evtData.data8&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
 
        <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">roi</span><span class="p">:</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">_polar_axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;norm&#39;</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: </span><span class="si">{:}</span><span class="s1"> is not a valid method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; - only norm method is valid for radial projections&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">_cartesian_axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_methods</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: </span><span class="si">{:}</span><span class="s1"> is not a valid method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; - method must be in </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_methods</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> is not a 2D image -- cannot make projection&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
                <span class="k">return</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR:  </span><span class="si">{:}</span><span class="s1"> is not a valid axis&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; - Valid Cartesian Options = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cartesian_axes</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; - Valid Polar Options = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_polar_axes</span><span class="p">))</span>
            <span class="k">return</span> 

        <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="s1">&#39;roi_&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">roi_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="n">sensor</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">roi_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xattrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="n">roi_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sensor</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">-axis projection of </span><span class="si">{:}</span><span class="s1"> within roi=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">-axis projection of </span><span class="si">{:}</span><span class="s1"> sensor </span><span class="si">{:}</span><span class="s1"> within roi=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_name</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="k">if</span> <span class="n">doc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">-axis projection of </span><span class="si">{:}</span><span class="s2"> data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">axis</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_name</span><span class="p">:</span>
            <span class="n">axis_name</span> <span class="o">=</span> <span class="n">axis</span><span class="o">+</span><span class="n">roi_name</span>
 
        <span class="n">calibData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">calibData</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">_polar_axes</span><span class="p">:</span>
            <span class="n">animg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">animg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">animg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">coords_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">coords_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span> <span class="o">*</span> <span class="n">coords_x</span>

            <span class="k">elif</span> <span class="n">calibData</span><span class="o">.</span><span class="n">coords_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coords_x</span> <span class="o">=</span> <span class="n">calibData</span><span class="o">.</span><span class="n">coords_x</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coords_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
                
            <span class="k">if</span> <span class="n">coords_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">coords_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span> <span class="o">*</span> <span class="n">coords_y</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            
            <span class="k">elif</span> <span class="n">calibData</span><span class="o">.</span><span class="n">coords_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coords_y</span> <span class="o">=</span> <span class="n">calibData</span><span class="o">.</span><span class="n">coords_y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coords_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibData</span><span class="o">.</span><span class="n">mask</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

            <span class="n">coords_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">coords_y</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">coords_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">coords_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">coords_y</span><span class="p">,</span> <span class="n">coords_x</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">xunit</span><span class="p">:</span>
                    <span class="n">xunit</span> <span class="o">=</span> <span class="s1">&#39;um&#39;</span>
                <span class="n">coord_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">coords_r</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_size</span><span class="p">:</span>
                        <span class="n">bin_size</span> <span class="o">=</span> <span class="n">calibData</span><span class="o">.</span><span class="n">pixel_size</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_size</span><span class="p">:</span>
                        <span class="n">bin_size</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coord_hist</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">bin_size</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> 
                                     <span class="n">coord_hist</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">bin_size</span><span class="o">*</span><span class="mf">10.</span><span class="p">,</span> 
                                     <span class="n">bin_size</span><span class="p">)</span>
     
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rmin</span> <span class="ow">and</span> <span class="n">rmax</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rmin</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rmax</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># in future</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vectors for rmin and rmax not yet supported&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rmin</span><span class="p">:</span>
                        <span class="c1"># add logical or for rmin</span>
                        <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">coords_r</span><span class="p">,</span> <span class="n">rmin</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

                    <span class="k">if</span> <span class="n">rmax</span><span class="p">:</span>
                        <span class="c1"># add logical or for rmax</span>
                        <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater_equal</span><span class="p">(</span><span class="n">coords_r</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span><span class="o">.</span><span class="n">mask</span>

                    <span class="n">coord_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">coords_az</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_size</span><span class="p">:</span>
                        <span class="n">bin_size</span> <span class="o">=</span> <span class="mf">2.</span>

                    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>

            <span class="n">coord_compressed</span> <span class="o">=</span> <span class="n">coord_hist</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>
            <span class="n">norm</span><span class="p">,</span> <span class="n">hbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">coord_compressed</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.</span>
            
            <span class="n">projaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">hbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">hbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">axis_name</span><span class="p">:</span> <span class="n">projaxis</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="n">axis_name</span><span class="p">],</span> <span class="p">(</span><span class="n">projaxis</span><span class="o">.</span><span class="n">size</span><span class="p">))})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">roi_name</span><span class="p">,</span> 
                            <span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="n">axis</span><span class="p">,</span> 
                            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                            <span class="s1">&#39;axis_name&#39;</span><span class="p">:</span> <span class="n">axis_name</span><span class="p">,</span>
                            <span class="s1">&#39;coord_compressed&#39;</span><span class="p">:</span> <span class="n">coord_compressed</span><span class="p">,</span>
                            <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
                            <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="n">bins</span><span class="p">,</span>
                            <span class="s1">&#39;rmin&#39;</span><span class="p">:</span> <span class="n">rmin</span><span class="p">,</span>
                            <span class="s1">&#39;rmax&#39;</span><span class="p">:</span> <span class="n">rmax</span><span class="p">,</span>
                            <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span>
                            <span class="s1">&#39;xunit&#39;</span><span class="p">:</span> <span class="n">xunit</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                            <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                            <span class="s1">&#39;xdata&#39;</span><span class="p">:</span> <span class="n">projaxis</span><span class="p">}})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">projaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis_name</span><span class="p">)</span> 
           
            <span class="k">if</span> <span class="n">projaxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Need to add in auto axis for Data Arrays</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">xunit</span><span class="p">:</span>
                    <span class="n">xunit</span> <span class="o">=</span> <span class="s1">&#39;pixel&#39;</span>
                
                <span class="n">iaxis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">projaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">iaxis</span><span class="p">])</span>    
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">axis_name</span><span class="p">:</span> <span class="n">projaxis</span><span class="p">})</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="n">axis_name</span><span class="p">],</span> <span class="p">(</span><span class="n">projaxis</span><span class="o">.</span><span class="n">size</span><span class="p">))})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">roi_name</span><span class="p">,</span> 
                            <span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="n">axis</span><span class="p">,</span> 
                            <span class="s1">&#39;xunit&#39;</span><span class="p">:</span> <span class="n">xunit</span><span class="p">,</span> 
                            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                            <span class="s1">&#39;axis_name&#39;</span><span class="p">:</span> <span class="n">axis_name</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                            <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                            <span class="s1">&#39;xdata&#39;</span><span class="p">:</span> <span class="n">projaxis</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">publish</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">psplot</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">xaxis_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yaxis_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ADU&#39;</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">graphical</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>       
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make roi for given attribute, by default this is given the name img.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object on which to make roi</span>
<span class="sd">        sensor : int</span>
<span class="sd">            First array element for 3 dim objects</span>
<span class="sd">        roi : tuple</span>
<span class="sd">            For 1 dim objects, roi is a tuple (xstart, xend)</span>
<span class="sd">            For 2 dim objects, roi is a tuple ((ystart, yend), (xstart, xend))</span>
<span class="sd">            For 3 dim objects (e.g., cspad raw, calib), use sensor keyword to </span>
<span class="sd">            sepcify the sensor and roi as ((ystart, yend), (xstart, xend)).</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of roi object [Default is to append &#39;_roi&#39; and sequential number</span>
<span class="sd">            to input attr name.</span>
<span class="sd">        xaxis: array_like</span>
<span class="sd">            X-axis coordinate of roi</span>
<span class="sd">        yaxis: array_like</span>
<span class="sd">            Y-axis coordinate of roi</span>
<span class="sd">        xaxis_name : str</span>
<span class="sd">            Name of xaxis (used for xarray Datasets - name and axis values must be unique)</span>
<span class="sd">        yaxis_name : str</span>
<span class="sd">            Name of yaxis (used for xarray Datasets - name and axis values must be unique)</span>
<span class="sd">        doc : str</span>
<span class="sd">            Doc string for resulting roi data</span>
<span class="sd">        unit : str</span>
<span class="sd">            Units of roi data [Default assumes same as attr data]</span>
<span class="sd">        publish : bool</span>
<span class="sd">            Make psplot of roi data</span>
<span class="sd">        projection : bool</span>
<span class="sd">            Make projection(s) of data.  See projection method. </span>
<span class="sd">        graphical : bool</span>
<span class="sd">            Select roi interactively</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;calib&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;image&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not valid roi </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">roi</span> <span class="ow">and</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">graphical</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plotMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>
                <span class="n">plotMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using the 5/99.5% as plot min/max: (&#39;</span><span class="p">,</span><span class="n">plotMin</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">plotMax</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">gs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="n">plotMin</span><span class="p">,</span><span class="n">plotMax</span><span class="p">],</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Select two points to form ROI to zoom in on target location.&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ginput</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">roi</span> <span class="o">=</span> <span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())],</span>
                       <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected ROI [y, x] =&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot get roi&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1">#if len(roi) == 3:</span>
        <span class="c1">#    xroi = roi[2]</span>
        <span class="c1">#    yroi = roi[1]</span>
        <span class="c1">#else:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">roi</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sensor&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sensor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nroi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">nroi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;roi&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;roi&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nroi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">roi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">doc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> ROI of </span><span class="si">{:}</span><span class="s2"> data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>
            <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">})</span>
           
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([],</span> <span class="p">(),</span> <span class="n">xattrs</span><span class="p">)})</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xattrs</span><span class="p">)})</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xattrs</span><span class="p">)})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> 
                                                   <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">,</span>
                                                   <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                   <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                                                   <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">}})</span>
 
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis_name</span><span class="p">:</span>
                <span class="n">xaxis_name</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="n">xroi</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="k">if</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid roi </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">))</span>
            <span class="n">xroi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    
            
            <span class="k">if</span> <span class="n">doc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> ROI of </span><span class="si">{:}</span><span class="s2"> data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="n">xroi</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">})</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">xaxis_name</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="n">xaxis_name</span><span class="p">],</span> <span class="p">(</span><span class="n">xaxis</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">xattrs</span><span class="p">)})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> 
                                                   <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="n">xroi</span><span class="p">,</span>
                                                   <span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">,</span>
                                                   <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                                                   <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                                                   <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">}})</span>
 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xroi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">yroi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">yroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">yroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid roi </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">))</span>
            
            <span class="n">xroi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
            <span class="n">yroi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">yroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">([</span><span class="n">yroi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis_name</span><span class="p">:</span>
                <span class="n">xaxis_name</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span> <span class="o">!=</span> <span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xroi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">yaxis_name</span><span class="p">:</span>
                <span class="n">yaxis_name</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">yaxis</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">yaxis</span><span class="p">)</span> <span class="o">!=</span> <span class="n">yroi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">yroi</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">yroi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yroi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    
            
            <span class="k">if</span> <span class="n">doc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2"> ROI of </span><span class="si">{:}</span><span class="s2"> data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">yroi</span><span class="p">,</span> <span class="n">xroi</span><span class="p">)})</span>
            <span class="k">if</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">})</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">xaxis_name</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span> 
                                                <span class="n">yaxis_name</span><span class="p">:</span> <span class="n">yaxis</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="n">yaxis_name</span><span class="p">,</span> <span class="n">xaxis_name</span><span class="p">],</span> <span class="p">(</span><span class="n">yaxis</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">xattrs</span><span class="p">)})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> 
                                                   <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">yroi</span><span class="p">,</span> <span class="n">xroi</span><span class="p">),</span>
                                                   <span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">,</span>
                                                   <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                                                   <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="n">yaxis</span><span class="p">,</span> 
                                                   <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                                                   <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">projection</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="n">publish</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">publish</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psplot</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eventCodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate running statistics (mean, std, min, max, count) of detector data attribute </span>
<span class="sd">        during event iteration using Welford algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object in detector object on which to act</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_stats&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stats add Not valid for </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">eventCodes</span><span class="p">:</span>
            <span class="c1"># try first source eventCode to make sure get 140 instead of 40 </span>
            <span class="c1"># for example in CsPad where 40 is given in configData.eventCode</span>
            <span class="n">srcstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_srcstr</span>
            <span class="n">code0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">srcstr</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eventCode&#39;</span><span class="p">)</span>
            <span class="c1">#print attr, srcstr, code0</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code0</span><span class="p">:</span>
                <span class="c1"># some devices like Timetool with roi do not give eventCode in configData</span>
                <span class="n">code0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">eventCode</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code0</span><span class="p">:</span>
                <span class="n">code0</span> <span class="o">=</span> <span class="mi">40</span>
                <span class="k">if</span> <span class="n">code0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span><span class="p">:</span>
                    <span class="n">code0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">_eventcodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">code0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventCodes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">eventCodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">eventCodes</span><span class="p">]</span>
        <span class="c1"># Need to update dims always</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_update_xarray_info</span><span class="p">()</span>

        <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dims</span><span class="p">:</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dims&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fixing stat dims for &#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
                <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot update stat dims for &#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>

        <span class="n">all_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1">#coords = {dim: coord for dim, coord in all_coords.items() if dim in dims[0]}</span>
        <span class="c1">#coords = {dim: coord for dim, coord in all_coords.items() if not isinstance(coord[0], list) or len(set(coord[0]) &amp; set(dims[0])) &gt; 0}</span>
        <span class="c1">#coords = {dim: coord for dim, coord in all_coords.items() if coord[0] == dims[0]}</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#attrs = self._det_config[&#39;xarray&#39;].get(&#39;attrs&#39;, {})</span>
        <span class="n">stat_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_source_info</span>
        <span class="n">stat_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

<span class="c1">#        try:</span>
<span class="c1">#            dims = self._det_config[&#39;xarray&#39;][&#39;dims&#39;].get(attr)</span>
<span class="c1">#            coords = self._det_config[&#39;xarray&#39;][&#39;coords&#39;].get(attr)</span>
<span class="c1">#        except:</span>
<span class="c1">#            dims = []</span>
<span class="c1">#            coords = {}</span>
<span class="c1">#</span>
<span class="c1">#        dims.insert(0, &#39;codes&#39;)</span>
<span class="c1">#        dims.insert(0, &#39;steps&#39;)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> 
                <span class="p">{</span>
                <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span>
                <span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="n">dims</span><span class="p">,</span>
                <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span>
                <span class="s1">&#39;funcs&#39;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s1">&#39;eventCodes&#39;</span><span class="p">:</span> <span class="n">eventCodes</span><span class="p">,</span>
                <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="n">stat_attrs</span><span class="p">,</span>
                <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span>
                <span class="p">}})</span>

        <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="AddOn.count"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.count.html#PyDataSource.AddOn.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count (i.e., sum) of detector within optional roi.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object in detector object on which to act</span>
<span class="sd">        gain: float</span>
<span class="sd">            optional converion from ADU to for example X-rays.</span>
<span class="sd">        limits: tuple</span>
<span class="sd">            (low, high) values to be counted.</span>
<span class="sd">        doc : str</span>
<span class="sd">            Doc string for resulting roi data</span>
<span class="sd">        unit : str</span>
<span class="sd">            Units of histogramed data.  Default ADU (times gain factor if supplied) </span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest (roi) parameters passed to roi method.</span>
<span class="sd">            roi method then acts on this reduced data</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">gain</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;ADUx</span><span class="si">{:.2g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>

        <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="s1">&#39;roi_&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">roi_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">roi_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xattrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="n">roi_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Sum of </span><span class="si">{:}</span><span class="s1"> within roi=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
       
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_name</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Sum of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">ncount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ncount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_count&#39;</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_count&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncount</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">roi_name</span><span class="p">,</span> 
                                                 <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="n">gain</span><span class="p">,</span> 
                                                 <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                                                 <span class="s1">&#39;limits&#39;</span><span class="p">:</span> <span class="n">limits</span><span class="p">,</span>
                                                 <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>

        <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([],</span> <span class="p">(),</span> <span class="n">xattrs</span><span class="p">)})</span></div>

<div class="viewcode-block" id="AddOn.histogram"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.histogram.html#PyDataSource.AddOn.histogram">[docs]</a>    <span class="k">def</span> <span class="nf">histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publish</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a histogram.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object in detector object on which to act</span>
<span class="sd">        bins : int or sequence of scalars, optional</span>
<span class="sd">            If `bins` is an int, it defines the number of equal-width</span>
<span class="sd">            bins in the given range (10, by default). If `bins` is a sequence,</span>
<span class="sd">            it defines the bin edges, including the rightmost edge, allowing</span>
<span class="sd">            for non-uniform bin widths. (used with np.histogram)</span>
<span class="sd">        gain : float, optional</span>
<span class="sd">            converion from ADU to for example X-rays.</span>
<span class="sd">        doc : str, optional</span>
<span class="sd">            Doc string for resulting roi data</span>
<span class="sd">        unit : str, optional</span>
<span class="sd">            Units of histogramed data.  Default ADU (times gain factor if supplied) </span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest (roi) parameters passed to roi method.</span>
<span class="sd">            Histogram acts on this reduced data</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            Name of histogram data object</span>
<span class="sd">        weights : array_like, optional</span>
<span class="sd">            An array of weights, of the same shape as `a`.  Each value in `a`</span>
<span class="sd">            only contributes its associated weight towards the bin count</span>
<span class="sd">            (instead of 1).  If `normed` is True, the weights are normalized,</span>
<span class="sd">            so that the integral of the density over the range remains 1</span>
<span class="sd">            (used with np.histogram)</span>
<span class="sd">        density : bool, optional</span>
<span class="sd">            If False, the result will contain the number of samples</span>
<span class="sd">            in each bin.  If True, the result is the value of the</span>
<span class="sd">            probability *density* function at the bin, normalized such that</span>
<span class="sd">            the *integral* over the range is 1. Note that the sum of the</span>
<span class="sd">            histogram values will not be equal to 1 unless bins of unity</span>
<span class="sd">            width are chosen; it is not a probability *mass* function.</span>
<span class="sd">            Overrides the `normed` keyword if given.</span>
<span class="sd">            (used with np.histogram)</span>
<span class="sd">        publish : bool</span>
<span class="sd">            Make psplot of histogram</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        np.histogram</span>

<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        range : (float, float), optional</span>
<span class="c1">#            The lower and upper range of the bins.  If not provided, range</span>
<span class="c1">#            is simply ``(a.min(), a.max())``.  Values outside the range are</span>
<span class="c1">#            An array of weights, of the same shape as `a`.  Each value in `a`</span>
<span class="c1">#            only contributes its associated weight towards the bin count</span>
<span class="c1">#            (instead of 1).  If `normed` is True, the weights are normalized,</span>
<span class="c1">#            so that the integral of the density over the range remains 1</span>
<span class="c1">#            (used with np.histogram)</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">gain</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;ADUx</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;ADU&#39;</span>

        <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="s1">&#39;roi_&#39;</span><span class="o">+</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roi_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">roi_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">roi_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">xattrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="n">roi_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Histogram of </span><span class="si">{:}</span><span class="s1"> within roi=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
       
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_name</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="n">xattrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Histogram of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">ncount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ncount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_hist&#39;</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="o">+</span><span class="s1">&#39;_hist&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncount</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bins</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">roi_name</span><span class="p">)</span>
            <span class="n">hst</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> 
                    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">)</span>

        <span class="n">xaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">roi_name</span><span class="p">,</span> 
                                                     <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="n">gain</span><span class="p">,</span> 
                                                     <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                                                     <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="n">bins</span><span class="p">,</span>
                                                     <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span> 
                                                     <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
                                                     <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="n">density</span><span class="p">,</span>
                                                     <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>

        <span class="n">xattrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_xaxis&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">([</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_xaxis&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">xaxis</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">xattrs</span><span class="p">)})</span>

        <span class="k">if</span> <span class="n">publish</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psplot</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> 
                        <span class="n">xdata</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> 
                        <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">)</span></div>


<div class="viewcode-block" id="AddOn.peak"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.peak.html#PyDataSource.AddOn.peak">[docs]</a>    <span class="k">def</span> <span class="nf">peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ichannel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">docs</span><span class="o">=</span><span class="p">{},</span> <span class="n">units</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple 1D peak locator.</span>
<span class="sd">           </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        attr : str</span>
<span class="sd">            Name of data object on which to find peaks</span>
<span class="sd">        ichannel : int</span>
<span class="sd">            If not present, peak locators will be created for all chanels</span>
<span class="sd">            [Note: acqiris waveform default names start with ch1 following AMI convention]  </span>
<span class="sd">        name : str</span>
<span class="sd">            Name of peak object [Default is to append &#39;_peak&#39; and sequential number</span>
<span class="sd">            to input attr name.</span>
<span class="sd">        xaxis: array_like</span>
<span class="sd">            X-axis coordinate of data object</span>
<span class="sd">            Default is to use wftime for attr=&#39;waveform&#39;</span>
<span class="sd">        threshold : float</span>
<span class="sd">            Peak threshold.  default threshold is 1.5% of full range for Acqiris</span>
<span class="sd">        baseline : float</span>
<span class="sd">            Baseline level to subtract</span>
<span class="sd">        scale : float</span>
<span class="sd">            Peak scale factor</span>
<span class="sd">        method : str</span>
<span class="sd">            Peak finding method options include:</span>
<span class="sd">            &#39;index&#39;: index at max channel.</span>
<span class="sd">            &#39;max&#39;: maximum value.</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest </span>
<span class="sd">        docs : dict</span>
<span class="sd">            Doc strings for resulting peaks</span>
<span class="sd">        units : dict</span>
<span class="sd">            Units of peaks data [Default assumes same as attr data]</span>
<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_pydet_name</span> <span class="o">==</span> <span class="s1">&#39;WFDetector&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Detector&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="s1">&#39;acqiris&#39;</span><span class="p">)</span>

                <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;waveform&#39;</span>
                <span class="k">if</span> <span class="n">ichannel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">waveform</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding ichannel&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">(</span><span class="n">ichannel</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> 
                                  <span class="n">theshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">docs</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                    
                    <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">methods</span><span class="p">:</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="s1">&#39;max&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span> <span class="s1">&#39;waveform&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">methods</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;pos&#39;</span><span class="p">})</span>

        <span class="n">attr_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_get_info</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="c1">#units = {&#39;max&#39;: attr_info.get(&#39;unit&#39;), &#39;index&#39;: &#39;bin&#39;}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;peak&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_peak&#39;</span>
            
            <span class="k">if</span> <span class="n">ichannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;_ch</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ichannel</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;waveform&#39;</span> <span class="ow">and</span> <span class="n">ichannel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">wftime</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;xaxis&#39;</span> <span class="ow">in</span> <span class="n">attr_info</span><span class="p">:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xaxis&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;bins&#39;</span> <span class="ow">in</span> <span class="n">attr_info</span><span class="p">:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">attr_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bins&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]:</span>
                        <span class="n">adims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">xaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">adims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_pydet</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">vert</span><span class="o">.</span><span class="n">fullScale</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]</span><span class="o">*</span><span class="mf">0.015</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">mname</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># make entry for each peak method</span>
            <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">mname</span><span class="p">])</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">docs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;waveform&#39;</span><span class="p">]:</span>
                    <span class="n">doc</span><span class="o">+=</span><span class="s1">&#39; of peak&#39;</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">pname</span><span class="p">:</span>   
                    <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span>
                     <span class="s1">&#39;ichannel&#39;</span><span class="p">:</span> <span class="n">ichannel</span><span class="p">,</span>
                     <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="n">roi</span><span class="p">,</span>
                     <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">baseline</span><span class="p">,</span>
                     <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span> 
                     <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">,</span>
                     <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span>
                     <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                     <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                     <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                     <span class="p">}})</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;waveform&#39;</span><span class="p">]:</span>
                <span class="n">axis_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>
                <span class="n">projaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">wftime</span><span class="p">[</span><span class="n">ichannel</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">axis_name</span><span class="p">:</span> <span class="n">projaxis</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">pname</span><span class="p">:</span> <span class="p">([</span><span class="n">axis_name</span><span class="p">],</span> <span class="p">(</span><span class="n">projaxis</span><span class="o">.</span><span class="n">size</span><span class="p">))})</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;xarray&#39;</span><span class="p">][</span><span class="s1">&#39;dims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">pname</span><span class="p">:</span> <span class="p">([],</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">})}</span>
                        <span class="p">)</span></div>



<span class="c1">#    def mask(self, attr):</span>
<span class="c1">#        img = self._getattr(attr)</span>
<span class="c1">#        plotMax = np.percentile(img, 99.5)</span>
<span class="c1">#        plotMin = np.percentile(img, 5)</span>
<span class="c1">#        print &#39;using the 5/99.5% as plot min/max: (&#39;,plotMin,&#39;,&#39;,plotMax,&#39;)&#39;</span>
<span class="c1">#</span>
<span class="c1">##        image = self.__dict__[detname].image(self.lda.run, img)</span>
<span class="c1">##        det = self.__dict__[detname]</span>
<span class="c1">##        x = self.__dict__[detname+&#39;_x&#39;]</span>
<span class="c1">##        y = self.__dict__[detname+&#39;_y&#39;]</span>
<span class="c1">##        iX = self.__dict__[detname+&#39;_iX&#39;]</span>
<span class="c1">##        iY = self.__dict__[detname+&#39;_iY&#39;]</span>
<span class="c1">#        x = self._getattr()</span>
<span class="c1">#        extent=[x.min(), x.max(), y.min(), y.max()]</span>
<span class="c1">#</span>
<span class="c1">#        fig=plt.figure(figsize=(10,6))</span>
<span class="c1">#        from matplotlib import gridspec</span>
<span class="c1">#        gs=gridspec.GridSpec(1,2,width_ratios=[2,1])</span>
<span class="c1">#        </span>
<span class="c1">#        mask=None</span>
<span class="c1">#        mask_r_nda=None</span>
<span class="c1">#        select=True</span>
<span class="c1">#        while select:</span>
<span class="c1">#            plt.subplot(gs[0]).imshow(image,clim=[plotMin,plotMax],interpolation=&#39;None&#39;)</span>
<span class="c1">#</span>
<span class="c1">#            shape = raw_input(&quot;rectangle(r), circle(c) or polygon(p)?:\n&quot;)</span>
<span class="c1">#            if shape==&#39;r&#39;:</span>
<span class="c1">#                print &#39;select two corners: &#39;</span>
<span class="c1">#                p =np.array(ginput(2))</span>
<span class="c1">#                mask_roi=np.zeros_like(image)</span>
<span class="c1">#                mask_roi[p[:,1].min():p[:,1].max(),p[:,0].min():p[:,0].max()]=1</span>
<span class="c1">#                mask_r_nda = np.array( [mask_roi[ix, iy] for ix, iy in zip(iX,iY)] )</span>
<span class="c1">#                plt.subplot(gs[1]).imshow(det.image(self.lda.run,mask_r_nda))</span>
<span class="c1">#                print &#39;mask from rectangle (shape):&#39;,mask_r_nda.shape</span>
<span class="c1">#                if raw_input(&quot;Done?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#                    select = False</span>
<span class="c1">#            elif shape==&#39;c&#39;:</span>
<span class="c1">#                plt.subplot(gs[0]).imshow(np.rot90(image),clim=[plotMin,plotMax],interpolation=&#39;None&#39;,extent=(x.min(),x.max(),y.min(),y.max()))</span>
<span class="c1">#                if raw_input(&quot;Select center by mouse?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#                    c=ginput(1)</span>
<span class="c1">#                    cx=c[0][0];cy=c[0][1]</span>
<span class="c1">#                    print &#39;center: &#39;,cx,&#39; &#39;,cy</span>
<span class="c1">#                else:</span>
<span class="c1">#                    ctot = raw_input(&quot;center (x y)?\n&quot;)</span>
<span class="c1">#                    c = ctot.split(&#39; &#39;);cx=float(c[0]);cy=float(c[1]);</span>
<span class="c1">#                if raw_input(&quot;Select outer radius by mouse?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]: </span>
<span class="c1">#                    r=ginput(1)</span>
<span class="c1">#                    rox=r[0][0];roy=r[0][1]</span>
<span class="c1">#                    ro=np.sqrt((rox-cx)**2+(roy-cy)**2)</span>
<span class="c1">#                    if raw_input(&quot;Select inner radius by mouse?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#                        r=ginput(1)</span>
<span class="c1">#                        rix=r[0][0];riy=r[0][1]</span>
<span class="c1">#                        ri=np.sqrt((rix-cx)**2+(riy-cy)**2)</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        ri=0</span>
<span class="c1">#                    print &#39;radii: &#39;,ro,&#39; &#39;,ri</span>
<span class="c1">#                else:</span>
<span class="c1">#                    rtot = raw_input(&quot;radii (r_outer r_inner)?\n&quot;)</span>
<span class="c1">#                    r = rtot.split(&#39; &#39;);ro=float(r[0]);ri=max(0.,float(r[1]));        </span>
<span class="c1">#                mask_router_nda = np.array( [(ix-cx)**2+(iy-cy)**2&lt;ro**2 for ix, iy in zip(x,y)] )</span>
<span class="c1">#                mask_rinner_nda = np.array( [(ix-cx)**2+(iy-cy)**2&lt;ri**2 for ix, iy in zip(x,y)] )</span>
<span class="c1">#                mask_r_nda = mask_router_nda&amp;~mask_rinner_nda</span>
<span class="c1">#                print &#39;mask from circle (shape):&#39;,mask_r_nda.shape</span>
<span class="c1">#                plt.subplot(gs[1]).imshow(det.image(self.lda.run,mask_r_nda))</span>
<span class="c1">#                if raw_input(&quot;Done?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#                    select = False</span>
<span class="c1">#            elif shape==&#39;p&#39;:</span>
<span class="c1">#                plt.subplot(gs[0]).imshow(np.rot90(image),clim=[plotMin,plotMax],interpolation=&#39;None&#39;,extent=(x.min(),x.max(),y.min(),y.max()))</span>
<span class="c1">#                nPoints = int(raw_input(&quot;Number of Points (-1 until right click)?\n&quot;))</span>
<span class="c1">#                p=np.array(ginput(nPoints))</span>
<span class="c1">#                print p</span>
<span class="c1">#                mpath=path.Path(p)</span>
<span class="c1">#                all_p = np.array([ (ix,iy) for ix,iy in zip(x.flatten(),y.flatten()) ] )</span>
<span class="c1">#                mask_r_nda = np.array([mpath.contains_points(all_p)]).reshape(x.shape)</span>
<span class="c1">#                plt.subplot(gs[1]).imshow(det.image(self.lda.run,mask_r_nda))</span>
<span class="c1">#                print &#39;mask from polygon (shape):&#39;,mask_r_nda.shape</span>
<span class="c1">#                print &#39;not implemented yet....&#39;</span>
<span class="c1">#                if raw_input(&quot;Done?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#                    select = False</span>
<span class="c1">#</span>
<span class="c1">#            if mask_r_nda is not None:</span>
<span class="c1">#                print &#39;created a mask....&#39;</span>
<span class="c1">#                if mask is None:</span>
<span class="c1">#                    mask = mask_r_nda.astype(bool).copy()</span>
<span class="c1">#                else:</span>
<span class="c1">#                    mask = np.logical_or(mask,mask_r_nda)</span>
<span class="c1">#            print &#39;masked now: &#39;,np.ones_like(x)[mask_r_nda.astype(bool)].sum()</span>
<span class="c1">#            print &#39;masked tot: &#39;,np.ones_like(x)[mask.astype(bool)].sum()</span>
<span class="c1">#</span>
<span class="c1">#            fig=plt.figure(figsize=(6,6))</span>
<span class="c1">#            plt.show()</span>
<span class="c1">#            image_mask = img.copy(); image_mask[mask]=0;</span>
<span class="c1">#            plt.imshow(det.image(self.lda.run,image_mask),clim=[plotMin,plotMax])</span>
<span class="c1">#</span>
<span class="c1">#        if det.is_cspad2x2():</span>
<span class="c1">#            mask=mask.reshape(2,185*388).transpose(1,0)</span>
<span class="c1">#        else:</span>
<span class="c1">#            mask=mask.reshape(32*185,388)</span>
<span class="c1">#        #2x2 save as 71780 lines, 2 entries</span>
<span class="c1">#        #cspad save as 5920 lines, 388 entries</span>
<span class="c1">#        if raw_input(&quot;Save to calibdir?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#            if raw_input(&quot;Invert?\n&quot;) in [&quot;n&quot;,&quot;N&quot;]:</span>
<span class="c1">#                mask = (~(mask.astype(bool))).astype(int)</span>
<span class="c1">#            srcStr=det.source.__str__().replace(&#39;Source(&quot;DetInfo(&#39;,&#39;&#39;).replace(&#39;)&quot;)&#39;,&#39;&#39;)</span>
<span class="c1">#            if det.is_cspad2x2():</span>
<span class="c1">#                dirname=&#39;/reg/d/psdm/%s/%s/calib/CsPad2x2::CalibV1/%s/pixel_mask/&#39;%(self.lda.expname[:3],self.lda.expname,srcStr)</span>
<span class="c1">#            else:</span>
<span class="c1">#                dirname=&#39;/reg/d/psdm/%s/%s/calib/CsPad::CalibV1/%s/pixel_mask/&#39;%(self.lda.expname[:3],self.lda.expname,srcStr)        </span>
<span class="c1">#            if not os.path.exists(dirname):</span>
<span class="c1">#                os.makedirs(dirname)</span>
<span class="c1">#            fname=&#39;%s-end.data&#39;%self.lda.run</span>
<span class="c1">#            np.savetxt(dirname+fname,mask)</span>
<span class="c1">#        elif raw_input(&quot;Save to local?\n&quot;) in [&quot;y&quot;,&quot;Y&quot;]:</span>
<span class="c1">#            if raw_input(&quot;Invert?\n&quot;) in [&quot;n&quot;,&quot;N&quot;]:</span>
<span class="c1">#                mask = (~(mask.astype(bool))).astype(int)</span>
<span class="c1">#            np.savetxt(&#39;%s_mask_run%s.data&#39;%(self.lda.expname,self.lda.run),mask)</span>
<span class="c1">#        return mask</span>

<div class="viewcode-block" id="AddOn.psplot"><a class="viewcode-back" href="../../generated/PyDataSource.AddOn.psplot.html#PyDataSource.AddOn.psplot">[docs]</a>    <span class="k">def</span> <span class="nf">psplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add psplot.  Automatically reshape AreaDetector 3D data to 2D for plotting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">              </span>
<span class="sd">        local: bool</span>
<span class="sd">            open psplot locally (default)</span>
<span class="sd">        eventCode: int</span>
<span class="sd">            check if event code(s) are in data </span>
<span class="sd">            (or alternatively not in date with - sign)</span>
<span class="sd">            see is_eventCodePresent</span>
<span class="sd">        nskip : int</span>
<span class="sd">            number of events to skip between plot updates</span>

<span class="sd">        Keywords</span>
<span class="sd">        --------</span>
<span class="sd">        title : str</span>
<span class="sd">            Plot title</span>
<span class="sd">        eventCode : list</span>
<span class="sd">            Plot if eventCode is present</span>
<span class="sd">        transpose : bool</span>
<span class="sd">            Transpose 2D image data before plotting </span>
<span class="sd">        rot90 : bool</span>
<span class="sd">            Rotate 2D image data before plotting [Default = True for Cspad otherwise False]</span>
<span class="sd">        flipud : bool</span>
<span class="sd">            Flip 2D image up/down before plotting [Default = True for Cspad otherwise False]</span>
<span class="sd">        fliplr : bool</span>
<span class="sd">            Flip 2D image left/right before plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">plot_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> 
        <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A string value specifying the plot object must be suppied&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">attr_name</span> <span class="o">=</span> <span class="s1">&#39;_and_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># by default </span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">local</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="s1">&#39;eventCode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ecstrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eventCode&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ecstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ecstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;not&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="n">ec</span><span class="p">))</span>
            <span class="n">ecname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;_and_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ecstrs</span><span class="p">)</span>
            <span class="n">ectitle</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ecstrs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ecname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">ectitle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr_name</span><span class="o">+</span><span class="n">ecname</span>

        <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">attr_name</span><span class="o">+</span><span class="n">ectitle</span>
        
        <span class="k">if</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_ievent</span>

        <span class="k">if</span> <span class="s1">&#39;plot_type&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">plot_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_type</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pub_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eventCode&#39;</span><span class="p">,</span> <span class="s1">&#39;nskip&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose&#39;</span><span class="p">,</span> <span class="s1">&#39;fliplr&#39;</span><span class="p">,</span> <span class="s1">&#39;flipud&#39;</span><span class="p">,</span> <span class="s1">&#39;rot90&#39;</span><span class="p">]</span>
        <span class="n">pub_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                      <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pub_opts</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_error</span> <span class="ow">and</span> <span class="n">plot_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Image&#39;</span><span class="p">,</span><span class="s1">&#39;XYPlot&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;Image&#39;</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;XYPlot&#39;</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># place holder for stats plots</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;xXYPlot&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;xImage&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plot_error</span> <span class="o">=</span> <span class="s1">&#39;Data with ndim = </span><span class="si">{:}</span><span class="s1"> not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">plot_error</span> <span class="o">=</span> <span class="s1">&#39;Data must be numpy array of one or two dimensions.</span><span class="se">\n</span><span class="s1">&#39;</span>               
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="ow">is</span> <span class="s1">&#39;Image&#39;</span><span class="p">:</span>
                <span class="n">plt_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect_lock&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;xrange&#39;</span><span class="p">,</span> <span class="s1">&#39;yrange&#39;</span><span class="p">]</span>
                <span class="n">plt_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                              <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">plt_opts</span><span class="p">}</span>
        
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">calibData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="s1">&#39;calibData&#39;</span><span class="p">)</span>
                    <span class="n">pub_kwargs</span><span class="p">[</span><span class="s1">&#39;reshape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">calibData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                    <span class="n">calibData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="s1">&#39;calibData&#39;</span><span class="p">)</span>
<span class="c1">#                    scale = calibData.pixel_size/1000.</span>
<span class="c1">#                    if not plt_kwargs.get(&#39;pos&#39;):</span>
<span class="c1">#                        plt_kwargs[&#39;pos&#39;] = (calibData.image_xaxis[0]/1000., calibData.image_yaxis[0]/1000.)</span>
<span class="c1">#                    if not plt_kwargs.get(&#39;scale&#39;):</span>
<span class="c1">#                        plt_kwargs[&#39;scale&#39;] = (scale, scale)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">):</span>
                        <span class="n">plt_kwargs</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">):</span>
                        <span class="n">plt_kwargs</span><span class="p">[</span><span class="s1">&#39;ylabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;devName&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cspad&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;rot90&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pub_kwargs</span><span class="p">:</span>
                            <span class="n">pub_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;rot90&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="c1">#                        if &#39;flipud&#39; not in pub_kwargs:</span>
<span class="c1">#                            pub_kwargs.update({&#39;flipud&#39;: True})</span>

                <span class="n">plt_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;det&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span>
                            <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">,</span>  
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;plot_function&#39;</span><span class="p">:</span> <span class="n">plot_type</span><span class="p">,</span>
                            <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
                            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">plt_kwargs</span><span class="p">,</span>
                            <span class="s1">&#39;pubargs&#39;</span><span class="p">:</span> <span class="n">pub_kwargs</span><span class="p">}</span>
            
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="ow">is</span> <span class="s1">&#39;XYPlot&#39;</span><span class="p">:</span>
                <span class="n">plt_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span><span class="s1">&#39;formats&#39;</span><span class="p">]</span>
                <span class="n">plt_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                              <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">plt_opts</span><span class="p">}</span>
                <span class="k">if</span> <span class="s1">&#39;xdata&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">xdata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xdata&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]:</span>
                        <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;xdata&#39;</span><span class="p">]</span>
                        <span class="n">axis_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;axis_name&#39;</span><span class="p">)</span>
                        <span class="n">xunit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xunit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis_name</span><span class="p">,</span> <span class="n">xunit</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">):</span>
                            <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">})</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">):</span>
                            <span class="n">plt_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;[</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">)})</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getattr</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                
                <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">plt_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;det&#39;</span><span class="p">:</span> <span class="n">alias</span><span class="p">,</span>
                            <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">,</span>
                            <span class="s1">&#39;xdata&#39;</span><span class="p">:</span> <span class="n">xdata</span><span class="p">,</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;plot_function&#39;</span><span class="p">:</span> <span class="n">plot_type</span><span class="p">,</span>
                            <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
                            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">plt_kwargs</span><span class="p">,</span>
                            <span class="s1">&#39;pubargs&#39;</span><span class="p">:</span> <span class="n">pub_kwargs</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">plot_error</span> <span class="o">=</span> <span class="s1">&#39;Unknown plot type </span><span class="si">{:}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error adding psplot:&#39;</span> <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">plot_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;psmon plot added -- use the following to view: &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&gt; psplot -s </span><span class="si">{:}</span><span class="s1"> -p 12301 </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING -- see notice when adding for -p PORT specification&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           if default PORT=12301 not available&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;psplot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;psplot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;psplot&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt_args</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">publish</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
                <span class="n">publish</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
                <span class="n">psmon_publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)</span>  </div>

<span class="c1">#    def __getattr__(self, attr):</span>
<span class="c1">#        if attr in self._plugins:</span>
<span class="c1">#            plugin = self._plugins.get(attr)</span>
<span class="c1">#            return plugin(self._ds)._det_add(attr)</span>
<span class="c1">#            if plugin:</span>
<span class="c1">#                return getattr(plugin, &#39;add&#39;)</span>

<span class="c1">#    def __setattr__(self, attr, val):</span>
<span class="c1">#        if attr not in self._init_attrs:</span>
<span class="c1">#            self._plugins.update({attr: val})</span>

    <span class="k">def</span> <span class="nf">_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get detector attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plugins</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">AddOn</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="IpimbData"><a class="viewcode-back" href="../../generated/PyDataSource.IpimbData.html#PyDataSource.IpimbData">[docs]</a><span class="k">class</span> <span class="nc">IpimbData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tab accessibile dictified psana.Detector object.</span>
<span class="sd">       </span>
<span class="sd">       Attributes come from psana.Detector </span>
<span class="sd">       with low level implementation done in C++ or python.  </span>
<span class="sd">       Boost is used for the C++.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;xpos&#39;</span><span class="p">,</span> <span class="s1">&#39;ypos&#39;</span><span class="p">]</span> 

    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span>     <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Array of 4 channel values&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">},</span>
            <span class="s1">&#39;sum&#39;</span><span class="p">:</span>         <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Sum of all 4 channels&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">},</span>
            <span class="s1">&#39;xpos&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Calulated X beam position&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;mm&#39;</span><span class="p">},</span>
            <span class="s1">&#39;ypos&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Calulated Y beam position&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;mm&#39;</span><span class="p">},</span>
            <span class="p">}</span> 

<div class="viewcode-block" id="IpimbData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.IpimbData.html#PyDataSource.IpimbData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span></div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrument to which this detector belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:.5}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)})</span>
             
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">IpimbData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>

<span class="k">class</span> <span class="nc">GenericWaveformData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tab accessibile dictified psana.Detector object.</span>
<span class="sd">       </span>
<span class="sd">       Attributes come from psana.Detector </span>
<span class="sd">       with low level implementation done in C++ or python.  </span>
<span class="sd">       Boost is used for the C++.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;waveform&#39;</span><span class="p">]</span> 

    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>    <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Waveform array&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">},</span>
<span class="c1">#            &#39;wftime&#39;:      {&#39;doc&#39;: &#39;Waveform sample time&#39;,</span>
<span class="c1">#                            &#39;unit&#39;: &#39;s&#39;},</span>
            <span class="p">}</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:.5}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of waveforms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)</span>

<span class="c1">#    def __getattr__(self, attr):</span>
<span class="c1">#        if attr in self._attrs:</span>
<span class="c1">#            return getattr(self._det, attr)(self._evt)</span>
<span class="c1">#</span>
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">GenericWaveformData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span>


<div class="viewcode-block" id="WaveformData"><a class="viewcode-back" href="../../generated/PyDataSource.WaveformData.html#PyDataSource.WaveformData">[docs]</a><span class="k">class</span> <span class="nc">WaveformData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tab accessibile dictified psana.Detector object.</span>
<span class="sd">       </span>
<span class="sd">    Attributes come from psana.Detector with low level implementation </span>
<span class="sd">    done in C++ or python.  </span>
<span class="sd">    Boost is used for the C++.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;waveform&#39;</span><span class="p">,</span> <span class="s1">&#39;wftime&#39;</span><span class="p">]</span> 

    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;waveform&#39;</span><span class="p">:</span>    <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Waveform array&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">},</span>
            <span class="s1">&#39;wftime&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Waveform sample time&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">},</span>
            <span class="p">}</span> 

<div class="viewcode-block" id="WaveformData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.WaveformData.html#PyDataSource.WaveformData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrument to which this detector belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:.5}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Only access psana.Detector data once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)})</span>
             
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">WaveformData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>

<span class="k">class</span> <span class="nc">GenericWaveformCalibData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic Waveform Calib Data -- not implented</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>


<div class="viewcode-block" id="WaveformCalibData"><a class="viewcode-back" href="../../generated/PyDataSource.WaveformCalibData.html#PyDataSource.WaveformCalibData">[docs]</a><span class="k">class</span> <span class="nc">WaveformCalibData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Waveform Calibration data using psana.Detector access.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runnum&#39;</span><span class="p">]</span> 

    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;runnum&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Run number&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
            <span class="p">}</span>

<div class="viewcode-block" id="WaveformCalibData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.WaveformCalibData.html#PyDataSource.WaveformCalibData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrument to which this detector belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">print_attributes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        On/off correction of time.&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">set_correct_acqiris_time</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">dettype</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">set_calib_imp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:.5}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">WaveformCalibData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ImageData"><a class="viewcode-back" href="../../generated/PyDataSource.ImageData.html#PyDataSource.ImageData">[docs]</a><span class="k">class</span> <span class="nc">ImageData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tab accessibile dictified psana Detector object.</span>
<span class="sd">       </span>
<span class="sd">    Attributes come from psana.Detector with low level implementation </span>
<span class="sd">    done in C++ or python.  Boost is used for the C++.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;calib&#39;</span><span class="p">,</span> <span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="s1">&#39;photons&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span> 
    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;shape&#39;</span><span class="p">:</span>       <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Shape of raw data array&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Total size of raw data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span>         <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Raw data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;calib&#39;</span><span class="p">:</span>       <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Calibrated data&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span>       <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Reconstruced 2D image from calibStore geometry&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;photons&#39;</span><span class="p">:</span>     <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;2-d or 3-d array of integer number of merged photons&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;corr&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pedestal corrected data (no common mode correction)&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="p">}</span> 

    <span class="c1">#def __init__(self, det, evt, opts={}):</span>
<div class="viewcode-block" id="ImageData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.ImageData.html#PyDataSource.ImageData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span></div>
        <span class="c1">#self._opts = opts</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrument to which this detector belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">photons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns photons with correction for split photons between neighboring pixels.</span>
<span class="sd">        adu_per_photon </span>
<span class="sd">          - photon conversion factor parameter </span>
<span class="sd">          - can be updated with set_adu_per_photon.</span>
<span class="sd">          - default = 30</span>
<span class="sd">        thr_fraction </span>
<span class="sd">          - fraction of the merged intensity which gets converted to one photon</span>
<span class="sd">          - can be updated with set_thr_fraction.</span>
<span class="sd">          - default = 0.9</span>
<span class="sd">        see:  https://confluence.slac.stanford.edu/display/PSDM/Hit+and+Peak+Finding+Algorithms#HitandPeakFindingAlgorithms-Photoncounting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu_per_photon</span><span class="p">:</span>
            <span class="n">adu_per_photon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu_per_photon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adu_per_photon</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thr_fraction</span><span class="p">:</span>
            <span class="n">thr_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thr_fraction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thr_fraction</span> <span class="o">=</span> <span class="mf">0.9</span> 

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">photons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> 
                    <span class="n">adu_per_photon</span><span class="o">=</span><span class="n">adu_per_photon</span><span class="p">,</span>
                    <span class="n">thr_fraction</span><span class="o">=</span><span class="n">thr_fraction</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pedestal corrected raw data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">pedestals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">-</span><span class="n">ped</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>

    <span class="k">def</span> <span class="nf">set_thr_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thr_fraction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets threshold fraction for photons calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span><span class="n">thr_fraction</span><span class="o">=</span><span class="n">thr_fraction</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_adu_per_photon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adu_per_photon</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets adu per photon for photons calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span><span class="n">adu_per_photon</span><span class="o">=</span><span class="n">adu_per_photon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nda</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an image from the input numpy array based on the </span>
<span class="sd">        geometry in the calib directory for this event.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nda : np.array</span>
<span class="sd">            input array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="n">nda</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">common_mode_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nda</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the common mode correction for the input numpy </span>
<span class="sd">        array (pedestal-subtracted). </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">common_mode_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="n">nda</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">common_mode_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nda</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply in place the common mode correction for the input </span>
<span class="sd">        numpy array (pedestal-subtracted). </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">common_mode_apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="n">nda</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;corr&#39;</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">strval</span> <span class="o">=</span> <span class="n">_repr_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span> <span class="n">strval</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                
<span class="c1">#                if isinstance(value, str):</span>
<span class="c1">#                    fdict[&#39;str&#39;] = value</span>
<span class="c1">#                elif isinstance(value, list):</span>
<span class="c1">#                    if len(value) &lt; 5:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = str(value)</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = &#39;list&#39;</span>
<span class="c1">#                elif hasattr(value,&#39;mean&#39;):</span>
<span class="c1">#                    if value.size &lt; 5:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = str(value)</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = &#39;&lt;{:.5}&gt;&#39;.format(value.mean())</span>
<span class="c1">#                else:</span>
<span class="c1">#                    try:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = &#39;{:12.5g}&#39;.format(value)</span>
<span class="c1">#                    except:</span>
<span class="c1">#                        fdict[&#39;str&#39;] = str(value)</span>
<span class="c1">#</span>
                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Only access psana.Detector data once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
<span class="c1">#                opts = self._opts.get(attr, {})</span>
<span class="c1">#                self._data.update({attr: getattr(self._det, attr)(self._evt, **opts)})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">size</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">ImageData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ImageCalibData"><a class="viewcode-back" href="../../generated/PyDataSource.ImageCalibData.html#PyDataSource.ImageCalibData">[docs]</a><span class="k">class</span> <span class="nc">ImageCalibData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calibration Data from psana Detector object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">,</span> <span class="s1">&#39;pedestals&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;bkgd&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span>
              <span class="s1">&#39;common_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;runnum&#39;</span><span class="p">,</span>
              <span class="s1">&#39;areas&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;indexes_y&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_size&#39;</span><span class="p">,</span>
              <span class="s1">&#39;coords_x&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_y&#39;</span><span class="p">,</span> <span class="s1">&#39;coords_z&#39;</span><span class="p">,</span> 
              <span class="s1">&#39;image_xaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;image_yaxis&#39;</span><span class="p">,</span>
              <span class="p">]</span> 
    <span class="n">_attr_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;runnum&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Run number&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;shape&#39;</span><span class="p">:</span>       <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Shape of raw data array&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Total size of raw data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;ndim&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of dimensions of raw data&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pedestals&#39;</span><span class="p">:</span>   <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pedestals from calibStore&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;rms&#39;</span><span class="p">:</span>         <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;ADU&#39;</span><span class="p">},</span>
            <span class="s1">&#39;gain&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel Gain factor from calibStore&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;bkgd&#39;</span><span class="p">:</span>        <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span>      <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;common_mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Common mode parameters&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;areas&#39;</span><span class="p">:</span>       <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel area correction factor&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;indexes_x&#39;</span><span class="p">:</span>   <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel X index&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;indexes_y&#39;</span><span class="p">:</span>   <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel Y index&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pixel_size&#39;</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel Size&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="s1">&#39;coords_x&#39;</span><span class="p">:</span>    <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel X coordinate&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="s1">&#39;coords_y&#39;</span><span class="p">:</span>    <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel Y coordinate&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="s1">&#39;coords_z&#39;</span><span class="p">:</span>    <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Pixel Z coordinate&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="s1">&#39;image_xaxis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Image X coordinate&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="s1">&#39;image_yaxis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Image Y coordinate&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span><span class="p">},</span>
            <span class="p">}</span> 

<div class="viewcode-block" id="ImageCalibData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.ImageCalibData.html#PyDataSource.ImageCalibData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt</span> <span class="o">=</span> <span class="n">evt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instrument to which this detector belongs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">instrument</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get image origin indecies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ixo</span><span class="p">,</span> <span class="n">iyo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">point_indexes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ixo</span><span class="p">,</span> <span class="n">iyo</span>

    <span class="k">def</span> <span class="nf">_get_point_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">ixo</span><span class="p">,</span> <span class="n">iyo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">point_indexes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">yaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span><span class="o">-</span><span class="n">iyo</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">yaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yaxis</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">xaxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span><span class="o">-</span><span class="n">ixo</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xaxis</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ixo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;ixo&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;doc&#39;</span><span class="p">:</span>  <span class="s1">&#39;Image x index of origin&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">ixo</span><span class="p">}})</span>
        <span class="k">if</span> <span class="n">xaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;xaxis&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;doc&#39;</span><span class="p">:</span>  <span class="s1">&#39;Reconstructed image xaxis&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">xaxis</span><span class="p">}})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;iyo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;iyo&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;doc&#39;</span><span class="p">:</span>  <span class="s1">&#39;Image y index of origin&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">iyo</span><span class="p">}})</span>
        <span class="k">if</span> <span class="n">yaxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="s1">&#39;yaxis&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;doc&#39;</span><span class="p">:</span>  <span class="s1">&#39;Reconstructed image yaxis&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">yaxis</span><span class="p">}})</span>

        <span class="k">return</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstructed image x axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_xaxis</span>
<span class="c1">#        item = self._info.get(&#39;xaxis&#39;)</span>
<span class="c1">#        if item:</span>
<span class="c1">#            xaxis = item.get(&#39;value&#39;)</span>
<span class="c1">#        else:</span>
<span class="c1">#            xaxis, yaxis = self._get_point_indexes()</span>
<span class="c1">#            </span>
<span class="c1">#        return xaxis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstruced image y axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_yaxis</span>
<span class="c1">#        item = self._info.get(&#39;yaxis&#39;)</span>
<span class="c1">#        if item:</span>
<span class="c1">#            yaxis = item.get(&#39;value&#39;)</span>
<span class="c1">#        else:</span>
<span class="c1">#            xaxis, yaxis = self._get_point_indexes()</span>
<span class="c1">#            </span>
<span class="c1">#        return yaxis</span>

    <span class="k">def</span> <span class="nf">set_gain_mask_factor</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mf">6.85</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set Gain mask factor.  Default=6.85</span>
<span class="sd">        Passed to gain_mask(...) in the calib and image methods</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">set_gain_mask_factor</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_do_offset</span><span class="p">(</span><span class="n">do_offset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch mode of the Camera type of detector.</span>
<span class="sd">        Control parameter to turn on/off Camera intensity offset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">set_do_offset</span><span class="p">(</span><span class="n">do_offset</span><span class="o">=</span><span class="n">do_offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">central</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">unbond</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unbondnbrs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate image mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calib: bool</span>
<span class="sd">            mask from file in calib directory.</span>
<span class="sd">        status: bool</span>
<span class="sd">            pixel status from file in calib director.</span>
<span class="sd">        edges: bool</span>
<span class="sd">            mask detector module edge pixels (mbit +1 in mask_geo).</span>
<span class="sd">        central: bool</span>
<span class="sd">            mask wide central columns (mbit +2 in mask_geo).</span>
<span class="sd">        unbond: bool</span>
<span class="sd">            mask unbonded pixels (mbit +4 in mask_geo).</span>
<span class="sd">        unbondnbrs: bool</span>
<span class="sd">            mask unbonded neighbour pixels (mbit +8 in mask_geo).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        combined mask: array-like</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="n">calib</span><span class="o">=</span><span class="n">calib</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> 
                              <span class="n">central</span><span class="o">=</span><span class="n">central</span><span class="p">,</span> <span class="n">unbond</span><span class="o">=</span><span class="n">unbond</span><span class="p">,</span> <span class="n">unbondnbrs</span><span class="o">=</span><span class="n">unbondnbrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mask_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbits</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return geometry mask for given mbits keyword.</span>
<span class="sd">        Default is mbits=15 to mask edges, wide central columns,</span>
<span class="sd">        non-bo pixels and their neighbors</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mbits: int </span>
<span class="sd">            +1-edges; </span>
<span class="sd">            +2-wide central cols; </span>
<span class="sd">            +4 unbonded pixel; </span>
<span class="sd">            +8-unbonded neighbour pixels;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">mask_geo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">,</span> <span class="n">mbits</span><span class="o">=</span><span class="n">mbits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">print_attributes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information for relevant detector attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_info</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                <span class="n">fdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;list&#39;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:.5}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:12.5g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{attr:18s}</span><span class="s1"> </span><span class="si">{str:&gt;12}</span><span class="s1"> </span><span class="si">{unit:7}</span><span class="s1"> </span><span class="si">{doc:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fdict</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;No Event&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">ImageCalibData</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EpicsConfig"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsConfig.html#PyDataSource.EpicsConfig">[docs]</a><span class="k">class</span> <span class="nc">EpicsConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tab Accessible configStore Epics information.</span>
<span class="sd">    Currently relatively simple, but expect this to be expanded</span>
<span class="sd">    at some point with more PV config info with daq update.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_pv_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="s1">&#39;pvId&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EpicsConfig.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsConfig.html#PyDataSource.EpicsConfig.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configStore</span><span class="p">):</span>

        <span class="c1"># move to PsanaSrcData objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">configStore</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">type</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;psana.Epics&#39;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">configStore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span><span class="n">key</span><span class="o">.</span><span class="n">src</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">getPvConfig</span><span class="p">():</span>
                    <span class="n">pvdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">attr</span><span class="p">)()</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_attrs</span><span class="p">}</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">description</span><span class="p">()]</span> <span class="o">=</span> <span class="n">pvdict</span></div>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#for alias, items in self._pvs.items():</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">message</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:18s}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">pvId</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pvs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EpicsConfig</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EpicsData"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsData.html#PyDataSource.EpicsData">[docs]</a><span class="k">class</span> <span class="nc">EpicsData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Epics data from psana epicsStore.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : object</span>
<span class="sd">        PyDataSource.DataSource object</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dictified representation of ds.env().epicsStore()</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    epicsStore = EpicsData(ds)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EpicsData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsData.html#PyDataSource.EpicsData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>

        <span class="n">pv_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">epicsStore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epicsConfig</span> <span class="o">=</span> <span class="n">EpicsConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">configStore</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span>  <span class="n">epicsStore</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;:|\.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">)</span>
            <span class="c1">#check if valid -- some old data had aliases generated from comments in epicsArch files.</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[_A-Za-z][_a-zA-Z0-9]*$&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="n">epicsStore</span><span class="o">.</span><span class="n">pvName</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pvname</span><span class="p">:</span>
                    <span class="n">pvalias</span> <span class="o">=</span> <span class="n">pv</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pvalias</span> <span class="o">=</span> <span class="n">epicsStore</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                    <span class="n">pvname</span> <span class="o">=</span> <span class="n">pv</span>

                <span class="n">pvalias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;:|\.|-| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pvalias</span><span class="p">)</span>
                <span class="n">components</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:|\.|-| &#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">components</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># check if alias has 2 components -- if not fix</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pv</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">components</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="o">+</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="n">pv_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">pvname</span><span class="p">,</span>
                                   <span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">pvalias</span><span class="p">,</span>
                                   <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="n">components</span><span class="p">,</span>
                                 <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pv_dict</span> <span class="o">=</span> <span class="n">pv_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span></div>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">pdict</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">pdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">PvData</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">()):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">(),</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">())</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EpicsData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>



<div class="viewcode-block" id="PvData"><a class="viewcode-back" href="../../generated/PyDataSource.PvData.html#PyDataSource.PvData">[docs]</a><span class="k">class</span> <span class="nc">PvData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Epics PV Data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PvData.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.PvData.html#PyDataSource.PvData.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_dict</span> <span class="o">=</span> <span class="n">attr_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="n">level</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">pdict</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span></div>

    <span class="k">def</span> <span class="nf">_get_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">EpicsStorePV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">env</span><span class="p">()</span><span class="o">.</span><span class="n">epicsStore</span><span class="p">(),</span> <span class="n">pv</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show information from PVdictionary for all PV&#39;s starting with </span>
<span class="sd">        the specified dictified base.</span>
<span class="sd">        (i.e. &#39;:&#39; replaced by &#39;.&#39; to make them tab accessible in python)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return string representation of all PV&#39;s starting with </span>
<span class="sd">        the specified dictified base.</span>
<span class="sd">        (i.e. &#39;:&#39; replaced by &#39;.&#39; to make them tab accessible in python)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">pdict</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">alias</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">pvfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pvfunc</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">pvfunc</span><span class="o">.</span><span class="n">isCtrl</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;isCtrl&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:30s}</span><span class="s1"> </span><span class="si">{:12.4g}</span><span class="s1"> -- </span><span class="si">{:30s}</span><span class="s1"> </span><span class="si">{:10}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                        <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:30s}</span><span class="s1"> </span><span class="si">{:&gt;12}</span><span class="s1"> -- </span><span class="si">{:30s}</span><span class="s1"> </span><span class="si">{:10}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                        <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">pdict</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">pdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">PvData</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">PvData</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="EpicsStorePV"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsStorePV.html#PyDataSource.EpicsStorePV">[docs]</a><span class="k">class</span> <span class="nc">EpicsStorePV</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Epics PV access from epicsStore. </span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EpicsStorePV.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.EpicsStorePV.html#PyDataSource.EpicsStorePV.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epicsStore</span><span class="p">,</span> <span class="n">pv</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epicsStore</span> <span class="o">=</span> <span class="n">epicsStore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span> <span class="o">=</span> <span class="n">pv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">epicsStore</span><span class="o">.</span><span class="n">getPV</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">)</span> \
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> \
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dbr&#39;</span><span class="p">,</span><span class="s1">&#39;stamp&#39;</span><span class="p">]]</span></div>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> = </span><span class="si">{:}</span><span class="s1"> -- </span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span><span class="p">,</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_attrs</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:12}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(),</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epicsStore</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="s1">&#39;stamp&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">TimeStamp</span><span class="p">(</span><span class="n">val</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">val</span><span class="p">()</span> 
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&lt;</span><span class="si">{:}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1"> = </span><span class="si">{:}</span><span class="s1">, </span><span class="si">{:}</span><span class="s1"> -- </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span><span class="p">,</span> \
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stamp</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">(</span><span class="n">EpicsStorePV</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_attrs</span><span class="p">))</span></div>


<div class="viewcode-block" id="TimeStamp"><a class="viewcode-back" href="../../generated/PyDataSource.TimeStamp.html#PyDataSource.TimeStamp">[docs]</a><span class="k">class</span> <span class="nc">TimeStamp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to represent time stamp objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeStamp.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.TimeStamp.html#PyDataSource.TimeStamp.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stamp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">sec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsec</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">.</span><span class="n">nsec</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time stamp date representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> 
                <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Time stamp time representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EventTimeStr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">))</span>
        <span class="n">EventTimeStr</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsec</span><span class="o">/</span><span class="mf">1e5</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">EventTimeStr</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">.</span><span class="si">{:}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1"> &gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__name_</span><span class="p">,</span> <span class="n">_self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_update_stats</span><span class="p">(</span><span class="n">evt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update Welford statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">welford</span> <span class="k">import</span> <span class="n">Welford</span>
    <span class="n">istep</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">_istep</span>
    <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">_dets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">det</span><span class="o">.</span><span class="n">_det_config</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">getattr_complete</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">eventCodes</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;eventCodes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="n">eventCodes</span><span class="p">:</span>
                    <span class="c1"># Note that no Evr for Controls cameras</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">Evr</span><span class="p">,</span> <span class="s1">&#39;present&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">det</span><span class="o">.</span><span class="n">Evr</span><span class="o">.</span><span class="n">present</span><span class="p">(</span><span class="n">ec</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]:</span>
                            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ec</span><span class="p">:</span> <span class="p">{}})</span>
                        <span class="n">funcs</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;funcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span> 
                        <span class="k">if</span> <span class="n">istep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                            <span class="n">funcs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">istep</span><span class="p">:</span> <span class="n">Welford</span><span class="p">()})</span>
                        <span class="n">fec</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">fec</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">fec</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                                <span class="n">fec</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stats update error&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stats update error&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">_alias</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
<span class="c1">#            else:</span>
<span class="c1">#                print alias, name, attr, vals</span>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>