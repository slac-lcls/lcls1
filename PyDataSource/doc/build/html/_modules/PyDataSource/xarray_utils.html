

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.xarray_utils &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.xarray_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.xarray_utils</h1><div class="highlight"><pre>
<div class="viewcode-block" id="to_summary"><a class="viewcode-back" href="../../generated/PyDataSource.to_summary.html#PyDataSource.to_summary">[docs]</a><span></span><span class="k">def</span> <span class="nf">to_summary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> 
        <span class="n">save_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">normby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">omit_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">],</span>
        <span class="c1">#stats=[&#39;mean&#39;, &#39;std&#39;, &#39;min&#39;, &#39;max&#39;,],</span>
        <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span>
        <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;Damage_cut&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summarize a run.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    x : xarray.Dataset</span>
<span class="sd">        input xarray Dataset</span>
<span class="sd">    dim : str</span>
<span class="sd">        dimension to summarize over [default = &#39;time&#39;]</span>
<span class="sd">    groupby : str</span>
<span class="sd">        coordinate to groupby [default = &#39;step&#39;]</span>
<span class="sd">    save_summary : bool</span>
<span class="sd">        Save resulting xarray Dataset object</span>
<span class="sd">    normby : list or dict</span>
<span class="sd">        Normalize data by attributes</span>
<span class="sd">    omit_list : list</span>
<span class="sd">        List of Dataset attributes to omit</span>
<span class="sd">    stats : list</span>
<span class="sd">        List of statistical operations to be performed for summary.</span>
<span class="sd">        Default = [&#39;mean&#39;, &#39;std&#39;, &#39;var&#39;, &#39;min&#39;, &#39;max&#39;, &#39;count&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="n">xattrs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span>
    <span class="n">data_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cut</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
   
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">dim</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit_list</span> <span class="ow">and</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span> 
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normby</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">norm_attr</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">normby</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">norm_attr</span><span class="o">=</span><span class="n">norm_attr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normby</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">normalize_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">normby</span><span class="p">)</span>

    <span class="c1"># With new xarray 0.9.1 need to make sure loaded otherwise h5py error</span>
    <span class="n">x</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">xgroups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="n">groupby</span><span class="o">+</span><span class="s1">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sattrs</span><span class="p">:</span>
                <span class="n">xstat</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">sattrs</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">groupby</span><span class="o">+</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">groupby</span><span class="p">})</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">sattrs</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span>
    <span class="c1">#        group_vars = [attr for attr in x.keys() if groupby+&#39;s&#39; in x[attr].dims]</span>
    <span class="c1">#        if group_vars:</span>
    <span class="c1">#            xgroups = {attr: x[attr].rename({groupby+&#39;s&#39;: groupby}) for attr in group_vars}</span>
    <span class="c1">#            for attr in group_vars:</span>
    <span class="c1">#                del x[attr]</span>
            <span class="c1">#x = x.groupby(groupby)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot groupby </span><span class="si">{:}</span><span class="s1"> -- ignoring groupby&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groupby</span><span class="p">))</span>


    <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">func</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;concat_dim&#39;</span><span class="p">:</span> <span class="s1">&#39;stat&#39;</span><span class="p">})</span>
<span class="c1">#    try:</span>
<span class="c1">#        x = xr.concat([dsets, stats], dim=&#39;stat&#39;)</span>
<span class="c1">#    except:</span>
<span class="c1">#        return dsets</span>
    
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">xattrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="n">data_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>                                                       
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">and</span> <span class="n">sattrs</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xstat</span><span class="p">)</span>
<span class="c1">#    try:</span>
<span class="c1">#        for attr in group_vars:</span>
<span class="c1">#            x[attr] = xgroups[attr]</span>
<span class="c1">#    except:</span>
<span class="c1">#        return x, xgroups</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_summary</span><span class="p">:</span>
        <span class="n">to_h5netcdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>

<span class="k">def</span> <span class="nf">resort</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resort alphabitically xarray Dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">dims</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>                                                       
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">normalize_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[],</span> <span class="n">norm_attr</span><span class="o">=</span><span class="s1">&#39;PulseEnergy&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a list of variables with norm_attr [default = &#39;PulseEnergy&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)]</span>    
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">variables</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">aname</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="n">norm_attr</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; -- normalized to &#39;</span><span class="o">+</span><span class="n">norm_attr</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                <span class="n">norm_units</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">norm_attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">units</span> <span class="ow">and</span> <span class="n">norm_units</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">aname</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">units</span><span class="p">,</span> <span class="n">norm_units</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s1">&#39;cannot add attrs for&#39;</span><span class="p">,</span> <span class="n">aname</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot normalize </span><span class="si">{:}</span><span class="s1"> with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">norm_attr</span><span class="p">)</span>

    <span class="k">return</span>  <span class="n">resort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add index for attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bins</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">percentiles</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">percentiles</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_index&#39;</span>

    <span class="c1">#per = [percentiles[i-1] for i in np.digitize(x[attr].values, bins)]</span>
    <span class="n">x</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add_steps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add step coordinate for attr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
    <span class="n">asteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_step&#39;</span>
 
    <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">asteps</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_butterworth_filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
            <span class="n">norm_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">filt_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imputer_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">drop_attr</span><span class="o">=</span><span class="s1">&#39;XrayOff&#39;</span><span class="p">,</span> 
            <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add Butterworth high, low or band pass filter for attr.</span>
<span class="sd">    </span>
<span class="sd">    Events with drop_attr and below threshold are considered missing </span>
<span class="sd">    during filtering.  They are replaced using sklearn Imputer method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    attr : str</span>
<span class="sd">        Name of Dataset attribute</span>
<span class="sd">    lowcut : float</span>
<span class="sd">        Low pass frequency cutoff</span>
<span class="sd">    highcut : float</span>
<span class="sd">        High pass frequency cutoff</span>
<span class="sd">    order : int</span>
<span class="sd">        Butterworth filter order [Default = 10, i.e., 10th order Butterworth filter]</span>
<span class="sd">    filt_name : str, optional</span>
<span class="sd">        Name of resutling filtered data.  [Default = attr+&#39;_filt&#39;]</span>
<span class="sd">    pass_name : str, optional</span>
<span class="sd">        Name of resutling band pass data.</span>
<span class="sd">        - Lowpass Default = attr+&#39;_lowpass&#39;</span>
<span class="sd">        - Highpass Default = attr+&#39;_highpass&#39;</span>
<span class="sd">        - Bandpass Default = attr+&#39;_bandpass&#39;</span>
<span class="sd">    imputer_name : str, optional</span>
<span class="sd">        Name of corrected data using Imputer method for drop_attr and below </span>
<span class="sd">        threshold data</span>
<span class="sd">    dim : str</span>
<span class="sd">        Dimension to filter over [Default = &#39;time&#39;]</span>
<span class="sd">    drop_attr : str</span>
<span class="sd">        Replace points where drop_attr is True with average of nearest points </span>
<span class="sd">        during filtering.  </span>
<span class="sd">        Resulting filtered data where drop_attr is True is unaffected.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        Minimum threshold to filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">from</span> <span class="nn">filter_methods</span> <span class="k">import</span> <span class="n">butter_bandpass_filter</span> 
    <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">sec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">sec</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">lowcut</span> <span class="ow">and</span> <span class="n">highcut</span><span class="p">:</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;band&#39;</span>
    <span class="k">elif</span> <span class="n">highcut</span><span class="p">:</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
    <span class="k">elif</span> <span class="n">lowcut</span><span class="p">:</span>
        <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error -- must supply lowcut, highcut or both&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;nsec&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">drop_attr</span> <span class="ow">and</span> <span class="n">drop_attr</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="o">~</span><span class="n">x</span><span class="p">[</span><span class="n">drop_attr</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;drop sum&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">cut</span> <span class="o">=</span>  <span class="n">xr</span><span class="o">.</span><span class="n">ufuncs</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;threshold cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    
        <span class="k">if</span> <span class="n">norm_attr</span> <span class="ow">and</span> <span class="n">norm_attr</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">norm_threshold</span><span class="p">:</span>
                <span class="n">cut</span> <span class="o">=</span>  <span class="n">xr</span><span class="o">.</span><span class="n">ufuncs</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">norm_attr</span><span class="p">]</span><span class="o">&gt;</span><span class="n">norm_threshold</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;norm threshold cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
     
            <span class="n">dfnorm</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">norm_attr</span><span class="p">]]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">norm_attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">dfnorm0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">norm_attr</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">norm_attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfnorm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">norm_attr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> not available for normalization&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_attr</span><span class="p">))</span>
    
        <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">attr</span><span class="p">]]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">attr</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="k">import</span> <span class="n">Imputer</span>
        <span class="n">mean_imputer</span> <span class="o">=</span> <span class="n">Imputer</span><span class="p">(</span><span class="n">missing_values</span><span class="o">=</span><span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dfnorm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mean_imputer</span> <span class="o">=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_imputer</span> <span class="o">=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfnorm</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">/=</span> <span class="n">mean_imputer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dfnorm</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
   
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mean_imputer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not preprocess </span><span class="si">{:}</span><span class="s1"> using Imputation of events with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">drop_attr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data0</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="n">dfnorm0</span><span class="o">.</span><span class="n">values</span>

    <span class="n">filt</span> <span class="o">=</span> <span class="n">butter_bandpass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">imputer_name</span> <span class="ow">and</span> <span class="n">mean_imputer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">imputer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">imputer_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">x</span><span class="p">[</span><span class="n">imputer_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> imputer corrected data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">imputer_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drop_attr</span>
        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">imputer_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span> 

    <span class="k">if</span> <span class="n">filt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error making filter for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
   
    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">dfnorm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filt_name</span><span class="p">:</span>
                <span class="n">filt_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_filt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_name</span><span class="p">:</span>
                <span class="n">pass_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">pass&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">btype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filt_name</span><span class="p">:</span>
                <span class="n">filt_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_norm_filt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pass_name</span><span class="p">:</span>
                <span class="n">pass_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_norm_</span><span class="si">{:}</span><span class="s1">pass&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">btype</span><span class="p">)</span>

        <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dim</span><span class="p">),</span> <span class="n">filt</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">-pass butterworth filter of </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">btype</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
        <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;btype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btype</span>

        <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dim</span><span class="p">),</span> <span class="n">data</span><span class="o">-</span><span class="n">filt</span><span class="p">)</span> 
<span class="c1">#        if cut is not None:</span>
<span class="c1">#            try:</span>
<span class="c1">#                x[pass_name][~cut] = data0[~cut]</span>
<span class="c1">#            except:</span>
<span class="c1">#                print(&#39;Cannot reset cut data&#39;)</span>
        
        <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">-pass butterworth filtered data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">btype</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
        <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;btype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btype</span>

        <span class="k">if</span> <span class="n">highcut</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;highcut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">highcut</span>
            <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;highcut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">highcut</span>
        <span class="k">if</span> <span class="n">lowcut</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">pass_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lowcut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowcut</span>
            <span class="n">x</span><span class="p">[</span><span class="n">filt_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lowcut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lowcut</span>
        
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">get_correlations</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
        <span class="n">omit_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage_cut&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_damageMask&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Find variables that correlate with given attr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]</span>
    <span class="n">cmatrix</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">cattrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">item</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cmatrix</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="n">confidence</span> \
            <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">attr</span> <span class="ow">and</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit_list</span><span class="p">}</span>    
    <span class="k">return</span> <span class="n">cattrs</span>

<span class="k">def</span> <span class="nf">get_cov</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[],</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span>
        <span class="n">omit_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;nsec&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducials&#39;</span><span class="p">,</span> <span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;Damage_cut&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_damageMask&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Find variables that correlate with given attr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="c1">#attrs = [a for a, item in x.data_vars.items() if item.dims == (&#39;time&#39;,)]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit_list</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Gasdet&#39;</span><span class="p">)]</span>
        <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="n">cmatrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
    <span class="c1">#cattrs = {a: item for a, item in cmatrix[attr].iteritems() if a != attr and a not in omit_list}    </span>
    <span class="k">return</span> <span class="n">cmatrix</span>

<span class="k">def</span> <span class="nf">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.35</span><span class="p">,</span><span class="mf">0.45</span><span class="p">,</span><span class="mf">0.6</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span> 
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="c1">#plt.gca().set_position(position)</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
    
    <span class="n">corr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">confidence</span><span class="p">:</span>
        <span class="n">cattrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[((</span><span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">confidence</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cattrs</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>   

    <span class="k">return</span> <span class="n">corr</span>

<div class="viewcode-block" id="xy_ploterr"><a class="viewcode-back" href="../../generated/PyDataSource.xy_ploterr.html#PyDataSource.xy_ploterr">[docs]</a><span class="k">def</span> <span class="nf">xy_ploterr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="o">.</span><span class="mi">7</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot summary data with error bars, e.g.,</span>
<span class="sd">        xy_ploterr(x, &#39;MnScatter&#39;,&#39;Sample_z&#39;,logy=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Must supply plot attribute&#39;</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s1">&#39;groupby&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">groupby</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;step&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;steps&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;run&#39;</span>

    <span class="n">run</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">runstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">runstr</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xaxis</span><span class="p">:</span>
            <span class="n">xaxis</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">xaxis</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="o">+</span><span class="s1">&#39;_axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">groupby</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">xaxis</span> <span class="o">=</span> <span class="n">xaxis</span><span class="o">+</span><span class="s1">&#39;_axis&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="n">groupby</span><span class="p">:</span><span class="n">xaxis</span><span class="p">})</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xaxis</span> <span class="o">=</span> <span class="n">groupby</span>
        <span class="n">xerr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">ylabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ylabel</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="n">xlabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xlabel</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">xaxis</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ndims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">xerr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;xerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xerr</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yerr</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span><span class="n">xerr</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xerr&#39;</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-.</span><span class="mi">1</span><span class="p">,</span><span class="o">-.</span><span class="mi">2</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
 
        <span class="k">return</span> <span class="n">p</span> 
    <span class="k">elif</span> <span class="n">ndims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="o">.</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">pdim</span><span class="p">])):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">pdim</span><span class="p">:</span><span class="n">i</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">pdim</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">pdim</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yerr</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-.</span><span class="mi">1</span><span class="p">,</span><span class="o">-.</span><span class="mi">2</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   

        <span class="k">return</span> <span class="n">p</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;Too many dims to plot&#39;</span></div>

<span class="k">def</span> <span class="nf">ttest_groupby</span><span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">ishot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    nearest neighbors compare with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Select DataArray for attr with groupby as coord</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[[</span><span class="n">attr</span><span class="p">,</span><span class="n">groupby</span><span class="p">]]</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">groupby</span><span class="p">)[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">ntime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nearest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">inear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nearest</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nearest</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">itest</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">itest</span><span class="o">+</span><span class="n">inear</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">a</span><span class="o">&lt;</span><span class="n">ntime</span><span class="p">:</span>
                        <span class="n">k0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">ntime</span><span class="p">]</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">ishot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">ntime</span><span class="p">]</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">da</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">ttest</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span><span class="n">df0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ttest</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> has only one group -- cannot compare&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">test_correlation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr0</span><span class="p">,</span> <span class="n">attr1</span><span class="o">=</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">xds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[[</span><span class="n">attr0</span><span class="p">,</span><span class="n">attr1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">cut</span> <span class="ow">and</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">xds</span><span class="p">:</span>
        <span class="n">xds</span> <span class="o">=</span> <span class="n">xds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cut</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cut</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">dim</span><span class="p">:</span><span class="o">-</span><span class="n">shift</span><span class="p">}))</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> 

    <span class="n">xds</span> <span class="o">=</span> <span class="n">xds</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>
    
    <span class="n">df0</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">attr0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">shift</span><span class="p">)</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">attr1</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">df0</span><span class="p">[</span><span class="n">kind</span><span class="p">],</span><span class="n">df1</span><span class="p">[</span><span class="n">kind</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="set_delta_beam"><a class="viewcode-back" href="../../generated/PyDataSource.xarray_utils.set_delta_beam.html#PyDataSource.set_delta_beam">[docs]</a><span class="k">def</span> <span class="nf">set_delta_beam</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;delta_drop&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the number of beam codes to nearest code</span>
<span class="sd">       using time stamps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">df0</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">df_beam</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span><span class="o">.</span><span class="n">fiducials</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">/</span><span class="mi">3</span>
                <span class="n">df_drop</span> <span class="o">=</span> <span class="n">df_beam</span><span class="p">[</span><span class="n">df0</span><span class="p">]</span>
                <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_beam</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">df_beam</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">df_drop</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_drop</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="n">a</span><span class="p">))]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Not robust way to get rid of outliers </span>
                <span class="c1">#dbeam_max = df_beam.diff().max()</span>
                <span class="c1">#x.coords[attr][abs(x.coords[attr]) &gt; dbeam_max] = dbeam_max</span>
                <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;number of beam codes to nearest </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> 
                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No event code </span><span class="si">{:}</span><span class="s1"> to drop&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Cannot set drop_code = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span></div>


<div class="viewcode-block" id="find_beam_correlations"><a class="viewcode-back" href="../../generated/PyDataSource.xarray_utils.find_beam_correlations.html#PyDataSource.find_beam_correlations">[docs]</a><span class="k">def</span> <span class="nf">find_beam_correlations</span><span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">pvalue</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">pvalue0_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">corr_pvalue</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
            <span class="n">adet_pvalue0_ratio</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">adet_pvalue</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
            <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">corr_coord</span><span class="o">=</span><span class="s1">&#39;delta_drop&#39;</span><span class="p">,</span>
            <span class="n">pulse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sigma0</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">],</span> 
            <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="n">xcoor_coord</span> <span class="o">=</span> <span class="n">set_delta_beam</span><span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">corr_coord</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">xstats</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">xo</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]</span>
    <span class="n">xds</span> <span class="o">=</span> <span class="n">xo</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">area_detectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area_detectors&#39;</span><span class="p">,[])]</span>
    <span class="n">wf_detectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_detectors&#39;</span><span class="p">,[])]</span>
    <span class="n">adets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">area_detectors</span> <span class="o">+</span> <span class="n">wf_detectors</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">adets</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xds</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">adets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">adets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;EBeam_damageMask&#39;</span> <span class="ow">in</span> <span class="n">xds</span><span class="p">:</span>
        <span class="n">xds</span> <span class="o">=</span> <span class="n">xds</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;EBeam_damageMask&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pulse</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xds</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span> <span class="ow">in</span> <span class="n">xds</span><span class="p">:</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span>
            <span class="k">if</span> <span class="n">xds</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pulse</span> <span class="o">=</span> <span class="s1">&#39;GasDet_f21&#39;</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pulse</span>
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr_confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span> 
    <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_attr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupby</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Analyzing beam correlations for </span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xo</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">xo</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">xds</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]:</span>
        <span class="n">adf</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> -- too few events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">adf_unique</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adf_unique</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> -- only one unique value in data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1">#if verbose:</span>
        <span class="nb">print</span> <span class="s1">&#39;*****&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;*******&#39;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">pulse</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">xds</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ommitting cut: </span><span class="si">{:}</span><span class="s1"> not valid cut&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cut</span><span class="p">))</span>
                <span class="n">cut</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># use lower threshold for area detector</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">adets</span><span class="p">:</span>
            <span class="n">pvalue_thresh</span> <span class="o">=</span> <span class="n">adet_pvalue</span>
            <span class="n">pval0_ratio</span> <span class="o">=</span> <span class="n">adet_pvalue0_ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvalue_thresh</span> <span class="o">=</span> <span class="n">pvalue</span>
            <span class="n">pval0_ratio</span> <span class="o">=</span> <span class="n">pvalue0_ratio</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">xds</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span>
        <span class="n">attest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">actest</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#ashots = range(-nearest,nearest+1)</span>
        <span class="c1">#for ishot in ashots:</span>
        <span class="c1"># Need to rework ttest_groupby and test_correlation</span>
        <span class="c1"># to handle non 120Hz data in a more natural way</span>
        <span class="c1"># This fixes timing errors but not necessarily robustly</span>
        <span class="n">ashots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">xo</span><span class="p">[</span><span class="n">corr_coord</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">iashot</span><span class="p">,</span><span class="n">idelta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ashots</span><span class="p">):</span>
            <span class="n">ishot</span> <span class="o">=</span> <span class="n">iashot</span><span class="o">-</span><span class="n">ashots</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">pulse</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">):</span>
                <span class="c1"># if FEEGasDetEnergy detector then test agains all other with shifted drops</span>
                <span class="n">tnearest</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnearest</span> <span class="o">=</span> <span class="n">nearest</span>
            <span class="n">ttest</span> <span class="o">=</span> <span class="n">ttest_groupby</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="n">ishot</span><span class="o">=</span><span class="n">ishot</span><span class="p">,</span> 
                                    <span class="n">nearest</span><span class="o">=</span><span class="n">tnearest</span><span class="p">)</span>
            <span class="n">attest</span><span class="p">[</span><span class="n">idelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttest</span>
            <span class="k">if</span> <span class="n">ttest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="n">attr</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="s1">&#39;Not valid test&#39;</span>
                <span class="k">continue</span>
         
            <span class="c1"># Do not test correlation of same attr</span>
            <span class="n">ctest</span> <span class="o">=</span> <span class="n">test_correlation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">ishot</span><span class="p">)</span>
            <span class="n">actest</span><span class="p">[</span><span class="n">idelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctest</span>

        <span class="n">xstd</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">xmean</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Statistics for delta_drop</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[[</span><span class="n">attr</span><span class="p">,</span><span class="n">corr_coord</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">df_nearest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">corr_coord</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">df_table</span> <span class="o">=</span> <span class="n">df_nearest</span><span class="p">[[</span><span class="n">attr</span><span class="p">,</span><span class="n">corr_coord</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">corr_coord</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">)[</span><span class="n">attr</span><span class="p">]</span>

            <span class="c1"># T-test for the means of *two independent* samples of scores.</span>
            <span class="c1"># see scipy.stats.ttest_ind</span>
            <span class="c1"># The calculated t-statistic, The two-tailed p-value</span>
            <span class="n">df_ttest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">attest</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">,</span><span class="s1">&#39;t_pvalue&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Pearson correlation coefficient and the p-value for testing non-correlation.</span>
            <span class="c1"># see scipy.stats.pearsonr</span>
            <span class="c1"># Pearson&#39;s correlation coefficient, 2-tailed p-value</span>
            <span class="n">df_ctest</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">actest</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">,</span><span class="s1">&#39;c_pvalue&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>        
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_ctest</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_ttest</span><span class="p">)</span>
            
            <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">t_pvalue0</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;t_pvalue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">xmean</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xmean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">xstd</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">sigma0</span> \
                    <span class="ow">or</span> <span class="n">xstd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xstd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sigma0</span> \
                    <span class="ow">or</span> <span class="n">xstd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xstd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">sigma_scale</span><span class="p">:</span>
                <span class="c1"># First check if dropped shot and regular shot mean values differ by &gt; sigma0 </span>
                <span class="c1"># If drop_shot std (i.e., xstd[1] is &lt; sigma/sigma_scale times other shots then timing is correct</span>
                <span class="c1">#    e.g., opal_1 from exp=xppls7917:run=98 which has laser on/off</span>
                <span class="c1">#          and the signal is strong and stable with no X-rays but</span>
                <span class="c1">#          varies significantly with X-rays because of laser x-ray effects</span>
                <span class="c1"># If drop_shot std is &lt; sigma0 times other shots then also timing is correct</span>
                <span class="n">ishot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise choose shot with greatest ttest significance</span>
                <span class="n">ishot</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ishot can be nan when t_stat are nan</span>
                <span class="n">t_pvalue</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;t_pvalue&#39;</span><span class="p">][</span><span class="n">ishot</span><span class="p">]</span>
                <span class="n">sig_significance</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">])[</span><span class="n">ishot</span><span class="p">]</span>
                <span class="c1"># Check pvalue valid and if not timed with drop_code then</span>
                <span class="c1"># check ratio of found ishot pvalue is less than pvalue on drop code</span>
                <span class="c1"># Ignore if mean/std for time detected is too big to be reasonable</span>
                <span class="k">if</span> <span class="n">sig_significance</span> <span class="o">&lt;</span> <span class="mf">1.e10</span> <span class="ow">and</span> <span class="n">t_pvalue0</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t_pvalue</span> <span class="o">&lt;=</span> <span class="n">pvalue_thresh</span> \
                            <span class="ow">and</span> <span class="p">(</span><span class="n">t_pvalue</span><span class="o">/</span><span class="n">t_pvalue0</span> <span class="o">&lt;</span> <span class="n">pval0_ratio</span> <span class="ow">or</span> <span class="n">ishot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">t_pvalue</span> <span class="o">=</span> <span class="kc">None</span>

           
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">shot_corr</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
                <span class="n">c_pvalue</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;c_pvalue&#39;</span><span class="p">][</span><span class="n">shot_corr</span><span class="p">]</span>
                <span class="n">beam_corr</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">][</span><span class="n">shot_corr</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">shot_corr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c_pvalue0</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;c_pvalue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">beam_corr0</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># default to correlated with X-rays if not clear correlation on timing error</span>
                    <span class="k">if</span> <span class="n">c_pvalue</span> <span class="o">&lt;</span> <span class="n">corr_pvalue</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
                        <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Make sure shot correlation is not also OK on drop shot</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">beam_corr0</span> <span class="o">&gt;</span> <span class="n">beam_corr</span><span class="o">/</span><span class="mf">2.</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c_pvalue</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">c_pvalue0</span><span class="o">/</span><span class="n">c_pvalue</span> <span class="o">&gt;=</span> <span class="n">pval0_ratio</span><span class="p">)):</span>
                            <span class="n">shot_corr</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">beam_corr</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">][</span><span class="n">shot_corr</span><span class="p">]</span>
                            <span class="n">c_pvalue</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;c_pvalue&#39;</span><span class="p">][</span><span class="n">shot_corr</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;c_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">c_pvalue0</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">beam_corr0</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="c1">#beam_corr = df_stats[&#39;beam_corr&#39;][shot_corr]</span>
                    <span class="c1"># If off-by-one make sure not beam correlated on ec162</span>
                    <span class="k">if</span> <span class="n">ishot</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c_pvalue</span> <span class="o">&lt;</span> <span class="n">corr_pvalue</span> <span class="ow">and</span> \
                                <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr0</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">):</span>
                        <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">ishot</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c_pvalue</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">c_pvalue0</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Make checks to be sure beam_corr is valid </span>
                    <span class="k">if</span> <span class="n">c_pvalue0</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">c_pvalue</span><span class="o">/</span><span class="n">c_pvalue0</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="o">/</span><span class="n">pval0_ratio</span><span class="p">:</span>
                        <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">c_pvalue</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c_pvalue0</span> <span class="o">&lt;</span> <span class="n">pvalue</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">beam_corr0</span><span class="o">&gt;</span><span class="n">beam_corr</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                        <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">c_pvalue</span> <span class="o">&lt;</span> <span class="n">corr_pvalue</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">beam_corr0</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">):</span>
                        <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Make sure beam correlation is consistent with drop shot detection</span>
                <span class="c1"># If beam_corr is on ec162 then do not tag</span>
                <span class="k">if</span> <span class="n">shot_corr_detected</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag_shot_corr</span> <span class="ow">and</span> <span class="n">ishot</span> <span class="o">!=</span> <span class="n">shot_corr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">shot_corr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">tag_shot_corr</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">ishot</span> <span class="o">=</span> <span class="n">shot_corr</span>
                            <span class="n">t_pvalue</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;t_pvalue&#39;</span><span class="p">][</span><span class="n">ishot</span><span class="p">]</span>
                    
                    <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_corr</span>
                    <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;shot_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shot_corr</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">]:</span>
                        <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;Beam-corr  of </span><span class="si">{:5.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">beam_corr</span><span class="p">)</span>
                    <span class="n">corr_note</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> on </span><span class="si">{:2}</span><span class="s1"> shot for </span><span class="si">{:}</span><span class="s1"> detector </span><span class="si">{:}</span><span class="s1"> (corr = </span><span class="si">{:}</span><span class="s1">, c_pvalue = </span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">shot_corr</span><span class="p">,</span> 
                                <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">beam_corr</span><span class="p">,</span> <span class="n">c_pvalue</span><span class="p">)</span>
                    <span class="nb">print</span> <span class="n">corr_note</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">shot_corr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">c_pvalue</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">beam_corr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">shot_corr_detected</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Tag shot correlation after checking beam correlation</span>
            <span class="k">if</span> <span class="n">tag_shot_corr</span><span class="p">:</span> 
                <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;delta_beam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ishot</span> 
                <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;delta_beam_pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_pvalue</span>
                <span class="k">if</span> <span class="n">ishot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;Drop-shot detected &#39;</span>
                    <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">]:</span>
                        <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">alias</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EBeam&#39;</span><span class="p">,</span><span class="s1">&#39;PhaseCavity&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;xpos&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ypos&#39;</span><span class="p">):</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;Beam-warning detected&#39;</span>
                    <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">]:</span>
                        <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">note</span> <span class="o">=</span> <span class="s1">&#39;Time-error detected&#39;</span>
                    <span class="n">xo</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">]:</span>
                        <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                
                <span class="n">shot_note</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> on </span><span class="si">{:2}</span><span class="s1"> shot for </span><span class="si">{:}</span><span class="s1"> detector </span><span class="si">{:}</span><span class="s1"> (t_pvalue=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">ishot</span><span class="p">,</span> 
                        <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">t_pvalue</span><span class="p">)</span>
                <span class="nb">print</span> <span class="n">shot_note</span>


            <span class="c1">#xstats[attr] = ((corr_coord,&#39;drop_stats&#39;), df_stats)</span>
            <span class="n">xstats</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_stats</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span> <span class="s1">&#39;xmean&#39;</span><span class="p">,</span> <span class="n">xmean</span>
            <span class="nb">print</span> <span class="s1">&#39;xstd&#39;</span><span class="p">,</span> <span class="n">xstd</span>
            <span class="nb">print</span> <span class="s1">&#39;Cannot calc stats for&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">ishot</span>
        
    <span class="k">for</span> <span class="n">avar</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">avar</span> <span class="ow">in</span> <span class="n">xstats</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">xo</span><span class="p">[</span><span class="n">avar</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> 
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">xstats</span><span class="p">[</span><span class="n">avar</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add attrs for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avar</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">xo</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">xstats</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add attrs for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;dim_1&#39;</span> <span class="ow">in</span> <span class="n">xstats</span><span class="p">:</span>
        <span class="n">xstats</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;dim_1&#39;</span><span class="p">:</span><span class="s1">&#39;drop_stats&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Drop stats&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xstats</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Save drop summary file: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save file: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xstats</span></div>

<span class="k">def</span> <span class="nf">clean_dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace unicode with str in dict </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">clean_item</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                    <span class="n">clean_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clean_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_item</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

    <span class="k">return</span> <span class="n">attrs</span>

<span class="k">def</span> <span class="nf">clean_dataset</span><span class="p">(</span><span class="n">xds</span><span class="p">):</span>
    <span class="n">xds</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">xds</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xcoord</span> <span class="o">=</span> <span class="n">xds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">xcoord</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">xcoord</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">xds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">xds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcoord</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">xdata</span> <span class="ow">in</span> <span class="n">xds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">clean_dict</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">xds</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">xds</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdata</span>
    <span class="k">return</span> <span class="n">xds</span>

    <span class="k">return</span> <span class="n">xds</span>

<span class="k">def</span> <span class="nf">get_psocake_runs</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find psocake runs for experiment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">)</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/*/*/psocake/r*/</span><span class="si">{:}</span><span class="s1">_*.cxi&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
    <span class="n">runs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">open_cxi_psocake</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">load_summary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_smd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_moved_pvs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    load psocake cxidb formatted hdf5 file and return xarray</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    load_smd : bool</span>
<span class="sd">        load small data from </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Experiment must be supplied as exp=&quot;xxx&quot; or as first argument&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm&#39;</span><span class="p">,</span><span class="n">instrument</span><span class="p">,</span><span class="n">exp</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="n">get_psocake_runs</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No run specified:  Runs with psocake files include:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Enter run number as run= or second argument&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No psocake files exist for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
        
        <span class="k">return</span>

    <span class="n">file_nc</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/*/*/psocake/r</span><span class="si">{:04}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_nc</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_nc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_nc</span><span class="p">):</span>
            <span class="n">file_nc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span> <span class="ow">and</span> <span class="n">file_nc</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_nc</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading netcdf4 file </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_nc</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">xdata</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not open netcdf4 file </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_nc</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">base_path</span><span class="o">+</span><span class="s1">&#39;/*/*/psocake/r</span><span class="si">{:04}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:04}</span><span class="s1">.cxi&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...choosing </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;use folder keyword to select a different psocake file&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No psocake files available&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;r</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:04}</span><span class="s1">.cxi&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_nc</span><span class="p">:</span>
        <span class="n">file_nc</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;cxi&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;nc&#39;</span>

    <span class="n">xdata</span> <span class="o">=</span> <span class="n">open_cxi_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
    <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span>
    <span class="k">if</span> <span class="n">load_summary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... opening </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
            <span class="n">xsmd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">xsmd</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">xsmd</span><span class="o">.</span><span class="n">nsec</span><span class="p">))</span>
            <span class="c1"># datetime64 not consistent at the us time level so need to recreate it</span>
            <span class="c1"># datetime64 is curriosly slow to calculate -- ~16 ms each time point</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... recalculating datetime64 for scratch summary data&#39;</span><span class="p">)</span>
            <span class="c1">#xsmd[&#39;time&#39;] = [np.datetime64(int(sec*1e9+nsec), &#39;ns&#39;) for sec,nsec in zip(xsmd.sec,xsmd.nsec)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load Time smd hdf5 = </span><span class="si">{:8.3f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_last</span><span class="p">))</span>
            <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time_ns&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;merge time psocake &amp; smd = </span><span class="si">{:8.3f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_last</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">load_smd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">load_smd</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot load and merge smd&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">load_smd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_smd.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... opening </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
            <span class="n">xsmd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">xsmd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">xsmd</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">xsmd</span><span class="o">.</span><span class="n">nsec</span><span class="p">))</span>
            <span class="c1"># datetime64 not consistent at the us time level so need to recreate it</span>
            <span class="c1"># datetime64 is curriosly slow to calculate -- ~16 ms each time point</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... recalculating datetime64 for smd&#39;</span><span class="p">)</span>
            <span class="c1">#xsmd[&#39;time&#39;] = [np.datetime64(int(sec*1e9+nsec), &#39;ns&#39;) for sec,nsec in zip(xsmd.sec,xsmd.nsec)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load Time smd hdf5 = </span><span class="si">{:8.3f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_last</span><span class="p">))</span>
            <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xsmd</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time_ns&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;merge time psocake &amp; smd = </span><span class="si">{:8.3f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_last</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot load and merge smd&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">load_moved_pvs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">add_moved_pvs</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding moved pvs&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add moved pvs&#39;</span><span class="p">)</span>

    <span class="c1">#if save:</span>
    <span class="c1">#    xdata.to_</span>

    <span class="k">return</span> <span class="n">xdata</span>


<span class="k">def</span> <span class="nf">open_cxi_dataset</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">load_peakpos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read cxi format hdf5 file as xarray.  </span>
<span class="sd">    Currently skips much and is first intended to retrieve psocake results_1.nPeaks</span>
<span class="sd">    </span>
<span class="sd">    Paarameters:</span>
<span class="sd">    ------------</span>
<span class="sd">    load_peakpos : bool</span>
<span class="sd">        lood bragg peak positions in event images </span>
<span class="sd">    add_time : bool</span>
<span class="sd">        add datetime64</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> 
    <span class="n">f5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f5keys</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>

    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;cxi_version&#39;</span>
        <span class="n">f5keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting cxi_version&#39;</span><span class="p">)</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;psocake&#39;</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">f5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">f5keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;/input&#39;</span><span class="p">)</span>
            <span class="n">psocake_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">}</span>        
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting </span><span class="si">{:}</span><span class="s1"> attrs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="n">psocake_attrs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">status_attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">f5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">f5keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">status_attrs</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting </span><span class="si">{:}</span><span class="s1"> attrs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>

    <span class="n">eventNumber</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LCLS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eventNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eventNumber</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading </span><span class="si">{:}</span><span class="s1"> events&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nevents</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">f5keys</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">f5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">load_data</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> event data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">):</span>
                    <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">adata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="n">ashape</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nevents</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ashape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">load_peakpos</span><span class="p">:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">value</span>
                                    <span class="n">xdata</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time_ns&#39;</span><span class="p">,</span><span class="s1">&#39;peak&#39;</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ashape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">value</span>
                                    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">adata</span><span class="p">))</span>
                                        <span class="k">continue</span>
                                    <span class="n">xdata</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time_ns&#39;</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">adata</span><span class="p">))</span>
                                    <span class="k">continue</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">adata</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> event data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xdata</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time_ns&#39;</span><span class="p">,],</span> <span class="n">val</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> event data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error getting </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> event data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">machineTime</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;nsec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">machineTimeNanoSeconds</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">xdata</span><span class="o">.</span><span class="n">nsec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_time</span><span class="p">:</span>
            <span class="n">xdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">nsec</span><span class="p">),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span><span class="p">,</span><span class="n">nsec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span><span class="n">xdata</span><span class="o">.</span><span class="n">nsec</span><span class="p">)]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error making time from machintTime and machineTimeNanSeconds&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Load Time psocake hdf5 = </span><span class="si">{:8.3f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xdata</span>

<span class="k">def</span> <span class="nf">add_transmission</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add transmission from epicsArch attenuation pvs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp : str</span>
<span class="sd">        Experiment name</span>
<span class="sd">        Default use xdata.attrs[&#39;experiment&#39;] or xdata.attrs[&#39;exp&#39;]</span>
<span class="sd">    run : int</span>
<span class="sd">        Run number</span>
<span class="sd">        Default use xdata.attrs[&#39;run&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">exp_summary</span> <span class="k">import</span> <span class="n">get_exp_summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;experiment&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exp must be specified or in Dataset attrs&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="nb">print</span> <span class="n">exp</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;run&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;run must be specified or in Dataset attrs&#39;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">es</span> <span class="o">=</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> 
 
<span class="k">def</span> <span class="nf">add_moved_pvs</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add epics pvs that were moved during run to Dataset.</span>
<span class="sd">    - Moved pvs are automatically determined from epicsArch data</span>
<span class="sd">    loaded in PyDataSource.ExperimentSummary class.</span>
<span class="sd">    - merge_fill method used to match moved pvs using timestamp info</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp : str</span>
<span class="sd">        Experiment name</span>
<span class="sd">        Default use xdata.attrs[&#39;experiment&#39;] or xdata.attrs[&#39;exp&#39;]</span>
<span class="sd">    run : int</span>
<span class="sd">        Run number</span>
<span class="sd">        Default use xdata.attrs[&#39;run&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">exp_summary</span> <span class="k">import</span> <span class="n">get_exp_summary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;experiment&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exp must be specified or in Dataset attrs&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="nb">print</span> <span class="n">exp</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;run&#39;</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;run must be specified or in Dataset attrs&#39;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">es</span> <span class="o">=</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> 
    <span class="n">xadd</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get_scan_data</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">merge_fill</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xadd</span><span class="p">,</span> <span class="n">bfill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_pvs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xadd</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">xdata</span>

<span class="k">def</span> <span class="nf">merge_fill</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">xadd</span><span class="p">,</span> <span class="n">bfill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_new_times</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge Datasets.  Fill second Dataset forward then backward unless bfill=False</span>
<span class="sd">    Currently only 1D arrays with dim=&#39;time&#39; are added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">operator</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">xdata</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_new_times</span><span class="p">:</span>
        <span class="n">da</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;_orig_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time_ns&#39;</span><span class="p">),</span> <span class="n">xdata</span><span class="o">.</span><span class="n">time_ns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xadd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">xadd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">xadd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xadd</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">xadd</span> <span class="o">=</span> <span class="n">xadd</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span>

    <span class="n">xmerge</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">xadd</span><span class="p">)</span>
    <span class="n">xfill</span> <span class="o">=</span> <span class="n">xmerge</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time_ns&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bfill</span><span class="p">:</span>
        <span class="n">xfill</span> <span class="o">=</span> <span class="n">xfill</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time_ns&#39;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_new_times</span><span class="p">:</span>
        <span class="n">xfill</span> <span class="o">=</span> <span class="n">xfill</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xfill</span><span class="p">[</span><span class="s1">&#39;_orig_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="k">del</span> <span class="n">xfill</span><span class="p">[</span><span class="s1">&#39;_orig_data&#39;</span><span class="p">]</span>
    <span class="n">xfill</span> <span class="o">=</span> <span class="n">xfill</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time_ns&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
    <span class="c1"># merge and concat are not efficient when already same dims</span>
    <span class="c1"># may still be more clever way, but this is fast</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xfill</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">xdata</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">item</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xadd</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">xdata</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">keep_attrs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">xadd</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">xdata</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">xdata</span>

<span class="k">def</span> <span class="nf">dataset_fill</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">bfill</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataset with time and fill forward then backward</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">xdata</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">xdata</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;time_ns&#39;</span>
    <span class="n">xadd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
    <span class="n">xadd</span> <span class="o">=</span> <span class="n">xadd</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;time_stamp&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xadd</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">xadd</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">xadd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">if</span> <span class="s1">&#39;time_ns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xadd</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">xadd</span> <span class="o">=</span> <span class="n">xadd</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span>

    <span class="n">xmerge</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time_ns&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xadd</span><span class="p">)</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;time_ns&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
    <span class="n">xfill</span> <span class="o">=</span> <span class="n">xmerge</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">xfill</span>

<span class="c1"># Placeholder to make independent of PyDataSource.get_dataset</span>
<span class="c1">#def get_epics_dataset(exp=None, run=None, pvdict={}, fields=None,</span>
<span class="c1">#            meta_attrs = {&#39;units&#39;: &#39;EGU&#39;, &#39;PREC&#39;: &#39;PREC&#39;, &#39;pv&#39;: &#39;name&#39;},</span>
<span class="c1">#            tstart=None, tend=None, quiet=True, **kwargs):</span>
<span class="c1">#        import time</span>
<span class="c1">#        import numpy as np</span>
<span class="c1">#        import pandas as pd</span>
<span class="c1">#        import xarray as xr</span>
<span class="c1">#        import xarray_utils</span>
<span class="c1">#        if not fields:</span>
<span class="c1">#            fields={</span>
<span class="c1">#                    &#39;description&#39;:            (&#39;DESC&#39;, &#39;Description&#39;), </span>
<span class="c1">#                    &#39;slew_speed&#39;:             (&#39;VELO&#39;, &#39;Velocity (EGU/s) &#39;),</span>
<span class="c1">#                    &#39;acceleration&#39;:           (&#39;ACCL&#39;, &#39;acceleration time&#39;),</span>
<span class="c1">#                    &#39;step_size&#39;:              (&#39;RES&#39;,  &#39;Step Size (EGU)&#39;),</span>
<span class="c1">#                    &#39;encoder_step&#39;:           (&#39;ERES&#39;, &#39;Encoder Step Size &#39;),</span>
<span class="c1">#                    &#39;resolution&#39;:             (&#39;MRES&#39;, &#39;Motor Step Size (EGU)&#39;),</span>
<span class="c1">#                    &#39;high_limit&#39;:             (&#39;HLM&#39;,  &#39;User High Limit&#39;),</span>
<span class="c1">#                    &#39;low_limit&#39;:              (&#39;LLM&#39;,  &#39;User Low Limit&#39;),</span>
<span class="c1">#                    &#39;units&#39;:                  (&#39;EGU&#39;,  &#39;Units&#39;),</span>
<span class="c1">#        #            &#39;device_type&#39;:            (&#39;DTYP&#39;, &#39;Device type&#39;), </span>
<span class="c1">#        #            &#39;record_type&#39;:            (&#39;RTYP&#39;, &#39;Record Type&#39;), </span>
<span class="c1">#                    }</span>
<span class="c1">#        time0 = time.time()</span>
<span class="c1">#        time_last = time0</span>
<span class="c1">#       </span>
<span class="c1">#        if load_default:</span>
<span class="c1">#            trans_pvs = [a for a in _transmission_pvs.get(&#39;FEE&#39;, {}) if a.endswith(&#39;_trans&#39;)]</span>
<span class="c1">#            trans_pvs += [a for a in _transmission_pvs.get(ds.instrument, {}) if a.endswith(&#39;_trans&#39;)]</span>
<span class="c1">#            trans3_pvs = [a for a in _transmission_pvs.get(&#39;FEE&#39;, {}) if a.endswith(&#39;_trans3&#39;)]</span>
<span class="c1">#            trans3_pvs += [a for a in _transmission_pvs.get(ds.instrument, {}) if a.endswith(&#39;_trans3&#39;)]</span>
<span class="c1">#            pvdict.update(**_transmission_pvs.get(&#39;FEE&#39;,{}))</span>
<span class="c1">#            pvdict.update(**_transmission_pvs.get(ds.instrument,{}))</span>
<span class="c1">#        else:</span>
<span class="c1">#            trans_pvs = []</span>
<span class="c1">#            trans3_pvs = []</span>
<span class="c1">#</span>
<span class="c1">#        pvs = {alias: pv for alias, pv in pvdict.items() if configData._in_archive(pv)} </span>
<span class="c1">#        </span>
<span class="c1">#        data_arrays = {} </span>
<span class="c1">#        data_fields = {}</span>
<span class="c1"># </span>
<span class="c1">#        for alias, pv in pvs.items():</span>
<span class="c1">#            data_fields[alias] = {}</span>
<span class="c1">#            dat = configData._get_pv_from_arch(pv, tstart, tend)</span>
<span class="c1">#            if not dat:</span>
<span class="c1">#                print(&#39;WARNING:  {:} - {:} not archived&#39;.format(alias, pv))</span>
<span class="c1">#                continue</span>
<span class="c1">#            </span>
<span class="c1">#            try:</span>
<span class="c1">#                attrs = {a: dat[&#39;meta&#39;].get(val) for a,val in meta_attrs.items() if val in dat[&#39;meta&#39;]}</span>
<span class="c1">#                for attr, item in fields.items():  </span>
<span class="c1">#                    try:</span>
<span class="c1">#                        field=item[0]</span>
<span class="c1">#                        pv_desc = pv.split(&#39;.&#39;)[0]+&#39;.&#39;+field</span>
<span class="c1">#                        if configData._in_archive(pv_desc):</span>
<span class="c1">#                            desc = configData._get_pv_from_arch(pv_desc)</span>
<span class="c1">#                            if desc:</span>
<span class="c1">#                                vals = {}</span>
<span class="c1">#                                fattrs = attrs.copy()</span>
<span class="c1">#                                fattrs.update(**desc[&#39;meta&#39;])</span>
<span class="c1">#                                fattrs[&#39;doc&#39;] = item[1]</span>
<span class="c1">#                                val = None</span>
<span class="c1">#                                # remove redundant data</span>
<span class="c1">#                                for item in desc[&#39;data&#39;]:</span>
<span class="c1">#                                    newval =  item.get(&#39;val&#39;)</span>
<span class="c1">#                                    if not val or newval != val:</span>
<span class="c1">#                                        val = newval</span>
<span class="c1">#                                        vt = np.datetime64(long(item[&#39;secs&#39;]*1e9+item[&#39;nanos&#39;]), &#39;ns&#39;)</span>
<span class="c1">#                                        vals[vt] = val</span>
<span class="c1">#                               </span>
<span class="c1">#                                data_fields[alias][attr] = xr.DataArray(vals.values(), </span>
<span class="c1">#                                                                coords=[vals.keys()], dims=[&#39;time&#39;], </span>
<span class="c1">#                                                                name=alias+&#39;_&#39;+attr, attrs=fattrs) </span>
<span class="c1">#                                attrs[attr] = val</span>
<span class="c1">#         </span>
<span class="c1">#                    except:</span>
<span class="c1">#                        traceback.print_exc()</span>
<span class="c1">#                        print(&#39;cannot get meta for&#39;, alias, attr)</span>
<span class="c1">#                        pass</span>
<span class="c1">#                vals = [item[&#39;val&#39;] for item in dat[&#39;data&#39;]]</span>
<span class="c1">#                if not vals:</span>
<span class="c1">#                    print(&#39;No Data in archive for  {:} - {:}&#39;.format(alias, pv))</span>
<span class="c1">#                    continue</span>
<span class="c1">#</span>
<span class="c1">#                doc = attrs.get(&#39;description&#39;,&#39;&#39;)</span>
<span class="c1">#                units = attrs.get(&#39;units&#39;, &#39;&#39;)</span>
<span class="c1">#                time_next = time.time()</span>
<span class="c1">#              </span>
<span class="c1">#                try:</span>
<span class="c1">#                    if isinstance(vals[0],str):</span>
<span class="c1">#                        if not quiet:</span>
<span class="c1">#                            print(alias, &#39;string&#39;)</span>
<span class="c1">#                        vals = np.array(vals, dtype=str)</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        times = [np.datetime64(long(item[&#39;secs&#39;]*1e9+item[&#39;nanos&#39;]), &#39;ns&#39;) for item in dat[&#39;data&#39;]]</span>
<span class="c1">#                        dfs = pd.Series(vals, times).sort_index()</span>
<span class="c1">#                        dfs = dfs[~dfs.index.duplicated()]</span>
<span class="c1">#                        dfs = dfs[~(dfs.diff()==0)]</span>
<span class="c1">#                        vals = dfs.values</span>
<span class="c1">#                        dfs = dfs.to_xarray().rename({&#39;index&#39;: &#39;time&#39;})</span>
<span class="c1">#                        data_arrays[alias] = dfs </span>
<span class="c1">#                        data_arrays[alias].name = alias</span>
<span class="c1">#                        data_arrays[alias].attrs = attrs</span>
<span class="c1">#                </span>
<span class="c1">#                except:</span>
<span class="c1">#                    traceback.print_exc()</span>
<span class="c1">#                    if not quiet:</span>
<span class="c1">#                        print(&#39;Error loadinig&#39;, alias)</span>
<span class="c1">#</span>
<span class="c1">#                if not quiet:</span>
<span class="c1">#                    try:</span>
<span class="c1">#                        print(&#39;{:8.3f} {:28} {:8} {:10.3f} {:4} {:20} {:}&#39;.format(time_next-time_last, \</span>
<span class="c1">#                                        gias, len(vals), np.array(vals).mean(), units, doc, pv))</span>
<span class="c1">#                    except:</span>
<span class="c1">#                        print(&#39;{:8.3f} {:28} {:8} {:&gt;10} {:4} {:20} {:}&#39;.format(time_next-time_last, \</span>
<span class="c1">#                                        alias, len(vals), vals[0], units, doc, pv))</span>
<span class="c1">#            </span>
<span class="c1">#            except:</span>
<span class="c1">#                traceback.print_exc()</span>
<span class="c1">#                if not quiet:</span>
<span class="c1">#                    print(&#39;Error loading&#39;, alias)</span>
<span class="c1">#</span>
<span class="c1">#        xdata = xr.merge(data_arrays.values())</span>
<span class="c1">#        if trans_pvs:</span>
<span class="c1">#            da = xdata.reset_coords()[trans_pvs].to_array() </span>
<span class="c1">#            xdata[&#39;trans&#39;] = ((&#39;time&#39;), da.prod(dim=&#39;variable&#39;))</span>
<span class="c1">#            xdata[&#39;trans&#39;].attrs[&#39;doc&#39;] = &#39;Total transmission: &#39;+&#39;*&#39;.join(trans_pvs)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#   </span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>