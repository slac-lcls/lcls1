

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.build_html &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.build_html</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.build_html</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>

<span class="c1">#from pylab import *</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">output_html</span>
<span class="kn">import</span> <span class="nn">markup</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;max_colwidth&#39;</span><span class="p">,</span> <span class="mi">66</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> 

<span class="n">default_path</span> <span class="o">=</span> <span class="s1">&#39;stats&#39;</span>

<span class="k">def</span> <span class="nf">hover</span><span class="p">(</span><span class="n">hover_color</span><span class="o">=</span><span class="s2">&quot;#ffff99&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;tr:hover&quot;</span><span class="p">,</span>
                <span class="n">props</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hover_color</span><span class="p">)])</span>

<span class="n">styles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">hover</span><span class="p">(),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;font-size&quot;</span><span class="p">,</span> <span class="s2">&quot;100%&quot;</span><span class="p">),</span>
                               <span class="p">(</span><span class="s2">&quot;text-align&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">)]),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;caption&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;caption-side&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)])</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">get_run_size</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">start_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">runstr</span> <span class="o">=</span> <span class="s1">&#39;r</span><span class="si">{:04.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">start_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;xtc&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runstr</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
                <span class="n">tt</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">nn</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">,</span> <span class="n">tt</span>

<span class="k">def</span> <span class="nf">load_DataSource</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">PyDataSource</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DataSource not available&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make default html run summary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Build_html</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Make tidy pandas dataframe</span>
<span class="c1">#a = x.dims.keys()</span>
<span class="c1">#a.remove(&#39;time&#39;)</span>
<span class="c1">#df = x.drop(a).to_dataframe()</span>

<div class="viewcode-block" id="Build_experiment"><a class="viewcode-back" href="../../generated/PyDataSource.build_html.Build_experiment.html#PyDataSource.Build_experiment">[docs]</a><span class="k">class</span> <span class="nc">Build_experiment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to build an html RunSummary report.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Build_experiment.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.build_html.Build_experiment.html#PyDataSource.Build_experiment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">psutils</span> 
        <span class="k">if</span> <span class="n">psutils</span><span class="o">.</span><span class="n">interactive_mode</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;.build_html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;exp_summary&#39;</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_es</span> <span class="o">=</span> <span class="n">exp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">exp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exp_summary</span><span class="p">()</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xtc_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;xtc&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;scratch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_output</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto</span><span class="p">:</span>
            <span class="c1"># assume first 2% are setup</span>
            <span class="n">run_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*.</span><span class="mi">01</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_defaults</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">()</span></div>
 
    <span class="k">def</span> <span class="nf">_get_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">exp_summary</span> <span class="k">import</span> <span class="n">get_exp_summary</span>
        <span class="k">return</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_smd_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the table of active detectors</span>
<span class="sd">        and the table of percentage of valid data</span>
<span class="sd">        (both as documented in their respective functions),</span>
<span class="sd">        then exports them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str, optional</span>
<span class="sd">            Path to the files (for glob.glob() function, so uses the *-syntax)</span>
<span class="sd">        print_on : bool, optional</span>
<span class="sd">            Decides if the progress is printed</span>
<span class="sd">        make_plots : bool, optional</span>
<span class="sd">            Make individual detector damabe plots [default=False]</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        activetable : DataFrame</span>
<span class="sd">            Table of 1s and 0s for each variable in each run</span>
<span class="sd">        detectortable : DataFrame</span>
<span class="sd">            Table of percentages for each variable in each run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="kn">from</span> <span class="nn">smd_tools</span> <span class="k">import</span> <span class="n">get_active_dict</span><span class="p">,</span> <span class="n">get_active_table</span><span class="p">,</span> <span class="n">get_damage_table</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/*drop_stats.nc&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No files found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">print_on</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> files.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">datadict</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">det_alias</span> <span class="o">=</span> <span class="n">get_active_dict</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_on</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dictionary made&#39;</span><span class="p">)</span>
        <span class="n">activetable</span> <span class="o">=</span> <span class="n">get_active_table</span><span class="p">(</span><span class="n">datadict</span><span class="p">,</span><span class="n">runs</span><span class="p">,</span> <span class="n">det_alias</span><span class="o">=</span><span class="n">det_alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">print_on</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1st table made&#39;</span><span class="p">)</span>
        <span class="n">detectortable</span> <span class="o">=</span> <span class="n">get_damage_table</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">datadict</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">det_alias</span><span class="o">=</span><span class="n">det_alias</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_on</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Both tables ready&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">activetable</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Detectors&#39;</span><span class="p">,</span> 
                <span class="n">tbl_type</span> <span class="o">=</span> <span class="s1">&#39;Active Summary&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Summary&#39;</span><span class="p">,</span> 
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Summary of Active Detectors&#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">detectortable</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Detectors&#39;</span><span class="p">,</span> 
                <span class="n">tbl_type</span><span class="o">=</span><span class="s1">&#39;Damage Summary&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Summary&#39;</span><span class="p">,</span> 
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Summary of Detectors &amp; Damages&#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># draws plots </span>
        <span class="k">if</span> <span class="n">make_plots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">detectortable</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="s1">&#39;events&#39;</span> <span class="ow">or</span> <span class="n">var</span><span class="o">==</span><span class="s1">&#39;drop_events&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">detectortable</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Run&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Damaged&#39;</span><span class="p">)</span> 
<span class="c1">#                        ylim = (-1, 101), yticks = (0,10,20,30,40,50,60,70,80,90,100))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Damaged [%]&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="s1">&#39;Detectors&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_datadict</span> <span class="o">=</span> <span class="n">datadict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_active</span> <span class="o">=</span> <span class="n">activetable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_damage</span> <span class="o">=</span> <span class="n">detectortable</span>

        <span class="k">return</span> <span class="n">activetable</span><span class="p">,</span> <span class="n">detectortable</span>
 
<div class="viewcode-block" id="Build_experiment.add_defaults"><a class="viewcode-back" href="../../generated/PyDataSource.build_html.Build_experiment.add_defaults.html#PyDataSource.Build_experiment.add_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">add_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add defaults.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding defaults&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_smd_summary</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_scans</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_series</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#self.add_xy_ploterr(&#39;photon_beam_energy&#39;, &#39;run&#39;, title=&#39;Photon Beam Energy&#39;)</span>
            <span class="c1">#self.add_xy_ploterr(&#39;photon_current&#39;, &#39;run&#39;, title=&#39;Photon Current&#39;)</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">_machine_coords</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_xy_ploterr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Summary&#39;</span><span class="p">)</span>
            
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">get_scans</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_xy_ploterr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Scan Summary&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="n">run_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">get_run_sets</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_sets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding moved &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_epics</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run_set</span> <span class="ow">in</span> <span class="n">run_sets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding moved </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_set</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_epics</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_set</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_last_set</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed adding last set&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">add_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tbl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[],</span> <span class="n">doc</span><span class="o">=</span><span class="p">[],</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="s1">&#39;Tables&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tbl_type</span><span class="p">:</span>
            <span class="n">tbl_type</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tbl_type</span><span class="p">:</span> 
                                                   <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span> 
                                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                                    <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                    <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="n">hidden</span><span class="p">,</span> 
                                                    <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>


    <span class="k">def</span> <span class="nf">add_last_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">last_set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> 
   
        <span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;Epics&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Last time Epics PV was set&#39;</span><span class="p">)</span>
        <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;es.last_set(</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;es.last_set(</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Last Set&#39;</span><span class="p">:</span> 
                                                   <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span> 
                                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;dflastset&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                    <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
                                                    <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>


    <span class="k">def</span> <span class="nf">add_epics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add epics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dets</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#dets = list(set([a.split(&#39;_&#39;)[0] for a in es.xset.data_vars.keys()]))</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get_moved</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    
        <span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;Epics&#39;</span>
        <span class="k">if</span> <span class="n">run_min</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">+=</span> <span class="s1">&#39; from Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run_max</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">+=</span> <span class="s1">&#39; to Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
        <span class="n">archViewer_html</span> <span class="o">=</span> <span class="s1">&#39;https://pswww.slac.stanford.edu/archiveviewer/retrieval/ui/viewer/archViewer.html&#39;</span>
        <span class="n">ststart</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:02}</span><span class="s1">-</span><span class="si">{:02}</span><span class="s1">T</span><span class="si">{:02}</span><span class="s1">:</span><span class="si">{:02}</span><span class="s1">:</span><span class="si">{:02}</span><span class="s1">Z&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">es</span><span class="o">.</span><span class="n">_tstart</span><span class="p">)</span>
        <span class="n">stend</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:02}</span><span class="s1">-</span><span class="si">{:02}</span><span class="s1">T</span><span class="si">{:02}</span><span class="s1">:</span><span class="si">{:02}</span><span class="s1">:</span><span class="si">{:02}</span><span class="s1">Z&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">es</span><span class="o">.</span><span class="n">_tend</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Try plot_move&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">det</span>
            <span class="n">howto</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;es.plot_move(</span><span class="si">{:}</span><span class="s1">, run_min=</span><span class="si">{:}</span><span class="s1">, run_max=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="p">)]</span>

            <span class="n">dfattrs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="n">es</span><span class="o">.</span><span class="n">xset</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">es</span><span class="o">.</span><span class="n">xset</span><span class="p">})</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">archstr</span> <span class="o">=</span> <span class="n">archViewer_html</span><span class="o">+</span><span class="s1">&#39;?&#39;</span>
                <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">dfattrs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">archstr</span> <span class="o">+=</span> <span class="s1">&#39;pv=</span><span class="si">{:}</span><span class="s1">&amp;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                <span class="n">archstr</span> <span class="o">+=</span> <span class="s1">&#39;from=</span><span class="si">{:}</span><span class="s1">&amp;to=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ststart</span><span class="p">,</span><span class="n">stend</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">archstr</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">plot_move</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{:}</span><span class="s1"> plot for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">det</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39; Data&#39;</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="n">archstr</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">dfattrs</span><span class="p">)</span>
<span class="c1">#                self.results[alias][&#39;table&#39;].update({det+&#39; Configuration&#39;: </span>
<span class="c1">#                                                       {&#39;DataFrame&#39;: dfattrs, </span>
<span class="c1">#                                                        &#39;name&#39;: &#39;attrs&#39;,</span>
<span class="c1">#                                                        &#39;howto&#39;: None, </span>
<span class="c1">#                                                        &#39;hidden&#39;: True,</span>
<span class="c1">#                                                        &#39;doc&#39;: None}})</span>

    <span class="k">def</span> <span class="nf">add_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add summary of sets of runs based on a change in attr setting for each run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span>
        <span class="n">xset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">xset</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">asets</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get_scan_series</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">min_runs</span><span class="o">=</span><span class="n">min_runs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rns</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">asets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">howto</span><span class="o">=</span><span class="kc">None</span>
                <span class="n">doc</span><span class="o">=</span><span class="kc">None</span>
                <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Set of runs where </span><span class="si">{:}</span><span class="s1"> was moved between runs.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="n">attr_cat</span> <span class="o">=</span> <span class="s1">&#39;Scan Series&#39;</span>
                <span class="n">tbl_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Runs </span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">rns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="nb">print</span> <span class="s1">&#39;Adding&#39;</span><span class="p">,</span> <span class="n">tbl_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">attr_cat</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_steps</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add summary of scans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">min_steps</span><span class="o">=</span><span class="n">min_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">dets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dets</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>

        <span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;Scans&#39;</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">det</span><span class="p">)]</span>
            <span class="n">dfscan</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">min_steps</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">dfscan</span> <span class="o">=</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfscan</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">min_steps</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
           
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scans involving </span><span class="si">{:}</span><span class="s1"> devices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xattrs = pd.DataFrame({attr: self._es.xscan[attr].attrs for attr in attrs})&quot;</span><span class="p">)</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;min_steps=</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_steps</span><span class="p">))</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfscan = df.where(df[attrs].T.sum() &gt; min_steps).dropna()&quot;</span><span class="p">)</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfscan = dfscan.T.where(dfscan.sum() &gt; min_steps).dropna().T&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">det</span><span class="p">:</span> 
                                                       <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">dfscan</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;dfscan&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                        <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Number of times each </span><span class="si">{:}</span><span class="s1"> device was moved (or state changed) during run.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
            <span class="n">dfattrs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">attr</span><span class="p">:</span> <span class="n">es</span><span class="o">.</span><span class="n">xscan</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">es</span><span class="o">.</span><span class="n">xscan</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">det</span><span class="o">+</span><span class="s1">&#39; Configuration&#39;</span><span class="p">:</span> 
                                                       <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">dfattrs</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;attrs&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                                                        <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>

            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">plot_scan</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
                <span class="n">howto</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;es.plot_scan(</span><span class="si">{:}</span><span class="s1">, attrs=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;Run </span><span class="si">{:03}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">det</span><span class="p">),</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_catagory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">catagory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;figure&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;textblock&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="n">hidden</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">add_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[],</span> <span class="n">doc</span><span class="o">=</span><span class="p">[],</span> 
                <span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a plot to RunSummary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tight</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># seems like tight_layout does not work with add_detector </span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot make tight&#39;</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>

            <span class="n">plt_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;figure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plt_type</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
                                                                 <span class="s1">&#39;png&#39;</span><span class="p">:</span> <span class="n">plt_file</span><span class="p">,</span>
                                                                 <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span>
                                                                 <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                                                                 <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                                                                 <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">link</span><span class="p">}})</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">plt_file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not add Plot </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_init_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">default_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set output path and build appropriate directories for html</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;stats&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_dir</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting output path to&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> 
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not create dir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Requires sudo:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; .  /reg/g/psdm/etc/ana_env.sh&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; sit_setup dm-current&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; dm-create-folders --dir stats --mkdir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not create dir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Requires sudo:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; .  /reg/g/psdm/etc/ana_env.sh&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; sit_setup dm-current&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;psana-&gt; dm-create-folders --dir stats --mkdir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out html file</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_html</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_html</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_html</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing html to: &#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_init_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize html page.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_output</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">output_html</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;Experiment Summary&#39;</span><span class="p">,</span> 
                 <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                 <span class="n">css</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;css/bootstrap.min.css&#39;</span><span class="p">,</span><span class="s1">&#39;jumbotron-narrow.css&#39;</span><span class="p">,</span><span class="s1">&#39;css/mine.css&#39;</span><span class="p">),</span>
                 <span class="n">script</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;js/ie-emulation-modes-warning.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/jquery.min.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/toggler.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/sticky.js&#39;</span><span class="p">),</span>
                 <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_block</span><span class="p">(</span><span class="s1">&#39;Experiment Summary&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Experiment Information&#39;</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;datatime&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">begin_time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">sformat</span> <span class="o">=</span> <span class="s1">&#39;First Run: </span><span class="si">{:}</span><span class="s1">&lt;br/&gt;Last Run: </span><span class="si">{:}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Number of Runs: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_times</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">event_times</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Report time: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_ExperimentSummary_html</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_block</span><span class="p">()</span>         
 
    <span class="k">def</span> <span class="nf">_make_ExperimentSummary_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make html notes for accessing ExperimentSummary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Access the Experiment Information&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Access overall experiment information:&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import PyDataSource&#39;</span><span class="p">]</span>
        <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;es = PyDataSource.get_exp_summary(&quot;</span><span class="si">{:}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;For questions and feedback contact koglin@slac.stanford.edu&#39;</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">_add_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_caption</span><span class="o">=</span><span class="s1">&#39;Hover to highlight.&#39;</span><span class="p">,</span> <span class="n">show_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add html pages for results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cat_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_block</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">))</span>
            <span class="n">ahowto</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;figure&#39;</span><span class="p">]:</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# For interactive plotting -- plt.ioff() to turn off interactive plotting.&#39;</span><span class="p">)</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;plt.ion()&#39;</span><span class="p">)</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Alternatively make plt.show() after each plot and close window to make next&#39;</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">catagory</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;table&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
            <span class="c1">#for name, data in item[datatyp].items():</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto make the </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">):</span>
                    <span class="n">formatters</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">format</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">formatterstr</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span><span class="o">+</span><span class="s1">&#39;.format&#39;</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formatters</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="n">dfname</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">show_attrs</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">hidden</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hidden</span> <span class="o">=</span> <span class="kc">True</span>
                   
                    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">formatters</span><span class="p">:</span>
                        <span class="n">dfstr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">justify</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">formatters</span><span class="o">=</span><span class="n">formatters</span><span class="p">)</span>
                        <span class="c1">#if dfname:</span>
                        <span class="c1">#    howto_step += &#39;\n# to reprsent with formatting&#39;</span>
                        <span class="c1">#    howto_step += &quot;\nprint {:}.to_string(justify=&#39;left&#39;,formatters={:})&quot;.format(dfname, formatterstr)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        <span class="c1">#if dfname:</span>
                        <span class="c1">#    howto_step += &quot;\n print {:}&quot;.format(dfname)</span>
                    
                    <span class="k">if</span> <span class="n">howto_step</span><span class="p">:</span>
                        <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">dfstr</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> 
                            <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">datatyp</span><span class="p">),</span> 
                            <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
                    
                    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;figure&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
            <span class="c1">#for name, data in item[datatyp].items():</span>
                <span class="n">png</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
                <span class="n">subname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">png</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="n">subname</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">&gt;</span><span class="si">{:}</span><span class="s1"> archViewer Link&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span> <span class="n">markup</span><span class="o">.</span><span class="n">oneliner</span><span class="o">.</span><span class="n">img</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">png</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;width:100%;&#39;</span><span class="p">),</span> 
                            <span class="n">href</span><span class="o">=</span><span class="n">png</span> <span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;&lt;pre&gt;</span><span class="si">{:}</span><span class="s1">&lt;/pre&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto make the </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ahowto</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">ahowto</span><span class="p">,</span> 
                        <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;HowTo make </span><span class="si">{:}</span><span class="s1"> tables and figures.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">),</span> 
                        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;howto_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)),</span> 
                        <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_block</span><span class="p">()</span>         

    <span class="k">def</span> <span class="nf">_close_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close html files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this closes the left column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">mk_nav</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">_finish_page</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">myprint</span><span class="p">(</span><span class="n">tofile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_xy_ploterr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">xy_ploterr</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_es</span><span class="o">.</span><span class="n">xscan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">howto</span><span class="p">:</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;Summary&#39;</span><span class="p">)</span>
        
        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Custom plot see PyDataSource.plotting.xy_ploterr method&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">xy_ploterr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span><span class="p">:</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">scan_variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>   
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logy&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logx&#39;</span><span class="p">):</span>
                <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; log-log&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; log scale&#39;</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logx&#39;</span><span class="p">):</span>
            <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; lin-log&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;df_tbl&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}})</span></div>


<div class="viewcode-block" id="Build_html"><a class="viewcode-back" href="../../generated/PyDataSource.build_html.Build_html.html#PyDataSource.Build_html">[docs]</a><span class="k">class</span> <span class="nc">Build_html</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to build an html RunSummary report.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Build_html.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.build_html.Build_html.html#PyDataSource.Build_html.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        auto - bool</span>
<span class="sd">            Automatic detailed report</span>
<span class="sd">        basic - bool</span>
<span class="sd">            Basic timing error and drop shot analysis only</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">psutils</span> 
        <span class="k">if</span> <span class="n">psutils</span><span class="o">.</span><span class="n">interactive_mode</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;.build_html&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">xdat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xdat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;DataSource&#39;</span><span class="p">:</span>
                <span class="c1"># 1st arg is actually PyDataSource.DataSource</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xdat</span>
                <span class="n">xdat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;run&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;exp&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading PyDataSource data&#39;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Require valid xdat=xarray object and/or ds=PyDataSource object&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;or alternatively exp and run kwargs&#39;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">xdat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="o">=</span> <span class="n">xdat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building xarray data&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
           
        <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">expNum</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">run</span>

        <span class="k">if</span> <span class="n">ds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading PyDataSource data&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">load_DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xtc_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;xtc&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;scratch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="s1">&#39;h5file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;h5file&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h5file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/nc/run</span><span class="si">{:04}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
     
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)]))</span>

        <span class="k">if</span> <span class="s1">&#39;steps&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;codes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_output</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">webattrs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">expNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;report.html&#39;</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://pswww.slac.stanford.edu/experiment_results/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">-</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">webattrs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">auto</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Auto configure&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...add_all&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No auto config&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">basic</span> <span class="ow">or</span> <span class="n">auto</span><span class="p">:</span>
            <span class="c1"># Add Timing error and drop shot analysis </span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...add_delta_beam&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_delta_beam</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add Timing Error and Drop Shot Detection&#39;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...to_html&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">default_path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set output path and build appropriate directories for html</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;stats&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_dir</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting output path to&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> 
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
    
<div class="viewcode-block" id="Build_html.add_correlations"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_correlations.html#PyDataSource.Build_html.add_correlations">[docs]</a>    <span class="k">def</span> <span class="nf">add_correlations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add correlations for Photon Energy and Pulse Energy </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        cut : str</span>
<span class="sd">            Attribute on which to make cut when making plots</span>

<span class="sd">        confidence : float</span>
<span class="sd">            Minimum confidence level for correlation plot.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">get_correlations</span>
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">heatmap</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="n">catagory</span> <span class="o">=</span> <span class="s1">&#39;PhotonEnergy&#39;</span>
        <span class="k">if</span> <span class="n">catagory</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="s1">&#39;EBeam&#39;</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="n">catagory</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span>
                    <span class="n">make_scatter</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">make_timeplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_histplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Gasdet_post_atten&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation&#39;</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="n">alias</span> <span class="o">=</span> <span class="s1">&#39;Gasdet_post_atten&#39;</span>
        <span class="n">catagory</span> <span class="o">=</span> <span class="s1">&#39;PulseEnergy&#39;</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="n">catagory</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> 
                    <span class="n">make_scatter</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">make_timeplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_histplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;PhotonEnergy&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation&#39;</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Build_html.add_all"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_all.html#PyDataSource.Build_html.add_all">[docs]</a>    <span class="k">def</span> <span class="nf">add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                        <span class="n">min_step_data</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="n">min_in_cut</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add All detector and run summary plots with limited intelligence in selecting plots.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        min_step_data : int</span>
<span class="sd">            Only groupby attributes in x.attrs[&#39;scan_variables&#39;] if having this min</span>
<span class="sd">            number of steps.</span>

<span class="sd">        min_in_cut : int</span>
<span class="sd">            Only make add_correlations plots for attributes in x.attrs[&#39;cuts&#39;]</span>
<span class="sd">            if ther are min number of events after cut</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#self.make_default_cuts()</span>
        
        <span class="k">if</span> <span class="s1">&#39;cuts&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">cuts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cuts&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cuts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cuts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cuts</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cuts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cuts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cuts</span> <span class="o">=</span> <span class="p">[]</span>
       

        <span class="c1"># Add RunStats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detstats</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot add detstats&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add Config</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_config</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot add config&#39;</span><span class="p">)</span>
        

        <span class="c1"># Add Correlations</span>
        <span class="k">if</span> <span class="n">cuts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cuts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">cut</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_in_cut</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_correlations</span><span class="p">(</span><span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add correlelations for cut&#39;</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_correlations</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add correlelations&#39;</span><span class="p">)</span>

        <span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">,</span> <span class="p">[])</span> \
                            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">min_step_data</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span><span class="s1">&#39;points&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:24}</span><span class="s1"> </span><span class="si">{:&gt;8}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding detector&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
           
            <span class="k">if</span> <span class="n">cuts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">cut</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_in_cut</span><span class="p">:</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not add detector </span><span class="si">{:}</span><span class="s1"> with cut </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">cut</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                     <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">alias</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not add summary&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not add summary&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_axis_plots</span><span class="p">()</span>

        <span class="n">xdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="k">if</span> <span class="s1">&#39;codes&#39;</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="p">[</span><span class="s1">&#39;codes&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                    <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding stats for &#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nevents</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_stats</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nevents</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>

<span class="c1"># Multiplot boxplot</span>
<span class="c1"># data=xstats.Sc1Imp_amplitudes.to_dataframe()</span>
<span class="c1"># data.groupby(&#39;Sc1Imp_ch&#39;).boxplot(column=&#39;Sc1Imp_amplitudes&#39;, by=&#39;delta_drop&#39;) </span>
<span class="c1"># or </span>
<span class="c1"># sns.boxplot(x=&#39;delta_drop&#39;, y=&#39;Sc1Imp_amplitudes&#39;, hue=&#39;Sc1Imp_ch&#39;, data=data.reset_index())</span>
    <span class="k">def</span> <span class="nf">add_delta_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">code</span><span class="o">=</span><span class="s1">&#39;ec162&#39;</span><span class="p">,</span> <span class="n">xattr</span><span class="o">=</span><span class="s1">&#39;delta_drop&#39;</span><span class="p">,</span> <span class="n">min_codes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                <span class="n">nearest</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_box</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">add_detectors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="c1">#                make_timeplot=False, make_scatter=False, </span>
<span class="c1">#                make_correlation=False, make_histplot=False, make_table=False,</span>
                <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beam_on</span><span class="o">=</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">,</span>
                <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.95</span><span class="p">],</span> <span class="n">make_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add timing error and drop shot plots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">find_beam_correlations</span><span class="p">,</span> <span class="n">ttest_groupby</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;XrayOff&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;XrayOff&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No code = </span><span class="si">{:}</span><span class="s1"> in data for add_delta_beam analysis&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="k">return</span>
        
        <span class="n">ncode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ncode</span> <span class="o">&lt;</span> <span class="n">min_codes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING only </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> found -- not enought data to find beam correlations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncode</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">save_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/reg/d/psdm/&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> \
                    <span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="s1">&#39;run</span><span class="si">{:04}</span><span class="s1">_drop_sum.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>

        <span class="n">xstats</span> <span class="o">=</span> <span class="n">find_beam_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">nearest</span><span class="o">=</span><span class="n">nearest</span><span class="p">,</span> 
                    <span class="n">cut</span><span class="o">=</span><span class="n">beam_on</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="n">save_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">,[])</span> \
                  <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">,[])</span> \
                  <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area_detectors&#39;</span><span class="p">,[])</span> \
                  <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_detectors&#39;</span><span class="p">,[])</span> \
                  <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">,[])</span>
        
        <span class="n">all_attrs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_warning_detected&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area_detectors&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_detectors&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">,[])</span>
 
        <span class="n">show_attrs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">,[])</span> \
              <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">,[])</span>
        
        <span class="n">adets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">show_attrs</span><span class="p">])))</span> 

        <span class="k">if</span> <span class="n">add_detectors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">adets</span><span class="p">:</span>
                        <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span>
                        <span class="n">make_correlation</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1">#make_correlation = True</span>
                        <span class="n">det_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_attrs</span> \
                                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">alias</span> <span class="p">]</span>
                        <span class="k">if</span> <span class="n">alias</span> <span class="o">==</span> <span class="s1">&#39;EBeam&#39;</span><span class="p">:</span>
                            <span class="n">det_attrs</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamCharge&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamPhotonEnergy&#39;</span><span class="p">]</span>
                        <span class="n">make_scatter</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1">#make_scatter = [a for a in x.attrs.get(&#39;beam_corr_detected&#39;,[]) \</span>
                        <span class="c1">#            if str(x[a].attrs.get(&#39;alias&#39;)) == alias ]</span>
                        <span class="n">make_histplot</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span>
                        <span class="c1">#det_attrs = None</span>
                        <span class="n">det_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> \
                                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">alias</span> <span class="p">]</span>
                        <span class="n">make_correlation</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">make_scatter</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">make_histplot</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">det_attrs</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="s1">&#39;XrayOn&#39;</span><span class="p">,</span>
                            <span class="n">make_timeplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_scatter</span><span class="o">=</span><span class="n">make_scatter</span><span class="p">,</span> 
                            <span class="n">make_correlation</span><span class="o">=</span><span class="n">make_correlation</span><span class="p">,</span> <span class="n">make_histplot</span><span class="o">=</span><span class="n">make_histplot</span><span class="p">,</span> 
                            <span class="n">make_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
                
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot add detector summary for </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>

        <span class="n">dfattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">dfattrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">df_nearest</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">delta_drop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nearest</span><span class="p">]</span>

        <span class="n">setup_howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;from PyDataSource.xarray_utils import find_beam_correlations&quot;</span><span class="p">]</span>
        <span class="n">setup_howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;import seaborn as sns&quot;</span><span class="p">)</span>
        <span class="n">setup_howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstats = find_beam_correlations(x, groupby=&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
        <span class="n">setup_howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfattrs = [a for a in x if x[a].dims == (&#39;time&#39;,)]&quot;</span><span class="p">)</span>
        <span class="n">setup_howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = x[dfattrs].to_dataframe()&quot;</span><span class="p">)</span>
        <span class="n">setup_howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_nearest = df[abs(df.delta_drop) &lt;= </span><span class="si">{:}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nearest</span><span class="p">))</span>
        <span class="n">setup_added</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">###       Test and add in timing error summary</span>
<span class="c1">#        ntiming_errors = len(x.attrs.get(&#39;timing_error_detected&#39;,[]))</span>
<span class="c1">#        if ntiming_errors:</span>
<span class="c1">#            attr_cat = &#39; Alert Timing Error&#39;</span>
<span class="c1">#            plt_type = &#39;Timing Error Event Summary&#39; </span>
<span class="c1">#            howto = []</span>
<span class="c1">#            fig, axes = plt.subplots(nrows=ntiming_errors,sharex=True)</span>
<span class="c1">#            for attr in x.attrs.get(&#39;timing_error_detected&#39;,[]):</span>
<span class="c1">#                aattrs = x[attr].attrs</span>
<span class="c1">#                delta_beam = aattrs.get(&#39;delta_beam&#39;)</span>
<span class="c1">#                df = x[attr].where(x.delta_drop==0,drop=True).to_pandas()</span>
<span class="c1">#                df.plot(color=&#39;green&#39;,style=&#39;.&#39;,ax=axes[0], label=&#39;drop&#39;,legend=True)</span>
<span class="c1">#                df = x[attr].where(x.delta_drop==delta_beam,drop=True).to_pandas()</span>
<span class="c1">#                df.plot(color=&#39;purple&#39;,style=&#39;.&#39;,ax=axes[0],label=&#39;off-by {:}&#39;.format(delta_beam),legend=True,title=attr)</span>
<span class="c1">#            </span>
<span class="c1">#            self.add_plot(attr_cat, plt_type, howto=howto)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xstats</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">xstats</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">aattrs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">attr_attr</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attr&#39;</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))]</span>
            <span class="n">delta_beam</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delta_beam&#39;</span><span class="p">)</span>
            <span class="n">delta_beam_pvalue</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delta_beam_pvalue&#39;</span><span class="p">)</span>
            <span class="n">timing_error_detected</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timing_error_detected&#39;</span><span class="p">)</span>
            <span class="n">drop_shot_detected</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drop_shot_detected&#39;</span><span class="p">)</span>
            <span class="n">beam_corr_detected</span> <span class="o">=</span> <span class="n">aattrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_corr_detected&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">catagory</span><span class="p">:</span>
                <span class="n">attr_cat</span> <span class="o">=</span> <span class="n">catagory</span>
                <span class="n">plt_type</span> <span class="o">=</span> <span class="n">attr</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timing_error_detected</span><span class="p">:</span> 
                    <span class="c1">#if alias in [&#39;EBeam&#39;]:</span>
                    <span class="c1">#    continue</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="s1">&#39; Alert Timing Error&#39;</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39; Timing&#39;</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39; Timing&#39;</span>
                    <span class="n">sformat</span><span class="o">=</span><span class="s1">&#39;Timing offset by </span><span class="si">{:}</span><span class="s1"> detected relative to </span><span class="si">{:}</span><span class="s1">&#39;</span> 
                    <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delta_beam</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">drop_shot_detected</span><span class="p">:</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="n">alias</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Detected Dropped Shot&#39;</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Detected Dropped Shot&#39;</span>
                    <span class="n">sformat</span><span class="o">=</span><span class="s1">&#39;Dropped Shot Detected on </span><span class="si">{:}</span><span class="s1">&#39;</span> 
                    <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">beam_corr_detected</span><span class="p">:</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="n">alias</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Delta Beam&#39;</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Delta Beam&#39;</span>
                    <span class="n">sformat</span><span class="o">=</span><span class="s1">&#39;Beam Correlated but No Dropped Shot on </span><span class="si">{:}</span><span class="s1">&#39;</span> 
                    <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attr_cat</span> <span class="o">=</span> <span class="n">alias</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Delta Beam&#39;</span>
                    <span class="n">tbl_type</span> <span class="o">=</span> <span class="n">attr_attr</span><span class="o">+</span><span class="s1">&#39; Delta Beam&#39;</span>
                    <span class="n">sformat</span><span class="o">=</span><span class="s1">&#39;No Beam Correlation or Dropped Shot on </span><span class="si">{:}</span><span class="s1">&#39;</span> 
                    <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">attr_cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">setup_added</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_setup</span><span class="p">(</span><span class="n">attr_cat</span><span class="p">,</span> <span class="n">setup_howto</span><span class="p">)</span>
                <span class="n">setup_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_cat</span><span class="p">)</span>

            <span class="n">df_table</span> <span class="o">=</span> <span class="n">df_nearest</span><span class="p">[[</span><span class="n">attr</span><span class="p">,</span><span class="n">xattr</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">xattr</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">)</span>
<span class="c1">#            if make_table:</span>
<span class="c1">#                howto = [&quot;df_stats = xstats[&#39;{:}&#39;].to_pandas()&quot;.format(attr)]</span>
<span class="c1">#                self.add_table(df_stats, attr_cat, tbl_type, tbl_type, doc=doc, howto=howto, hidden=True)</span>

            <span class="n">std_ratio</span> <span class="o">=</span> <span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">df_stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            
            <span class="c1"># Auto test if systematic ec141 bias </span>
            <span class="n">hue</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
                <span class="n">hue</span> <span class="o">=</span> <span class="n">cut</span>
            <span class="k">elif</span> <span class="n">cut</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;ec141&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ttest</span> <span class="o">=</span> <span class="n">ttest_groupby</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;ec141&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ttest</span><span class="o">.</span><span class="n">pvalue</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span> 
                        <span class="n">hue</span> <span class="o">=</span> <span class="s1">&#39;ec141&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error ttest_gropuby&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;ec141&#39;</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">hue</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xattr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_nearest</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">inner</span><span class="o">=</span><span class="s1">&#39;quart&#39;</span><span class="p">)</span>
                <span class="n">howstr</span> <span class="o">=</span> <span class="s2">&quot;sns.violinplot(x=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, y=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, data=df_nearest, hue=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, split=True, inner=&#39;quart&#39;)&quot;</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span> <span class="n">howstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xattr</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">hue</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">std_ratio</span> <span class="o">&gt;</span> <span class="n">std_box</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xattr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_nearest</span><span class="p">)</span>
                    <span class="n">howstr</span> <span class="o">=</span> <span class="s2">&quot;sns.boxplot(x=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, y=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, data=df_nearest)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xattr</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_nearest</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s1">&#39;quart&#39;</span><span class="p">)</span>
                    <span class="n">howstr</span> <span class="o">=</span> <span class="s2">&quot;sns.violinplot(x=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, y=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, data=df_nearest, inner=&#39;quart&#39;)&quot;</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span> <span class="n">howstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xattr</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span> <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">attr_cat</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">df_stats</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xstats</span>

<div class="viewcode-block" id="Build_html.add_counts"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_counts.html#PyDataSource.Build_html.add_counts">[docs]</a>    <span class="k">def</span> <span class="nf">add_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Detector Count&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add correlation plots of detector count and sum values</span>
<span class="sd">        </span>
<span class="sd">        catagory : str</span>
<span class="sd">            Cataroy name.  Default = &#39;Detector Count&#39; </span>

<span class="sd">        confidence : float</span>
<span class="sd">            Minimum confidence level for correlation plot.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_count&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_sum&#39;</span><span class="p">))</span> 
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;PhotonEnergy&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Gasdet_post_atten&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="n">catagory</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">)</span></div>
       
<div class="viewcode-block" id="Build_html.add_axis_plots"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_axis_plots.html#PyDataSource.Build_html.add_axis_plots">[docs]</a>    <span class="k">def</span> <span class="nf">add_axis_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PhotonEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;Gasdet_post_atten&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add correlation plots of X and Y axis data.  Compare all attrs that end with:</span>
<span class="sd">           Xaxis: _PosX, _AngX or xpos </span>
<span class="sd">           Yaxis: _PosY, _AngY or ypos </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        base_attrs : list</span>
<span class="sd">            List of base attrs to add to axis attrs. Default = [&#39;PhotonEnergy&#39;, &#39;Gasdet_post_atten&#39;]  </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_PosX&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_AngX&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;xpos&#39;</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span> <span class="o">+</span> <span class="n">base_attrs</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
<span class="c1">#            if &#39;PhotonEnergy&#39; in x:</span>
<span class="c1">#                attrs.append(&#39;PhotonEnergy&#39;)</span>
<span class="c1">#            if &#39;Gasdet_post_atten&#39; in x:</span>
<span class="c1">#                attrs.append(&#39;Gasdet_post_atten&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Xaxis&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_PosY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_AngY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ypos&#39;</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">]</span> <span class="o">+</span> <span class="n">base_attrs</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
<span class="c1">#            if &#39;PhotonEnergy&#39; in x:</span>
<span class="c1">#                attrs.append(&#39;PhotonEnergy&#39;)</span>
<span class="c1">#            if &#39;Gasdet_post_atten&#39; in x:</span>
<span class="c1">#                attrs.append(&#39;Gasdet_post_atten&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_detector</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;Yaxis&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">make_default_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gasdetcut_mJ</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make default cuts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        gasdetcut_mJ : float</span>
<span class="sd">            Minimum gasdetector value to pass cut</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        h5write.make_default_cuts</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">h5write</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="o">=</span> <span class="n">h5write</span><span class="o">.</span><span class="n">make_default_cuts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot make default cuts&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make summary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">PyDataSource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xsummary</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">to_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">)</span>

<div class="viewcode-block" id="Build_html.add_config"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_config.html#PyDataSource.Build_html.add_config">[docs]</a>    <span class="k">def</span> <span class="nf">add_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add detector configurations based on </span>
<span class="sd">        information provided in attrs of {alias}_preset data objects. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        attrs : list</span>
<span class="sd">            List of detector aliases to describe configuration.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;present&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:&lt;50}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;textblock&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;config&#39;</span><span class="p">:{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;textblock_text&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span></div>

<div class="viewcode-block" id="Build_html.add_detstats"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_detstats.html#PyDataSource.Build_html.add_detstats">[docs]</a>    <span class="k">def</span> <span class="nf">add_detstats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;RunStats&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add detector statistics. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        catagory : str</span>
<span class="sd">            Cataroy name.  Default = &#39;RunStats&#39; </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
            <span class="n">df_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eventStats</span> <span class="o">=</span> <span class="n">df_tbl</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A summary of the mean, stdev, min and max values were created &quot;</span>
                      <span class="o">+</span><span class="s2">&quot;for each eventCode for the detectors in this table:&quot;</span><span class="p">)</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_tbl = x[attrs].sel(steps=0).to_array().to_pandas()&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">catagory</span><span class="p">:{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df_tbl</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;df_tbl&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span></div>

<div class="viewcode-block" id="Build_html.add_detector"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_detector.html#PyDataSource.Build_html.add_detector">[docs]</a>    <span class="k">def</span> <span class="nf">add_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;FEEGasDetEnergy&#39;</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.50</span><span class="p">,</span><span class="mf">0.95</span><span class="p">],</span> 
                           <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">scat_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">make_scatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">make_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">make_timeplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">make_histplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">make_correlation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">min_step_data</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                           <span class="n">confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                           <span class="n">robust_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">plot_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                           <span class="n">max_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                           <span class="n">max_scatter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                           <span class="n">plt_style</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                           <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a detector based on alias</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        alias : str</span>
<span class="sd">            Detector alias</span>

<span class="sd">        attrs : list</span>
<span class="sd">            List of attributes to be operated on.</span>
<span class="sd">            By default attrs will be the list of all data elements with the given alias and dim = (&#39;time&#39;,) </span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        make_table : bool</span>
<span class="sd">            Make a table with statistical description of attributes</span>
<span class="sd">            (uses pandas DataFrame.describe method)</span>

<span class="sd">        make_histplot : bool</span>
<span class="sd">            Make histotram plots for each attr</span>

<span class="sd">        bins : int</span>
<span class="sd">            Number of bins used in histograms [Default = 50]</span>

<span class="sd">        make_timeplot : bool</span>
<span class="sd">            Make plots vs time for each attr</span>

<span class="sd">        make_correlation : bool</span>
<span class="sd">            Make a correlation plot of attributes that have a correlation</span>
<span class="sd">            confidence greater than the specified confidence value</span>

<span class="sd">        confidence : float</span>
<span class="sd">            Minimum confidence level for correlation plot.</span>

<span class="sd">        make_scatter : bool, list, or dict</span>
<span class="sd">            Make scatter correlation plot of detector attributes.</span>
<span class="sd">            Optionally provide list specifying attrs for scatter plots.</span>
<span class="sd">            If dict of lists of attributes is provided, than make multiple </span>
<span class="sd">            loop through dict to make scatter plots with the keys used </span>
<span class="sd">            as names of the plots and values used as attributes in plot.</span>

<span class="sd">        max_steps : int</span>
<span class="sd">            Max steps in scatter plot to be color coded</span>

<span class="sd">        max_scatter : int</span>
<span class="sd">            Max attributes to make scatter plot [Default=8]</span>
<span class="sd">        </span>
<span class="sd">        robust_attrs : list</span>
<span class="sd">            List of attibutes to cut on outliers in making scatter plots. </span>

<span class="sd">        scat_name : str</span>
<span class="sd">            Optional name of scatter plot</span>

<span class="sd">        groupby : list</span>
<span class="sd">            Optionally group data by each attribute in groupby list</span>
<span class="sd">            Default is to use attibutes in scan_variables DataSet attrs.</span>

<span class="sd">        min_step_data : int</span>
<span class="sd">            Minimum number of steps in groupby attributes to make groupby plots</span>
<span class="sd">            Default = 20</span>

<span class="sd">        plot_errors : bool</span>
<span class="sd">            Optionally plot error bars in groupby plots</span>

<span class="sd">        cut : str</span>
<span class="sd">            Attribute on which to make cut when making plots</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="n">nevents</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">nevents</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">make_scatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_scatter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">make_timeplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_timeplot</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">make_histplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_histplot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">nevents</span> <span class="o">&gt;</span> <span class="mi">40000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">make_scatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_scatter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">make_scatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_scatter</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">make_timeplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_timeplot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">make_histplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">make_histplot</span> <span class="o">=</span> <span class="kc">True</span> 

        <span class="c1">#if &#39;Damage_cut&#39; in x:</span>
        <span class="c1">#    x = x.where(x.Damage_cut == 1)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelsize</span> 
        <span class="n">desc_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span>
        <span class="n">default_scatter_attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;EBeam&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ebeamCharge&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamDumpCharge&#39;</span><span class="p">,</span><span class="s1">&#39;ebeamUndPosX&#39;</span><span class="p">,</span> <span class="s1">&#39;ebeamUndPosY&#39;</span><span class="p">]</span>
                <span class="c1">#&#39;EBeam&#39;: [&#39;ebeamCharge&#39;, &#39;ebeamDumpCharge&#39;,&#39;ebeamL3Energy&#39;, &#39;ebeamPhotonEnergy&#39;, &#39;ebeamUndPosX&#39;, &#39;ebeamUndPosY&#39;]</span>
                <span class="c1">#&#39;EBeam&#39;: [&#39;ebeamCharge&#39;, &#39;ebeamL3Energy&#39;, &#39;ebeamPhotonEnergy&#39;, &#39;ebeamXTCAVAmpl&#39;, &#39;ebeamXTCAVPhase&#39;]</span>
                <span class="p">}</span>

<span class="c1">#        print default_scatter_attrs</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupby</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gattr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">gattr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span><span class="o">.</span><span class="n">data_vars</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">gattr</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">min_step_data</span><span class="p">:</span>
                    <span class="n">groupby</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gattr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>

        <span class="c1">#if groupby and not np.shape(groupby):</span>
        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupby</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groupby</span><span class="p">))</span>

        <span class="n">attr_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                     <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">alias</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]</span>
            <span class="n">attrs0</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_variables&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">make_scatter</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">make_scatter</span><span class="p">:</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">attr_names</span> <span class="o">=</span> <span class="n">attrs</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">attr_names</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            
            <span class="n">attrs0</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No scalar data for &#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_names</span><span class="p">:</span>
            <span class="n">attr_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="p">}</span>

        <span class="n">typ_pre</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">catagory</span><span class="p">:</span>
                <span class="n">typ_pre</span> <span class="o">=</span> <span class="n">cut</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">catagory</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">cut</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">catagory</span><span class="p">:</span>
                <span class="n">typ_pre</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">catagory</span> <span class="o">=</span> <span class="n">alias</span>

<span class="c1">#        if cut is None:</span>
<span class="c1">#            if &#39;Damage_cut&#39; not in x:</span>
<span class="c1">#                self.make_damage_cut()</span>
<span class="c1">#            cut = &#39;Damage_cut&#39;</span>
        
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
            <span class="n">nattrs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nattrs</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">ncolumns</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">nattrs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">ncolumns</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">nattrs</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nattrs</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">layout</span><span class="p">:</span>
                <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncolumns</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">figsize</span><span class="p">:</span>
                <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">ncolumns</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">]),</span><span class="nb">max</span><span class="p">([</span><span class="n">nrows</span><span class="o">*</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">6</span><span class="p">]))</span>
           
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xselect</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not add </span><span class="si">{:}</span><span class="s1"> attrs: </span><span class="si">{:}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span><span class="n">attrs</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="n">tselect</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
            <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
                <span class="n">tselect</span> <span class="o">=</span> <span class="s1">&#39;points&#39;</span>
                <span class="n">itimes</span> <span class="o">=</span> <span class="n">xselect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itimes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xselect</span> <span class="o">=</span> <span class="n">xselect</span><span class="o">.</span><span class="n">isel_points</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">itimes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">xselect</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labelsize</span><span class="p">)]</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;itimes = x[attrs].groupby(&#39;</span><span class="si">{:}</span><span class="s2">&#39;).groups[1]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cut</span><span class="p">))</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xselect = x[attrs].isel_points(times=itimes)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xselect = x[attrs]&quot;</span><span class="p">)</span>

                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = xselect.to_array().to_pandas().T&quot;</span><span class="p">)</span>

                <span class="n">df_attrs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">attr_names</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">desc_attrs</span><span class="p">}</span> \
                                         <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">})</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">desc_attrs</span><span class="p">]</span>
                
                <span class="c1"># Need to add in howto print formatted df_attrs, but tricky</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df_attrs</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;df_attrs&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:&lt;10s}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:&lt;60s}</span><span class="s1">&#39;</span><span class="p">}}})</span>
                
                <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">attr_names</span><span class="p">)</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attr_names=</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_names</span><span class="p">))</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df.rename(inplace=True, columns=attr_names)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;setup&#39;</span><span class="p">:{</span><span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span>
                
                <span class="c1">#df_attrs.to_string(formatters={&#39;unit&#39;: &#39;{:&lt;10s}&#39;.format, &#39;doc&#39;: &#39;{:&lt;60s}&#39;.format},justify=&#39;left&#39;)</span>

                <span class="n">df_tbl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df_tbl = df.describe(percentiles=</span><span class="si">{:}</span><span class="s2">).T.round(</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})]</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;print df_tbl&quot;</span><span class="p">)</span>

                <span class="c1"># make table using pandas</span>
                <span class="k">if</span> <span class="n">make_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;stats&#39;</span><span class="p">:{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df_tbl</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;df_tbl&#39;</span><span class="p">,</span> <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span>
               
                <span class="c1"># make time plots</span>
                <span class="k">if</span> <span class="n">make_timeplot</span><span class="p">:</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">plt_style</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="c1">#plt.tight_layout()</span>
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df.plot(subplots=True, sharex=True, style=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, layout=</span><span class="si">{:}</span><span class="s2">, figsize=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plt_style</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">figsize</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not build df to describe &#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">xselect</span><span class="p">)</span>

            <span class="c1"># Make groupby plots</span>
            <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
                    
<span class="c1">#                    try:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># not sure why this is a list sometimes</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">grp</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>
                        <span class="c1">#print group, tselect</span>
                        <span class="k">if</span> <span class="n">plot_errors</span><span class="p">:</span>
                            <span class="n">df_group</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                            <span class="n">xaxis</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">xlab</span> <span class="o">=</span> <span class="n">group</span>
                            <span class="n">unit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
                                <span class="n">xlab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
                            
                            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs0</span><span class="p">:</span>
                                <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                                <span class="n">yaxis</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                                <span class="n">yerr</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xaxis</span><span class="p">,</span><span class="n">yaxis</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">)</span>
                                <span class="n">ylab</span> <span class="o">=</span> <span class="n">attr</span>
                                <span class="n">unit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
                                    <span class="n">ylab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
                                
                                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">)</span>
                                <span class="c1">#plt.tight_layout()</span>
                                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xaxis = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_group = xselect.to_array().to_pandas().T.groupby(&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xaxis = df_group[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].mean()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span> 
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;yaxis = df_group[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].mean()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span> 
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;yerr = df_group[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].std()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span> 
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;figure()&quot;</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.errorbar(xaxis,yaxis,yerr=yerr)&quot;</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.xlabel(&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xlab</span><span class="p">))</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.ylabel(&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ylab</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span> 
                            <span class="c1"># Switch to something like </span>
                            <span class="c1"># g = sns.PairGrid(df_group, y_vars=attrs0, x_vars=group, size=5, aspect=.5)</span>
                            <span class="c1"># g.map(sns.pointplot, color=sns.xkcd_rgb[&quot;plum&quot;])</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                            <span class="n">x_group</span> <span class="o">=</span> <span class="n">xselect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">tselect</span><span class="p">)</span>
                            <span class="n">df_group</span> <span class="o">=</span> <span class="n">x_group</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">ndfg</span> <span class="o">=</span> <span class="n">df_group</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span>
                            <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">ndfg</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>
                            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ndfg</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">)))</span>
                            <span class="n">df_group</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncolumns</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                            <span class="c1">#plt.tight_layout()</span>
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x_group = xselect.groupby(&#39;</span><span class="si">{:}</span><span class="s2">&#39;).mean(dim=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">tselect</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_group = x_group.to_array().to_pandas().T&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_group.plot(subplots=True, sharex=True, layout=</span><span class="si">{:}</span><span class="s2">, figsize=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">figsize</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        
                        <span class="c1">#grp_values = set(xselect[grp].values)</span>
                        <span class="c1">#if len(grp_values) &lt; 9:</span>
                        <span class="c1">#    for attr in attrs0:</span>
                        <span class="c1">#        plt.cla()</span>

                        <span class="c1">#        xselect[attr] plot(robust=True)</span>
                        <span class="c1">#        howto = []</span>
                        <span class="c1">#        howto.append(&quot;xdat.squeeze(&#39;steps&#39;).sel(codes={:}).plot(robust=True)&quot;.format(code))</span>
                        <span class="c1">#        howto.append(&quot;plt.show()&quot;)</span>
                        <span class="c1">#        name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
                        <span class="c1">#        plt_type = &#39;summary_{:}_ec{:}&#39;.format(name, code) </span>
                        <span class="c1">#        self.add_plot(alias, plt_type, howto=howto)</span>

                    <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#except:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed adding:&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># make hist plots:</span>
            <span class="k">if</span> <span class="n">make_histplot</span><span class="p">:</span>
                <span class="c1">#perlow = &#39;{:}%&#39;.format(int(min(percentiles)*100))</span>
                <span class="c1">#perhigh = &#39;{:}%&#39;.format(int(max(percentiles)*100))</span>
                <span class="c1">#dfcut = df[(df &gt; df_tbl[perlow]-2*df_tbl[&#39;std&#39;]).all(axis=1) &amp; (df &lt; df_tbl[perhigh]+2*df_tbl[&#39;std&#39;]).all(axis=1)]</span>
                <span class="c1">#dfcut = df[(df &gt; df_tbl[&#39;5%&#39;]-2*df_tbl[&#39;std&#39;]).all(axis=1) &amp; (df &lt; df_tbl[&#39;95%&#39;]+2*df_tbl[&#39;std&#39;]).all(axis=1)]</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = x.reset_coords()[attrs].to_dataframe()&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcut</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfcut = df[(df &lt; df.max(axis=0)).all(axis=1) &amp; (df &gt; df.min(axis=0)).all(axis=1)].dropna()&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dfcut</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#howto = [&quot;dfcut = df[(df &gt; df_tbl[&#39;5%&#39;]-2*df_tbl[&#39;std&#39;]).all(axis=1) &amp; (df &lt; df_tbl[&#39;95%&#39;]+2*df_tbl[&#39;std&#39;]).all(axis=1)]&quot;] </span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span>
                    <span class="c1">#dfcut.hist(alpha=0.2, layout=layout, figsize=figsize)</span>
                    <span class="n">dfcut</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                    <span class="c1">#plt.tight_layout()</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfcut.hist(alpha=0.2, layout=</span><span class="si">{:}</span><span class="s2">, figsize=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">figsize</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;make_histplot failed&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">dfcut</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">make_correlation</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">heatmap</span>
                    <span class="n">corr</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">)</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation&#39;</span>
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from PyDataSource.xarray_utils import heatmap&#39;</span><span class="p">]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;heatmap(df, confidence=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">confidence</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">corr</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not make correlation&#39;</span><span class="p">)</span>


            <span class="c1"># make scatter matrix using pandas -- cut outliers</span>
            <span class="k">if</span> <span class="n">make_scatter</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">robust_attrs</span><span class="p">:</span>
                    <span class="n">robust_attrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    
                <span class="n">robust_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">robust_attrs</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">dfr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">robust_attrs</span><span class="p">]</span>
                <span class="n">df_tbl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
                <span class="n">df_tblr</span> <span class="o">=</span> <span class="n">df_tbl</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">robust_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">dfcut</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">dfr</span> <span class="o">&gt;</span> <span class="n">df_tblr</span><span class="p">[</span><span class="s1">&#39;5%&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">df_tblr</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfr</span> <span class="o">&lt;</span> <span class="n">df_tblr</span><span class="p">[</span><span class="s1">&#39;95%&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">df_tblr</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">dfcut</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dfcut</span> <span class="o">=</span> <span class="n">df</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">make_scatter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">scat_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">scat_group</span><span class="p">,</span> <span class="n">sattrs</span> <span class="ow">in</span> <span class="n">make_scatter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">slist</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">sattrs</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dfcut</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                        <span class="n">scat_dict</span><span class="p">[</span><span class="n">scat_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">slist</span> 

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">make_scatter</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1">#scat_attrs = [attr.replace(alias+&#39;_&#39;,&#39;&#39;) for attr in make_scatter if attr in dfcut.keys()]</span>
                    <span class="n">scat_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">make_scatter</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dfcut</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="n">scat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">scat_attrs</span><span class="p">}</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scat_attrs</span> <span class="o">=</span> <span class="n">default_scatter_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">attr_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">scat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">scat_attrs</span><span class="p">}</span>
               
                <span class="k">for</span> <span class="n">scat_group</span><span class="p">,</span> <span class="n">scat_attrs</span> <span class="ow">in</span> <span class="n">scat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_variables&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">dfcut</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scat_attrs</span><span class="p">:</span>
                            <span class="n">scat_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scat_attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_scatter</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many parameters to make scatter plots:&#39;</span><span class="p">,</span> <span class="n">scat_attrs</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scat_attrs</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfscat</span> <span class="o">=</span> <span class="n">dfcut</span><span class="p">[</span><span class="n">scat_attrs</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">scat_group</span><span class="p">,</span> <span class="s1">&#39;make_scatter failed&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">dfcut</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scat_attrs = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scat_attrs</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;robust_attrs = [a for a in [attr.replace(alias+&#39;_&#39;,&#39;&#39;) for attr in df.keys()]]&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfr = df[robust_attrs]&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df_tblr = df_tbl.T[robust_attrs].T&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfcut = df[(dfr &gt; df_tblr[&#39;5%&#39;]-2*df_tblr[&#39;std&#39;]).all(axis=1) &amp; (dfr &lt; df_tblr[&#39;95%&#39;]+2*df_tblr[&#39;std&#39;]).all(axis=1)]&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dfscat = dfcut[scat_attrs]&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">groupby</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&lt;</span> <span class="n">max_steps</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">scat_name</span><span class="p">:</span>
                                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">scat_name</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                                
                                <span class="k">if</span> <span class="n">scat_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                                    <span class="n">plt_type</span> <span class="o">=</span> <span class="n">scat_group</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">plt_type</span>
                                
                                <span class="n">pltattrs</span> <span class="o">=</span> <span class="n">scat_attrs</span>
                                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">pltattrs</span><span class="p">:</span>
                                        <span class="n">pltattrs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                                    
                                <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> 
                                <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">dfcut</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                                        <span class="n">x_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span><span class="n">y_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span>
                                        <span class="c1">#palette=&quot;Set1&quot;, </span>
                                        <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> 
                                        <span class="c1">#palette=&quot;Set1&quot;, diag_kind=&quot;kde&quot;, size=2.5) </span>
                                        <span class="c1">#x_vars=pltattrs,y_vars=pltattrs)</span>
                                <span class="c1">#g = sns.PairGrid(dfscat, hue=group, </span>
                                <span class="c1">#        palette=&quot;Set1&quot;, </span>
                                <span class="c1">#        x_vars=pltattrs,y_vars=pltattrs)</span>
                                <span class="c1">#g = g.map_offdiag(plt.scatter)</span>
                                <span class="c1">#g = g.add_legend()</span>
                                <span class="c1">#plt.tight_layout()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
        <span class="c1">#df = x[attrs].to_dataframe()</span>
        <span class="c1">#sns.pairplot(df, hue=&quot;LaserOn&quot;, vars=attrs0)</span>
                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">plt_type</span> <span class="o">=</span> <span class="n">scat_group</span><span class="o">+</span><span class="s1">&#39; scatter_matrix&#39;</span>
                                <span class="c1">#Axes = pd.tools.plotting.scatter_matrix(dfscat, alpha=0.2, figsize=(20, 20), diagonal=&#39;kde&#39;)</span>
                                <span class="c1">#plt.tight_layout()</span>
                                <span class="c1">#howto.append(&quot;Axes = pd.tools.plotting.scatter_matrix(dfscat, alpha=0.2, figsize=(20, 20), diagonal=&#39;kde&#39;)&quot;)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> 
                                <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">dfscat</span><span class="p">,</span> <span class="n">diag_sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="n">g</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues_d&quot;</span><span class="p">)</span>
                                <span class="n">g</span><span class="o">.</span><span class="n">map_upper</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">)</span>
                                <span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g = sns.PairGrid(dfscat, diag_sharey=False)&#39;</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_lower(sns.kdeplot, cmap=&quot;Blues_d&quot;)&#39;</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_upper(plt.scatter)&#39;</span><span class="p">)</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_diag(sns.kdeplot, lw=3)&#39;</span><span class="p">)</span>
                                
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">typ_pre</span><span class="o">+</span><span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
            
            <span class="c1">#                    #y ticklabels</span>
            <span class="c1">#                    [plt.setp(item.yaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]</span>
            <span class="c1">#                    howto.append(&quot;[plt.setp(item.yaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]&quot;)</span>
            <span class="c1">#                    #x ticklabels</span>
            <span class="c1">#                    [plt.setp(item.xaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]</span>
            <span class="c1">#                    howto.append(&quot;[plt.setp(item.xaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]&quot;)</span>
            <span class="c1">#                    #y labels</span>
            <span class="c1">#                    [plt.setp(item.yaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]</span>
            <span class="c1">#                    howto.append(&quot;[plt.setp(item.yaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]&quot;)</span>
            <span class="c1">#                    #x labels</span>
            <span class="c1">#                    [plt.setp(item.xaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]</span>
            <span class="c1">#                    howto.append(&quot;[plt.setp(item.xaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]&quot;)</span>

                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">dfscat</span><span class="p">)</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="k">return</span> <span class="n">dfscat</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Build_html.add_xy_ploterr"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_xy_ploterr.html#PyDataSource.Build_html.add_xy_ploterr">[docs]</a>    <span class="k">def</span> <span class="nf">add_xy_ploterr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">howto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add error bar plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd"> </span>
<span class="sd">        attr : str </span>
<span class="sd">            Attribute to plot    </span>

<span class="sd">        xaxis : str </span>
<span class="sd">            Optional attribute of X axis.    </span>

<span class="sd">        cut : str</span>
<span class="sd">            Attribute on which to make cut when making plots</span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        table : pandas.DataFrame</span>
<span class="sd">            Optional pandas.DataFrame object to represent as a table </span>
<span class="sd">            in order to describe plot.</span>

<span class="sd">        text : str</span>
<span class="sd">            Text describing table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xarray_utils</span> <span class="k">import</span> <span class="n">xy_ploterr</span>
        <span class="k">if</span> <span class="n">xds</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
            <span class="k">if</span> <span class="s1">&#39;stat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">xarray_utils</span>
                <span class="n">sattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">xaxis</span><span class="p">:</span>
                    <span class="n">sattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xaxis</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;groupby&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">sattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groupby&#39;</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">sattrs</span><span class="p">]</span>    
                <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">cut</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xarray_utils</span><span class="o">.</span><span class="n">to_summary</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">howto</span><span class="p">:</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;Summary&#39;</span><span class="p">)</span>
        
        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Custom plot see PyDataSource.plotting.xy_ploterr method&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">xy_ploterr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="n">xaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xaxis</span><span class="p">:</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">scan_variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">)</span>   
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logy&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logx&#39;</span><span class="p">):</span>
                <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; log-log&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; log scale&#39;</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logx&#39;</span><span class="p">):</span>
            <span class="n">plt_type</span><span class="o">+=</span><span class="s1">&#39; lin-log&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">:{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span> 
                                                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;df_tbl&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                                                        <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}})</span></div>


    <span class="k">def</span> <span class="nf">add_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Add scatter plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
       
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> 
        <span class="n">pltattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">group</span><span class="p">]]</span>

        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sns.set()&quot;</span><span class="p">)</span>
        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pltattrs = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pltattrs</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                    <span class="n">x_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span><span class="n">y_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> 
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g = sns.pairplot(df, hue=&#39;</span><span class="si">{:}</span><span class="s2">&#39;, x_vars=pltattrs,y_vars=pltattrs,size=2.5)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;correlation&#39;</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span><span class="n">y_vars</span><span class="o">=</span><span class="n">pltattrs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> 
            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map_upper</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues_d&quot;</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;g = sns.pairplot(df, x_vars=pltattrs,y_vars=pltattrs,size=2.5)&quot;</span><span class="p">)</span>

        <span class="c1">#plt.tight_layout()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_scatter_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Scatter Groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EBeam_ebeamPhotonEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;FEEGasDetEnergy_f_21_ENRC&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlation_variables&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;XrayOn&#39;</span>
        
        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;is not a valid group -- ignoring group keyword&#39;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">howto</span><span class="p">:</span>
            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_groups</span><span class="p">:</span>
            <span class="n">attr_groups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Undulator X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamUndAngX&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamUndPosX&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Undulator Y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamUndAngY&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamUndPosY&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;LTU X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamLTUAngX&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamLTUPosX&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;LTU Y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamLTUAngY&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamLTUPosY&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;LTU 250 and 450&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamLTU250&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamLTU450&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Energy BC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamEnergyBC1&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamEnergyBC2&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Charge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamCharge&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamDumpCharge&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Peak Current&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamPkCurrBC1&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamPkCurrBC2&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;XTCAV&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EBeam_ebeamXTCAVAmpl&#39;</span><span class="p">,</span> <span class="s1">&#39;EBeam_ebeamXTCAVPhase&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Phase Cavity Charge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PhaseCavity_charge1&#39;</span><span class="p">,</span> <span class="s1">&#39;PhaseCavity_charge2&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Phase Cavity Fit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PhaseCavity_fitTime1&#39;</span><span class="p">,</span> <span class="s1">&#39;PhaseCavity_fitTime2&#39;</span><span class="p">],</span>
                           <span class="s1">&#39;Gasdet&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;FEEGasDetEnergy_f_63_ENRC&#39;</span><span class="p">,</span> <span class="s1">&#39;FEEGasDetEnergy_f_11_ENRC&#39;</span><span class="p">],</span>
                           <span class="p">}</span>

        <span class="n">all_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dims</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,)]</span>
        
        <span class="k">if</span> <span class="s1">&#39;Damage_cut&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_damage_cut</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">all_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">Damage_cut</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        
        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">grp_attrs</span> <span class="ow">in</span> <span class="n">attr_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">gattrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">grp_attrs</span><span class="p">:</span>
                <span class="n">gattrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">ghowto</span> <span class="o">=</span> <span class="n">howto</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">gattrs</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">ghowto</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="n">catagory</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">gattrs</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">ghowto</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_damage_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge_min</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
            <span class="n">fitTime1_min</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">fitTime1_max</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> 
            <span class="n">fitTime2_min</span><span class="o">=-</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">fitTime2_max</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">gasdet_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make damage cut based on EBeam and Gasdet data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span>
        <span class="n">phasecut</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_charge1</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="n">charge_min</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_charge2</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="n">charge_min</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_fitTime1</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">fitTime1_max</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_fitTime1</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">fitTime1_min</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_fitTime2</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">fitTime2_max</span><span class="p">)</span> <span class="o">&amp;</span> \
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">PhaseCavity_fitTime2</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">fitTime2_min</span><span class="p">)</span> 
        <span class="n">gasdetcut</span> <span class="o">=</span>  <span class="n">x</span><span class="o">.</span><span class="n">FEEGasDetEnergy_f_11_ENRC</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="n">damagecut</span> <span class="o">=</span> <span class="n">phasecut</span> <span class="o">&amp;</span> <span class="n">gasdetcut</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">EBeam_damageMask</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Damage_cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">damagecut</span><span class="p">)</span>

<span class="c1">#    def add_scatter(self, df, catagory=&#39;scatter&#39;, group=None, attrs=None, howto=[]):</span>
<span class="c1">#        if not attrs:</span>
<span class="c1">#            attrs = df.keys()</span>
<span class="c1">#       </span>
<span class="c1">#        pltattrs = [attr for attr in attrs if attr not in [group]]</span>
<span class="c1">#        if group:</span>
<span class="c1">#            plt_type = &#39;correlation with {:}&#39;.format(group)</span>
<span class="c1">#        else:</span>
<span class="c1">#            plt_type = &#39;correlation&#39;</span>
<span class="c1">#</span>
<span class="c1">#        sns.set()</span>
<span class="c1">#        plt.rcParams[&#39;axes.labelsize&#39;] = 10 </span>
<span class="c1">#        g = sns.pairplot(df, hue=group,</span>
<span class="c1">#                x_vars=pltattrs,y_vars=pltattrs,</span>
<span class="c1">#                size=2.5) </span>
<span class="c1">#</span>
<span class="c1">#        howto.append(&quot;sns.set()&quot;)</span>
<span class="c1">#        howto.append(&quot;pltattrs = {:}&quot;.format(pltattrs))</span>
<span class="c1">#        howto.append(&quot;g = sns.pairplot(df, hue={:}, x_vars=pltattrs,y_vars=pltattrs,size=2.5)&quot;)</span>
<span class="c1">#</span>
<span class="c1">#        self.add_plot(catagory, plt_type, howto=howto)</span>
<span class="c1">#</span>
<span class="c1">#                #palette=&quot;Set1&quot;, diag_kind=&quot;kde&quot;, size=2.5) </span>
<span class="c1">#                #x_vars=pltattrs,y_vars=pltattrs)</span>
<span class="c1">#        #g = sns.PairGrid(dfscat, hue=group, </span>
<span class="c1">#        #        palette=&quot;Set1&quot;, </span>
<span class="c1">#        #        x_vars=pltattrs,y_vars=pltattrs)</span>
<span class="c1">#        #g = g.map_offdiag(plt.scatter)</span>
<span class="c1">#        #g = g.add_legend()</span>

<div class="viewcode-block" id="Build_html.add_setup"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_setup.html#PyDataSource.Build_html.add_setup">[docs]</a>    <span class="k">def</span> <span class="nf">add_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">howto</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add text to beginning of HowTo.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        howto : list</span>
<span class="sd">            List of strings to describe howto setup the environment for making plots and tables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;setup&#39;</span><span class="p">:{</span><span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span></div>

    <span class="k">def</span> <span class="nf">_add_catagory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">catagory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;figure&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;textblock&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="n">hidden</span><span class="p">}</span>
    
<div class="viewcode-block" id="Build_html.add_plot"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_plot.html#PyDataSource.Build_html.add_plot">[docs]</a>    <span class="k">def</span> <span class="nf">add_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[],</span> <span class="n">doc</span><span class="o">=</span><span class="p">[],</span> 
                <span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a plot to the report. </span>
<span class="sd">        After making using matplotlib or higher level methods for making matplotlib plots </span>
<span class="sd">        (e.g., pandas, xarray or seaborn), use this method to save the figure to a file</span>
<span class="sd">        for later use in building report with plot organized by catagory and plt_type.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        plt_type : str</span>
<span class="sd">            Name describing plot type</span>

<span class="sd">        howto : list</span>
<span class="sd">            List of strings to describe howto make the plot</span>

<span class="sd">        tight : bool</span>
<span class="sd">            Tighten up plot to remove dead space [Default = True] </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tight</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># seems like tight_layout does not work with add_detector </span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot make tight&#39;</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
        <span class="n">plt_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;figure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plt_type</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> 
                                                             <span class="s1">&#39;png&#39;</span><span class="p">:</span> <span class="n">plt_file</span><span class="p">,</span>
                                                             <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                             <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                                                             <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                                                             <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">link</span><span class="p">}})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">plt_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">add_textblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[],</span> <span class="n">doc</span><span class="o">=</span><span class="p">[]):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a table to the report from the input pandas.DataFrame</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">       </span>
<span class="sd">        data : str or list</span>
<span class="sd">            input data</span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        text_type : str</span>
<span class="sd">            Name describing text type</span>

<span class="sd">        howto : list</span>
<span class="sd">            List of strings to describe howto make the table </span>

<span class="sd">        doc : str</span>
<span class="sd">            String to describe the table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="s1">&#39;Tables&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text_type</span><span class="p">:</span>
            <span class="n">text_type</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">catagory</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">text_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;textblock&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">text_type</span><span class="p">:</span> 
                                                   <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> 
                                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                                    <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                    <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span>

<div class="viewcode-block" id="Build_html.add_table"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_table.html#PyDataSource.Build_html.add_table">[docs]</a>    <span class="k">def</span> <span class="nf">add_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tbl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="p">[],</span> <span class="n">doc</span><span class="o">=</span><span class="p">[],</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a table to the report from the input pandas.DataFrame</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">       </span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            input Dataframe</span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>

<span class="sd">        tbl_type : str</span>
<span class="sd">            Name describing table type</span>

<span class="sd">        howto : list</span>
<span class="sd">            List of strings to describe howto make the table </span>

<span class="sd">        doc : str</span>
<span class="sd">            String to describe the table</span>

<span class="sd">        hidden : bool</span>
<span class="sd">            Optionally hide the table, only displaying the name given by tbl_type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="s1">&#39;Tables&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tbl_type</span><span class="p">:</span>
            <span class="n">tbl_type</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">catagory</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">tbl_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tbl_type</span><span class="p">:</span> 
                                                   <span class="p">{</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span> 
                                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                                    <span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">,</span> 
                                                    <span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="n">hidden</span><span class="p">,</span> 
                                                    <span class="s1">&#39;doc&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">}})</span></div>


<div class="viewcode-block" id="Build_html.add_summary"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_summary.html#PyDataSource.Build_html.add_summary">[docs]</a>    <span class="k">def</span> <span class="nf">add_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                        <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">max_columns</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                        <span class="n">plt_style</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">labelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">plot_axis_sums</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">pltsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                        <span class="n">nlines</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add summary for variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        variables : list</span>
<span class="sd">            List of attributes to be operated on.</span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>
<span class="sd">        </span>
<span class="sd">        bins : int</span>
<span class="sd">            Number of bins used in histograms [Default = 50]</span>

<span class="sd">        groupby : list</span>
<span class="sd">            Optionally group data by each attribute in groupby list</span>
<span class="sd">            Default is to use attibutes in scan_variables DataSet attrs.</span>

<span class="sd">        plot_axis_sums : bool</span>
<span class="sd">            Optionally make plots summing over each axis </span>

<span class="sd">        nlines : int</span>
<span class="sd">            For 2D data objects (plus time for three total dims),</span>
<span class="sd">            make line graphs instead of image plots if number of elements is</span>
<span class="sd">            less than nlines [Default = 16]</span>

<span class="sd">        codes : list</span>
<span class="sd">            List of event codes to cut on when making plots</span>

<span class="sd">        show : bool</span>
<span class="sd">            Optionally show plot instead of default of it being minimized</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan_variables&#39;</span><span class="p">,</span> <span class="p">[])</span> \
                            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;alias&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">catagory</span> <span class="o">=</span> <span class="n">alias</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>
            <span class="c1"># Make groupby plots</span>
            <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
                    <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Make groupby plots for&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                    <span class="n">xdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">x_group</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">24</span><span class="p">)]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;x_group = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].T.groupby(&#39;</span><span class="si">{:}</span><span class="s2">&#39;).mean(dim=&#39;time&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;setup&#39;</span><span class="p">:{</span><span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span>
 
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_group</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">x_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nlines</span><span class="p">:</span>
                            <span class="n">x_group</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">group</span><span class="p">)</span> 
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;x_group.plot()&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                            <span class="c1"># make scatter with groupby like in add_detector </span>
                            <span class="c1">#df = xdat.to_pandas().dropna()</span>
                            <span class="c1">#pltattrs = scat_attrs</span>
                            <span class="c1">#for group in groupby:</span>
                            <span class="c1">#    if group in pltattrs:</span>
                            <span class="c1">#        pltattrs.remove(group)</span>
                            <span class="c1">#    </span>
                            <span class="c1">#sns.set()</span>
                            <span class="c1">#plt.rcParams[&#39;axes.labelsize&#39;] = 10 </span>
                            <span class="c1">#g = sns.pairplot(dfcut, hue=group,</span>
                            <span class="c1">#        x_vars=pltattrs,y_vars=pltattrs,</span>
                            <span class="c1">#        #palette=&quot;Set1&quot;, </span>
                            <span class="c1">#        size=2.5) </span>
 
                            <span class="c1"># Not very interesting generally to have mean plots like this:</span>
                            <span class="c1">#plt.cla()</span>
                            <span class="c1">#x_group.to_pandas().T.plot()</span>
                            <span class="c1">#howto = []</span>
                            <span class="c1">#howto.append(&quot;x_group.to_pandas().T.plot()&quot;)</span>
                            <span class="c1">#howto.append(&quot;plt.show()&quot;)</span>
                            <span class="c1">#name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
                            <span class="c1">#plt_dim = x_group.dims[1]</span>
                            <span class="c1">#plt_type = &#39;summary_{:}_{:}&#39;.format(name, str(plt_dim)) </span>
                            <span class="c1">#self.add_plot(alias, plt_type, howto=howto)</span>
                            <span class="c1"># Instead Add pairplot next ..</span>
                            <span class="c1">#df = xdat.to_pandas()</span>
                            <span class="c1">#df[group] = xdat[group].to_pandas()</span>
                            <span class="c1">#g = sns.PairGrid(df, hue=group, diag_sharey=False)</span>
                            <span class="c1">#g.map_lower(sns.kdeplot, cmap=&quot;Blues_d&quot;)</span>
                            <span class="c1">#g.map_upper(plt.scatter)</span>
                            <span class="c1">#g.map_diag(sns.kdeplot, lw=3)</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_group</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">x_group</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nlines</span><span class="p">:</span>
                            <span class="n">plt_dim</span> <span class="o">=</span> <span class="n">x_group</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">ich</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_group</span><span class="p">[</span><span class="n">plt_dim</span><span class="p">]):</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                                <span class="n">x_group</span><span class="p">[:,</span><span class="n">ich</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                                <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;x_group[:,</span><span class="si">{:}</span><span class="s2">].to_pandas().T.plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ich</span><span class="p">))</span>
                                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;summary_</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plt_dim</span><span class="p">),</span> <span class="n">ich</span><span class="p">)</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">nax</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nax</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c1">#                self._xdat[attr].mean(axis=0).plot()</span>
    <span class="c1">#                plt_type = &#39;{:} summary&#39;.format(attr.lstrip(alias+&#39;_&#39;)) </span>
    <span class="c1">#                howto = [&quot;x[&#39;{:}&#39;].mean(axis=0).plot()&quot;.format(attr)]</span>
    <span class="c1">#                self.add_plot(alias, plt_type, howto=howto)</span>
                   
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nlines</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">plt_style</span><span class="p">)</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span> 
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].to_pandas().dropna()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df.plot(style=&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plt_style</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                            
                            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s1">&#39;histogram&#39;</span><span class="p">)</span> 
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].to_pandas().dropna()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df.plot.hist(bins=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bins</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>

                            <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">diag_sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues_d&quot;</span><span class="p">)</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">map_upper</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">)</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].to_pandas().dropna()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g = sns.PairGrid(df, diag_sharey=False)&#39;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_lower(sns.kdeplot, cmap=&quot;Blues_d&quot;)&#39;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_upper(plt.scatter)&#39;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;g.map_diag(sns.kdeplot, lw=3)&#39;</span><span class="p">)</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s1">&#39;scatter matrix&#39;</span><span class="p">)</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;scatter matrix plot failed for&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                        <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> with </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span> 
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">nax</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nlines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">plot_axis_sums</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">iaxis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nax</span><span class="p">):</span>
                                <span class="n">pltaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">iaxis</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                                <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum over </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">pltaxis</span><span class="p">)</span> 
                                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].mean(axis=0).plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">iaxis</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">pltaxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">iaxis</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum over </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">pltaxis</span><span class="p">)</span> 
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;].mean(axis=0).plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                    
                    <span class="k">elif</span> <span class="n">nax</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">codes</span><span class="p">:</span>
                        <span class="n">attr_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span> <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">attr_codes</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">xdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xdat</span><span class="p">[</span><span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                            <span class="n">pltaxis</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> summary for ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">code</span><span class="p">)</span> 
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xdat = x[&#39;</span><span class="si">{:}</span><span class="s2">&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = xdat.where(xdat[</span><span class="si">{:}</span><span class="s2">] == 1).to_pandas().dropna().mean(axis=0).T&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">)))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>

    <span class="c1">#                    plt_dim = xdat.dims[1]</span>
    <span class="c1">#                    for ich, ch in enumerate(xdat[plt_dim]):</span>
    <span class="c1">#                        plt.cla()</span>
    <span class="c1">#                        xdat[:,ich].to_pandas().T.plot()</span>
    <span class="c1">#                        howto = []</span>
    <span class="c1">#                        howto.append(&quot;xdat.squeeze(&#39;steps&#39;)[:,{:}].to_pandas().T.plot()&quot;.format(ich))</span>
    <span class="c1">#                        howto.append(&quot;plt.show()&quot;)</span>
    <span class="c1">#                        name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
    <span class="c1">#                        plt_type = &#39;summary_{:}_{:}_{:}&#39;.format(name, str(plt_dim), ich) </span>
    <span class="c1">#                        self.add_plot(alias, plt_type, howto=howto)</span>
    <span class="c1">#</span>

<span class="c1">#### Moved to add_stats method</span>
<span class="c1">#            if len(self._xdat[attr].shape) == 4 and &#39;codes&#39; in self._xdat[attr]:</span>
<span class="c1">#                xdat = self._xdat[attr]</span>
<span class="c1">#                attr_codes = None</span>
<span class="c1">#                if codes:</span>
<span class="c1">#                    attr_codes = codes</span>
<span class="c1">#                elif hasattr(self, &#39;eventStats&#39;):</span>
<span class="c1">#                    try:</span>
<span class="c1">#                        tbl = self.eventStats.T.get(alias+&#39;_events&#39;)</span>
<span class="c1">#                        if tbl is not None:</span>
<span class="c1">#                            attr_codes = [c for c,n in tbl.to_dict().items() if n &gt; 0]</span>
<span class="c1">#                    except:</span>
<span class="c1">#                        print &#39;WARNING: Need to fix auto getting attr_codes&#39;</span>
<span class="c1">#                </span>
<span class="c1">#                if not attr_codes:</span>
<span class="c1">#                    if &#39;codes&#39; in self._xdat:</span>
<span class="c1">#                        attr_codes = self._xdat.codes.values</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        attr_codes = [140]</span>
<span class="c1">#                else:</span>
<span class="c1">#                    attr_codes = [code for code in attr_codes if code in self._xdat.codes.values]</span>
<span class="c1">#</span>
<span class="c1">#                print &#39;det_summary&#39;, attr, attr_codes</span>
<span class="c1">#</span>
<span class="c1">#                if self.nsteps &lt; max_columns**2:</span>
<span class="c1">#                    ncolumns = int(sqrt(self.nsteps))</span>
<span class="c1">#                else:</span>
<span class="c1">#                    ncolumns = int(min([self.nsteps,max_columns]))</span>
<span class="c1">#                    </span>
<span class="c1">#                nrows = int(np.ceil(self.nsteps/float(ncolumns)))</span>
<span class="c1">#                </span>
<span class="c1">#                if not labelsize:</span>
<span class="c1">#                    if ncolumns &gt; 9:</span>
<span class="c1">#                        labelsize = 12</span>
<span class="c1">#                    elif ncolumns &gt; 5:</span>
<span class="c1">#                        labelsize = 18</span>
<span class="c1">#                    else:</span>
<span class="c1">#                        labelsize = 24</span>
<span class="c1">#</span>
<span class="c1">#                if not layout:</span>
<span class="c1">#                    layout = (nrows,ncolumns)</span>
<span class="c1">#                if not figsize:</span>
<span class="c1">#                    figsize = (ncolumns*4,nrows*4)</span>
<span class="c1">#                </span>
<span class="c1">#                plt.rcParams[&#39;axes.labelsize&#39;] = 24 </span>
<span class="c1">#                howto = [&quot;plt.rcParams[&#39;axes.labelsize&#39;] = {:}&quot;.format(24)]</span>
<span class="c1">#                howto.append(&quot;attr = &#39;{:}&#39;&quot;.format(attr))</span>
<span class="c1">#                howto.append(&quot;xdat = x[attr]&quot;)</span>
<span class="c1">#                self.results[alias][&#39;text&#39;].update({&#39;setup&#39;:{&#39;howto&#39;: howto}})</span>
<span class="c1">#</span>
<span class="c1">#                # Need to fix errors calculation with std and plot with error bars</span>
<span class="c1">#                #fig, ax = plt.subplots()</span>
<span class="c1">#                #errors = sqrt(self._xdat[attr].sum(axis=(2,3)).to_pandas()**2)</span>
<span class="c1">#                #df.plot(yerr=errors, ax=ax)</span>
<span class="c1">#</span>
<span class="c1">#                if self.ncodes &gt; 4:</span>
<span class="c1">#                    col_wrap = int(min([self.ncodes,3]))</span>
<span class="c1">#                    aspect = 0.9</span>
<span class="c1">#                elif self.ncodes == 4:</span>
<span class="c1">#                    col_wrap = 2</span>
<span class="c1">#                    aspect = 0.9</span>
<span class="c1">#                else:</span>
<span class="c1">#                    col_wrap = 1</span>
<span class="c1">#                    aspect = 0.9</span>
<span class="c1">#                </span>
<span class="c1">#                if self.nsteps == 1:</span>
<span class="c1">#                    if wrap:</span>
<span class="c1">#                        howto = []</span>
<span class="c1">#                        df = xdat.squeeze(&#39;steps&#39;)</span>
<span class="c1">#                        howto.append(&quot;df = xdat.squeeze(&#39;steps&#39;)&quot;)</span>
<span class="c1">#                        if self.ncodes == 1:</span>
<span class="c1">#                            df.squeeze(&#39;codes&#39;).plot(robust=True)</span>
<span class="c1">#                            howto.append(&quot;df.squeeze(&#39;codes&#39;).plot()&quot;)</span>
<span class="c1">#                            howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                        else:</span>
<span class="c1">#                            df.plot(col=&#39;codes&#39;, col_wrap=col_wrap, size=20, aspect=aspect, robust=True)</span>
<span class="c1">#                            howto.append(&quot;df.plot(col=&#39;codes&#39;, col_wrap={:})&quot;.format(col_wrap))</span>
<span class="c1">#                            howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                        name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                        plt_type = &#39;summary_{:}&#39;.format(name) </span>
<span class="c1">#                        self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#                        </span>
<span class="c1">#                    else:</span>
<span class="c1">#                        if xdat.shape[2] &gt; 8: </span>
<span class="c1">#                            for code in attr_codes:</span>
<span class="c1">#                                plt.cla()</span>
<span class="c1">#                                plt.figure(figsize=(16,14))</span>
<span class="c1">#                                xdat.squeeze(&#39;steps&#39;).sel(codes=code).plot(robust=True,size=pltsize,aspect=&#39;equal&#39;)</span>
<span class="c1">#                                howto = []</span>
<span class="c1">#                                howto.append(&#39;plt.figure(figsize=(16,14))&#39;)</span>
<span class="c1">#                                howto.append(&quot;xdat.squeeze(&#39;steps&#39;).sel(codes={:}).plot(robust=True,size={:}aspect=&#39;equal&#39;)&quot;.format(code, pltsize))</span>
<span class="c1">#                                howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                                name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                                plt_type = &#39;summary_{:}_ec{:}&#39;.format(name, code) </span>
<span class="c1">#                                self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#                        else:</span>
<span class="c1">#                            for code in attr_codes:</span>
<span class="c1">#                                plt.cla()</span>
<span class="c1">#                                xdat.squeeze(&#39;steps&#39;).sel(codes=code).to_pandas().T.plot()</span>
<span class="c1">#                                howto = []</span>
<span class="c1">#                                howto.append(&quot;xdat.squeeze(&#39;steps&#39;).sel(codes={:}).to_pandas().T.plot()&quot;.format(code))</span>
<span class="c1">#                                howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                                name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                                plt_type = &#39;summary_{:}_ec{:}&#39;.format(name, code) </span>
<span class="c1">#                                self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#                           </span>
<span class="c1">#                            plt_dim = xdat.dims[2]</span>
<span class="c1">#                            for ich, ch in enumerate(xdat[plt_dim]):</span>
<span class="c1">#                                plt.cla()</span>
<span class="c1">#                                xdat.squeeze(&#39;steps&#39;)[:,ich].to_pandas().T.plot()</span>
<span class="c1">#                                howto = []</span>
<span class="c1">#                                howto.append(&quot;xdat.squeeze(&#39;steps&#39;)[:,{:}].to_pandas().T.plot()&quot;.format(ich))</span>
<span class="c1">#                                howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                                name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                                plt_type = &#39;summary_{:}_{:}_{:}&#39;.format(name, str(plt_dim), ich) </span>
<span class="c1">#                                self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#                else:</span>
<span class="c1">#                    # plot mean of image vs steps for each event code</span>
<span class="c1">#                    df = xdat.sum(axis=(2,3)).to_pandas()</span>
<span class="c1">#                    df.plot(subplots=True)</span>
<span class="c1">#                   </span>
<span class="c1">#                    howto = []</span>
<span class="c1">#                    howto.append(&quot;df = xdat.sum(axis=(2,3)).to_pandas()&quot;)</span>
<span class="c1">#                    howto.append(&quot;df.plot(subplots=True)&quot;)</span>
<span class="c1">#                    howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                    name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                    plt_type = &#39;scan_{:}_summary&#39;.format(name) </span>
<span class="c1">#                    self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#     </span>
<span class="c1">#                    for iaxis in [2,3]:</span>
<span class="c1">#                        df = xdat.mean(axis=iaxis)</span>
<span class="c1">#                        </span>
<span class="c1">#                        howto = [&quot;plt.rcParams[&#39;axes.labelsize&#39;] = 24&quot;]</span>
<span class="c1">#                        howto.append(&quot;df = xdat.mean(axis={:}).to_pandas()&quot;.format(iaxis))</span>
<span class="c1">#                        if self.ncodes == 1:</span>
<span class="c1">#                            df.squeeze(&#39;codes&#39;).plot(robust=True)</span>
<span class="c1">#                            howto.append(&quot;df.squeeze(&#39;codes&#39;).plot(robust=True)&quot;)</span>
<span class="c1">#                            howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                        else:</span>
<span class="c1">#                            df.plot(col=&#39;codes&#39;, col_wrap=col_wrap, size=20, aspect=aspect, robust=True)</span>
<span class="c1">#                            sformat = &quot;df.plot(col=&#39;codes&#39;, col_wrap={:}, size=20, aspect={:}, robust=True)&quot;</span>
<span class="c1">#                            howto.append(sformat.format(col_wrap, aspect))</span>
<span class="c1">#                            howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                        name = df.dims[2].replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                        plt_type = &#39;scan_vs_{:}&#39;.format(name) </span>
<span class="c1">#                        self.add_plot(alias, plt_type, howto=howto)</span>
<span class="c1">#</span>
<span class="c1">#                    plt.rcParams[&#39;axes.labelsize&#39;] = labelsize</span>
<span class="c1">#                    for code in self._xdat[attr].codes.values:</span>
<span class="c1">#                        df = xdat.sel(codes=code)</span>
<span class="c1">#                        df.plot(col=&#39;steps&#39;, col_wrap=ncolumns, robust=True)</span>
<span class="c1">#                        </span>
<span class="c1">#                        howto = [&quot;plt.rcParams[&#39;axes.labelsize&#39;] = {:}&quot;.format(labelsize)]</span>
<span class="c1">#                        howto.append(&quot;df = xdat.sel(codes={:})&quot;.format(code))</span>
<span class="c1">#                        howto.append(&quot;df.plot(col=&#39;steps&#39;, col_wrap={:})&quot;.format(ncolumns))</span>
<span class="c1">#                        name = attr.replace(alias+&#39;_&#39;,&#39;&#39;)</span>
<span class="c1">#                        plt_type = &#39;scan_{:}_2D_ec{:}&#39;.format(name, str(code)) </span>
<span class="c1">#                        self.add_plot(alias, plt_type, howto=howto)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span></div>

<div class="viewcode-block" id="Build_html.add_stats"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.add_stats.html#PyDataSource.Build_html.add_stats">[docs]</a>    <span class="k">def</span> <span class="nf">add_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">],</span>
                        <span class="n">catagory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">make_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">max_columns</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">labelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">pltsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                        <span class="n">nlines</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add detector stats plots</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute to make stats summary plots.</span>

<span class="sd">        catagory : str</span>
<span class="sd">            Plot catagory for organization in html page [Default = alias]</span>
<span class="sd">       </span>
<span class="sd">        stats : list</span>
<span class="sd">            List of stats for making plots.  Default = [&#39;mean&#39;, &#39;std&#39;, &#39;max&#39;]  </span>

<span class="sd">        nlines : int</span>
<span class="sd">            For 2D data objects (plus time for three total dims),</span>
<span class="sd">            make line graphs instead of image plots if number of elements is</span>
<span class="sd">            less than nlines [Default = 16]</span>

<span class="sd">        codes : list</span>
<span class="sd">            List of event codes to cut on when making plots</span>

<span class="sd">        make_images : bool</span>
<span class="sd">            Make 2D plots of waveforms vs step</span>

<span class="sd">        show : bool</span>
<span class="sd">            Optionally show plot instead of default of it being minimized</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">:</span>
            <span class="n">xdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;add_stats only valid for objects with dimensions (&#39;stat&#39;,&#39;step&#39;,&#39;codes&#39;, xdim, ydim)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No stats available for&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s1">&#39;alias&#39;</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">alias</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">catagory</span><span class="p">:</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39; Stats&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>

        <span class="n">attr_codes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">codes</span><span class="p">:</span>
            <span class="n">attr_codes</span> <span class="o">=</span> <span class="n">codes</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;eventStats&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventStats</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_events&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attr_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Need to fix auto getting attr_codes&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_codes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;codes&#39;</span> <span class="ow">in</span> <span class="n">xdat</span><span class="p">:</span>
                <span class="n">attr_codes</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr_codes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">140</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attr_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">attr_codes</span> <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span> 
        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">24</span><span class="p">)]</span>
        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attr = &#39;</span><span class="si">{:}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xdat = x[attr]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">catagory</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;setup&#39;</span><span class="p">:{</span><span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xstat</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span>
                <span class="n">howto0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xstat = xdat.sel(stat=&#39;</span><span class="si">{:}</span><span class="s2">&#39;).squeeze(&#39;steps&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="p">)]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">stat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="n">xstat</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span>
                    <span class="n">howto0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xstat = xdat.sel(stat=&#39;</span><span class="si">{:}</span><span class="s2">&#39;).sum(dim=&#39;steps&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="p">)]</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; sum_over_steps&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xstat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># make images</span>
                <span class="kn">from</span> <span class="nn">h5write</span> <span class="k">import</span> <span class="n">make_image</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xcodes</span> <span class="o">=</span> <span class="n">xstat</span><span class="o">.</span><span class="n">codes</span>
                    <span class="n">xstat</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">make_image</span><span class="p">(</span><span class="n">xstat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">codes</span><span class="o">=</span><span class="n">code</span><span class="p">))</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">xstat</span><span class="o">.</span><span class="n">codes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;codes&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xstat</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                        <span class="n">xstat</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;codes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcodes</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot make image&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
                    <span class="k">continue</span>

           <span class="c1">#print &#39;det_summary&#39;, attr, attr_codes, stat</span>

           <span class="c1"># Need to fix errors calculation with std and plot with error bars</span>
            <span class="c1">#fig, ax = plt.subplots()</span>
            <span class="c1">#errors = sqrt(self._xstat[attr].sum(axis=(2,3)).to_pandas()**2)</span>
            <span class="c1">#df.plot(yerr=errors, ax=ax)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">col_wrap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">aspect</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">col_wrap</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">aspect</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col_wrap</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">aspect</span> <span class="o">=</span> <span class="mf">0.9</span>
            
            <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="n">howto0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xstat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat.squeeze(&#39;codes&#39;).plot()&quot;</span><span class="p">)</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xstat</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;codes&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pltsize</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat.plot(col=&#39;codes&#39;, col_wrap=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_wrap</span><span class="p">))</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>

                <span class="c1">#plt.tight_layout()</span>
                <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xstat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nlines</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;doing image&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">attr_codes</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                        <span class="c1">#plt.figure(figsize=(16,14))</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1">#ax = xstat.sel(codes=code).reset_coords()[attr].plot(robust=True, size=pltsize)</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">xstat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">codes</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pltsize</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
                            <span class="c1">#plt.tight_layout()</span>
                            <span class="n">howto</span> <span class="o">=</span> <span class="n">howto0</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;plt.figure(figsize=(16,14))&#39;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat.sel(codes=</span><span class="si">{:}</span><span class="s2">).plot(robust=True, size=</span><span class="si">{:}</span><span class="s2">, aspect=True)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pltsize</span><span class="p">))</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">xstat</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">attr_codes</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                        <span class="n">xstat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">codes</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="n">howto0</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat.sel(codes=</span><span class="si">{:}</span><span class="s2">).to_pandas().T.plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                        <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;summary_</span><span class="si">{:}</span><span class="s1">_ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                  
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr_codes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">plt_dim</span> <span class="o">=</span> <span class="n">xstat</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ich</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xstat</span><span class="p">[</span><span class="n">plt_dim</span><span class="p">]):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">ich</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">xstat</span><span class="p">[:,</span><span class="n">ich</span><span class="p">,:]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat[:,</span><span class="si">{:}</span><span class="s2">].to_pandas().T.plot()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ich</span><span class="p">))</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">plt_dim</span><span class="p">),</span> <span class="n">ich</span><span class="p">)</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nlines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smart waveforms&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">&lt;</span> <span class="n">max_columns</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span><span class="n">max_columns</span><span class="p">]))</span>
                
            <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">)))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">labelsize</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ncolumns</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="k">elif</span> <span class="n">ncolumns</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">18</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">24</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">layout</span><span class="p">:</span>
                <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncolumns</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">figsize</span><span class="p">:</span>
                <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncolumns</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">nrows</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="c1"># plot mean of image vs steps for each event code</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">xdat</span><span class="p">)</span>
            <span class="n">sumaxes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">sumaxes</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="c1">#plt.tight_layout()</span>
            <span class="c1">#df.plot(subplots=True)</span>

            <span class="n">howto</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = xdat.sel(stat=&#39;mean&#39;).sum(axis=(2,3)).to_pandas()&quot;</span><span class="p">)</span>
            <span class="c1">#howto.append(&quot;df.plot(subplots=True)&quot;)</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df.plot()&quot;</span><span class="p">)</span>
            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;scan_</span><span class="si">{:}</span><span class="s1">_summary&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># need to handle CsPad calib data as images and radial/azimuth projections</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iaxis</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span>
                    <span class="c1">#plt.tight_layout()</span>
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = 24&quot;</span><span class="p">]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da = xdat.sel(stat=&#39;mean&#39;).mean(axis=&#39;</span><span class="si">{:}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iaxis</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">da</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da.squeeze(&#39;codes&#39;).plot(robust=True)&quot;</span><span class="p">)</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;codes&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pltsize</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">sformat</span> <span class="o">=</span> <span class="s2">&quot;da.plot(col=&#39;codes&#39;, col_wrap=</span><span class="si">{:}</span><span class="s2">, size=</span><span class="si">{:}</span><span class="s2">, aspect=</span><span class="si">{:}</span><span class="s2">, robust=True)&quot;</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">pltsize</span><span class="p">,</span> <span class="n">aspect</span><span class="p">))</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>

                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> scan_vs_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">da</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                        <span class="c1">#plt.tight_layout()</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da.sum(dim=&#39;steps&#39;).squeeze(&#39;codes&#39;).plot()&quot;</span><span class="p">)</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>

                        <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> sum over steps vs </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot squeeze codes for plot over steps&#39;</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">make_images</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labelsize</span>
                <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">xdat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">codes</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">ncolumns</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1">#plt.tight_layout()</span>
                    
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labelsize</span><span class="p">)]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da = xdat.sel(stat=&#39;mean&#39;).sel(codes=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da.plot(col=&#39;steps&#39;, col_wrap=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">))</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> 2D each step for ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>  <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">xstat</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;steps&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xstat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nlines</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">attr_codes</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">14</span><span class="p">))</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">xstat</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">codes</span><span class="o">=</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                    <span class="c1">#plt.tight_layout()</span>

                    <span class="n">howto</span> <span class="o">=</span> <span class="n">howto0</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;plt.figure(figsize=(16,14))&#39;</span><span class="p">)</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = xstat.sel(codes=</span><span class="si">{:}</span><span class="s2">).to_pandas()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df.plot()&quot;</span><span class="p">)</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1">#                if xstat.shape[1] &gt; 1 and xstat.shape[0] &gt; 1:</span>
<span class="c1">#                    for ich in </span>
<span class="c1">#                        plt.cla()</span>
<span class="c1">#                        plt.figure(figsize=(16,14))</span>
<span class="c1">#                        xstat.sel(codes=code).plot()</span>
<span class="c1">#</span>
<span class="c1">#                        howto = howto0</span>
<span class="c1">#                        howto.append(&#39;plt.figure(figsize=(16,14))&#39;)</span>
<span class="c1">#                        howto.append(&quot;xstat.sel(codes={:}).plot(robust=True, size={:}, aspect=True)&quot;.format(code, size))</span>
<span class="c1">#                        howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#                        plt_type = &#39;{:}_ec{:}&#39;.format(name, code) </span>
<span class="c1">#                        self.add_plot(catagory, plt_type, howto=howto)</span>
     
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iaxis</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="n">xstat</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> scan_vs_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = 24&quot;</span><span class="p">]</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xstat = xdat.sel(stat=&#39;mean&#39;).squeeze(&#39;steps&#39;)&quot;</span><span class="p">)</span>
                        <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da = xstat.mean(axis=</span><span class="si">{:}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iaxis</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncodes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">da</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;codes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pltsize</span><span class="p">)</span>
                            <span class="c1">#plt.tight_layout()</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;da.squeeze(&#39;codes&#39;).plot()&quot;</span><span class="p">)</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;df = da.to_pandas().T.plot()&#39;</span><span class="p">)</span>
                            <span class="c1">#df.plot(subplots=True, layout=(self.ncodes,1), figsize=(self.ncodes*6,10))</span>
                            <span class="c1">#sformat = &quot;da.plot(col=&#39;codes&#39;, col_wrap={:}, size={:})&quot;</span>
                            <span class="c1">#plt.tight_layout()</span>
                            <span class="c1">#howto.append(sformat.format(col_wrap, pltsize, aspect))</span>
                            <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot add &#39;</span><span class="p">,</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">)</span>
    <span class="c1">#</span>
<span class="c1">#                da.squeeze(&#39;codes&#39;).to_pandas().plot()</span>
<span class="c1">#                howto.append(&quot;da.squeeze(&#39;codes&#39;).plot()&quot;)</span>
<span class="c1">#                howto.append(&quot;plt.show()&quot;)</span>
<span class="c1">#</span>
<span class="c1">#                plt_type = &#39;{:} sum over steps vs {:}&#39;.format(name, da.dims[1]) </span>
<span class="c1">#                self.add_plot(catagory, plt_type, howto=howto)</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">max_columns</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">nmax_events</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">pltsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">labelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                        <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add every event of variables.</span>
<span class="sd">        </span>
<span class="sd">        variables : list</span>
<span class="sd">            List of attributes to be operated on.</span>

<span class="sd">        show : bool</span>
<span class="sd">            Optionally show plot instead of default of it being minimized</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;event_variables&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">event_variables</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span>
            <span class="n">catagory</span> <span class="o">=</span> <span class="n">alias</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_catagory</span><span class="p">(</span><span class="n">catagory</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                <span class="n">xdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">itimes</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ec</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">eventCode</span><span class="p">))</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">xdat</span><span class="o">.</span><span class="n">isel_points</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">itimes</span><span class="p">)</span>
                <span class="c1">#cut = [i for i,a in enumerate(self._xdat[attr][:,0,0].values) if isfinite(a)]</span>
               
                <span class="n">nevents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nevents</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ncolumns</span> <span class="o">=</span> <span class="mi">2</span> 
                <span class="k">elif</span> <span class="n">nevents</span> <span class="o">&lt;</span> <span class="n">max_columns</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nevents</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ncolumns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">nevents</span><span class="p">,</span><span class="n">max_columns</span><span class="p">]))</span>
                    
                <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nevents</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">)))</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">labelsize</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ncolumns</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                        <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">12</span>
                    <span class="k">elif</span> <span class="n">ncolumns</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">18</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">24</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">layout</span><span class="p">:</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncolumns</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">figsize</span><span class="p">:</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncolumns</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">nrows</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
 
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
                
                <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plt.rcParams[&#39;axes.labelsize&#39;] = 24&quot;</span><span class="p">]</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attr = [&#39;</span><span class="si">{:}</span><span class="s2">&#39;]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;xdat = x[attr]&quot;</span><span class="p">)</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;itimes = xdat.groupby(&#39;ec</span><span class="si">{:}</span><span class="s2">&#39;).groups[1]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xdat</span><span class="o">.</span><span class="n">eventCode</span><span class="p">))</span>
                <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;df = xdat.isel_points(time=itimes)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;begin&#39;</span><span class="p">:{</span><span class="s1">&#39;howto&#39;</span><span class="p">:</span> <span class="n">howto</span><span class="p">}})</span>
                <span class="k">if</span> <span class="n">nevents</span> <span class="o">&lt;=</span> <span class="n">nmax_events</span><span class="p">:</span>
                    <span class="c1">#plt.rcParams[&#39;axes.labelsize&#39;] = labelsize</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">ncolumns</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pltsize</span><span class="p">)</span>
                    
                    <span class="c1">#howto = [&quot;plt.rcParams[&#39;axes.labelsize&#39;] = {:}&quot;.format(labelsize)]</span>
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df.plot(col=&#39;points&#39;, col_wrap=</span><span class="si">{:}</span><span class="s2">, robust=True)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncolumns</span><span class="p">)]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;events_</span><span class="si">{:}</span><span class="s1">_2D&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">iaxis</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">iaxis</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;df.mean(axis=</span><span class="si">{:}</span><span class="s2">).plot(robust=True)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iaxis</span><span class="p">)]</span>
                    <span class="n">howto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;plt.show()&quot;</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">iaxis</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">plt_type</span> <span class="o">=</span> <span class="s1">&#39;events_vs_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">plt_type</span><span class="p">,</span> <span class="n">howto</span><span class="o">=</span><span class="n">howto</span><span class="p">)</span>
                           
<span class="c1"># Methods to build html file</span>

<div class="viewcode-block" id="Build_html.to_html"><a class="viewcode-back" href="../../generated/PyDataSource.Build_html.to_html.html#PyDataSource.Build_html.to_html">[docs]</a>    <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out html file</span>
<span class="sd">       </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>

<span class="sd">        quiet : bool</span>
<span class="sd">            Suppress stdout comments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_html</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_html</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_html</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing html to: &#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">output_file</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_init_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize html page.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        path : str</span>
<span class="sd">            Output path of report</span>
<span class="sd">       </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_output</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">subtitle</span><span class="p">:</span>
            <span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39;Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">output_html</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">subtitle</span><span class="p">,</span> 
                 <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                 <span class="n">css</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;css/bootstrap.min.css&#39;</span><span class="p">,</span><span class="s1">&#39;jumbotron-narrow.css&#39;</span><span class="p">,</span><span class="s1">&#39;css/mine.css&#39;</span><span class="p">),</span>
                 <span class="n">script</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;js/ie-emulation-modes-warning.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/jquery.min.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/toggler.js&#39;</span><span class="p">,</span><span class="s1">&#39;js/sticky.js&#39;</span><span class="p">),</span>
                 <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_block</span><span class="p">(</span><span class="s1">&#39;Data Summary&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
        <span class="c1">#self.html.start_subblock(&#39;Data Information&#39;,id=&#39;datatime&#39;)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">begin_time</span> <span class="o">=</span> <span class="n">event_times</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">event_times</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
            <span class="n">minutes</span><span class="p">,</span><span class="n">fracseconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">run_time</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>

            <span class="n">sformat</span> <span class="o">=</span> <span class="s1">&#39;Start Time: </span><span class="si">{:}</span><span class="s1">&lt;br/&gt;End Time: </span><span class="si">{:}</span><span class="s1">&lt;br/&gt;Duration: </span><span class="si">{:}</span><span class="s1"> seconds (</span><span class="si">{:02.0f}</span><span class="s1">:</span><span class="si">{:02.0f}</span><span class="s1">)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Total events: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="n">sformat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">begin_time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span> <span class="n">end_time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span> <span class="n">run_time</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span><span class="n">fracseconds</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_nfile&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Total files: </span><span class="si">{:}</span><span class="s1">&lt;br/&gt;Total bytes: </span><span class="si">{:}</span><span class="s1"> (</span><span class="si">{:0.1f}</span><span class="s1"> GB)&lt;br/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_nfile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nbytes</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nbytes</span><span class="o">/</span><span class="p">(</span><span class="mf">1000.</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Report time: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="c1">#self.html.end_subblock()</span>

        <span class="k">if</span> <span class="s1">&#39;h5file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_h5file_html</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1">#self._make_h5file_html(kwargs[&#39;h5file&#39;], report_notes=kwargs.get(&#39;report_notes&#39;))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_PyDataSource_html</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_block</span><span class="p">()</span>         
 
    <span class="k">def</span> <span class="nf">_make_h5file_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">report_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">,</span> 
            <span class="n">show_event_access</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make html notes for accessing hdf5 file (using netCDF format) in xarray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h5file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Must pass h5file keyword&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">report_notes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_notes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">report_notes</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
            <span class="nb">print</span> <span class="n">report_notes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Report Notes&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Access the Data&#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Analyze run summary data on a psana node using pylab, pandas and xarray:&#39;</span><span class="p">)</span>
        <span class="n">conda_setup</span> <span class="o">=</span> <span class="s1">&#39;. /reg/g/psdm/etc/psconda.sh&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> 
                                           <span class="s1">&#39;ipython --pylab&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;...&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;import xarray as xr&#39;</span><span class="p">,</span> 
                                           <span class="s1">&#39;x = xr.open_dataset(&quot;</span><span class="si">{:}</span><span class="s1">&quot;, engine=&quot;</span><span class="si">{:}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h5file</span><span class="p">,</span> <span class="n">engine</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">),</span> 
                <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;View of RunSummary data with xarray python package &#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://xarray.pydata.org&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;See &lt;a href=&quot;</span><span class="si">{:}</span><span class="s1">&quot;&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt; for details on how to use data using xarray.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span><span class="n">weblink</span><span class="p">))</span>
<span class="c1">#        weblink=&#39;http://pswww.slac.stanford.edu/swdoc/ana/PyDataSource&#39;</span>
<span class="c1">#        self.html.page.p(&#39;See &lt;a href=&quot;{:}&quot;&gt;{:}&lt;/a&gt; for details on how to use PyDataSource.&#39;.format(weblink,weblink))</span>
        <span class="k">if</span> <span class="n">show_event_access</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Access event data with PyDataSource python module on a psana node:&#39;</span><span class="p">)</span>
            <span class="n">conda_setup</span> <span class="o">=</span> <span class="s1">&#39;. /reg/g/psdm/etc/psconda.sh&#39;</span>
            <span class="n">idatasource</span> <span class="o">=</span> <span class="s1">&#39;idatasource --exp </span><span class="si">{:}</span><span class="s1"> --run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span> 
            <span class="c1">#self.html.add_textblock(&#39;\n&#39;.join([ana_env, idatasource]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> <span class="n">idatasource</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Where idatasource is a shortcut for starting ipython and loading the event data:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> 
                                               <span class="s1">&#39;ipython --pylab&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;...&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;import PyDataSource&#39;</span><span class="p">,</span> 
                                               <span class="s1">&#39;ds = PyDataSource.DataSource(exp=&quot;</span><span class="si">{:}</span><span class="s1">&quot;,run=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)]))</span>
     

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;For questions and feedback contact koglin@slac.stanford.edu&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">_make_PyDataSource_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make html notes for accessing data with PyDataSource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">PyDataSource</span>

        <span class="k">if</span> <span class="n">report_notes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_notes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">report_notes</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Report Notes&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">report_notes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="s1">&#39;Access the Data&#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Access event data with PyDataSource python module on a psana node:&#39;</span><span class="p">)</span>
        <span class="n">conda_setup</span> <span class="o">=</span> <span class="s1">&#39;. /reg/g/psdm/etc/psconda.sh&#39;</span>
        <span class="n">idatasource</span> <span class="o">=</span> <span class="s1">&#39;idatasource --exp </span><span class="si">{:}</span><span class="s1"> --run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span> 
        <span class="c1">#self.html.add_textblock(&#39;\n&#39;.join([ana_env, idatasource]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> <span class="n">idatasource</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Where idatasource is a shortcut for starting ipython and loading the event data:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> 
                                           <span class="s1">&#39;ipython --pylab&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;...&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;import PyDataSource&#39;</span><span class="p">,</span> 
                                           <span class="s1">&#39;ds = PyDataSource.DataSource(exp=&quot;</span><span class="si">{:}</span><span class="s1">&quot;,run=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pyds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">PyDataSource</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pyds</span> <span class="o">=</span> <span class="n">PyDataSource</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">pyds</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span> 
                <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;HowTo access event data with PyDataSource python package&#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;Analyze run summary data on a psana node using pylab, pandas and xarray:&#39;</span><span class="p">)</span>
<span class="c1">#        ixarray = &#39;ixarray --exp {:} --run {:}&#39;.format(self.exp, self.run)</span>
<span class="c1">#        self.html.add_textblock(&#39;\n&#39;.join([conda_setup, ixarray]))</span>
<span class="c1">#        self.html.page.p(&#39;Where ixarray is a shortcut for starting ipython and loading the data summary:&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">conda_setup</span><span class="p">,</span> 
                                           <span class="s1">&#39;ipython --pylab&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;...&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;import PyDataSource&#39;</span><span class="p">,</span> 
                                           <span class="s1">&#39;x = PyDataSource.open_h5netcdf(exp=&quot;</span><span class="si">{:}</span><span class="s1">&quot;,run=</span><span class="si">{:}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xdat</span><span class="p">),</span> 
                <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;View of RunSummary data with xarray python package &#39;</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://pswww.slac.stanford.edu/swdoc/ana/PyDataSource&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;See &lt;a href=&quot;</span><span class="si">{:}</span><span class="s1">&quot;&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt; for details on how to use PyDataSource.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span><span class="n">weblink</span><span class="p">))</span>
        <span class="n">weblink</span><span class="o">=</span><span class="s1">&#39;http://xarray.pydata.org&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;See &lt;a href=&quot;</span><span class="si">{:}</span><span class="s1">&quot;&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt; for details on how to use data using xarray.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weblink</span><span class="p">,</span><span class="n">weblink</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;HDF5 summary file (using netCDF format) located at:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;For questions and feedback contact koglin@slac.stanford.edu&#39;</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">_add_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_caption</span><span class="o">=</span><span class="s1">&#39;Hover to highlight.&#39;</span><span class="p">,</span> <span class="n">show_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add html pages for results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cat_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">catagory</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cat_items</span><span class="p">:</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_block</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> Data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">),</span> <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
            <span class="n">ahowto</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;figure&#39;</span><span class="p">]:</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# For interactive plotting -- plt.ioff() to turn off interactive plotting.&#39;</span><span class="p">)</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;plt.ion()&#39;</span><span class="p">)</span>
                <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;# Alternatively make plt.show() after each plot and close window to make next&#39;</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">catagory</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;table&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
            <span class="c1">#for name, data in item[datatyp].items():</span>
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto make the </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">):</span>
                    <span class="n">formatters</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">format</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">formatterstr</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span><span class="o">+</span><span class="s1">&#39;.format&#39;</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formatters</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="n">dfname</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">show_attrs</span><span class="p">:</span>
                        <span class="n">hidden</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hidden</span> <span class="o">=</span> <span class="kc">True</span>
                   
                    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">formatters</span><span class="p">:</span>
                        <span class="n">dfstr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">justify</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">formatters</span><span class="o">=</span><span class="n">formatters</span><span class="p">)</span>
                        <span class="c1">#if dfname:</span>
                        <span class="c1">#    howto_step += &#39;\n# to reprsent with formatting&#39;</span>
                        <span class="c1">#    howto_step += &quot;\nprint {:}.to_string(justify=&#39;left&#39;,formatters={:})&quot;.format(dfname, formatterstr)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        <span class="c1">#if dfname:</span>
                        <span class="c1">#    howto_step += &quot;\n print {:}&quot;.format(dfname)</span>
                    
                    <span class="k">if</span> <span class="n">howto_step</span><span class="p">:</span>
                        <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">dfstr</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> 
                            <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">datatyp</span><span class="p">),</span> 
                            <span class="n">hidden</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
                    
                    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;figure&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
            <span class="c1">#for name, data in item[datatyp].items():</span>
                <span class="n">png</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
                <span class="n">subname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">png</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">start_subblock</span><span class="p">(</span><span class="n">subname</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="s1">&#39;&lt;a href=</span><span class="si">{:}</span><span class="s1">&gt;</span><span class="si">{:}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">a</span><span class="p">(</span> <span class="n">markup</span><span class="o">.</span><span class="n">oneliner</span><span class="o">.</span><span class="n">img</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">png</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;width:100%;&#39;</span><span class="p">),</span> 
                            <span class="n">href</span><span class="o">=</span><span class="n">png</span> <span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">p</span><span class="p">(</span><span class="s1">&#39;&lt;pre&gt;</span><span class="si">{:}</span><span class="s1">&lt;/pre&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                   
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_subblock</span><span class="p">(</span><span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
                <span class="n">howto</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howto</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">howto</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">howto</span> <span class="o">=</span> <span class="p">[</span><span class="n">howto</span><span class="p">]</span>
                    <span class="n">howto_step</span> <span class="o">=</span> <span class="s2">&quot;# Howto make the </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2"> </span><span class="si">{:}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datatyp</span><span class="p">)</span>
                    <span class="n">howto_step</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">howto</span><span class="p">)</span>
                    <span class="n">ahowto</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">howto_step</span><span class="p">)</span>

            <span class="n">datatyp</span> <span class="o">=</span> <span class="s1">&#39;textblock&#39;</span>
            <span class="n">data_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">datatyp</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_items</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>
                <span class="n">text_data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">text_data</span><span class="p">,</span> 
                        <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> 
                        <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ahowto</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_textblock</span><span class="p">(</span><span class="n">ahowto</span><span class="p">,</span> 
                        <span class="n">subblock</span><span class="o">=</span><span class="s1">&#39;HowTo make </span><span class="si">{:}</span><span class="s1"> tables and figures.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="p">),</span> 
                        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;howto_</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catagory</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)),</span> 
                        <span class="n">hidden</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">end_block</span><span class="p">()</span>         

    <span class="k">def</span> <span class="nf">_close_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close html files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this closes the left column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">mk_nav</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">_finish_page</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">myprint</span><span class="p">(</span><span class="n">tofile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1">#    def make_default_cuts(self, gasdetcut_mJ=0.5):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        Make default cuts.</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        x = self._xdat</span>
<span class="c1">#        # FEEGasDetEnergy_f_12_ENRC is duplicate measurement -- can average if desired </span>
<span class="c1">#        try:</span>
<span class="c1">#            attr = &#39;FEEGasDetEnergy_f_11_ENRC&#39;</span>
<span class="c1">#            x[&#39;Gasdet_pre_atten&#39;] = ([&#39;time&#39;], x[attr].values)</span>
<span class="c1">#            x[&#39;Gasdet_pre_atten&#39;].attrs[&#39;doc&#39;] = &quot;Energy measurement before attenuation ({:})&quot;.format(attr)</span>
<span class="c1">#            for a in [&#39;unit&#39;, &#39;alias&#39;]: </span>
<span class="c1">#                try:</span>
<span class="c1">#                    x[&#39;Gasdet_pre_atten&#39;].attrs[a] = x[attr].attrs[a]  </span>
<span class="c1">#                except:</span>
<span class="c1">#                    pass</span>
<span class="c1">#</span>
<span class="c1">#            # FEEGasDetEnergy_f_22_ENRC is duplicate measurement -- can average if desired </span>
<span class="c1">#            attr = &#39;FEEGasDetEnergy_f_21_ENRC&#39;</span>
<span class="c1">#            x[&#39;Gasdet_post_atten&#39;] = ([&#39;time&#39;], x[attr].values)</span>
<span class="c1">#            x[&#39;Gasdet_post_atten&#39;].attrs[&#39;doc&#39;] = &quot;Energy measurement afeter attenuation ({:})&quot;.format(attr)</span>
<span class="c1">#            for a in [&#39;unit&#39;, &#39;alias&#39;]: </span>
<span class="c1">#                try:</span>
<span class="c1">#                    x[&#39;Gasdet_post_atten&#39;].attrs[a] = x[attr].attrs[a]  </span>
<span class="c1">#                except:</span>
<span class="c1">#                    pass</span>
<span class="c1">#        </span>
<span class="c1">#            x = x.drop([&#39;FEEGasDetEnergy_f_11_ENRC&#39;, &#39;FEEGasDetEnergy_f_12_ENRC&#39;,</span>
<span class="c1">#                        &#39;FEEGasDetEnergy_f_21_ENRC&#39;, &#39;FEEGasDetEnergy_f_22_ENRC&#39;])</span>
<span class="c1">#</span>
<span class="c1">#        except:</span>
<span class="c1">#            pass</span>
<span class="c1">#</span>
<span class="c1">##      Need to add in experiment specific PulseEnergy with attenuation</span>
<span class="c1">##        try:</span>
<span class="c1">##            x[&#39;PulseEnergy&#39;] = ([&#39;time&#39;], x[&#39;Gasdet_post_atten&#39;].values*x[&#39;dia_trans1&#39;].values)</span>
<span class="c1">##        except:</span>
<span class="c1">##            x[&#39;PulseEnergy&#39;] = ([&#39;time&#39;], x[&#39;Gasdet_post_atten&#39;].values*x.attrs[&#39;dia_trans1&#39;])</span>
<span class="c1">##        </span>
<span class="c1">##        x[&#39;PulseEnergy&#39;].attrs = x[&#39;Gasdet_pre_atten&#39;].attrs</span>
<span class="c1">##        x[&#39;PulseEnergy&#39;].attrs[&#39;doc&#39;] = &quot;Energy measurement normalized by attenuators&quot;</span>
<span class="c1">##</span>
<span class="c1">#        try:</span>
<span class="c1">#            gasdetcut =  np.array(x.Gasdet_pre_atten.values &gt; gasdetcut_mJ, dtype=byte)</span>
<span class="c1">#            x.coords[&#39;Gasdet_cut&#39;] = ([&#39;time&#39;], gasdetcut)</span>
<span class="c1">#            x.coords[&#39;Gasdet_cut&#39;].attrs[&#39;doc&#39;] = &quot;Gas detector cut.  Gasdet_pre_atten &gt; {:} mJ&quot;.format(gasdetcut_mJ)</span>
<span class="c1">#        except:</span>
<span class="c1">#            gasdetcut = np.ones(x.time.data.shape)</span>
<span class="c1">#</span>
<span class="c1">#    #    damagecut = np.array(phasecut &amp; gasdetcut &amp; (x.EBeam_damageMask.values == 0), dtype=byte)</span>
<span class="c1">#        damagecut = np.array(gasdetcut, dtype=byte)</span>
<span class="c1">#        x.coords[&#39;Damage_cut&#39;] = ([&#39;time&#39;], damagecut)</span>
<span class="c1">#        x.coords[&#39;Damage_cut&#39;].attrs[&#39;doc&#39;] = &quot;Combined Gas detector, Phase cavity and EBeam damage cut&quot;</span>
<span class="c1">#</span>
<span class="c1">#        try:</span>
<span class="c1">#            x = x.rename( {&#39;EBeam_ebeamPhotonEnergy&#39;: &#39;PhotonEnergy&#39;} )</span>
<span class="c1">#        except:</span>
<span class="c1">#            pass</span>
<span class="c1">#</span>
<span class="c1">#        if not x.attrs.get(&#39;correlation_variables&#39;):</span>
<span class="c1">#            cvars = []</span>
<span class="c1">#            for cvar in [&#39;PhotonEnergy&#39;,&#39;Gasdet_post_atten&#39;]:</span>
<span class="c1">#                if cvar in x:</span>
<span class="c1">#                    cvars.append(cvar)</span>
<span class="c1">#            x.attrs[&#39;correlation_variables&#39;] = cvars</span>
<span class="c1">#</span>
<span class="c1">#        try:</span>
<span class="c1">#            sattrs = list(set(x.attrs.get(&#39;scan_variables&#39;,[])))</span>
<span class="c1">#            for pv in [a.replace(&#39;_steps&#39;,&#39;&#39;) for a in x.keys() if a.endswith(&#39;_steps&#39;)]:</span>
<span class="c1">#                if pv not in x:</span>
<span class="c1">#                    x.coords[pv] = ((&#39;time&#39;,), x[pv+&#39;_steps&#39;].data[list(x.step.data.astype(int))])</span>
<span class="c1">#                    x.coords[pv].attrs = x[pv+&#39;_steps&#39;].attrs</span>
<span class="c1">#                    sattrs.append(pv)</span>
<span class="c1">#        except:</span>
<span class="c1">#            print &#39;Cannot add _steps as events&#39;</span>
<span class="c1">#</span>
<span class="c1">#        try:</span>
<span class="c1">#            for pv in x.attrs.get(&#39;pvControls&#39;, []):</span>
<span class="c1">#                if pv+&#39;_control&#39; in x:</span>
<span class="c1">#                    sattrs.append(pv+&#39;_control&#39;)</span>
<span class="c1">#                elif pv in x:</span>
<span class="c1">#                    sattrs.append(pv)</span>
<span class="c1">#            sattrs = list(set([attr for attr in sattrs if attr in x and len(set(x[attr].data)) &gt; 3]))</span>
<span class="c1">#            x.attrs[&#39;scan_variables&#39;] = sattrs</span>
<span class="c1">#</span>
<span class="c1">#        except:</span>
<span class="c1">#            print &#39;Cannot add pvControls to scan_variables&#39;</span>
<span class="c1">#</span>
<span class="c1">#        try:</span>
<span class="c1">#            if &#39;XrayOff&#39; in x and x.XrayOff.data.sum() &gt; 0 and not x.attrs.get(&#39;cuts&#39;):</span>
<span class="c1">#                x.attrs[&#39;cuts&#39;] = [&#39;XrayOn&#39;,&#39;XrayOff&#39;]</span>
<span class="c1">#                print &#39;Setting cuts&#39;, x.attrs[&#39;cuts&#39;]</span>
<span class="c1">#</span>
<span class="c1">#        except:</span>
<span class="c1">#            print &#39;Cannot make default cuts&#39;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#        self._xdat = x</span>
<span class="c1">#</span>
<span class="c1">#        return x</span>




<span class="c1">#                Axes = pd.tools.plotting.scatter_matrix(dfscat, figsize=figsize)</span>
<span class="c1">#                #y ticklabels</span>
<span class="c1">#                [plt.setp(item.yaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]</span>
<span class="c1">#                #x ticklabels</span>
<span class="c1">#                [plt.setp(item.xaxis.get_majorticklabels(), &#39;size&#39;, 15) for item in Axes.ravel()]</span>
<span class="c1">#                #y labels</span>
<span class="c1">#                [plt.setp(item.yaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]</span>
<span class="c1">#                #x labels</span>
<span class="c1">#                [plt.setp(item.xaxis.get_label(), &#39;size&#39;, 20) for item in Axes.ravel()]</span>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>