

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyDataSource.exp_summary &mdash; PyDataSource 0.6.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyDataSource 0.6.9 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyDataSource
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_processing.html">Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xarray.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_summary.html">Summarizing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_data.html">Configuration Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta_data.html">Meta Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_html.html">Run Summary Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp_summary.html">Experiment Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../offbyone.html">Off-by-one Timing Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch.html">Submitting Batch Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conda.html">Updating Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">PyDatSource API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyDataSource</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>PyDataSource.exp_summary</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for PyDataSource.exp_summary</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">instrument_transmission_pvs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;FEE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GATT:FEE1:310:R_ACT&#39;</span><span class="p">,</span><span class="s1">&#39;SATT:FEE1:320:RACT&#39;</span><span class="p">],</span>
        <span class="s1">&#39;XPP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;XPP:ATT:COM:R_CUR&#39;</span><span class="p">],</span>
        <span class="s1">&#39;XCS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;XCS:ATT:COM:R_CUR&#39;</span><span class="p">],</span>
        <span class="s1">&#39;MFX&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;MFX:ATT:COM:R_CUR&#39;</span><span class="p">],</span>
        <span class="s1">&#39;CXI&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CXI:DSB:ATT:COM:R_CUR&#39;</span><span class="p">,</span><span class="s1">&#39;XRT:DIA:ATT:COM:R_CUR&#39;</span><span class="p">],</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">write_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write ExperimentSummary as pickle file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;experiment_summary.pkl&#39;</span>
    
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpvs</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;xpvs.nc&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xscan</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;xscan.nc&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;xset.nc&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">pickle_file</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failes writing pickle file&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">open_epics_data</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;xpvs.nc&#39;</span>
    
    <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Must supply exp Name&#39;</span><span class="p">)</span>
        <span class="k">return</span> 

    <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">exp_dir</span> <span class="o">=</span> <span class="s2">&quot;/reg/d/psdm/</span><span class="si">{:}</span><span class="s2">/</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)):</span> 
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>

    <span class="n">full_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">file_name</span>
    <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">full_file</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">full_file</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;h5netcdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failes reading file&#39;</span><span class="p">,</span> <span class="n">full_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failes finding file&#39;</span><span class="p">,</span> <span class="n">full_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="n">xdata</span>

<span class="k">def</span> <span class="nf">get_pv_attrs</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get dict of attributes for epics pvs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp : str</span>
<span class="sd">        Experiment Name</span>
<span class="sd">    </span>
<span class="sd">    auto_load : bool</span>
<span class="sd">        Automatically reload exp_summary if not existing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xpvs</span> <span class="o">=</span> <span class="n">open_epics_data</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;xpvs.nc&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed open_epics_data for&#39;</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
        <span class="n">xpvs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">xpvs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_load</span><span class="p">:</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xpvs</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">xpvs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span> 

    <span class="k">return</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xpvs</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">get_scan_pvs</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_load</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get scan pvs for exp.  </span>
<span class="sd">    If run is provided return dict of alias, pv</span>
<span class="sd">    Otherwise return pandas data frame for all runs</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exp : str</span>
<span class="sd">        Experiment Name</span>
<span class="sd">    run : int</span>
<span class="sd">        Run number (optional)</span>
<span class="sd">    auto_load : bool</span>
<span class="sd">        Automatically reload exp_summary if not existing</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xscan</span> <span class="o">=</span> <span class="n">open_epics_data</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;xscan.nc&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">xscan</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">xscan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_load</span><span class="p">:</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">get_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xscan</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">xscan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xscan</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">dfscan</span> <span class="o">=</span> <span class="n">xscan</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span>
    <span class="n">dfscan</span> <span class="o">=</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
   
    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">T</span>

<span class="k">def</span> <span class="nf">read_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read exp_summary pickle file.  Return none if does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;experiment_summary.pkl&#39;</span>
    
    <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Must supply exp Name&#39;</span><span class="p">)</span>
        <span class="k">return</span> 

    <span class="n">instrument</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">exp_dir</span> <span class="o">=</span> <span class="s2">&quot;/reg/d/psdm/</span><span class="si">{:}</span><span class="s2">/</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)):</span> 
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">,</span><span class="s1">&#39;RunSummary&#39;</span><span class="p">)</span>

    <span class="n">full_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">file_name</span>
    <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">full_file</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failes reading pickle file&#39;</span><span class="p">,</span> <span class="n">full_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">get_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use scratch for now since results unreliable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">es</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span><span class="p">:</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">read_exp_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">es</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">ExperimentSummary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">es</span>

<span class="k">def</span> <span class="nf">epicsArch_dict</span><span class="p">(</span><span class="n">archfile_name</span><span class="p">,</span><span class="n">file_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load text file containing aliases and pvs with daq epicsArch convention. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="n">arch_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">archfile_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">archfile_name</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                    <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="n">arch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">arch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                    
        <span class="n">arch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">arch_list</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">pvalias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arch_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)):</span>
                <span class="n">pvalias</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">pvalias</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">pvbase</span> <span class="o">=</span> <span class="n">pvname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pvalias</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pvalias</span> <span class="ow">in</span> <span class="n">arch_dict</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: duplicate alias </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalias</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pvalias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;:|\.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pvname</span><span class="p">)</span> 

                <span class="n">components</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:|\.&#39;</span><span class="p">,</span><span class="n">pvname</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                         <span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="o">+</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
     
                <span class="n">arch_dict</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">pvname</span><span class="p">,</span>
                                     <span class="s1">&#39;alias&#39;</span><span class="p">:</span> <span class="n">pvalias</span><span class="p">,</span>
                                     <span class="s1">&#39;base&#39;</span><span class="p">:</span>  <span class="n">pvbase</span><span class="p">,</span>
                                     <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="n">components</span><span class="p">}</span> 
    
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loading </span><span class="si">{:}</span><span class="s1"> from </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archfile_name</span><span class="p">,</span><span class="n">file_dir</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">arch_dict</span>



<div class="viewcode-block" id="ExperimentSummary"><a class="viewcode-back" href="../../generated/PyDataSource.exp_summary.ExperimentSummary.html#PyDataSource.ExperimentSummary">[docs]</a><span class="k">class</span> <span class="nc">ExperimentSummary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Experiment information from elog and epics archive data. </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    xscan : xarray.Dataset</span>
<span class="sd">        </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_fields</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span>            <span class="p">(</span><span class="s1">&#39;DESC&#39;</span><span class="p">,</span> <span class="s1">&#39;Description&#39;</span><span class="p">),</span> 
            <span class="s1">&#39;slew_speed&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;VELO&#39;</span><span class="p">,</span> <span class="s1">&#39;Velocity (EGU/s) &#39;</span><span class="p">),</span>
            <span class="s1">&#39;acceleration&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ACCL&#39;</span><span class="p">,</span> <span class="s1">&#39;acceleration time&#39;</span><span class="p">),</span>
            <span class="s1">&#39;step_size&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span>  <span class="s1">&#39;Step Size (EGU)&#39;</span><span class="p">),</span>
            <span class="s1">&#39;encoder_step&#39;</span><span class="p">:</span>           <span class="p">(</span><span class="s1">&#39;ERES&#39;</span><span class="p">,</span> <span class="s1">&#39;Encoder Step Size &#39;</span><span class="p">),</span>
            <span class="s1">&#39;resolution&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;MRES&#39;</span><span class="p">,</span> <span class="s1">&#39;Motor Step Size (EGU)&#39;</span><span class="p">),</span>
            <span class="s1">&#39;high_limit&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;HLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User High Limit&#39;</span><span class="p">),</span>
            <span class="s1">&#39;low_limit&#39;</span><span class="p">:</span>              <span class="p">(</span><span class="s1">&#39;LLM&#39;</span><span class="p">,</span>  <span class="s1">&#39;User Low Limit&#39;</span><span class="p">),</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="s1">&#39;EGU&#39;</span><span class="p">,</span>  <span class="s1">&#39;Units&#39;</span><span class="p">),</span>
<span class="c1">#            &#39;device_type&#39;:            (&#39;DTYP&#39;, &#39;Device type&#39;), </span>
<span class="c1">#            &#39;record_type&#39;:            (&#39;RTYP&#39;, &#39;Record Type&#39;), </span>
            <span class="p">}</span>

<div class="viewcode-block" id="ExperimentSummary.__init__"><a class="viewcode-back" href="../../generated/PyDataSource.exp_summary.ExperimentSummary.html#PyDataSource.ExperimentSummary.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exper_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">exp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xtc_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h5_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scratch_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Experiment Summary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exper_id</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">name2id</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">exper_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exper_id</span> <span class="o">=</span> <span class="n">exper_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">getexp</span><span class="p">(</span><span class="n">exper_id</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">instrument</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">active_experiment</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exper_id</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">name2id</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="p">:</span>
            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> <span class="n">station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exp_dir</span><span class="p">:</span>
            <span class="n">exp_dir</span> <span class="o">=</span> <span class="s2">&quot;/reg/d/psdm/</span><span class="si">{:}</span><span class="s2">/</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">xtc_dir</span><span class="p">:</span>
            <span class="n">xtc_dir</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">/xtc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h5_dir</span><span class="p">:</span>
            <span class="n">h5_dir</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">/hdf5&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scratch_dir</span><span class="p">:</span>
            <span class="n">scratch_dir</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="si">{:}</span><span class="s2">/scratch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span> <span class="o">=</span> <span class="n">exp_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h5_dir</span> <span class="o">=</span> <span class="n">h5_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xtc_dir</span> <span class="o">=</span> <span class="n">xtc_dir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_dir</span><span class="p">,</span><span class="s1">&#39;scratch&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_run_info</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_arch</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Could not load epics Archive&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_exp_runs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Could not load exp_runs&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="s1">&#39;Could not write summary&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save to pickle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">write_exp_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_runtables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add RunTables... currently does not work in conda env.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">LogBook.runtables</span> <span class="k">import</span> <span class="n">RunTables</span>

            <span class="c1"># Setup elog pswwww RunTables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RunTables</span> <span class="o">=</span> <span class="n">RunTables</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;web-service-url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://pswww.slac.stanford.edu/ws-kerb&#39;</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_user_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RunTables</span><span class="o">.</span><span class="n">usertables</span><span class="p">(</span><span class="n">exper_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
            <span class="c1">#self.add_user_run_table(RunSummary=&#39;Run Summary&#39;)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;currently does not work in conda env.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_user_run_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a user User RunTable from pswww elog server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RunTables</span><span class="o">.</span><span class="n">findUserTable</span><span class="p">(</span><span class="n">exper_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_tables</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">alias</span><span class="p">:</span> <span class="n">tbl</span><span class="p">})</span> 
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">tbl</span><span class="p">)</span>

<div class="viewcode-block" id="ExperimentSummary.to_html"><a class="viewcode-back" href="../../generated/PyDataSource.exp_summary.ExperimentSummary.to_html.html#PyDataSource.ExperimentSummary.to_html">[docs]</a>    <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build experiment html report.  </span>
<span class="sd">        see build_html.Build_experiment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">build_html</span>
        <span class="k">return</span> <span class="n">build_html</span><span class="o">.</span><span class="n">Build_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">detectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of detector names configured in the DAQ system for the input run number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="k">return</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">detectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calibration_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of calibration runs for the experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="k">return</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">calibration_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_moved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show motors that have moved (or devices that have changed state).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs : list</span>
<span class="sd">            List of motor aliases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">xvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s1">&#39;begin_time&#39;</span><span class="p">,</span><span class="s1">&#39;prep_time&#39;</span><span class="p">])[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** </span><span class="si">{:}</span><span class="s1"> **&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">xvar</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PREC&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:10}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">xvar</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_run_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_time</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">xscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscan</span>
        <span class="n">run_last</span> <span class="o">=</span> <span class="n">xscan</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">run_min</span><span class="p">:</span>
            <span class="n">xscan</span> <span class="o">=</span> <span class="n">xscan</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xscan</span><span class="o">.</span><span class="n">run</span> <span class="o">&gt;</span> <span class="n">run_min</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">run_last</span> <span class="o">=</span> <span class="n">run_min</span>
        <span class="k">if</span> <span class="n">run_max</span><span class="p">:</span>
            <span class="n">xscan</span> <span class="o">=</span> <span class="n">xscan</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xscan</span><span class="o">.</span><span class="n">run</span> <span class="o">&lt;=</span> <span class="n">run_max</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">runs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">xscan</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xscan</span><span class="o">.</span><span class="n">prep_time</span> <span class="o">&gt;</span> <span class="n">delta_time</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xscan</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">aruns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="n">run_next</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="n">aruns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">run_last</span><span class="p">,</span> <span class="n">run_next</span><span class="p">,))</span>
            <span class="n">run_last</span> <span class="o">=</span> <span class="n">run_next</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">aruns</span>

    <span class="k">def</span> <span class="nf">get_transmission_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get transmission dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run : int</span>
<span class="sd">            Run number</span>
<span class="sd">        time : array</span>
<span class="sd">            Array of times</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="o">.</span><span class="n">time</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;=</span><span class="n">a</span><span class="o">.</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">a</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No scan data for run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">time</span><span class="p">:</span>    
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">fill_times</span><span class="p">(</span><span class="n">xepics</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">xepics</span>

    <span class="k">def</span> <span class="nf">get_scan_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get scan dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run : int</span>
<span class="sd">            Run number</span>
<span class="sd">        time : array</span>
<span class="sd">            Array of times</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="o">.</span><span class="n">time</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;=</span><span class="n">a</span><span class="o">.</span><span class="n">begin_time</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">a</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No scan data for run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">time</span><span class="p">:</span>    
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">fill_times</span><span class="p">(</span><span class="n">xepics</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">xepics</span>

    <span class="k">def</span> <span class="nf">plot_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">min_steps</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_motors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot motor moves vs time and run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan_data</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">min_steps</span><span class="o">=</span><span class="n">min_steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">min_motors</span><span class="o">=</span><span class="n">min_motors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run </span><span class="si">{:}</span><span class="s1"> scan for attrs=</span><span class="si">{:}</span><span class="s1"> device=</span><span class="si">{:}</span><span class="s1"> not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">device</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Motors&#39;</span>
     
            <span class="n">aunits</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
            <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aunits</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aunits</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">+=</span> <span class="s1">&#39; [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="n">attr</span>
                <span class="k">if</span> <span class="n">aunits</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                    <span class="n">lab</span> <span class="o">+=</span> <span class="s1">&#39; [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aunits</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                
                <span class="n">df</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">style</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (US Pacific)&#39;</span><span class="p">)</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_epics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get epics motion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">attrs</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_min</span><span class="p">:</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xepics</span><span class="o">.</span><span class="n">run</span> <span class="o">&gt;=</span> <span class="n">run_min</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_max</span><span class="p">:</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xepics</span><span class="o">.</span><span class="n">run</span> <span class="o">&lt;=</span> <span class="n">run_max</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xepics</span>

    <span class="k">def</span> <span class="nf">_pvs_with_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_set&#39;</span><span class="p">):</span>
                <span class="n">aout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_set&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aout</span>

    <span class="k">def</span> <span class="nf">get_moved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get devices that moved (between run_min and run_max if specified)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_set&#39;</span><span class="p">):</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">)</span>
        
        <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epics</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">min_count</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">xepics</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span>
                <span class="n">adets</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="n">det</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="n">xepics</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
                            <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\W+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">grp</span> <span class="o">=</span> <span class="n">det</span><span class="o">+</span><span class="s1">&#39;__&#39;</span><span class="o">+</span><span class="n">unit</span>
                    <span class="k">if</span> <span class="n">grp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adets</span><span class="p">:</span>
                        <span class="n">adets</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">adets</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">adets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]))</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">det</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">det</span><span class="p">)]</span> <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">attrs</span>

    <span class="k">def</span> <span class="nf">plot_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> 
            <span class="n">ax_pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="o">.</span><span class="mi">7</span><span class="p">),</span> <span class="n">box_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> 
            <span class="c1">#ax_pos = (.1,.2,.55,.7), box_to_anchor=(1.1, 1.), </span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot motor moves vs time and run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epics</span><span class="p">(</span><span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="n">attrs</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moved</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="n">attrs</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Motors&#39;</span>
    
        <span class="n">moved_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moved</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">moved_attrs</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">xepics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epics</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="n">run_min</span><span class="o">=</span><span class="n">run_min</span><span class="p">,</span> <span class="n">run_max</span><span class="o">=</span><span class="n">run_max</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">xepics</span><span class="p">[</span><span class="s1">&#39;begin_run&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">axr</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">axr</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span>
        
        <span class="n">aunits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xepics</span><span class="p">:</span>
                <span class="n">aunits</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span>  <span class="n">xepics</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">a</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span> <span class="ow">in</span> <span class="n">xepics</span><span class="p">:</span>
                <span class="n">aunits</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span>  <span class="n">xepics</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aunits</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aunits</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">+=</span> <span class="s1">&#39; [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="k">if</span> <span class="n">aunits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                <span class="n">lab</span> <span class="o">+=</span> <span class="s1">&#39; [</span><span class="si">{:}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aunits</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">xepics</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_points</span><span class="p">:</span>
                    <span class="c1"># need to resample</span>
                    <span class="n">sample_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="p">(</span><span class="n">max_points</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span>
                    <span class="n">df_resampled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">S&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_time</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">df_resampled</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_resampled</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">df_resampled</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">style</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot plot&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xepics</span> <span class="ow">and</span> <span class="n">xepics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">):</span>
                    <span class="n">xepics</span><span class="p">[</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot plot&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span><span class="p">)</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span>
        <span class="n">xticks_minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">run_step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">xticks_minor</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">*</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">xticks_minor</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">b</span> <span class="o">%</span> <span class="n">run_step</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">b</span> <span class="o">%</span> <span class="n">run_step</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticklabels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks_minor</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">legendr</span> <span class="o">=</span> <span class="n">axr</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">axr</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">ax_pos</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">ax_pos</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">ax_pos</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>  <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">box_to_anchor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_add_run_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add experiment run details to xrun xarray Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xruns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;drop_stats_files&#39;</span><span class="p">,</span> <span class="s1">&#39;xtc_files&#39;</span><span class="p">,</span> <span class="s1">&#39;stats_files&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ftyp</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfruns</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ftyp</span><span class="p">]</span>
                <span class="n">xruns</span><span class="p">[</span><span class="n">ftyp</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;run&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">run</span><span class="p">])</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">dlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ddict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detectors</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="n">ddict</span><span class="p">[</span><span class="n">run</span><span class="p">]</span> <span class="o">=</span> <span class="n">dets</span>
            <span class="n">dlist</span> <span class="o">+=</span> <span class="n">dets</span>

        <span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;-|:|\.| |\|&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dlist</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">xruns</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;run&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">det</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ddict</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">xruns</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">xruns</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;detectors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">xruns</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runs_with_xtc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of runs with xtc files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">file_names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfruns</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;xtc_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">file_names</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">runs</span>

    <span class="k">def</span> <span class="nf">last_pv_fields_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Last time fields were changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">last_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the last time devices were set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="n">avals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">xvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
            <span class="n">avals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xvar</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">avals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">xvar</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                                <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="n">xvar</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">xvar</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">begin_time</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
                
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">avals</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_submit_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">batchqueue</span><span class="o">=</span><span class="s1">&#39;psanaq&#39;</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;beam_stats&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make beam_stats to check for timing error and drop shots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">bsubproc</span> <span class="o">=</span> <span class="s1">&#39;submit_summary </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">batchqueue</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; &#39;</span><span class="p">,</span><span class="n">bsubproc</span><span class="p">)</span>

        <span class="n">subproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">bsubproc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_configData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save configData .</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        runs : list of ints or int or &#39;all&#39;</span>
<span class="sd">            Runs to save configData - if &#39;all&#39; then submit all that have not already been created</span>
<span class="sd">            default = &#39;all&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">PyDataSource</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">drop_stats_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfruns</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;drop_stats_files&#39;</span><span class="p">]</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">run</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs_with_xtc</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_stats_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">configData</span><span class="o">.</span><span class="n">save_configData</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot save configData: &#39;</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">submit_beam_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">batchqueue</span><span class="o">=</span><span class="s1">&#39;psanaq&#39;</span><span class="p">,</span> <span class="n">alert</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make beam_stats to check for timing error and drop shots</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        runs : list of ints or int or &#39;all&#39;</span>
<span class="sd">            Runs to submit -- if &#39;all&#39; then submit all that have not already been created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">drop_stats_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfruns</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s1">&#39;drop_stats_files&#39;</span><span class="p">]</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">run</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs_with_xtc</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_stats_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="p">[])]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">runs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="n">bsubproc</span> <span class="o">=</span> <span class="s1">&#39;submit_beam_stats </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">batchqueue</span><span class="p">,</span> <span class="n">alert</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt; &#39;</span><span class="p">,</span><span class="n">bsubproc</span><span class="p">)</span>
            <span class="n">subproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">bsubproc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_beam_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load drop stats summary for all runs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">beam_stats</span>
        <span class="k">return</span> <span class="n">beam_stats</span><span class="o">.</span><span class="n">load_exp_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">build_beam_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build beam statistics summary including off-by-one.</span>

<span class="sd">        First run submit_beam_stats(&#39;all&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">beam_stats</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">beam_stats</span><span class="o">.</span><span class="n">build_drop_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">alert</span><span class="o">=</span><span class="n">alert</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">_load_run_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_create</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>                         
            <span class="k">try</span><span class="p">:</span>                                         
                <span class="n">x</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">h5write</span><span class="o">.</span><span class="n">get_config_xarray</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="s1">&#39;mfx11116&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">no_create</span><span class="o">=</span><span class="n">no_create</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">except</span><span class="p">:</span>     
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot load run&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span>

    <span class="k">def</span> <span class="nf">_load_run_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load run info from experiment_info database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

        <span class="n">rns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">experiment_info</span><span class="o">.</span><span class="n">experiment_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rns</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">xruns</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
            <span class="n">xruns</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">rns</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">])</span>
            <span class="n">xruns</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">rns</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rns</span><span class="p">[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">]))</span>
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rns</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]))</span>
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">rns</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e9</span> <span class="o">-</span> <span class="n">rns</span><span class="p">[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">))</span>
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sec&#39;</span>
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;prep_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">rns</span><span class="p">[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">rns</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">))</span> 
            <span class="n">xruns</span><span class="p">[</span><span class="s1">&#39;prep_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sec&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span> <span class="o">=</span> <span class="n">xruns</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span>

    <span class="k">def</span> <span class="nf">_init_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize archive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">epicsarchive</span> <span class="k">import</span> <span class="n">EpicsArchive</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;xruns&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_run_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span> <span class="o">=</span> <span class="n">EpicsArchive</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_run</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">max_run</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">min_run</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">min_run</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="s1">&#39;begin_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tstart</span> <span class="o">=</span> <span class="n">tstart</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tend</span> <span class="o">=</span> <span class="n">tend</span>

    <span class="k">def</span> <span class="nf">_get_pv_from_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tstart</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tstart</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tend</span><span class="p">:</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tend</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="o">.</span><span class="n">_get_json</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_in_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if pv is in archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arch</span><span class="o">.</span><span class="n">search_pvs</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">do_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_load_eventCodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Currently not archived</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_codes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seq_evtCodes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">67</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">167</span><span class="p">,</span><span class="mi">199</span><span class="p">)</span><span class="o">+</span><span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="mi">217</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">seq_evtCodes</span><span class="p">:</span>
            <span class="n">pvs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;inst_num&#39;</span><span class="p">:</span> <span class="s1">&#39;ECS:SYS0:0:EC_</span><span class="si">{:}</span><span class="s1">_OWNER_ID&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
                    <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;EVNT:SYS0:1:NAME</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
                    <span class="c1">#&#39;ticks&#39;: &#39;EVNT:SYS0:1:ECS_{:}DLY.A&#39;.format(num),</span>
                  <span class="p">}</span>
            <span class="n">data_codes</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_codes</span> <span class="o">=</span> <span class="n">data_codes</span>

    <span class="k">def</span> <span class="nf">_load_epics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">omit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ABSE&#39;</span><span class="p">,</span> <span class="s1">&#39;BEAM&#39;</span><span class="p">,</span> <span class="s1">&#39;SIOC&#39;</span><span class="p">,</span> <span class="s1">&#39;USEG&#39;</span><span class="p">,</span> <span class="s1">&#39;VGBA&#39;</span><span class="p">,</span> <span class="s1">&#39;GATT&#39;</span><span class="p">],</span>
                    <span class="c1">#      &#39;MIRR:EE1:M2H.RBV&#39;, &#39;MIRR:FEE1:M1H.RBV&#39;],</span>
                    <span class="n">omit_rbv</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;XRT:M2H&#39;</span><span class="p">,</span><span class="s1">&#39;MIRR:FEE1&#39;</span><span class="p">,</span><span class="s1">&#39;MIRR:XRT&#39;</span><span class="p">,</span><span class="s1">&#39;STEP:M1H&#39;</span><span class="p">,</span><span class="s1">&#39;STEP:M2H&#39;</span><span class="p">,</span><span class="s1">&#39;MOVR:DMP1&#39;</span><span class="p">],</span>
                    <span class="n">omit_endswith</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CNT&#39;</span><span class="p">],</span>
                    <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">set_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">max_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make xarray and pandas objects to describe which epics variables were set before</span>
<span class="sd">        and during runs.</span>
<span class="sd">        </span>
<span class="sd">        For now resample with max_size for monitoring pvs in order to keep file size small enough to pickle.</span>
<span class="sd">        In future refactor to save/load data objects separately and write with pandas/xarray to hdf5.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">operator</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;xruns&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_run_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pvs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">set_only</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">set_only</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="kn">import</span> <span class="nn">PyDataSource</span>
            <span class="n">autorun</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
                <span class="n">autorun</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs_with_xtc</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runs_with_xtc</span><span class="p">)</span>
                <span class="c1">#run=rns[&#39;num&#39;].max()</span>
            
            <span class="c1">#pvnames = {pv:ds.epicsData.alias(pv) for pv in ds.epicsData.pvNames()}</span>
            <span class="n">pvnames</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">autorun</span><span class="p">:</span>
                        <span class="c1"># go to next to last if last run fails</span>
                        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs_with_xtc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">PyDataSource</span><span class="o">.</span><span class="n">DataSource</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">pvNames</span><span class="p">():</span>
                    <span class="n">pvalias</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">epicsData</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pvalias</span><span class="p">:</span>
                        <span class="n">pvalias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;:|\.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pvalias</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;:|\.|-| &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">pvalias</span><span class="p">)</span>
                   
                    <span class="c1"># remove instrument from auto alias</span>
                    <span class="n">pvalias</span> <span class="o">=</span> <span class="n">pvalias</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="n">pvnames</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalias</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_pvnames0</span> <span class="o">=</span> <span class="n">pvnames</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">omit</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">omit</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvnames</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                        <span class="n">pvnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">pvnames</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">omit_pv</span> <span class="ow">in</span> <span class="n">omit_endswith</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">omit_pv</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pvnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot pop &#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span><span class="s1">&#39;ending with&#39;</span><span class="p">,</span><span class="n">omit_pv</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">omit_pv</span> <span class="ow">in</span> <span class="n">omit_rbv</span><span class="p">:</span>
                    <span class="k">if</span>  <span class="n">omit_pv</span> <span class="ow">in</span> <span class="n">pv</span> <span class="ow">and</span> <span class="n">pv</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.RBV&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">pvnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot pop &#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span> <span class="n">omit_rbv</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">set_only</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">set_only</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pvnames</span> <span class="o">=</span> <span class="n">pvs</span>

        <span class="n">evr_pvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">pvnames</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;TRIG&#39;</span> <span class="ow">in</span> <span class="n">pv</span><span class="p">:</span>
                <span class="n">pvsplit</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">pvbase</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pvsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pvbase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evr_pvs</span><span class="p">:</span>
                    <span class="n">evr_pvs</span><span class="p">[</span><span class="n">pvbase</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">evr_pvs</span><span class="p">[</span><span class="n">pvbase</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">pv</span><span class="p">:</span> <span class="n">alias</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">pv</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.RBV&#39;</span><span class="p">):</span>
                <span class="n">pvnames</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.RBV&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_set&#39;</span>
                <span class="k">if</span> <span class="n">set_only</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">pvnames</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">set_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pv</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;STATE&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">pvnames</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span>

        <span class="n">machine_pvs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epicsArch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_machine_epicsArch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">epicsArch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.RBV&#39;</span><span class="p">):</span>
                <span class="n">alias</span> <span class="o">+=</span> <span class="s1">&#39;_set&#39;</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.RBV&#39;</span><span class="p">)</span>
            
            <span class="n">pvnames</span><span class="p">[</span><span class="n">pv</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span>
            <span class="n">machine_pvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pvnames</span> <span class="o">=</span> <span class="n">pvnames</span>
        <span class="c1">#pvmots = {pv.rstrip(&#39;.RBV&#39;): alias+&#39;_set&#39; for pv, alias in pvnames.items() if pv.endswith(&#39;RBV&#39;)}</span>
        <span class="c1">#pvnames.update(**pvmots)</span>
        <span class="c1">#pvs = {pv: alias for pv, alias in pvnames.items() if arch.search_pvs(pv, do_print=False) != []} </span>
        <span class="n">pvs</span> <span class="o">=</span> <span class="p">{</span><span class="n">pv</span><span class="p">:</span> <span class="n">alias</span> <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">pvnames</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv</span><span class="p">)}</span> 

        <span class="n">meta_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;EGU&#39;</span><span class="p">,</span> <span class="s1">&#39;PREC&#39;</span><span class="p">:</span> <span class="s1">&#39;PREC&#39;</span><span class="p">,</span> <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">}</span>

        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">data_machine</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">data_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time0</span>
        <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">pvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dat</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">meta_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]}</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">pv_desc</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">field</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_archive</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">):</span>
                                <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pv_from_arch</span><span class="p">(</span><span class="n">pv_desc</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                                    <span class="n">vals</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">fattrs</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                    <span class="n">fattrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
                                    <span class="n">fattrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="c1"># remove redundant data</span>
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                                        <span class="n">newval</span> <span class="o">=</span>  <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                                            <span class="n">val</span> <span class="o">=</span> <span class="n">newval</span>
                                            <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span>
                                            <span class="n">vals</span><span class="p">[</span><span class="n">vt</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                                   
                                    <span class="n">data_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> 
                                                                    <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> 
                                                                    <span class="n">name</span><span class="o">=</span><span class="n">alias</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">attr</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">fattrs</span><span class="p">)</span> 
                                    <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
             
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot get meta for&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                            
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                  
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
                                <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;secs&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span><span class="o">+</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;nanos&#39;</span><span class="p">]),</span> <span class="s1">&#39;ns&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]]</span>
                                <span class="c1"># Simple way to remove duplicates</span>
                                <span class="c1"># Duplicates will break xarray merge</span>
        <span class="c1">#                        times_o = [a for a in times]</span>
        <span class="c1">#                        vals_o = [v for v in vals]</span>
        <span class="c1">#                        try:</span>
        <span class="c1">#                            aa = dict(zip(times, vals))</span>
        <span class="c1">#                            #aa = sorted(dict(zip(times, vals)).items(), key=operator.itemgetter(0))</span>
        <span class="c1">#                        except:</span>
        <span class="c1">#                            print &#39;cannot sort&#39;, alias</span>
        <span class="c1">#                            aa = dict(zip(times, vals))</span>
        <span class="c1">#                        times = np.array(aa.keys(), dtype=times[0].dtype)</span>
        <span class="c1">#                        vals = np.array(aa.values())</span>
        <span class="c1">#                        if not alias.endswith(&#39;set&#39;) and alias not in machine_pvs and len(aa) &gt; max_size:</span>
        <span class="c1">#                            print &#39;    ... resampling&#39;, alias</span>
        <span class="c1">#                            inds = range(0,len(aa), len(aa)/max_size)</span>
        <span class="c1">#                            times = times[inds]</span>
        <span class="c1">#                            vals = vals[inds]</span>
        <span class="c1">#</span>
                                <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">machine_pvs</span><span class="p">:</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="n">dfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
                                    <span class="n">vals</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
                                    <span class="n">data_machine</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span> 
                                    <span class="n">data_machine</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">alias</span>
                                    <span class="n">data_machine</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
                                    <span class="c1">#data_machine[alias] = xr.DataArray(vals, coords=[times], dims=[&#39;time&#39;], name=alias, attrs=attrs)</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">{:}</span><span class="s1"> due to too many data points </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
                                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="n">dfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
                                    <span class="n">vals</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span>
                                    <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>
                                    <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfs</span> 
                                    <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">alias</span>
                                    <span class="n">data_arrays</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
                                    <span class="c1">#data_arrays[alias] = xr.DataArray(vals, coords=[times], dims=[&#39;time&#39;], name=alias, attrs=attrs) </span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">data_points</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                          <span class="s1">&#39;pv&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">],</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)}</span>
                    
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loadinig&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:10.3f}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                            <span class="n">alias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:28}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">,</span> \
                                            <span class="n">alias</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
                
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error loading&#39;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Merging&#39;</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_machine</span> <span class="o">=</span> <span class="n">data_machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_arrays</span> <span class="o">=</span> <span class="n">data_arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_points</span> <span class="o">=</span> <span class="n">data_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_fields</span> <span class="o">=</span> <span class="n">data_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evr_pvs</span> <span class="o">=</span> <span class="n">evr_pvs</span>

        <span class="n">time_last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">xepics</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_arrays</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)]</span>
        <span class="n">xmachine</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_machine</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">xmachine</span> <span class="o">=</span> <span class="n">xmachine</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">xmachine</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">values</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;end_run&#39;</span><span class="p">)</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">begin_time</span><span class="o">.</span><span class="n">values</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;begin_run&#39;</span><span class="p">)</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xepics</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span><span class="p">])</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">end_run</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end_run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">})</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">begin_run</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;begin_run&#39;</span><span class="p">:</span> <span class="s1">&#39;brun&#39;</span><span class="p">})</span>
            <span class="c1"># Need to make sure there are no duplicates -- &#39;cxim7216&#39; odd case where there are using this method.</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">dfend</span><span class="p">[</span><span class="o">~</span><span class="n">dfend</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">dfbegin</span><span class="p">[</span><span class="o">~</span><span class="n">dfbegin</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xepics</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span><span class="p">])</span>
            <span class="n">xepics</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">run</span> <span class="o">!=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">brun</span> 
            <span class="n">xepics</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">xepics</span><span class="p">[</span><span class="s1">&#39;end_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">end_run</span>
            <span class="n">xepics</span><span class="p">[</span><span class="s1">&#39;begin_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">begin_run</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;brun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_run&#39;</span><span class="p">,</span> <span class="s1">&#39;end_run&#39;</span><span class="p">,</span> <span class="s1">&#39;prep&#39;</span><span class="p">])</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not merge run begin_time&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xepics</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">values</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;end_run&#39;</span><span class="p">)</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">begin_time</span><span class="o">.</span><span class="n">values</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;begin_run&#39;</span><span class="p">)</span>
            <span class="n">xmachine</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xmachine</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span><span class="p">])</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">end_run</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end_run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">})</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">begin_run</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;begin_run&#39;</span><span class="p">:</span> <span class="s1">&#39;brun&#39;</span><span class="p">})</span>
            <span class="c1"># Need to make sure there are no duplicates -- &#39;cxim7216&#39; odd case where there are using this method.</span>
            <span class="n">dfend</span> <span class="o">=</span> <span class="n">dfend</span><span class="p">[</span><span class="o">~</span><span class="n">dfend</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
            <span class="n">dfbegin</span> <span class="o">=</span> <span class="n">dfbegin</span><span class="p">[</span><span class="o">~</span><span class="n">dfbegin</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
            <span class="n">xmachine</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xmachine</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span><span class="p">])</span>
            <span class="n">xmachine</span><span class="p">[</span><span class="s1">&#39;prep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">run</span> <span class="o">!=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">brun</span> 
            <span class="n">xmachine</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">xmachine</span><span class="p">[</span><span class="s1">&#39;end_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">end_run</span>
            <span class="n">xmachine</span><span class="p">[</span><span class="s1">&#39;begin_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">begin_run</span>
            <span class="n">xmachine</span> <span class="o">=</span> <span class="n">xmachine</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;brun&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_run&#39;</span><span class="p">,</span> <span class="s1">&#39;end_run&#39;</span><span class="p">,</span> <span class="s1">&#39;prep&#39;</span><span class="p">])</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not merge run begin_time&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xmachine</span><span class="p">,</span> <span class="n">dfend</span><span class="p">,</span> <span class="n">dfbegin</span>

        <span class="c1"># add in machine info</span>
        <span class="c1">#phot_attrs = [&#39;photon_current&#39;,&#39;photon_beam_energy&#39;]</span>
        <span class="c1"># Need to add this smarter to avoid huge arrays.</span>
        <span class="c1"># Either interpolate or ffill and drop, e.g., photon_current.to_dataframe().ffill()</span>
        <span class="n">phot_attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_machine_coords</span> <span class="o">=</span> <span class="n">phot_attrs</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">phot_attrs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">xmachine</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">phot_attrs</span><span class="p">):</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">xmachine</span><span class="p">[</span><span class="n">phot_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">())</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">phot_attrs</span><span class="p">)</span>
            <span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span><span class="o">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_run&#39;</span><span class="p">,</span> <span class="s1">&#39;end_run&#39;</span><span class="p">,</span> <span class="s1">&#39;prep&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span> <span class="o">=</span> <span class="n">xepics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmachine</span> <span class="o">=</span> <span class="n">xmachine</span>
        <span class="n">time_next</span> <span class="o">=</span> <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> To merge epics data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time_last</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> Total Time to load epics data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time0</span><span class="p">))</span>
       
<span class="c1">#        if save:</span>
<span class="c1">#            if not path:</span>
<span class="c1">#                subfolder = &#39;results/epicsArch/&#39;</span>
<span class="c1">#                path = os.path.join(&#39;/reg/d/psdm/&#39;,self.instrument,self.experiment, subfolder)</span>
<span class="c1">#</span>
<span class="c1">#            file_name = os.paht.join(path, </span>
<span class="c1">#</span>
<span class="c1">#            #xepics.to_netcdf( </span>

    <span class="k">def</span> <span class="nf">_load_machine_epicsArch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epics_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epics_file</span><span class="o">=</span><span class="s1">&#39;epicsArch_machine.txt&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epics_dir</span><span class="p">:</span>
            <span class="c1"># scons needs updating to copy .txt file so use fixed path</span>
            <span class="c1">#epics_dir = os.path.dirname(__file__)</span>
            <span class="n">epics_dir</span> <span class="o">=</span> <span class="s1">&#39;/reg/neh/home/koglin/conda/PyDataSource/src/&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_epicsArch_dict</span> <span class="o">=</span> <span class="n">epicsArch_dict</span><span class="p">(</span><span class="n">epics_file</span><span class="p">,</span><span class="n">epics_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epicsArch_dict</span>

    <span class="k">def</span> <span class="nf">_load_instrument_epicsArch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epics_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epics_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                             <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load epicsArch file to define aliases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_camdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epics_file</span><span class="p">:</span>
            <span class="n">epics_file</span> <span class="o">=</span> <span class="s1">&#39;epicsArch.txt&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">epics_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="p">:</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
            
            <span class="n">epics_dir</span> <span class="o">=</span> <span class="s1">&#39;/reg/g/pcds/dist/pds/&#39;</span><span class="o">+</span><span class="n">instrument</span><span class="o">+</span><span class="s1">&#39;/misc/&#39;</span>

        <span class="k">if</span> <span class="n">epics_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;instrument: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading epics pvs from&#39;</span><span class="p">,</span> <span class="n">epics_file</span><span class="p">,</span> <span class="s1">&#39; in&#39;</span><span class="p">,</span> <span class="n">epics_dir</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_epics_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">epicsArch_dict</span><span class="p">(</span><span class="n">epics_file</span><span class="p">,</span><span class="n">epics_dir</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alias</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_sets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]})</span>
                <span class="c1">#self._devices.update(**{item[&#39;base&#39;]: {&#39;alias&#39;: item[&#39;alias&#39;], &#39;records&#39;: {}}})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_dict</span>

    <span class="k">def</span> <span class="nf">_load_exp_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">h5write</span> <span class="k">import</span> <span class="n">resort</span>
        <span class="kn">import</span> <span class="nn">time</span>

        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;xepics&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_epics</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... processing </span><span class="si">{:}</span><span class="s1"> epics data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">,</span><span class="s1">&#39;end_time&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;run_id&#39;</span><span class="p">,</span><span class="s1">&#39;prep_time&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pvs&#39;</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pvs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> \
                     <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;STATE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_set&#39;</span><span class="p">)</span> 
                  <span class="ow">or</span> <span class="s1">&#39;TRIG&#39;</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)]</span> 
                 <span class="c1">#or a.endswith(&#39;_calc&#39;) or a.endswith(&#39;_code&#39;)]</span>
                  <span class="c1">#or b.attrs.get(&#39;pv&#39;,&#39;&#39;).split(&#39;:&#39;)[-1] in [&#39;RATE&#39;,&#39;TCTL&#39;,&#39;EC_RBV&#39;,&#39;TPOL&#39;,&#39;TWID&#39;,&#39;TDES&#39;,&#39;TEC&#39;,&#39;EVENTCTRL.ENM&#39;]]</span>
        <span class="c1">#attrs = [a for a in self.xepics.data_vars.keys() \</span>
                 <span class="c1">#if a.startswith(&#39;dia_s&#39;) or (a.endswith(&#39;_set&#39;) and not a.startswith(&#39;dia_a&#39;))]</span>
        <span class="c1">#xpvs = self.xepics[attrs].dropna(dim=&#39;time&#39;,how=&#39;all&#39;)</span>
        <span class="n">xpvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="n">xcut</span> <span class="o">=</span> <span class="n">xpvs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xpvs</span><span class="o">.</span><span class="n">prep</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
        <span class="n">xcut</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ca</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">][</span><span class="n">ca</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">recoords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_machine_coords</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">xcut</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">recoords</span><span class="p">:</span>
            <span class="n">xcut</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">recoords</span><span class="p">)</span> 
        <span class="n">dgrp</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dgrp</span><span class="p">,</span> <span class="n">func</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
        <span class="n">mvs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;concat_dim&#39;</span><span class="p">:</span> <span class="s1">&#39;stat&#39;</span><span class="p">})</span>
        <span class="n">xscan</span> <span class="o">=</span> <span class="n">resort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mvs</span><span class="p">))</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recoords</span><span class="p">:</span>
            <span class="n">xscan</span> <span class="o">=</span> <span class="n">xscan</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">recoords</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xscan</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">xscan</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepics</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
 
        <span class="c1"># find the last value set in prep before a run starts</span>
        <span class="c1"># if only set once during run, then also consider it to be a set value</span>
        <span class="c1"># since run start time occurs sometimes before set is completed.</span>
        <span class="c1"># in future can make this a little smarter, but generally should be valid assumption</span>

<span class="c1">#        xcut = xpvs.where(xpvs.run_prep&gt;0,drop=True).drop(&#39;run&#39;).rename({&#39;run_prep&#39;: &#39;run&#39;}).set_coords(&#39;run&#39;)</span>
        <span class="n">xcut</span> <span class="o">=</span> <span class="n">xpvs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xpvs</span><span class="o">.</span><span class="n">prep</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
        <span class="n">xcut</span> <span class="o">=</span> <span class="n">xcut</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ca</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">][</span><span class="n">ca</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">xset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xruns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xcut</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">xpv</span> <span class="o">=</span> <span class="n">xcut</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xcut</span><span class="o">.</span><span class="n">run</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">xpv</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">xscan</span><span class="p">:</span>
                <span class="n">setonce</span> <span class="o">=</span> <span class="n">xscan</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">runs</span> <span class="o">=</span> <span class="n">runs</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">setonce</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">setonce</span><span class="p">])</span>
            <span class="c1">#data = {rn: xpv.where(xpv.run==rn,drop=True).values[-1] for rn in runs}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">xpv</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xpv</span><span class="o">.</span><span class="n">run</span><span class="o">==</span><span class="n">rn</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">setonce</span><span class="p">[</span><span class="n">rn</span><span class="p">]:</span>
                     <span class="n">val</span> <span class="o">=</span> <span class="n">xscan</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">rn</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">rn</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="n">xset</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> 
                                <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">],</span> <span class="n">attrs</span><span class="o">=</span><span class="n">xpvs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xscan</span> <span class="o">=</span> <span class="n">xscan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xset</span> <span class="o">=</span> <span class="n">xset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpvs</span> <span class="o">=</span> <span class="n">xpvs</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscan</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">xscan</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xscan</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()[</span><span class="n">attrs</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfset</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">time_next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:8.3f}</span><span class="s1"> Total Time to load and process epics data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_next</span><span class="o">-</span><span class="n">time0</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Done loading </span><span class="si">{:}</span><span class="s1"> epics data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
      
    <span class="k">def</span> <span class="nf">get_scan_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Infer sets or runs that are parametric series based on change in attr setting for each run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">dfp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">dfpp</span> <span class="o">=</span> <span class="n">dfp</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">asets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nrns</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">rn0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rn_last</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">run</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">dfp</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dfpp</span><span class="p">[</span><span class="n">run</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">or</span> <span class="n">run</span><span class="o">-</span><span class="n">rn_last</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">run</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">run</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">nrns</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">rn_last</span> <span class="o">=</span> <span class="n">run</span>
                <span class="k">if</span> <span class="n">nrns</span> <span class="o">&gt;=</span> <span class="n">min_runs</span><span class="p">:</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xset</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">da</span><span class="o">.</span><span class="n">run</span><span class="o">&gt;=</span><span class="n">rn0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">run</span><span class="o">&lt;=</span><span class="n">rn_last</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s1">&#39;begin_time&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span>
                    <span class="n">asets</span><span class="p">[(</span><span class="n">rn0</span><span class="p">,</span><span class="n">rn_last</span><span class="p">)]</span> <span class="o">=</span> <span class="n">da</span>
                <span class="n">rn0</span> <span class="o">=</span> <span class="n">run</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">rn_last</span> <span class="o">=</span> <span class="n">run</span>
                <span class="n">nrns</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">dfpp</span><span class="p">[</span><span class="n">run</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nrns</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">rn_last</span> <span class="o">=</span> <span class="n">run</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{:4}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1"> </span><span class="si">{:8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">dfp</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">dfpp</span><span class="p">[</span><span class="n">run</span><span class="p">]))</span>
        
        <span class="k">return</span> <span class="n">asets</span>

    <span class="k">def</span> <span class="nf">get_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_steps</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_motors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get epics scans from dfscan information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_steps : int</span>
<span class="sd">            Minimum number of steps in scan [default = 1]</span>
<span class="sd">        min_motors : int</span>
<span class="sd">            Minimum number of motors involved in scan [default = 1]</span>
<span class="sd">        device : str</span>
<span class="sd">            Base name of device for which all pvs share </span>
<span class="sd">            (e.g., devide=&#39;Sample&#39; will include &#39;Sample_x&#39;, &#39;Sample_y&#39;, &#39;Sample_z&#39;)</span>
<span class="sd">        attrs : list, optional</span>
<span class="sd">            List of pvs involved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">device</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">device</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">dfscan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfscan</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">dfscan</span> <span class="o">=</span> <span class="n">dfscan</span><span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

        <span class="c1"># determine attributes that make miniumum step cut</span>
        <span class="n">attr_cut</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfscan</span> <span class="o">&gt;</span> <span class="n">min_steps</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scan_attrs</span> <span class="o">=</span> <span class="n">dfscan</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">attr_cut</span><span class="p">]</span>
            <span class="c1"># Make cut on runs with minimum steps</span>
            <span class="n">cut</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfscan</span><span class="p">[</span><span class="n">scan_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;</span> <span class="n">min_steps</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">min_motors</span>
            <span class="c1"># Return reduced Dataframe with number of steps</span>
            <span class="k">return</span> <span class="n">dfscan</span><span class="p">[</span><span class="n">scan_attrs</span><span class="p">][</span><span class="n">cut</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_pv_set_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of epics PVs set before each run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfset</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pv_set_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of times PV was set before a run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfset</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dfruns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pandas DataFrame of Experiment run information. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">):</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Experiment run information from MySQL database and xtc directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="k">if</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">name2id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">):</span>
            <span class="n">runs_list</span> <span class="o">=</span>  <span class="n">experiment_info</span><span class="o">.</span><span class="n">experiment_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
            <span class="n">xtc_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtc_dir</span><span class="o">+</span><span class="s1">&#39;/*.xtc&#39;</span><span class="p">)</span>
            <span class="n">h5_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_dir</span><span class="o">+</span><span class="s1">&#39;/*.h5&#39;</span><span class="p">)</span>
            <span class="n">stats_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="o">+</span><span class="s1">&#39;/nc/*_stats.nc&#39;</span><span class="p">)</span>
            <span class="n">drop_stats_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="o">+</span><span class="s1">&#39;/nc/*_drop_stats.nc&#39;</span><span class="p">)</span>
            <span class="n">runs_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">runs_list</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">]</span>
                <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;xtc_files&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;h5_files&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                        <span class="s1">&#39;stats_files&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;drop_stats_files&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;scratch_nc_files&#39;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">xtc_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;xtc_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">stats_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_stats&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;stats_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">stats_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_drop_stats&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;drop_stats_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">stats_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;scratch_nc_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">h5_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs_dict</span><span class="p">:</span>
                        <span class="n">runs_dict</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;h5_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">runs_list</span> <span class="o">=</span> <span class="n">runs_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">runs_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">runs_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">open_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of files created (by the DAQ system).  </span>
<span class="sd">           Current run if no run is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="k">return</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">get_open_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exper_id</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_run_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load MySQL database experiment run summary information into a dictionary.</span>
<span class="sd">        </span>
<span class="sd">        Slow process.  Generally better information is available from epics </span>
<span class="sd">        information gathered in load_exp_runs method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">RegDB</span> <span class="k">import</span> <span class="n">experiment_info</span>
        <span class="n">vrun_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading summary of </span><span class="si">{:}</span><span class="s1"> runs for </span><span class="si">{:}</span><span class="s1"> from SQL database&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> \
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate loading time ~</span><span class="si">{:}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">run_attr</span> <span class="o">=</span> <span class="n">experiment_info</span><span class="o">.</span><span class="n">run_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span><span class="n">run</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">run_attr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vrun_attrs</span><span class="p">:</span>
                    <span class="n">vrun_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">],</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;descr&#39;</span><span class="p">],</span>
                                             <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span>
                                             <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">run</span><span class="p">)]}</span>
                <span class="n">vrun_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_summary</span> <span class="o">=</span> <span class="n">vrun_attrs</span>


    <span class="k">def</span> <span class="nf">show_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="mi">99999999</span><span class="p">,</span><span class="n">csv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show run summary for current experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">csv</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;7}</span><span class="s1">, </span><span class="si">{:&gt;10}</span><span class="s1">, </span><span class="si">{:&gt;8}</span><span class="s1">, </span><span class="si">{:&gt;10}</span><span class="s1">, </span><span class="si">{:3}</span><span class="s1">, </span><span class="si">{:2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="s1">&#39;xtc&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">72</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Experiment </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  xtc dir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtc_dir</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  hdf5 dir </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h5_dir</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">72</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;7}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:&gt;8}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:3}</span><span class="s1"> </span><span class="si">{:2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">,</span> <span class="s1">&#39;Day&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="s1">&#39;xtc&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">72</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runs</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">run</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">run</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="n">datestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
                                        <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;begin_time_unix&#39;</span><span class="p">]))</span>
                <span class="n">timestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                                        <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;begin_time_unix&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;xtc_files&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xtc</span> <span class="o">=</span> <span class="s1">&#39;xtc&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xtc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;h5_files&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">h5</span> <span class="o">=</span> <span class="s1">&#39;h5&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h5</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="n">begin_time</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;begin_time_unix&#39;</span><span class="p">]</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;end_time_unix&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">end_time</span><span class="p">:</span>
                    <span class="n">dtime</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">begin_time</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin_time</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>

                <span class="n">dmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtime</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">dsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtime</span> <span class="o">%</span> <span class="mi">60</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dmin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dtstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:4}</span><span class="s1">m </span><span class="si">{:02}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="n">dsec</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:02}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dsec</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">csv</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:7}</span><span class="s1">, </span><span class="si">{:10}</span><span class="s1">, </span><span class="si">{:8}</span><span class="s1">, </span><span class="si">{:&gt;10}</span><span class="s1">, </span><span class="si">{:3}</span><span class="s1">, </span><span class="si">{:2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span>
                                        <span class="n">datestr</span><span class="p">,</span> <span class="n">timestr</span><span class="p">,</span> <span class="n">dtstr</span><span class="p">,</span> <span class="n">xtc</span><span class="p">,</span> <span class="n">h5</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:7}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1"> </span><span class="si">{:8}</span><span class="s1"> </span><span class="si">{:&gt;10}</span><span class="s1"> </span><span class="si">{:3}</span><span class="s1"> </span><span class="si">{:2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">,</span>
                                        <span class="n">datestr</span><span class="p">,</span> <span class="n">timestr</span><span class="p">,</span> <span class="n">dtstr</span><span class="p">,</span> <span class="n">xtc</span><span class="p">,</span> <span class="n">h5</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* Currently Acquiring Data for Run </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">run</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repr_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&lt; &#39;</span><span class="o">+</span><span class="n">repr_str</span><span class="o">+</span><span class="s1">&#39; &gt;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp</span><span class="p">))</span></div>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLAC National Accelerator Laboratory.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.6.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>